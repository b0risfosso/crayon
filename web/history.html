<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Narratives</title>
  <style>
    body{font-family:sans-serif;max-width:900px;margin:40px auto}
    .node{margin-left:20px;border-left:2px solid #ccc;padding-left:8px}
    .sys{font-weight:bold}
    pre{white-space:pre-wrap}
  </style>
</head>
<body>
  <nav><a href="prompt.html">Imagine</a> | <a href="history.html">Narratives</a> |
       <a href="organize.html">Organize</a></nav>
  <h2>Conversation tree</h2>
  <div id="tree">Loading‚Ä¶</div>

<script>
function buildTree(list){
  const byId = Object.fromEntries(list.map(x=>[x.id, x]));
  const roots=[];
  list.forEach(x=>{
    x.children=[];                             // init
  });
  list.forEach(x=>{
    if(x.parent && byId[x.parent]) byId[x.parent].children.push(x);
    else roots.push(x);
  });

  function render(node){
    return `<div class="node">
              <div class="sys">üó®Ô∏è¬†${node.user}</div>
              <pre>${node.answer}</pre>
              ${node.children.map(render).join('')}
            </div>`;
  }
  return roots.map(render).join('');
}

async function load(){
  const r=await fetch('/api/history');
  const list=await r.json();
  document.getElementById('tree').innerHTML= buildTree(list);
}
load();
</script>
</body>
</html>
