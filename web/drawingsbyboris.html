<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fantasiagenesis ¬∑ Drawings by Boris</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background: Canvas; color: CanvasText; }
    header { padding: 1rem 1.25rem; border-bottom: 1px solid color-mix(in oklab, CanvasText 10%, transparent); display:flex; align-items:baseline; gap:1rem; }
    header h1 { margin:0; font-size: clamp(1.2rem, 2.2vw, 1.6rem); }
    header nav { margin-left:auto; display:flex; gap:.8rem; align-items:center; }
    header a { color:inherit; text-decoration:none; }
    header a:hover { text-decoration: underline; color: color-mix(in oklab, dodgerblue 60%, CanvasText 40%); }
    main { display:grid; grid-template-columns: 320px 1fr; gap:1rem; padding:1rem; }
    @media (max-width: 900px){ main { grid-template-columns: 1fr; } }
    .panel { border:1px solid color-mix(in oklab, CanvasText 20%, transparent); border-radius:.6rem; background: color-mix(in oklab, Canvas 92%, CanvasText 8%); }
    .panel header { border:0; padding:.8rem 1rem; font-weight:600; }
    .panel .content { padding: .8rem 1rem 1rem; }
    .muted { opacity:.85; font-size:.9rem; }
    input[type="text"] { width:100%; height:2.5rem; padding:.6rem .7rem; border:1px solid #c9c9c9; border-radius:.55rem; }
    button { padding:.6rem .9rem; border:0; border-radius:.55rem; background:#0b5cff; color:#fff; cursor:pointer; }
    button.secondary { background:#444; }
    .row { display:flex; gap:.5rem; align-items:center; }
    .list { display:grid; gap:.4rem; }
    .item { border:1px solid color-mix(in oklab, CanvasText 20%, transparent); border-radius:.55rem; padding:.55rem .65rem; background: color-mix(in oklab, Canvas 96%, CanvasText 4%); cursor:pointer; }
    .item:hover { outline:2px solid color-mix(in oklab, #0b5cff 35%, transparent); }
    .title { font-weight:600; }
    .meta { font-size:.9rem; opacity:.9; margin-top:.2rem; }
    .badge { font-size:.8rem; padding:.1rem .4rem; border:1px solid #ddd; border-radius:.4rem; }
    .group { border:1px solid #e2e2e2; border-radius:.55rem; padding:.6rem .75rem; background: color-mix(in oklab, Canvas 98%, CanvasText 2%); }
    .groups { display:grid; gap:.7rem; }
    .domains { display:grid; gap:.5rem; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); }
    .domain { border:1px solid #e5e5e5; border-radius:.55rem; padding:.55rem .7rem; }
    .dim-list { margin-top:.45rem; display:grid; gap:.35rem; }
    .dim-item { border:1px dashed #d5d5d5; border-radius:.5rem; padding:.45rem .55rem; background: color-mix(in oklab, Canvas 98%, CanvasText 2%); }
    details { margin-top:.6rem; }
    pre { background:#f6f6f6; padding:.65rem; border-radius:.5rem; overflow:auto; }
    .error { color:#b00020; white-space:pre-wrap; }
    .thesis-label { font-weight: 600; margin-top:.25rem; margin-bottom:.25rem; }
    .thesis-box  { background:#eaf3ff; border:1px solid #cfe3ff; border-left:3px solid #8bbcff; border-radius:.5rem; padding:.5rem .6rem; }
    .verify-box  { background:#fff8db; border:1px solid #f5e7a3; border-left:3px solid #e2c85a; border-radius:.5rem; padding:.5rem .6rem; }
    .true-box    { background:#e9f7ef; border:1px solid #c9ecd6; border-left:3px solid #88d19e; border-radius:.5rem; padding:.5rem .6rem; }
    .false-box   { background:#fdecea; border:1px solid #f7c7c3; border-left:3px solid #f39a93; border-radius:.5rem; padding:.5rem .6rem; }
    .thesis-box + .verify-box, .verify-box + .true-box, .true-box + .false-box { margin-top:.5rem; }
  </style>
</head>
<body>
  <header>
    <h1>Fantasiagenesis ¬∑ Drawings by Boris</h1>
    <nav class="muted">
      <p>Create your own</p>
      <a href="/crayon" target="_blank">üñçÔ∏è Crayon</a>
      <a href="/paper" target="_blank">üìÑ Paper</a>
    </nav>
  </header>

  <main>
    <!-- Left: controls + core list (email removed; hardcoded) -->
    <section class="panel" aria-labelledby="left-head">
      <header id="left-head">Cores</header>
      <div class="content">
        <div class="row" style="gap:.4rem; margin-bottom:.6rem;">
          <input id="searchInput" type="text" placeholder="Filter cores by title‚Ä¶" />
          <button id="reloadBtn" class="secondary" title="Reload cores">Reload</button>
        </div>
        <div id="leftStatus" class="muted">Auto-loading for <code>boris@fantasiagenesis.com</code>‚Ä¶</div>
        <div id="coreList" class="list" role="list" aria-label="Cores"></div>
      </div>
    </section>

    <!-- Right: details -->
    <section class="panel" aria-labelledby="right-head">
      <header id="right-head">Details</header>
      <div class="content">
        <div id="detailStatus" class="muted"></div>
        <div id="details"></div>
      </div>
    </section>
  </main>

  <script>
    // ---- fixed identity ----
    const FIXED_EMAIL = 'boris@fantasiagenesis.com';

    // ---- endpoints ----
    const EP_LIST_CORES  = '/api/cores';
    const EP_READ_CORE   = (id, email) => `/api/cores/${id}/domains?email=${encodeURIComponent(email)}`;
    const EP_READ_DIMS   = (domainId, email) => `/api/domains/${domainId}/dimensions?email=${encodeURIComponent(email)}`;
    const EP_LIST_THESES = (dimensionId, email) => `/api/dimensions/${dimensionId}/theses?email=${encodeURIComponent(email)}`;

    // ---- utils ----
    const $ = sel => document.querySelector(sel);
    function el(tag, opts={}){ const n=document.createElement(tag);
      if (opts.className) n.className = opts.className;
      if ('text' in opts) n.textContent = opts.text;
      if ('html' in opts) n.innerHTML = opts.html;
      if (opts.attrs) for (const [k,v] of Object.entries(opts.attrs)) n.setAttribute(k,v);
      return n;
    }
    function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }
    async function fetchJSON(url, opts={}){
      const r = await fetch(url, { headers:{'Accept':'application/json'}, ...opts });
      let data; try { data = await r.json(); } catch { throw new Error(`Non-JSON from ${url} (HTTP ${r.status})`); }
      if (!r.ok || data?.ok === false) throw new Error(data?.error || `HTTP ${r.status}`);
      return data;
    }

    // ---- elements ----
    const elSearch = $('#searchInput');
    const elReload = $('#reloadBtn');
    const coreList = $('#coreList');
    const leftStatus = $('#leftStatus');
    const detailStatus = $('#detailStatus');
    const details = $('#details');

    // ---- state ----
    let cores = [];
    let selectedCoreId = null;

    // ---- deeplink helpers ----
    function getDeeplinkCoreId(){
      const u = new URL(window.location.href);
      // support ?core=123 or ?id=123 or #core=123
      const q = u.searchParams.get('core') || u.searchParams.get('id');
      const h = (u.hash||'').replace(/^#/, '');
      if (q && /^\d+$/.test(q)) return Number(q);
      const hm = h.match(/^(?:core=)?(\d+)$/);
      if (hm) return Number(hm[1]);
      return null;
    }

    function setDeeplinkCoreId(id){
      const u = new URL(window.location.href);
      u.searchParams.set('core', String(id));
      history.replaceState(null, '', u.toString());
    }

    // ---- render cores list ----
    function renderCores(){
      coreList.innerHTML = '';
      const q = (elSearch.value||'').toLowerCase();
      const filtered = !q ? cores : cores.filter(c => (c.title||'').toLowerCase().includes(q));
      if (!filtered.length){
        coreList.append(el('div', { className:'muted', text:'No cores.' }));
        return;
      }
      filtered.forEach(c=>{
        const item = el('div', { className:'item', attrs:{ role:'listitem', tabindex:'0', 'data-id':String(c.id) } });
        const t = el('div', { className:'title', html:`${escapeHtml(c.title)} <span class="badge">#${c.id}</span>` });
        const d = el('div', { className:'muted', text: c.description || '' });
        item.append(t, d);
        item.addEventListener('click', ()=> { setDeeplinkCoreId(c.id); loadCore(c.id); });
        item.addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ setDeeplinkCoreId(c.id); loadCore(c.id); }});
        coreList.append(item);
      });
    }

    // ---- render core view (domains + dimensions) ----
    function renderCoreView(payload){
      details.innerHTML = '';
      if (!payload?.core){
        details.append(el('div',{className:'muted', text:'No details.'}));
        return;
      }
      const { core, groups } = payload;

      const h2 = el('h2', { text: core.title || 'Untitled core' });
      const meta = el('div', { className:'meta', html:
        `Core ID: <span class="badge">${escapeHtml(String(core.id))}</span> ¬∑ Owner: <code>${escapeHtml(core.owner_email||'')}</code> ¬∑ Provider: <span class="badge">${escapeHtml(core.provider||'')}</span>`
      });
      const desc = el('div', { className:'muted', text: core.description || '' });
      details.append(h2, meta, desc);

      const groupsWrap = el('div', { className:'groups', attrs:{ 'aria-label':'Domain groups' } });
      (groups || []).forEach(g=>{
        const block = el('div', { className:'group' });
        const gt = el('div', { className:'title', text: g.title || 'Group' });
        const doms = el('div', { className:'domains' });

        (g.domains || []).forEach(d=>{
          const card = el('div', { className:'domain' });
          const head = el('div', { className:'title', html:
            `${escapeHtml(d.name||'Domain')} ${d.id ? `<span class="badge">id ${escapeHtml(String(d.id))}</span>`:''}`
          });
          const dd = el('div', { className:'muted', text: d.description || '' });

          const dimMount = el('div', { className:'dim-list', attrs:{ id:`dims-${d.id}` } });
          const btn = el('button', { text:'Show picture', attrs:{ type:'button' }});
          btn.addEventListener('click', ()=> loadDimensions(d.id));

          card.append(head, dd, btn, dimMount);
          doms.append(card);
        });

        block.append(gt, doms);
        groupsWrap.append(block);
      });
      details.append(groupsWrap);

      const det = el('details');
      det.append(el('summary',{text:'Raw JSON (debug)'}), el('pre',{text: JSON.stringify(payload,null,2)}));
      details.append(det);
    }

    // ---- actions ----
    async function loadCores(preselectId=null){
      leftStatus.className='muted'; leftStatus.textContent='Loading cores‚Ä¶';
      coreList.innerHTML=''; details.innerHTML=''; detailStatus.textContent='';
      try{
        const data = await fetchJSON(`${EP_LIST_CORES}?email=${encodeURIComponent(FIXED_EMAIL)}`);
        cores = data.cores || [];
        renderCores();
        leftStatus.textContent = `Loaded ${cores.length} cores for ${FIXED_EMAIL}.`;

        let idToOpen = preselectId ?? getDeeplinkCoreId();
        if (idToOpen && !cores.some(c=>c.id===idToOpen)) idToOpen = null; // invalid id
        if (!idToOpen && cores.length) idToOpen = cores[0].id;

        if (idToOpen) {
          setDeeplinkCoreId(idToOpen);
          loadCore(idToOpen);
        }
      }catch(err){
        leftStatus.className='error';
        leftStatus.textContent = `Failed to load cores: ${err.message||err}`;
      }
    }

    async function loadCore(id){
      selectedCoreId = id;
      details.innerHTML=''; detailStatus.className='muted'; detailStatus.textContent='Loading core details‚Ä¶';
      try{
        const data = await fetchJSON(EP_READ_CORE(id, FIXED_EMAIL));
        renderCoreView(data);
        detailStatus.textContent='Done.';
      }catch(err){
        detailStatus.className='error';
        detailStatus.textContent = `Failed to load core: ${err.message||err}`;
      }
    }

    async function loadDimensions(domainId){
      const mount = document.getElementById(`dims-${domainId}`);
      if (!mount) return;
      mount.innerHTML = '<div class="muted">Loading dimensions‚Ä¶</div>';
      try{
        const data = await fetchJSON(EP_READ_DIMS(domainId, FIXED_EMAIL));
        const dims = data.dimensions || [];
        mount.innerHTML = '';
        if (!dims.length) {
          mount.append(el('div', { className:'muted', text:'No dimensions yet.' }));
        } else {
          dims.forEach(d=>{
            const it = el('div', { className:'dim-item' });
            const nm = el('div', { className:'title', text: d.name || 'Dimension' });
            const th = el('div', { className:'muted', text: d.thesis || '' });
            const tg = el('div', { className:'muted', text: (d.targets||[]).join(', ') });
            const tMount = el('div', { className:'dim-list', attrs:{ id:`theses-${d.id}` } });
            it.append(nm, th, tg, tMount);
            mount.append(it);
          });

          for (const d of dims) {
            await loadThesesForDimension(d.id);
          }
        }
      }catch(err){
        mount.innerHTML = '';
        mount.append(el('div', { className:'error', text:`Failed to load dimensions: ${err.message||err}` }));
      }
    }

    async function loadThesesForDimension(dimensionId){
      const tMount = document.getElementById(`theses-${dimensionId}`);
      if (!tMount) return;
      tMount.innerHTML = '<div class="muted">Loading theses‚Ä¶</div>';
      try{
        const res = await fetchJSON(EP_LIST_THESES(dimensionId, FIXED_EMAIL));
        const theses = res.theses || [];
        tMount.innerHTML = '';
        if (!theses.length){
          tMount.append(el('div', { className:'muted', text:'No theses yet.' }));
          return;
        }
        theses.forEach(t=>{
          const wrap = el('div', { className:'dim-item' });
          wrap.append(
            el('div', { className:'thesis-label', text:'Thesis' }),
            el('div', { className:'thesis-box',  text: t.text || '(no thesis text)' })
          );
          if (t.analysis){
            const v = Array.isArray(t.analysis.verification) ? t.analysis.verification : [];
            const verHTML = v.length ? `<ul>${v.map(s=>`<li>${escapeHtml(s)}</li>`).join('')}</ul>` : '<div class="muted">(no steps)</div>';
            const verify = el('div', { className:'verify-box', html:`<strong>Verification / Falsification</strong>${verHTML}` });
            const ifTrue  = el('div', { className:'true-box',  html:`<strong>If True</strong><div class="muted">${escapeHtml(t.analysis.if_true||'')}</div>` });
            const ifFalse = el('div', { className:'false-box', html:`<strong>If False (Alternative Thesis)</strong><div class="muted">${escapeHtml(t.analysis.if_false_alternative_thesis||'')}</div>` });
            wrap.append(verify, ifTrue, ifFalse);
          } else {
            wrap.append(el('div', { className:'muted', text:'(no evaluation yet)' }));
          }
          tMount.append(wrap);
        });
      }catch(err){
        tMount.innerHTML = `<span class="error">Failed to load theses: ${escapeHtml(err.message||String(err))}</span>`;
      }
    }

    // ---- events ----
    elReload.addEventListener('click', ()=> loadCores(getDeeplinkCoreId()));
    elSearch.addEventListener('input', renderCores);
    window.addEventListener('hashchange', ()=> {
      const id = getDeeplinkCoreId();
      if (id && id !== selectedCoreId && cores.some(c=>c.id===id)) loadCore(id);
    });
    window.addEventListener('popstate', ()=> {
      const id = getDeeplinkCoreId();
      if (id && id !== selectedCoreId && cores.some(c=>c.id===id)) loadCore(id);
    });

    // ---- init ----
    (function init(){
      loadCores(getDeeplinkCoreId());
    })();
  </script>
</body>
</html>
