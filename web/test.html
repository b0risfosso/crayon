<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Microbial Power Field â€” Live Wax Stack</title>
<style>
  :root{
    --bg:#f9fafb; --panel:#ffffff; --ink:#0f172a; --muted:#475569; --accent:#2563eb;
    --ok:#059669; --warn:#ca8a04; --bad:#b91c1c; --soft:#e2e8f0; --grid:#cbd5e1;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";}
  header{padding:16px 20px;border-bottom:1px solid var(--soft);background:#fff;position:sticky;top:0;z-index:2}
  header h1{margin:0;font-size:20px;font-weight:700}
  header .sub{color:var(--muted);font-size:12px;margin-top:4px}
  main{display:grid;grid-template-columns: 1.6fr 1fr; gap:16px; padding:16px; max-width:1250px; margin:0 auto}
  .card{background:var(--panel); border:1px solid var(--soft); border-radius:14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); overflow:hidden}
  .card h2{margin:0;padding:12px 14px;font-size:14px;border-bottom:1px solid var(--soft);background:linear-gradient(#fff,#fafafa)}
  .card .body{padding:14px}
  .grid{display:grid;gap:8px}
  .grid.cols-2{grid-template-columns:repeat(2, minmax(0,1fr))}
  .grid.cols-3{grid-template-columns:repeat(3, minmax(0,1fr))}
  .grid.cols-4{grid-template-columns:repeat(4, minmax(0,1fr))}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--soft);font-size:12px;color:var(--muted)}
  .badge{font-size:11px;border-radius:999px;padding:2px 8px;border:1px solid var(--soft);background:#fff;color:var(--muted)}
  .kpi{display:flex;justify-content:space-between;align-items:center;font-size:13px;padding:6px 0;border-bottom:1px dashed #edf2f7}
  .kpi:last-child{border-bottom:none}
  .progress{height:8px;background:#eef2ff;border-radius:6px;overflow:hidden}
  .progress > i{display:block;height:100%;background:var(--accent);width:0%}
  /* Field */
  .field-wrap{display:grid;grid-template-columns: 1fr 250px; gap:16px}
  .field{background:#fff;border:1px solid var(--soft);border-radius:12px;padding:12px}
  .legend{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .legend .key{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
  .key .sw{width:14px;height:14px;border-radius:3px;border:1px solid var(--soft)}
  .field svg{width:100%;height:420px;display:block;background:linear-gradient(180deg,#f8fafc 0%, #f1f5f9 100%);border-radius:10px}
  .cell-tip{font-size:12px;color:var(--muted);margin-top:8px}
  /* Right column panels */
  .status{display:grid;gap:10px}
  .status .row{display:flex;justify-content:space-between;font-size:13px}
  .cap{display:grid;grid-template-columns: 1fr auto;gap:10px;align-items:center}
  .vbar{width:10px;height:60px;background:#eef2ff;border-radius:6px;overflow:hidden;border:1px solid var(--soft)}
  .vbar i{display:block;width:100%;background:var(--ok);height:0%}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  /* Event log */
  .log{height:210px;overflow:auto;border:1px solid var(--soft);border-radius:10px;padding:8px;background:#fff}
  .log .ln{font-size:12px;color:#334155;border-bottom:1px dashed #e5e7eb;padding:6px 2px}
  .log .ln:last-child{border-bottom:none}
  .log .who{font-weight:600;margin-right:6px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)} .muted{color:var(--muted)}
  button{appearance:none;border:1px solid var(--soft);background:#fff;border-radius:10px;padding:8px 10px;font-size:13px;cursor:pointer}
  button:hover{border-color:#cbd5e1}
  .small{font-size:12px;color:var(--muted)}
  .rowc{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  canvas.spark{width:100%;height:54px;border:1px solid var(--soft);border-radius:8px;background:#fff}
  /* Wax roster */
  .roster{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .actor{border:1px solid var(--soft);border-radius:12px;padding:10px;background:#fff}
  .actor h3{margin:0 0 6px 0;font-size:13px}
  .actor p{margin:4px 0;color:var(--muted);font-size:12px}
  @media (max-width: 1024px){
    main{grid-template-columns:1fr}
    .field-wrap{grid-template-columns:1fr}
    .roster{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header>
  <h1>Microbial Power Field â€” Live Wax Stack</h1>
  <div class="sub">A campus garden array of 16 soil microbial cells. Budget â‰¤ $2k Â· Student lab Â· TRL 4 target in 90 days.</div>
</header>

<main>
  <!-- Left: World + Roster -->
  <section class="card">
    <h2>World View â€” 2Ã—8 Electrode Field</h2>
    <div class="body field-wrap">
      <div class="field">
        <div class="legend">
          <span class="key"><span class="sw" style="background:#dbeafe"></span>Voltage (OCV)</span>
          <span class="key"><span class="sw" style="background:#bbf7d0"></span>Current (through shunt)</span>
          <span class="key"><span class="sw" style="background:#fde68a"></span>Moisture</span>
          <span class="key"><span class="sw" style="background:#fecaca"></span>ORP Low (more reducing)</span>
        </div>
        <svg id="fieldSVG" viewBox="0 0 800 350" preserveAspectRatio="xMidYMid meet" aria-label="electrode array">
          <!-- Cells drawn by script -->
        </svg>
        <div class="cell-tip">Click a cell for details. The array rotates its shunt loads hourly; irrigation happens when soil dries.</div>
      </div>

      <div class="card">
        <h2>Characters (Waxes)</h2>
        <div class="body roster" id="roster">
          <!-- Populated by script with actors -->
        </div>
      </div>
    </div>
  </section>

  <!-- Right: Live Status -->
  <section class="card">
    <h2>Operations Console</h2>
    <div class="body">
      <div class="grid cols-2">
        <div class="card">
          <h2>Supercapacitor â€” Energy Harvester</h2>
          <div class="body cap">
            <div>
              <div class="status">
                <div class="row"><span>Vcap</span><strong class="mono" id="vcap">0.00 V</strong></div>
                <div class="row"><span>Avg. Harvest Power (10-min)</span><strong class="mono" id="pavg">0 Î¼W</strong></div>
                <div class="row"><span>Goal</span><span class="badge">â‰¥ 20 Î¼W</span></div>
                <div class="row"><span>Demo KPI</span><span id="kpi-demo" class="badge">Chargingâ€¦</span></div>
              </div>
              <div style="margin-top:8px">
                <div class="progress"><i id="capProg"></i></div>
                <div class="small">Target: charge 1 F to â‰¥ 0.25 V within 48 h (simulated).</div>
              </div>
            </div>
            <div class="vbar"><i id="capVbar"></i></div>
          </div>
        </div>

        <div class="card">
          <h2>Environment</h2>
          <div class="body">
            <div class="kpi"><span>Air Temp</span><strong class="mono" id="airT">â€”</strong></div>
            <div class="kpi"><span>Soil Temp</span><strong class="mono" id="soilT">â€”</strong></div>
            <div class="kpi"><span>Average Moisture</span><strong class="mono" id="moist">â€”</strong></div>
            <div class="kpi"><span>Average ORP</span><strong class="mono" id="orp">â€”</strong></div>
            <div class="rowc" style="margin-top:8px">
              <button id="irrigateBtn" title="Manual irrigation event (controlled)">Irrigate Now</button>
              <span class="small">Hydrological/Thermal Wax keeps VWC in band; drip starts automatically when dry.</span>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Data Wax â€” Live Channels</h2>
          <div class="body">
            <canvas id="sparkV" class="spark" aria-label="Voltage sparkline"></canvas>
            <div class="small" style="margin-top:6px">OCV (mean across 16 cells)</div>
            <canvas id="sparkI" class="spark" style="margin-top:8px" aria-label="Current sparkline"></canvas>
            <div class="small" style="margin-top:6px">Harvest current (sum across shunted cells)</div>
            <div class="rowc" style="margin-top:10px">
              <button id="exportBtn">Export Last 15 min (CSV)</button>
              <span class="small">Schema: timestamp,node_id,electrode_id,channel,value,unit</span>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Oversight & Budget</h2>
          <div class="body">
            <div class="kpi"><span>Approvals & SOPs</span><strong id="sops" class="badge muted">Pending</strong></div>
            <div class="kpi"><span>Stakeholder Sign-off</span><strong id="signoff" class="badge muted">Pending</strong></div>
            <div class="kpi"><span>Budget Spent</span><strong class="mono" id="budget">$0 / $2000</strong></div>
            <div class="progress" style="margin-top:6px"><i id="budgetProg" style="background:#10b981"></i></div>
            <div class="small" style="margin-top:6px">Capital Wax staggers purchases; incident log and public data enabled.</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>Event Log â€” The Field Speaks</h2>
        <div class="body">
          <div id="log" class="log" aria-live="polite" aria-atomic="false"></div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
/*
  Microbial Power Field â€” Live Simulation
  ---------------------------------------
  16 cells (2Ã—8). Each tick = 1 simulated minute. Loop runs at ~500 ms per tick.
  State: moisture, temp, microbial activity, ORP, OCV, current (with shunt rotation), supercap V.
  Characters (Waxes) drive autonomous actions and post to the event log.

  Constraints respected: student lab, budget â‰¤ $2k, no hazardous materials.
*/

const TICK_MS = 550;           // realtime per sim-minute
const N_ROWS = 2, N_COLS = 8;  // 16 cells
const N = N_ROWS * N_COLS;
const RINT = 1200;             // internal resistance (ohm) nominal
const CAP_F = 1.0;             // 1 F supercap target
const V_TARGET = 0.25;         // KPI target
const HARV_EFF = 0.28;         // harvester efficiency (speculative but conservative)
const LEAK = 0.00002;          // cap leak per minute (fractional)

let t = 0;                     // minutes elapsed
let spend = 0;
let approvals = {sop:false, sign:false};

// Budget map (from wax stack summary, rounded)
const budgetItems = [
  ["Electrodes & materials", 327],
  ["Conditioning & ADC", 320],
  ["Instrumentation", 350],
  ["Compute (Pi/ESP32)", 137],
  ["Mech & Hydro", 202],
  ["Bio assays & signage", 240],
  ["Contingency", 150],
];
// Stagger purchases across first 7 days
function stagedSpend(minute){
  const day = Math.floor(minute/ (24*60));
  if(day===0 && spend<200){spend += 200; log("Capital Wax","Stage-1 purchase executed (electrodes, logger, potentiostat).","ok");}
  if(day===1 && spend<700){spend += 500; log("Capital Wax","ADC & junction hardware received.","ok");}
  if(day===2 && spend<1000){spend += 300; log("Capital Wax","pH/ORP meters delivered.","ok");}
  if(day===3 && spend<1200){spend += 200; log("Capital Wax","Irrigation kit & sensors in stock.","ok");}
  if(day===4 && spend<1500){spend += 300; log("Capital Wax","Compute & storage provisioned.","ok");}
  if(day>=5 && !approvals.sop){approvals.sop=true; log("Operational Wax","SOP posted at plot gate; emergency contacts listed.","ok");}
  if(day>=6 && !approvals.sign){approvals.sign=true; log("Communal Wax","Stakeholder sign-off and site summary posted.","ok");}
}

// World state per cell
const cells = Array.from({length:N}, (_,i)=>({
  id: i,
  row: Math.floor(i / N_COLS),
  col: i % N_COLS,
  moisture: 0.42 + (Math.random()*0.08-0.04),   // VWC 0..1
  soilT: 16 + Math.random()*2,                   // Â°C
  orp: 200 + Math.random()*40,                   // mV (lower â†’ more reducing)
  activity: 0.0,                                  // 0..1
  ocv: 0.2,                                       // V
  current: 0.0,                                   // A
  shunted: (i%4===0),                             // which cells are loaded this "hour"
  rint: RINT * (0.8 + Math.random()*0.4),
}));

// Global variables
let airT = 18;        // Â°C diurnal sinusoid
let vcap = 0.00;      // V on supercap
let p10Buffer = [];   // last 10 min harvested power (Î¼W)
let sparkV = [];      // mean OCV sparkline
let sparkI = [];      // sum current sparkline

// DOM shortcuts
const el = id => document.getElementById(id);
const $vcap = el("vcap"), $pavg = el("pavg"), $kpi = el("kpi-demo");
const $airT = el("airT"), $soilT = el("soilT"), $moist = el("moist"), $orp = el("orp");
const $capProg = el("capProg"), $capVbar = el("capVbar");
const $budget = el("budget"), $budgetProg = el("budgetProg");
const $log = el("log");
const $fieldSVG = el("fieldSVG");
const $roster = el("roster");

// Utility
function clamp(x,a,b){return Math.max(a, Math.min(b,x));}
function lerp(a,b,t){return a+(b-a)*t;}
function fmt(x, d=2){return (x>=0? "":"") + x.toFixed(d);}
function rndn(mu=0, sigma=1){ // Boxâ€“Muller
  const u = 1 - Math.random(); const v = Math.random();
  return mu + sigma*Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
}
function colorScale(val, min, max, a=0.9, b=0.1){
  const t = clamp((val-min)/(max-min),0,1);
  const hue = lerp(200, 0, t); // blue â†’ red
  return `hsl(${hue} 80% ${lerp(88, 40, t)}%)`;
}
function log(who, msg, level=""){
  const div = document.createElement("div"); div.className="ln";
  const cl = level==="ok"?"ok":(level==="warn"?"warn":(level==="bad"?"bad":"muted"));
  div.innerHTML = `<span class="who ${cl}">${who}:</span> ${msg}`;
  $log.appendChild(div);
  $log.scrollTop = $log.scrollHeight;
}

// Build SVG Field
const PADDING = 40;
const W = 800 - PADDING*2, H = 350 - PADDING*2;
function drawField(){
  // clear
  while($fieldSVG.firstChild) $fieldSVG.removeChild($fieldSVG.firstChild);
  // background grid
  const bg = document.createElementNS("http://www.w3.org/2000/svg", "rect");
  bg.setAttribute("x", 0); bg.setAttribute("y", 0); bg.setAttribute("width", 800); bg.setAttribute("height", 350);
  bg.setAttribute("fill", "transparent");
  $fieldSVG.appendChild(bg);

  // Frame outline
  const frame = document.createElementNS("http://www.w3.org/2000/svg","rect");
  frame.setAttribute("x", PADDING); frame.setAttribute("y", PADDING);
  frame.setAttribute("width", W); frame.setAttribute("height", H);
  frame.setAttribute("rx", 12); frame.setAttribute("fill", "none");
  frame.setAttribute("stroke", "#cbd5e1"); frame.setAttribute("stroke-width", 2);
  $fieldSVG.appendChild(frame);

  const cellW = W / N_COLS, cellH = H / N_ROWS;
  // cell boundaries
  for(let r=0;r<N_ROWS;r++){
    for(let c=0;c<N_COLS;c++){
      const x = PADDING + c*cellW, y = PADDING + r*cellH, idx = r*N_COLS+c;
      const g = document.createElementNS("http://www.w3.org/2000/svg","g");
      g.setAttribute("data-idx", idx);

      // moisture overlay
      const m = cells[idx].moisture;
      const moistureRect = document.createElementNS("http://www.w3.org/2000/svg","rect");
      moistureRect.setAttribute("x", x+4); moistureRect.setAttribute("y", y+4);
      moistureRect.setAttribute("width", cellW-8); moistureRect.setAttribute("height", cellH-8);
      moistureRect.setAttribute("rx", 8);
      moistureRect.setAttribute("fill", colorScale(m, 0.2, 0.6)); // yellowish scale banded for VWC
      moistureRect.setAttribute("fill-opacity", 0.4);
      g.appendChild(moistureRect);

      // electrodes: anode/cathode bars
      const ocv = cells[idx].ocv;
      const colV = colorScale(ocv, 0.05, 0.6);
      const barA = document.createElementNS("http://www.w3.org/2000/svg","rect");
      barA.setAttribute("x", x + cellW*0.25 - 8);
      barA.setAttribute("y", y + cellH*0.25);
      barA.setAttribute("width", 8); barA.setAttribute("height", cellH*0.5);
      barA.setAttribute("rx", 2);
      barA.setAttribute("fill", colV);
      barA.setAttribute("stroke", "#94a3b8");
      g.appendChild(barA);

      const colI = colorScale(Math.abs(cells[idx].current), 0.00001, 0.00025);
      const barC = document.createElementNS("http://www.w3.org/2000/svg","rect");
      barC.setAttribute("x", x + cellW*0.75);
      barC.setAttribute("y", y + cellH*0.25);
      barC.setAttribute("width", 8); barC.setAttribute("height", cellH*0.5);
      barC.setAttribute("rx", 2);
      barC.setAttribute("fill", colI);
      barC.setAttribute("stroke", "#94a3b8");
      g.appendChild(barC);

      // ORP indicator (low = more reducing) as circle
      const orp = cells[idx].orp;
      const circ = document.createElementNS("http://www.w3.org/2000/svg","circle");
      circ.setAttribute("cx", x + cellW*0.5);
      circ.setAttribute("cy", y + cellH*0.5);
      circ.setAttribute("r", 10);
      const orpColor = colorScale(350-orp, 0, 350); // low ORP â†’ redder fill
      circ.setAttribute("fill", orpColor);
      circ.setAttribute("stroke", "#64748b");
      g.appendChild(circ);

      // shunt flag
      if(cells[idx].shunted){
        const flag = document.createElementNS("http://www.w3.org/2000/svg","path");
        const fx = x + cellW - 16, fy = y + 12;
        flag.setAttribute("d", `M${fx},${fy} l14,0 l-7,10 z`);
        flag.setAttribute("fill", "#22c55e");
        g.appendChild(flag);
      }

      // border
      const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
      rect.setAttribute("x", x+1); rect.setAttribute("y", y+1);
      rect.setAttribute("width", cellW-2); rect.setAttribute("height", cellH-2);
      rect.setAttribute("rx", 8);
      rect.setAttribute("fill", "none");
      rect.setAttribute("stroke", "#e2e8f0");
      $fieldSVG.appendChild(g);
      $fieldSVG.appendChild(rect);

      g.addEventListener("click", ()=>showCell(idx));
      // tooltip via title
      const title = document.createElementNS("http://www.w3.org/2000/svg","title");
      title.textContent = cellTooltip(idx);
      g.appendChild(title);
    }
  }
}
function cellTooltip(i){
  const c = cells[i];
  return `Cell ${i+1}
Moisture: ${(c.moisture*100).toFixed(1)}%
Soil T: ${c.soilT.toFixed(1)} Â°C
ORP: ${c.orp.toFixed(0)} mV
OCV: ${c.ocv.toFixed(3)} V
I (shunt): ${(c.current*1e6).toFixed(2)} Î¼A
Shunted: ${c.shunted ? "Yes":"No"}`;
}
function refreshTooltips(){
  [...$fieldSVG.querySelectorAll("g[data-idx]")].forEach(g=>{
    const idx = +g.getAttribute("data-idx");
    const title = g.querySelector("title");
    if(title) title.textContent = cellTooltip(idx);
  });
}

function showCell(i){
  const c = cells[i];
  log("Data Wax", `Cell ${i+1} â€” V=${c.ocv.toFixed(3)} V, I=${(c.current*1e6).toFixed(1)} Î¼A, ORP=${c.orp.toFixed(0)} mV, Moist=${(c.moisture*100).toFixed(0)}%.`);
}

// Roster (actors)
const actors = [
  ["Mechanical Wax","Holds geometry; sleeves keep electrodes at 10â€“20 cm, map â†” IDs; watches for drift.", "ok"],
  ["Fabrication/Materials Wax","Graphite anodes, carbon/stainless cathodes; keeps contact resistance low.", "ok"],
  ["Electrical/Electromagnetic Wax","Shunts, isolation, boost; guards noise floor and backfeed.", "ok"],
  ["Instrumentation & Measurement Wax","potentiostat, ORP, pH; runs polarization, validates metabolism.", "ok"],
  ["Data Wax","Schema, logging, sync; ensures <1% loss; renders dashboards.", "ok"],
  ["Hydrological/Thermal Wax","Moisture & temp in band; triggers drip irrigation when dry.", "warn"],
  ["Biological Monitoring Wax","Respiration chamber, ATP (optional); correlates ORP â†” current.", "ok"],
  ["Software/Control Wax","Schedules, rotates shunts hourly; watchdogs and alerts.", "ok"],
  ["Operational/Infrastructure Wax","Approvals, signage, SOPs; bench space and maintenance.", "warn"],
  ["Communal/Ethical Wax","Transparency, feedback; incident log; public data.", "ok"],
  ["Capital Wax","Budget tracking; staged purchasing â‰¤ $2k.", "ok"],
];
function buildRoster(){
  actors.forEach(([name, line, mood])=>{
    const div = document.createElement("div");
    div.className = "actor";
    div.innerHTML = `<h3>${name} ${mood==="ok"?"ðŸŸ¢":(mood==="warn"?"ðŸŸ ":"ðŸ”´")}</h3><p>${line}</p>`;
    $roster.appendChild(div);
  });
}

// Irrigation control
let autoIrrigateArmed = true;
function irrigate(){
  // Add moisture to all cells with slight variance
  cells.forEach(c=>{
    c.moisture = clamp(c.moisture + 0.08 + Math.random()*0.02, 0.2, 0.7);
  });
  log("Hydrological/Thermal Wax","Drip irrigation cycle: VWC nudged to setpoint.","ok");
  drawField(); refreshTooltips();
}
el("irrigateBtn").addEventListener("click", irrigate);

// Simple diurnal cycles & dynamics
function step(){
  t++;

  // Time & environment: 24 h sinusoid (minutes â†’ radians)
  const rad = 2*Math.PI*(t%1440)/1440;
  airT = 14 + 8*Math.sin(rad - Math.PI/2); // min morning, max afternoon
  // Soil temperature follows air with lag and smaller amplitude
  const soilBase = 16 + 4*Math.sin(rad - Math.PI/2 - 0.6);

  // Moisture evaporates with temperature; rainfall absent unless irrigated
  const evap = 0.0008 + 0.0004*Math.max(0, (airT-15)/15);
  cells.forEach(c=>{
    c.soilT = lerp(c.soilT, soilBase + rndn(0,0.15), 0.2);
    c.moisture = clamp(c.moisture - evap + rndn(0,0.0006), 0.1, 0.7);

    // Microbial activity depends on moisture & temperature (bell-shaped), plus noise
    const m = c.moisture; // ideal ~0.45
    const mTerm = Math.exp(-Math.pow((m-0.45)/0.12, 2));
    const T = c.soilT;    // ideal ~22 Â°C
    const tTerm = Math.exp(-Math.pow((T-22)/6.0, 2));
    c.activity = clamp(0.15 + 0.8*mTerm*tTerm + rndn(0,0.03), 0, 1);

    // ORP inversely tracks activity (more activity â†’ more reducing)
    c.orp = clamp(320 - 160*c.activity + rndn(0,6), 80, 360);

    // Open-circuit voltage (simplified): 0.05..0.6 V based on activity & redox spread
    c.ocv = clamp(0.05 + 0.55*c.activity + rndn(0,0.01), 0.03, 0.7);
  });

  // Software/Control Wax: Rotate shunted cells hourly
  if(t % 60 === 0){
    const start = (Math.floor(t/60) % 4); // quartiles
    cells.forEach((c,i)=> c.shunted = (i%4===start));
    log("Software/Control Wax",`Shunt rotation executed â€” group ${start+1}/4 now under load.`,"ok");
  }

  // Electrical: Current through shunt (select a shunt ~1kÎ©; measurement)
  // Harvest: only a fraction contributes to cap due to boost & losses
  let totalI = 0;
  let totalV = 0;
  cells.forEach(c=>{
    totalV += c.ocv;
    if(c.shunted){
      const Rload = 1000; // active shunt
      const I = c.ocv / (c.rint + Rload);
      c.current = I;
      totalI += I;
    }else{
      c.current = 0;
    }
  });

  // Supercap charging model
  // Effective harvested power â‰ˆ sum(I^2 * Rload) * efficiency (crude approximation)
  const Pload = cells.filter(c=>c.shunted).reduce((acc,c)=>acc + c.current*c.current*1000, 0); // watts
  const PmuW = Pload*1e6*HARV_EFF;
  p10Buffer.push(PmuW);
  if(p10Buffer.length>10) p10Buffer.shift(); // 10 minutes mean

  // Cap update: dV = (P / (C*V)) * dt  with guard when Vâ†’0
  const dt = 60; // seconds per tick
  const Pcap = Pload * HARV_EFF; // W
  const dV = (vcap>0 ? (Pcap/(CAP_F*vcap))*dt : (Pcap/CAP_F)*dt/0.1);
  vcap += dV;
  // leak
  vcap *= (1 - LEAK);

  // Hydrological autopilot
  const avgMoist = cells.reduce((a,c)=>a+c.moisture,0)/N;
  if(avgMoist < 0.32 && autoIrrigateArmed){
    irrigate();
    autoIrrigateArmed = false;
  }
  // Re-arm once moisture stabilizes
  if(avgMoist > 0.40) autoIrrigateArmed = true;

  // Instrumentation & Measurement validation checkpoints (simplified)
  if(t===180){ // after 3 hours
    log("Instrumentation Wax","Polarization on 3 cells shows OCV â‰¥ 50 mV and live > sterilized by 50% at fixed potential.","ok");
  }

  // KPI: demo target
  if(vcap >= V_TARGET){
    $kpi.textContent = "Target reached â‰¥ 0.25 V";
    $kpi.className = "badge ok";
  }else{
    $kpi.textContent = "Chargingâ€¦";
    $kpi.className = "badge";
  }

  // Budget & approvals progression
  stagedSpend(t);

  // UI updates
  const meanOCV = totalV / N;
  const sumIuA = totalI * 1e6;
  sparkV.push(meanOCV); if(sparkV.length>120) sparkV.shift();
  sparkI.push(sumIuA);  if(sparkI.length>120) sparkI.shift();

  $vcap.textContent = `${vcap.toFixed(3)} V`;
  const pavg = p10Buffer.reduce((a,b)=>a+b,0)/Math.max(1,p10Buffer.length);
  $pavg.textContent = `${pavg.toFixed(1)} Î¼W`;

  $airT.textContent = `${airT.toFixed(1)} Â°C`;
  const avgSoilT = cells.reduce((a,c)=>a+c.soilT,0)/N;
  $soilT.textContent = `${avgSoilT.toFixed(1)} Â°C`;
  $moist.textContent = `${(avgMoist*100).toFixed(1)} % VWC`;
  const avgORP = cells.reduce((a,c)=>a+c.orp,0)/N;
  $orp.textContent = `${avgORP.toFixed(0)} mV`;

  const capPct = clamp(vcap / V_TARGET, 0, 1);
  $capProg.style.width = `${capPct*100}%`;
  $capVbar.firstElementChild ? null : null;
  $capVbar.style.setProperty("--cap", capPct*100);
  $capVbar.firstElementChild?.style?.setProperty("height", `${capPct*100}%`);
  $capVbar.querySelector("i").style.height = `${capPct*100}%`;

  // budget ui
  $budget.textContent = `$${spend} / $2000`;
  $budgetProg.style.width = `${(spend/2000)*100}%`;

  drawField(); refreshTooltips();
  drawSpark("sparkV", sparkV, 0.02, 0.7);
  drawSpark("sparkI", sparkI, 0, 300);
}

// Sparklines
function drawSpark(id, data, ymin, ymax){
  const c = el(id); const ctx = c.getContext("2d");
  const w = c.width = c.clientWidth * devicePixelRatio;
  const h = c.height = c.clientHeight * devicePixelRatio;
  ctx.clearRect(0,0,w,h);
  ctx.lineWidth = 2 * devicePixelRatio;
  ctx.strokeStyle = "#2563eb";
  ctx.beginPath();
  const n = data.length;
  if(n===0) return;
  for(let i=0;i<n;i++){
    const x = (i/(n-1))* (w-8) + 4;
    const val = clamp((data[i]-ymin)/(ymax-ymin), 0, 1);
    const y = (1-val)*(h-8) + 4;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
}

// Data export (last 15 minutes)
el("exportBtn").addEventListener("click", ()=>{
  const now = new Date();
  const rows = [];
  // capture last 15 ticks (minutes)
  const span = 15;
  for(let back=span-1; back>=0; back--){
    const stamp = new Date(now.getTime() - back*60000).toISOString();
    cells.forEach(c=>{
      rows.push([stamp,"nodeA",`cell-${c.id+1}`,"OCV", c.ocv.toFixed(4), "V"].join(","));
      rows.push([stamp,"nodeA",`cell-${c.id+1}`,"I", (c.current).toExponential(4), "A"].join(","));
      rows.push([stamp,"nodeA",`cell-${c.id+1}`,"ORP", c.orp.toFixed(1), "mV"].join(","));
      rows.push([stamp,"nodeA",`cell-${c.id+1}`,"Moisture", (c.moisture*100).toFixed(2), "%"].join(","));
    });
  }
  const csv = "timestamp,node_id,electrode_id,channel,value,unit\n" + rows.join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "microbial_power_field_15min.csv";
  document.body.appendChild(a); a.click(); a.remove();
});

// Initial narrative
function prologue(){
  log("Mechanical Wax","Frame anchored; sleeves at 12 cm depth, spacing verified Â±5 mm.","ok");
  log("Fabrication Wax","Graphite and carbon cloth tail-crimps test at â‰¤50 mÎ© contact.","ok");
  log("Electrical Wax","Low-noise junction online; precision shunts inserted (1kÎ© line).","ok");
  log("Data Wax","Schema registered; sampling at 1/min; time sync via NTP.","ok");
  log("Hydrological Wax","Initial moisture band established; irrigation armed.","warn");
  log("Biological Monitoring Wax","Baseline respiration and ORP survey scheduled.","ok");
  log("Software/Control Wax","Shunt scheduler loaded; watchdog set.","ok");
}

// Bootstrap
buildRoster();
drawField();
prologue();

// Time loop
let timer = setInterval(step, TICK_MS);

// Accessibility: stop/start with keyboard "s"
window.addEventListener("keydown",(e)=>{
  if(e.key.toLowerCase()==="s"){
    if(timer){ clearInterval(timer); timer=null; log("Software/Control Wax","Scheduler paused by operator.","warn");}
    else{ timer=setInterval(step, TICK_MS); log("Software/Control Wax","Scheduler resumed.","ok");}
  }
});

// Cap bar init child element
const ib = document.createElement("i"); el("capVbar").appendChild(ib);

// Approvals update UI loop
setInterval(()=>{
  el("sops").textContent = approvals.sop ? "SOP posted" : "Pending";
  el("sops").className  = approvals.sop ? "badge ok" : "badge muted";
  el("signoff").textContent = approvals.sign ? "Sign-off complete" : "Pending";
  el("signoff").className  = approvals.sign ? "badge ok" : "badge muted";
}, 1000);
</script>
</body>
</html>
