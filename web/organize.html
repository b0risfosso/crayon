<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Organize conversations</title>
  <style>
    body{font-family:sans-serif;max-width:900px;margin:40px auto}
    select,button,textarea{margin:4px 0;padding:4px}
    textarea{width:100%;min-height:70px}
    pre{white-space:pre-wrap;background:#f8f8f8;padding:4px;border:1px solid #ccc}
    .panel{border:1px solid #ddd;padding:12px;margin:12px 0}
  </style>
</head>
<body>
  <nav>
    <a href="prompt.html">Prompt</a> |
    <a href="history.html">History</a> |
    <a href="organize.html">Organize</a>
  </nav>

  <h2>Organize conversations</h2>
  <div id="status"></div>

  <!-- Move panel -->
  <div class="panel">
    <h3>Move</h3>
    <label>Child:
      <select id="mv-child"></select>
    </label>
    <label>New parent:
      <select id="mv-parent"><option value="">(root)</option></select>
    </label>
    <button onclick="move()">Move</button>
  </div>

  <!-- Edit panel -->
  <div class="panel">
    <h3>Edit</h3>
    <label>Choose conversation:
      <select id="ed-id" onchange="fillEdit()"></select>
    </label>
    <br>System:<br><textarea id="ed-sys"></textarea>
    <br>User:<br><textarea id="ed-user"></textarea>
    <br>Answer:<br><textarea id="ed-ans"></textarea>
    <button onclick="saveEdit()">Save</button>
  </div>

  <!-- Delete panel -->
  <div class="panel">
    <h3>Delete</h3>
    <label>Conversation:
      <select id="del-id"></select>
    </label>
    <button style="color:red" onclick="del()">Delete</button>
  </div>

<script>
let cache=[];

async function fetchHistory(){
  const r=await fetch('/api/history');
  cache=await r.json();
}

function renderSelect(sel,idKey='id',txtKey='user',prependBlank=false){
  sel.innerHTML='';
  if(prependBlank) sel.insertAdjacentHTML('beforeend','<option value=""></option>');
  cache.forEach(x=>{
    const txt = x[txtKey].slice(0,60).replace(/</g,'&lt;');
    sel.insertAdjacentHTML('beforeend',`<option value="${x[idKey]}">${txt}</option>`);
  });
}

async function reloadUI(){
  await fetchHistory();
  ['mv-child','mv-parent','ed-id','del-id'].forEach(id=>{
    renderSelect(document.getElementById(id), 'id','user', id==='mv-parent');
  });
  fillEdit();
}

async function move(){
  const id=document.getElementById('mv-child').value;
  const parent=document.getElementById('mv-parent').value||null;
  if(!id){alert('select child');return;}
  const r=await fetch('/api/reparent',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,parent})});
  document.getElementById('status').textContent=await r.text();
  reloadUI();
}

function fillEdit(){
  const sel=document.getElementById('ed-id');
  const item=cache.find(x=>x.id===sel.value);
  ['ed-sys','ed-user','ed-ans'].forEach(id=>document.getElementById(id).value=item?item[{0:'system',1:'user',2:'answer'}[id.split('-')[1]==='sys'?0:id.split('-')[1]==='user'?1:2]]:'');
}

async function saveEdit(){
  const id=document.getElementById('ed-id').value;
  if(!id){alert('choose conversation');return;}
  const body={
    id,
    system:document.getElementById('ed-sys').value,
    user  :document.getElementById('ed-user').value,
    answer:document.getElementById('ed-ans').value
  };
  const r=await fetch('/api/edit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  document.getElementById('status').textContent=await r.text();
  reloadUI();
}

async function del(){
  const id=document.getElementById('del-id').value;
  if(!id){alert('choose conversation');return;}
  if(!confirm('Delete this conversation?'))return;
  const r=await fetch('/api/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
  document.getElementById('status').textContent=await r.text();
  reloadUI();
}

reloadUI();
</script>
</body>
</html>
