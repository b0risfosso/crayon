<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Story</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, sans-serif; background: #f7f7f7; color: #111; }
    main { max-width: 1100px; margin: 0 auto; padding: 24px 18px 48px; }
    header { display: flex; justify-content: space-between; align-items: baseline; gap: 12px; margin-bottom: 16px; }
    h1 { margin: 0; font-size: 22px; }
    .muted { color: #666; font-size: 13px; }
    .card { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; padding: 14px 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); }
    .stack { display: grid; grid-template-columns: 1fr; gap: 12px; }
    pre { white-space: pre-wrap; margin: 0; line-height: 1.6; }
    .grid-2 { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px) {
      .grid-2 { grid-template-columns: 1fr 1fr; }
    }
    .scroll-box {
      max-height: 240px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <main>
    <header>
      <div>
        <h1>Story</h1>
        <div id="meta" class="muted"></div>
      </div>
      <div class="muted" id="status"></div>
    </header>

    <section class="stack">
      <div class="card">
        <div class="muted">Art</div>
        <pre id="artText">Loading art...</pre>
      </div>
      <div class="card">
        <div class="muted">Color</div>
        <pre id="colorText" class="scroll-box">Loading color...</pre>
      </div>
    </section>

    <section class="grid-2" style="margin-top:14px;">
      <div class="card">
        <div class="muted">Story</div>
        <pre id="storyText" class="scroll-box">Loading story...</pre>
      </div>
      <div class="card">
        <div class="muted">Sources</div>
        <pre id="sourcesText" class="scroll-box">Loading sources...</pre>
      </div>
    </section>

    <section class="card" style="margin-top:14px;">
      <div class="muted">Notes</div>
      <div class="row" style="margin-top:8px;">
        <textarea id="noteInput" placeholder="Add a note..."></textarea>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="saveNoteBtn" type="button">Save note</button>
        <div id="noteStatus" class="muted"></div>
      </div>
      <div id="notesList" class="stack scroll-box" style="margin-top:8px;"></div>
    </section>
  </main>

  <script>
    const params = new URLSearchParams(window.location.search);
    const runId = parseInt(params.get("run_id") || "", 10);

    const metaEl = document.getElementById("meta");
    const statusEl = document.getElementById("status");
    const artText = document.getElementById("artText");
    const colorText = document.getElementById("colorText");
    const storyText = document.getElementById("storyText");
    const sourcesText = document.getElementById("sourcesText");
    const noteInput = document.getElementById("noteInput");
    const saveNoteBtn = document.getElementById("saveNoteBtn");
    const noteStatus = document.getElementById("noteStatus");
    const notesList = document.getElementById("notesList");

    if (!runId) {
      statusEl.textContent = "Missing run_id.";
      artText.textContent = "Missing run_id.";
      colorText.textContent = "Missing run_id.";
      storyText.textContent = "Missing run_id.";
      sourcesText.textContent = "Missing run_id.";
    } else {
      loadStory();
    }

    async function loadStory() {
      statusEl.textContent = "Loading...";
      try {
        const res = await fetch(`/oasis/story/runs/${runId}`);
        if (!res.ok) throw new Error("Failed to load story run");
        const run = await res.json();

        metaEl.textContent = `story ${run.id} · art ${run.art_id} · color ${run.color_id} · ${run.entity_title || "Entity"} · ${run.prompt_type || "connection"} · ${run.created_at || ""}`;

        storyText.textContent = run.story_text || "";
        sourcesText.textContent = run.sources_text || "";

        await Promise.all([
          loadArt(run.art_id),
          loadColor(run.color_id),
          loadNotes(),
        ]);

        statusEl.textContent = "";
      } catch (err) {
        statusEl.textContent = err.message || "Failed to load.";
      }
    }

    saveNoteBtn.addEventListener("click", async () => {
      const text = noteInput.value.trim();
      if (!text) {
        noteStatus.textContent = "Enter a note first.";
        return;
      }
      noteStatus.textContent = "Saving...";
      try {
        const res = await fetch(`/oasis/story/runs/${encodeURIComponent(runId)}/notes`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ note_text: text })
        });
        if (!res.ok) {
          const msg = await res.text();
          throw new Error(msg || "Failed to save note");
        }
        noteInput.value = "";
        noteStatus.textContent = "Saved.";
        await loadNotes();
      } catch (err) {
        noteStatus.textContent = err.message || "Failed to save note.";
      }
    });

    async function loadNotes() {
      notesList.textContent = "Loading notes...";
      try {
        const res = await fetch(`/oasis/story/runs/${encodeURIComponent(runId)}/notes`);
        if (!res.ok) throw new Error("Failed to load notes");
        const rows = await res.json();
        renderNotes(Array.isArray(rows) ? rows : []);
      } catch (err) {
        notesList.textContent = err.message || "Could not load notes.";
      }
    }

    function renderNotes(rows) {
      notesList.innerHTML = "";
      if (!rows.length) {
        notesList.innerHTML = '<div class="muted">No notes yet.</div>';
        return;
      }
      rows.forEach((row) => {
        const card = document.createElement("div");
        card.className = "card";
        const meta = document.createElement("div");
        meta.className = "muted";
        meta.textContent = row.created_at || "";
        const body = document.createElement("pre");
        body.textContent = row.note_text || "";

        const actions = document.createElement("div");
        actions.className = "row";
        actions.style.marginTop = "6px";

        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.textContent = "Edit";
        editBtn.onclick = async () => {
          const next = prompt("Edit note:", row.note_text || "");
          if (next === null) return;
          const trimmed = next.trim();
          if (!trimmed) {
            alert("Note cannot be empty.");
            return;
          }
          try {
            const res = await fetch(`/oasis/story/notes/${encodeURIComponent(row.id)}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ note_text: trimmed })
            });
            if (!res.ok) {
              const msg = await res.text();
              throw new Error(msg || "Failed to update note");
            }
            await loadNotes();
          } catch (err) {
            alert(err.message || "Failed to update note.");
          }
        };

        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = async () => {
          if (!confirm("Delete this note?")) return;
          try {
            const res = await fetch(`/oasis/story/notes/${encodeURIComponent(row.id)}`, {
              method: "DELETE"
            });
            if (!res.ok) {
              const msg = await res.text();
              throw new Error(msg || "Failed to delete note");
            }
            await loadNotes();
          } catch (err) {
            alert(err.message || "Failed to delete note.");
          }
        };

        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);

        card.appendChild(meta);
        card.appendChild(body);
        card.appendChild(actions);
        notesList.appendChild(card);
      });
    }
    async function loadArt(id) {
      try {
        const res = await fetch(`/art/api/art/${encodeURIComponent(id)}`);
        if (!res.ok) throw new Error("Failed to load art");
        const data = await res.json();
        artText.textContent = data.art || "";
      } catch (err) {
        artText.textContent = err.message || "Failed to load art.";
      }
    }

    async function loadColor(id) {
      try {
        const res = await fetch(`/colors/${encodeURIComponent(id)}`);
        if (!res.ok) throw new Error("Failed to load color");
        const data = await res.json();
        colorText.textContent = data.output_text || "";
      } catch (err) {
        colorText.textContent = err.message || "Failed to load color.";
      }
    }
  </script>
</body>
</html>
