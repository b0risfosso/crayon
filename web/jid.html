<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fantasiagenesis · JID Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      color-scheme: light;
      --bg:#f8f9fb;
      --panel:#ffffff;
      --elev:#ffffff;
      --text:#1b1e23;
      --muted:#5b626e;
      --accent:#2b6ef7;
      --border:#dce1ea;
      --ok:#2ecc71;
      --warn:#f1c40f;
      --err:#e74c3c;
    }
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:14px/1.45 system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    }
    header{
      grid-column:1/-1;
      padding:14px 18px;
      border-bottom:1px solid var(--border);
      background:#fdfdfd;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    h1{margin:0;font-size:18px;font-weight:600;}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .wrap{display:grid;grid-template-columns:280px 1fr;gap:16px;height:calc(100% - 70px);}
    aside{
      border-right:1px solid var(--border);
      padding:14px;
      overflow:auto;
      background:var(--panel);
    }
    main{padding:14px;overflow:auto;background:var(--bg);}
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row>*{flex:0 0 auto}
    input,select,button{
      background:#fff;
      border:1px solid var(--border);
      color:var(--text);
      padding:8px 10px;
      border-radius:8px;
      font-size:13px;
      outline:none;
    }
    input:focus,select:focus{border-color:var(--accent)}
    button{cursor:pointer;background:var(--accent);color:#fff;border:none}
    button:hover{opacity:0.9}
    .pill{
      display:inline-flex;gap:6px;align-items:center;
      background:#f3f6ff;border:1px solid #ccd8ff;
      padding:5px 10px;border-radius:999px;color:#345;
      font-size:12px
    }
    .list{margin-top:10px;display:flex;flex-direction:column;gap:6px}
    .file{
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:8px;
      background:#fff;
      cursor:pointer;
      transition:background .15s;
    }
    .file:hover{background:#f3f6ff}
    .file.active{border-color:var(--accent);background:#eaf1ff}
    .hint{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr 2fr 1.5fr 140px;gap:10px;align-items:start}
    .thead{
      position:sticky;top:0;background:#f8f9fb;
      padding:8px 6px;border-bottom:1px solid var(--border);z-index:2;
      font-weight:600;font-size:13px;color:var(--muted);
    }
    .cell{padding:8px 6px;border-bottom:1px solid var(--border)}
    .title{font-weight:600;color:#111}
    .desc,.hi{color:#333}
    .muted{color:var(--muted)}
    .empty{
      padding:18px;border:1px dashed var(--border);
      border-radius:10px;color:var(--muted);
      text-align:center;background:#fff;
    }
    .badge{
      display:inline-block;padding:3px 9px;border-radius:999px;
      border:1px solid var(--border);
      background:#f4f7fd;color:#333;font-size:11px
    }
    .stats{display:flex;gap:10px;flex-wrap:wrap}
    a{color:var(--accent);text-decoration:none}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <header>
    <h1>Fantasiagenesis · JID Viewer</h1>
    <div class="sub">Explore processed documents and generated fantasia cores.</div>
  </header>

  <div class="wrap">
    <aside>
      <div class="card">
        <div class="row" style="margin-bottom:8px">
          <strong>Files</strong>
          <span class="pill" id="fileCount">0 files</span>
          <button class="right" id="refreshFiles">Refresh</button>
        </div>
        <input id="fileFilter" type="text" placeholder="Filter files…" />
        <div class="list" id="fileList"></div>
        <div class="hint">
          This calls <code>/jid/files</code>.  
          Implement in Flask to list distinct file names from <code>jid.db</code>.
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Filters</strong>
        <input id="searchText" type="text" placeholder="Search text…" style="margin-top:8px;width:100%"/>
        <div class="row" style="margin-top:8px">
          <label class="muted">Limit</label>
          <select id="limit">
            <option>100</option><option selected>250</option><option>500</option><option>1000</option>
          </select>
          <label class="muted">Sort</label>
          <select id="sortBy">
            <option value="new">Newest</option>
            <option value="old">Oldest</option>
            <option value="title">Title A–Z</option>
          </select>
        </div>
        <button style="margin-top:10px" id="applyFilters">Apply</button>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Status</strong>
        <div id="status" class="hint">Idle.</div>
      </div>
    </aside>

    <main>
      <div class="card" style="margin-bottom:12px">
        <div class="stats">
          <span class="badge" id="statTotal">0 items</span>
          <span class="badge" id="statFiles">0 files</span>
          <span class="badge" id="statDate">—</span>
        </div>
      </div>

      <div class="card">
        <div class="grid thead">
          <div>Title</div><div>Description</div><div>Rationale</div><div>Created</div>
        </div>
        <div id="rows"></div>
        <div id="empty" class="empty" style="display:none">
          No items found. Try refreshing or clearing filters.
        </div>
      </div>
    </main>
  </div>

  <script>
    const el=id=>document.getElementById(id);
    const fileList=el('fileList'),fileFilter=el('fileFilter'),
          refreshFiles=el('refreshFiles'),searchText=el('searchText'),
          limitSel=el('limit'),sortBySel=el('sortBy'),
          applyFilters=el('applyFilters'),rows=el('rows'),
          empty=el('empty'),status=el('status'),
          statTotal=el('statTotal'),statFiles=el('statFiles'),
          statDate=el('statDate'),fileCount=el('fileCount');
    let files=[],activeFile=null,items=[];
    function setStatus(msg){status.textContent=msg;}
    function fmtDate(s){try{const d=new Date(s);if(isNaN(d))return s;return d.toLocaleString();}catch{return s;}}
    function escapeHtml(s){return String(s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
    function renderFiles(){
      const q=fileFilter.value.toLowerCase().trim();
      fileList.innerHTML="";let vis=0;
      files.filter(f=>!q||f.toLowerCase().includes(q))
        .sort((a,b)=>a.localeCompare(b))
        .forEach(name=>{
          const div=document.createElement('div');
          div.className='file'+(name===activeFile?' active':'');
          div.textContent=name;
          div.onclick=()=>{activeFile=name;renderFiles();fetchItems();};
          fileList.appendChild(div);vis++;
        });
      fileCount.textContent=`${vis} files`;
    }
    function renderItems(){
      rows.innerHTML="";
      if(!items.length){empty.style.display='block';statTotal.textContent='0 items';return;}
      empty.style.display='none';
      statTotal.textContent=`${items.length} items`;
      for(const it of items){
        const row=document.createElement('div');
        row.className='grid';
        row.innerHTML=`
          <div class="cell title">${escapeHtml(it.title)}</div>
          <div class="cell desc">${escapeHtml(it.description)}</div>
          <div class="cell hi">${escapeHtml(it.rationale)}</div>
          <div class="cell muted">${escapeHtml(fmtDate(it.created_at))}</div>`;
        rows.appendChild(row);
      }
    }
    function applyClientFilters(raw){
      const q=searchText.value.toLowerCase().trim();
      let list=raw.slice();
      const sortBy=sortBySel.value;
      list.sort((a,b)=>{
        if(sortBy==='new')return(b.created_at||'').localeCompare(a.created_at||'');
        if(sortBy==='old')return(a.created_at||'').localeCompare(b.created_at||'');
        if(sortBy==='title')return(a.title||'').localeCompare(b.title||'');return 0;
      });
      if(q){list=list.filter(it=>(it.title||'').toLowerCase().includes(q)||(it.description||'').toLowerCase().includes(q)||(it.rationale||'').toLowerCase().includes(q));}
      const lim=parseInt(limitSel.value||"250",10);
      return list.slice(0,lim);
    }
    async function fetchFiles(){
      setStatus("Loading files…");
      try{
        const r=await fetch('/jid/files');
        if(!r.ok)throw new Error(r.status);
        files=await r.json();if(!Array.isArray(files))files=[];
        renderFiles();if(!activeFile&&files.length){activeFile=files[0];renderFiles();}
        setStatus(`Loaded ${files.length} files.`);
      }catch(e){
        files=[];renderFiles();
        setStatus("Cannot load /jid/files. Add that endpoint in Flask.");
      }
    }
    async function fetchItems(){
      setStatus("Loading fantasia cores…");
      try{
        const params=new URLSearchParams();
        if(activeFile)params.set('file_name',activeFile);
        params.set('limit',limitSel.value);
        const r=await fetch(`/jid/fantasias?${params.toString()}`);
        if(!r.ok)throw new Error(r.status);
        const raw=await r.json();items=applyClientFilters(raw);renderItems();
        setStatus(`Loaded ${items.length} fantasia cores.`);
      }catch(e){
        items=[];renderItems();setStatus("Cannot load /jid/fantasias. Add that endpoint in Flask.");
      }
    }
    refreshFiles.onclick=()=>fetchFiles().then(fetchItems);
    fileFilter.oninput=()=>renderFiles();
    applyFilters.onclick=()=>fetchItems();
    searchText.addEventListener('keydown',e=>{if(e.key==='Enter')fetchItems();});
    fetchFiles().then(fetchItems);
  </script>
</body>
</html>
