<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>jid · Writings · Visions · Fantasia Cores</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --ink: #222;
      --muted: #666;
      --accent: #0a7bd7;
      --line: #e6e6ef;
    }
    html, body { margin:0; padding:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--ink); }
    header { position: sticky; top:0; background: var(--card); border-bottom: 1px solid var(--line); z-index: 10; }
    .container { max-width: 1200px; margin: 0 auto; padding: 12px 16px; }
    h1 { font-size: 18px; margin: 8px 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 16px; margin-top: 12px; }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 10px; overflow: hidden; display:flex; flex-direction:column; min-height: 300px; }
    .card header { padding: 10px 12px; border-bottom: 1px solid var(--line); display:flex; gap:8px; align-items: center; }
    .card h2 { font-size: 15px; margin: 0; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; }
    input[type="text"], select { border: 1px solid var(--line); border-radius: 8px; padding: 7px 10px; font-size: 13px; background: #fff; color: var(--ink); }
    button { border:1px solid var(--line); background:#fff; color:var(--ink); padding:7px 12px; border-radius:8px; cursor:pointer; }
    button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .list { padding: 8px 10px; overflow:auto; flex:1; }
    .item { border-bottom:1px dashed var(--line); padding:8px 4px; }
    .item:last-child { border-bottom:0; }
    .small { color: var(--muted); font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:11px; color:var(--muted); }
    .muted { color: var(--muted); }
    .row { display:flex; gap:8px; align-items:center; }
    .break { word-break: break-word; }
    .doc { white-space: pre-wrap; line-height: 1.35; }
    .filters { display:flex; gap:8px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>jid dashboard · <span class="small">Writings · Visions · Fantasia Cores</span></h1>
    </div>
  </header>

  <main class="container">
    <div class="grid">

      <!-- Writings -->
      <section class="card" id="writings-card">
        <header>
          <h2>Writings</h2>
        </header>
        <div class="toolbar" style="padding:8px 10px;">
          <input id="w-q" type="text" placeholder="Search topic/description…" />
          <input id="w-limit" type="text" value="100" class="mono" style="width:70px" />
          <button id="w-refresh">Refresh</button>
        </div>
        <div class="list" id="writings-list" aria-live="polite"></div>
      </section>

      <!-- Visions -->
      <section class="card" id="visions-card">
        <header>
          <h2>Visions</h2>
        </header>
        <div class="toolbar" style="padding:8px 10px;">
          <button id="v-refresh">Refresh</button>
        </div>
        <div class="list" id="visions-list" aria-live="polite"></div>
      </section>

      <!-- Fantasia Cores -->
      <section class="card" id="cores-card">
        <header>
          <h2>Fantasia Cores</h2>
        </header>
        <div class="toolbar" style="padding:8px 10px;">
          <div class="filters">
            <input id="f-q" type="text" placeholder="Search title/description/rationale…" />
            <select id="f-file"></select>
            <select id="f-vision"></select>
            <input id="f-limit" type="text" value="200" class="mono" style="width:70px" />
            <button id="f-refresh">Refresh</button>
          </div>
        </div>
        <div class="list" id="cores-list" aria-live="polite"></div>
      </section>

    </div>

    <!-- Writing drawer -->
    <section class="card" id="writing-view" style="margin-top:16px; display:none;">
      <header>
        <h2 id="wv-title">Writing</h2>
        <div style="margin-left:auto"></div>
        <button id="wv-close">Close</button>
      </header>
      <div class="list" style="padding:12px 14px;">
        <div class="small" id="wv-meta"></div>
        <pre class="doc break" id="wv-doc"></pre>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = "/jid"; // nginx will proxy /jid/* → Flask

    const el = sel => document.querySelector(sel);
    const mk = (tag, attrs={}, children=[]) => {
      const n = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)) {
        if (k === "class") n.className = v;
        else if (k === "text") n.textContent = v;
        else n.setAttribute(k, v);
      }
      for (const c of children) n.appendChild(c);
      return n;
    };

    async function fetchJSON(url) {
      const res = await fetch(url, {headers: {"Accept":"application/json"}});
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }

    // Populate Files and Visions filters
    async function loadFiles() {
      try {
        const files = await fetchJSON(`${API_BASE}/files`);
        const sel = el("#f-file");
        sel.innerHTML = "";
        sel.appendChild(new Option("All files", ""));
        for (const f of files) sel.appendChild(new Option(f, f));
      } catch (e) { console.error(e); }
    }
    async function loadVisions() {
      try {
        const visions = await fetchJSON(`${API_BASE}/visions`);
        const sel = el("#f-vision");
        sel.innerHTML = "";
        sel.appendChild(new Option("All visions", ""));
        for (const v of visions) sel.appendChild(new Option(v, v));
        // also fill the Visions panel list
        const list = el("#visions-list");
        list.innerHTML = "";
        visions.forEach(v => {
          const item = mk("div", {class:"item"}, [
            mk("div", {text: v}),
          ]);
          list.appendChild(item);
        });
      } catch (e) { console.error(e); }
    }

    // Load Writings list (no doc)
    async function loadWritings() {
      const q = encodeURIComponent(el("#w-q").value.trim());
      const limit = encodeURIComponent(el("#w-limit").value.trim() || "100");
      const url = `${API_BASE}/writings?limit=${limit}${q ? `&q=${q}` : ""}`;
      const list = el("#writings-list");
      list.innerHTML = "Loading…";
      try {
        const rows = await fetchJSON(url);
        list.innerHTML = "";
        rows.forEach(r => {
          const head = mk("div", {}, [
            mk("strong", {text: r.topic || "(untitled)"}),
            mk("span", {class:"small", style:"margin-left:8px;", text: `· ${r.created_at}`}),
          ]);
          const desc = mk("div", {class:"small break"}, []);
          desc.textContent = r.description || "";
          const meta = mk("div", {class:"small muted"}, []);
          meta.textContent = `id=${r.id} · model=${r.model || "?"} · run=${r.run_id || "-"}`;
          const btn = mk("button", {text:"Open", style:"margin-left:auto;"});
          const rowDiv = mk("div", {class:"row"});
          rowDiv.appendChild(head);
          rowDiv.appendChild(btn);
          const item = mk("div", {class:"item"}, [rowDiv, desc, meta]);
          btn.addEventListener("click", () => openWriting(r.id, r.topic, r.created_at, r.model, r.run_id));
          list.appendChild(item);
        });
      } catch (e) {
        list.innerHTML = `Error: ${e.message}`;
      }
    }

    // Load Fantasia cores with filters
    async function loadCores() {
      const q = encodeURIComponent(el("#f-q").value.trim());
      const file = encodeURIComponent(el("#f-file").value.trim());
      const vision = encodeURIComponent(el("#f-vision").value.trim());
      const limit = encodeURIComponent(el("#f-limit").value.trim() || "200");
      let url = `${API_BASE}/fantasias?limit=${limit}`;
      if (q) url += `&q=${q}`;
      if (file) url += `&file_name=${file}`;
      if (vision) url += `&vision=${vision}`;

      const list = el("#cores-list");
      list.innerHTML = "Loading…";
      try {
        const rows = await fetchJSON(url);
        list.innerHTML = "";
        rows.forEach(r => {
          const title = mk("div", {}, [
            mk("strong", {text: r.title}),
            r.vision ? mk("span", {class:"pill", style:"margin-left:8px;", text: r.vision}) : mk("span"),
          ]);
          const meta = mk("div", {class:"small muted"}, []);
          meta.textContent = `${r.file_name || "(no file)"} · ${r.created_at}`;
          const desc = mk("div", {class:"break small"}, []); desc.textContent = r.description || "";
          const rat = mk("div", {class:"break small muted"}, []); rat.textContent = r.rationale || "";
          const item = mk("div", {class:"item"}, [title, meta, desc, rat]);
          list.appendChild(item);
        });
      } catch (e) {
        list.innerHTML = `Error: ${e.message}`;
      }
    }

    // Open a single writing
    async function openWriting(id, topic, created_at, model, run_id) {
      const url = `${API_BASE}/writing/${encodeURIComponent(id)}`;
      const card = el("#writing-view");
      const title = el("#wv-title");
      const meta = el("#wv-meta");
      const doc = el("#wv-doc");
      title.textContent = topic || `Writing ${id}`;
      meta.textContent = `id=${id} · ${created_at} · model=${model || "?"} · run=${run_id || "-"}`;
      doc.textContent = "Loading…";
      card.style.display = "";
      try {
        const r = await fetchJSON(url);
        doc.textContent = r.document || "";
      } catch (e) {
        doc.textContent = `Error: ${e.message}`;
      }
    }

    // Close drawer
    el("#wv-close").addEventListener("click", () => {
      el("#writing-view").style.display = "none";
      el("#wv-doc").textContent = "";
    });

    // Wire up buttons
    el("#w-refresh").addEventListener("click", loadWritings);
    el("#v-refresh").addEventListener("click", loadVisions);
    el("#f-refresh").addEventListener("click", loadCores);

    // Initial load
    (async function init() {
      await loadFiles();
      await loadVisions();
      await loadWritings();
      await loadCores();
    })();
  </script>
</body>
</html>
