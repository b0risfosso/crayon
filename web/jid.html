<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>jid · Vision → Topics → Fantasia Cores</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#f7f7fb; --card:#fff; --ink:#222; --muted:#666; --accent:#0a7bd7; --line:#e6e6ef;
    }
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:12px 16px}
    h1{font-size:18px;margin:8px 0}
    .grid{display:grid;grid-template-columns:1fr 1.1fr 1.3fr;gap:16px;margin-top:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:10px;overflow:hidden;display:flex;flex-direction:column;min-height:300px}
    .card header{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center}
    .card h2{font-size:15px;margin:0}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:8px 10px}
    input[type="text"],select{border:1px solid var(--line);border-radius:8px;padding:7px 10px;font-size:13px;background:#fff;color:var(--ink)}
    button{border:1px solid var(--line);background:#fff;color:var(--ink);padding:7px 12px;border-radius:8px;cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .list{padding:8px 10px;overflow:auto;flex:1}
    .item{border-bottom:1px dashed var(--line);padding:8px 4px}
    .item:last-child{border-bottom:0}
    .small{color:var(--muted);font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:11px;color:var(--muted)}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center}
    .break{word-break:break-word}
    .doc{white-space:pre-wrap;line-height:1.35}
  </style>
</head>
<body>
<header>
  <div class="container">
    <h1>jid dashboard · <span class="small">Vision → Topics → Fantasia Cores</span></h1>
  </div>
</header>

<main class="container">
  <div class="grid">

    <!-- 1) Vision selector -->
    <section class="card" id="vision-card">
      <header>
        <h2>1. Select Vision</h2>
      </header>
      <div class="toolbar">
        <select id="vision-select" style="min-width:260px"></select>
        <button id="vision-refresh">Refresh</button>
      </div>
      <div class="list" id="vision-info">
        <div class="small muted">Pick a vision to filter topics and cores.</div>
      </div>
    </section>

    <!-- 2) Topics filtered by selected vision -->
    <section class="card" id="topics-card">
      <header>
        <h2>2. Topics for Vision</h2>
      </header>
      <div class="toolbar">
        <select id="topic-select" style="min-width:340px"></select>
        <input id="topic-search" type="text" placeholder="Search within these topics…" />
        <button id="topics-refresh">Refresh</button>
      </div>
      <div class="list" id="topics-list" aria-live="polite"></div>
    </section>

    <!-- 3) Fantasia cores constrained by (vision, writing) -->
    <section class="card" id="cores-card">
      <header>
        <h2>3. Fantasia Cores</h2>
      </header>
      <div class="toolbar">
        <input id="cores-search" type="text" placeholder="Search title/description/rationale…" />
        <input id="cores-limit" type="text" value="200" class="mono" style="width:70px" />
        <button id="cores-refresh">Refresh</button>
      </div>
      <div class="list" id="cores-list" aria-live="polite"></div>
    </section>

  </div>

  <!-- Writing drawer -->
  <section class="card" id="writing-view" style="margin-top:16px; display:none;">
    <header>
      <h2 id="wv-title">Writing</h2>
      <div style="margin-left:auto"></div>
      <button id="wv-close">Close</button>
    </header>
    <div class="list" style="padding:12px 14px;">
      <div class="small" id="wv-meta"></div>
      <pre class="doc break" id="wv-doc"></pre>
    </div>
  </section>
</main>

<script>
  const API_BASE = "/jid";

  const el = s => document.querySelector(s);
  const mk = (tag, attrs={}, children=[]) => {
    const n = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)) {
      if (k === "class") n.className = v;
      else if (k === "text") n.textContent = v;
      else n.setAttribute(k, v);
    }
    for (const c of children) n.appendChild(c);
    return n;
  };
  async function fetchJSON(url) {
    const res = await fetch(url, {headers: {"Accept":"application/json"}});
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    return res.json();
  }

  // ----- State -----
  let selectedVision = "";
  let selectedWritingId = null;
  let visionWritingIds = new Set();  // writing ids that have cores for selectedVision
  let cachedWritings = [];           // all writings (topic, id, etc.) loaded once for filtering

  // ----- Vision -----
  async function loadVisions() {
    const sel = el("#vision-select");
    sel.innerHTML = "<option>Loading…</option>";
    try {
        const visions = await fetchJSON(`/jid/visions?order=last_seen`);
        sel.innerHTML = "";
        sel.appendChild(new Option("— Choose a vision —", ""));
        visions.forEach(v => {
        const label = `${v.vision}  ·  ${v.core_count} cores  ·  last ${v.last_seen}`;
        const opt = new Option(label, v.vision);
        sel.appendChild(opt);
        });
    } catch (e) {
        sel.innerHTML = "";
        sel.appendChild(new Option(`Error: ${e.message}`, ""));
    }
    }


  async function onVisionChange() {
    selectedVision = el("#vision-select").value;
    el("#vision-info").innerHTML = selectedVision
      ? `<div class="small">Vision: <span class="pill">${selectedVision}</span></div>`
      : `<div class="small muted">Pick a vision to filter topics and cores.</div>`;

    // Reset downstream selections
    selectedWritingId = null;
    el("#topic-select").innerHTML = "";
    el("#topics-list").innerHTML = "";
    el("#cores-list").innerHTML = "";

    if (!selectedVision) return;

    // 1) Get all cores for this vision (to discover which writings are relevant)
    const cores = await fetchJSON(`${API_BASE}/fantasias?vision=${encodeURIComponent(selectedVision)}&limit=5000`);
    visionWritingIds = new Set(
      cores
        .map(r => (r.file_name || ""))
        .filter(fn => fn.startsWith("writing#"))
        .map(fn => parseInt(fn.replace("writing#", ""), 10))
        .filter(n => Number.isFinite(n))
    );

    // 2) Ensure we have all writings cached (so we can filter locally)
    if (cachedWritings.length === 0) {
      // biggish pull once; adjust if needed
      cachedWritings = await fetchJSON(`${API_BASE}/writings?limit=10000`);
    }

    // 3) Populate topic select with writings that appear in cores for this vision
    const relevant = cachedWritings.filter(w => visionWritingIds.has(w.id));
    const sel = el("#topic-select");
    sel.innerHTML = "";
    sel.appendChild(new Option("— Choose a topic —", ""));
    relevant.forEach(w => {
      const label = `${w.topic || "(untitled)"}  ·  #${w.id}`;
      sel.appendChild(new Option(label, String(w.id)));
    });

    // 4) Render the topic list (same relevant set)
    renderTopicList(relevant);
    // 5) Show cores for the vision only (until a topic is chosen)
    await loadCoresForCurrentFilters();
  }

  // ----- Topics -----
  function renderTopicList(rows) {
    const q = (el("#topic-search").value || "").toLowerCase();
    const list = el("#topics-list");
    list.innerHTML = "";
    rows
      .filter(w =>
        !q ||
        (w.topic && w.topic.toLowerCase().includes(q)) ||
        (w.description && w.description.toLowerCase().includes(q))
      )
      .forEach(r => {
        const head = mk("div", {}, [
          mk("strong", {text: r.topic || "(untitled)"}),
          mk("span", {class:"small", style:"margin-left:8px;", text: `· ${r.created_at}`}),
          mk("span", {class:"pill", style:"margin-left:8px;", text: `#${r.id}`})
        ]);
        const desc = mk("div", {class:"small break"}, []); desc.textContent = r.description || "";
        const meta = mk("div", {class:"small muted"}, []);
        meta.textContent = `model=${r.model || "?"} · run=${r.run_id || "-"}`;
        const rowDiv = mk("div", {class:"row"});
        const openBtn = mk("button", {text:"Open", style:"margin-left:auto;"});
        rowDiv.appendChild(head); rowDiv.appendChild(openBtn);
        const item = mk("div", {class:"item"}, [rowDiv, desc, meta]);
        openBtn.addEventListener("click", () => openWriting(r.id, r.topic, r.created_at, r.model, r.run_id));
        item.addEventListener("click", () => {
          selectedWritingId = r.id;
          el("#topic-select").value = String(r.id);
          loadCoresForCurrentFilters();
        });
        list.appendChild(item);
      });
    if (!list.children.length) list.innerHTML = `<div class="small muted">No topics match.</div>`;
  }

  async function onTopicSelectChange() {
    const val = el("#topic-select").value.trim();
    selectedWritingId = val ? parseInt(val, 10) : null;
    await loadCoresForCurrentFilters();
  }

  // ----- Cores (filtered by vision and optional writing) -----
  async function loadCoresForCurrentFilters() {
    const list = el("#cores-list");
    list.innerHTML = "Loading…";

    if (!selectedVision) {
      list.innerHTML = `<div class="small muted">Select a vision to view cores.</div>`;
      return;
    }

    const q = encodeURIComponent(el("#cores-search").value.trim());
    const limit = encodeURIComponent(el("#cores-limit").value.trim() || "200");

    // Always filter by vision
    let url = `${API_BASE}/fantasias?vision=${encodeURIComponent(selectedVision)}&limit=${limit}`;
    if (q) url += `&q=${q}`;

    // If a topic (writing) is selected, constrain file_name to writing#<id>
    if (selectedWritingId != null) {
      const fileName = encodeURIComponent(`writing#${selectedWritingId}`);
      url += `&file_name=${fileName}`;
    }

    try {
      const rows = await fetchJSON(url);
      list.innerHTML = "";
      rows.forEach(r => {
        // outer item
        const item = mk("div", {class:"item"});
        item.dataset.coreId = r.id;  // store core.id on the DOM node (future-click use)

        // title row: title, [vision pill], [#id]
        const title = mk("div", {class:"row"}, [
            mk("strong", {text: r.title || `Core ${r.id}`}),
            // vision pill (if any)
            r.vision
            
            ? mk("span", {
                class:"pill",
                style:"margin-left:8px;",
                text: r.vision
                })
            : mk("span"),
            // id pill (always show)
            mk("span", {
            class:"pill mono",
            style:"margin-left:8px;",
            text: `#${r.id}`
            })
        ]);

        // meta line: file_name · created_at
        const meta = mk("div", {class:"small muted"});
        meta.textContent = `${r.file_name || "(no file)"} · ${r.created_at}`;

        // description
        const desc = mk("div", {class:"break small"});
        desc.textContent = r.description || "";

        // rationale
        const rat  = mk("div", {class:"break small muted"});
        rat.textContent = r.rationale || "";

        // assemble
        item.appendChild(title);
        item.appendChild(meta);
        item.appendChild(desc);
        item.appendChild(rat);

        list.appendChild(item);
        });

      if (!rows.length) list.innerHTML = `<div class="small muted">No fantasia cores for the current selection.</div>`;
    } catch (e) {
      list.innerHTML = `Error: ${e.message}`;
    }
  }

  // ----- Writing drawer -----
  async function openWriting(id, topic, created_at, model, run_id) {
    const url = `${API_BASE}/writing/${encodeURIComponent(id)}`;
    const card = el("#writing-view");
    el("#wv-title").textContent = topic || `Writing ${id}`;
    el("#wv-meta").textContent = `id=${id} · ${created_at} · model=${model || "?"} · run=${run_id || "-"}`;
    el("#wv-doc").textContent = "Loading…";
    card.style.display = "";
    try {
      const r = await fetchJSON(url);
      el("#wv-doc").textContent = r.document || "";
    } catch (e) {
      el("#wv-doc").textContent = `Error: ${e.message}`;
    }
  }
  el("#wv-close").addEventListener("click", () => {
    el("#writing-view").style.display = "none";
    el("#wv-doc").textContent = "";
  });

  // ----- Wire up -----
  el("#vision-refresh").addEventListener("click", loadVisions);
  el("#vision-select").addEventListener("change", onVisionChange);

  el("#topics-refresh").addEventListener("click", onVisionChange);
  el("#topic-search").addEventListener("input", () => {
    // live filter within the already-relevant topics
    const relevant = cachedWritings.filter(w => visionWritingIds.has(w.id));
    renderTopicList(relevant);
  });
  el("#topic-select").addEventListener("change", onTopicSelectChange);

  el("#cores-refresh").addEventListener("click", loadCoresForCurrentFilters);
  el("#cores-search").addEventListener("input", loadCoresForCurrentFilters);

  // ----- Init -----
  (async function init(){
    await loadVisions();
    // keep topics/cores empty until a vision is chosen
  })();
</script>
</body>
</html>
