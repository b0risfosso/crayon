<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Architectures</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{color-scheme:light dark;}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:Canvas;color:CanvasText}
    header{padding:14px 18px;border-bottom:1px solid rgb(0 0 0 / .08);position:sticky;top:0;background:Canvas;z-index:2}
    h1{margin:0;font-size:clamp(1.05rem,2vw,1.25rem)}
    .sub{opacity:.8;margin-top:.25rem;font-size:.95rem}
    main{display:grid;grid-template-columns:260px 1fr;gap:0;min-height:calc(100vh - 78px)}
    nav{border-right:1px solid rgb(0 0 0 / .08);padding:12px 10px;position:sticky;top:78px;align-self:start;height:calc(100vh - 78px);overflow:auto}
    nav .title{font-weight:600;margin:6px 8px 10px 8px;font-size:.95rem}
    .toc{list-style:none;margin:0;padding:0}
    .toc li{margin:0}
    .toc a{display:block;padding:8px 10px;border-radius:8px;text-decoration:none;color:inherit}
    .toc a:hover{background:rgb(0 0 0 / .06)}
    .toc a.active{background:#0b5cff;color:white}
    section{padding:18px 18px 36px 18px;border-bottom:1px solid rgb(0 0 0 / .06)}
    .toolbar{display:flex;gap:.5rem;align-items:center;margin:6px 0 10px 0}
    button{padding:.45rem .7rem;border:0;border-radius:.5rem;background:#0b5cff;color:#fff;cursor:pointer}
    button.secondary{background:#4b5563}
    pre{margin:0;padding:14px;border:1px solid rgb(0 0 0 / .12);border-radius:12px;overflow:auto;white-space:pre-wrap;word-wrap:break-word;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:.92rem;line-height:1.4;background:rgb(255 255 255 / .6)}
    .muted{opacity:.8}
    .meta{font-size:.85rem;opacity:.8;margin-left:8px}
    .actions{margin-left:auto;display:flex;gap:.5rem}
    .top-actions{display:flex;gap:.5rem;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <h1 id="pageTitle">Architectures</h1>
    <div id="pageSubtitle" class="sub muted"></div>
    <div class="top-actions" style="padding:0 2px;">
      <button id="downloadAll" class="secondary">Download all (.txt)</button>
      <button id="copyAll">Copy all</button>
    </div>
  </header>
  <main>
    <nav>
      <div class="title">Architectures</div>
      <ul id="toc" class="toc"></ul>
    </nav>
    <div id="content"></div>
  </main>

  <script>
  const S = {
    data: { pictureTitle: 'Picture', items: [] }
  };

  function setPage({pictureTitle, items}){
    S.data.pictureTitle = pictureTitle || 'Picture';
    S.data.items = Array.isArray(items) ? items : [];
    document.getElementById('pageTitle').textContent = pictureTitle || 'Architectures';
    const kinds = [...new Set(S.data.items.map(x => x.meta?.collection).filter(Boolean))].join(', ');
    document.getElementById('pageSubtitle').textContent = kinds ? `Collections: ${kinds}` : '';

    // TOC
    const toc = document.getElementById('toc');
    toc.innerHTML = '';
    S.data.items.forEach((it, idx) => {
      const id = `arch-${idx}`;
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = `#${id}`;
      a.textContent = it.title || `Architecture ${idx+1}`;
      a.addEventListener('click', () => {
        document.querySelectorAll('.toc a').forEach(x => x.classList.remove('active'));
        a.classList.add('active');
      });
      if (idx === 0) a.classList.add('active');
      li.appendChild(a);
      toc.appendChild(li);
    });

    // Content
    const content = document.getElementById('content');
    content.innerHTML = '';
    S.data.items.forEach((it, idx) => {
      const id = `arch-${idx}`;
      const sec = document.createElement('section');
      sec.id = id;

      const h2 = document.createElement('h2');
      h2.textContent = it.title || `Architecture ${idx+1}`;
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = [
        it.subtitle || '',
        it.meta?.collection ? `• ${it.meta.collection}` : '',
        it.meta?.model ? `• ${it.meta.model}` : '',
        it.meta?.created_at ? `• ${it.meta.created_at}` : ''
      ].filter(Boolean).join(' ');

      const tools = document.createElement('div');
      tools.className = 'toolbar';
      const left = document.createElement('div');
      left.className = 'muted';
      left.textContent = 'TEXT OUTPUT';
      const actions = document.createElement('div');
      actions.className = 'actions';
      const copyBtn = document.createElement('button');
      copyBtn.textContent = 'Copy';
      copyBtn.addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(pre.textContent); alert('Copied.'); } catch { alert('Copy failed.'); }
      });
      const dlBtn = document.createElement('button');
      dlBtn.className = 'secondary';
      dlBtn.textContent = 'Download .txt';
      dlBtn.addEventListener('click', () => downloadText(it.title || `architecture_${idx+1}`, pre.textContent));

      actions.append(copyBtn, dlBtn);
      tools.append(left, actions);

      const pre = document.createElement('pre');
      pre.textContent = it.body || '';

      sec.append(h2, meta, tools, pre);
      content.append(sec);
    });
  }

  function downloadText(name, text){
    const blob = new Blob([text || ''], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (name || 'architecture').replace(/\s+/g,'_').toLowerCase() + '.txt';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function allText(){
    return S.data.items.map((it, i) => {
      const title = it.title || `Architecture ${i+1}`;
      const meta = [
        it.subtitle || '',
        it.meta?.collection ? `• ${it.meta.collection}` : '',
        it.meta?.model ? `• ${it.meta.model}` : '',
        it.meta?.created_at ? `• ${it.meta.created_at}` : ''
      ].filter(Boolean).join(' ');
      return `${title}\n${meta}\n\n${it.body || ''}\n\n---\n`;
    }).join('\n');
  }

  document.getElementById('copyAll').addEventListener('click', async ()=>{
    try { await navigator.clipboard.writeText(allText()); alert('All architectures copied.'); }
    catch { alert('Copy failed.'); }
  });
  document.getElementById('downloadAll').addEventListener('click', ()=>{
    const name = (S.data.pictureTitle || 'architectures').replace(/\s+/g,'_').toLowerCase();
    downloadText(name + '_all', allText());
  });

  // Accept postMessage payload
  window.addEventListener('message', (ev)=>{
    try {
      if (ev.origin !== window.location.origin) return;
      const d = ev.data || {};
      if (d.kind === 'architectures-batch' && Array.isArray(d.items)){
        setPage({ pictureTitle: d.pictureTitle, items: d.items });
      }
    } catch(_) {}
  });

  // Optional: querystring fallback for manual tests (tiny texts only)
  const u = new URL(location.href);
  if (u.searchParams.has('body')) {
    const items = [{
      title: u.searchParams.get('title') || 'Architecture',
      subtitle: u.searchParams.get('subtitle') || '',
      body: u.searchParams.get('body') || ''
    }];
    setPage({ pictureTitle: u.searchParams.get('picture') || 'Picture', items });
  }
  </script>
</body>
</html>
