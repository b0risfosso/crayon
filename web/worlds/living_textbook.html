<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Living Textbook ‚Äî Petri Dish World</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121922; --ink:#d2e3f5; --muted:#7a8aa0; --accent:#56d7ff;
      --good:#3bd16f; --warn:#ffbe3b; --bad:#ff5c7a; --gene:#9aa7ff; --tf:#ffd166; --mrna:#56d7ff; --prot:#3bd16f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"}
    .app{display:grid; grid-template-columns: 320px 1fr 360px; grid-template-rows:auto 1fr; height:100%}
    header{grid-column:1/4; padding:12px 16px; border-bottom:1px solid #1e2a39; background:linear-gradient(180deg,#121a25,#0d141c)}
    header h1{margin:0; font-size:18px; letter-spacing:.3px}
    header .sub{color:var(--muted); font-size:12px}
    aside.left, aside.right{background:var(--panel); border-right:1px solid #1e2a39; padding:12px; overflow:auto}
    aside.right{border-right:none; border-left:1px solid #1e2a39}
    .section{margin-bottom:16px}
    .section h2{margin:8px 0 6px; font-size:13px; color:#b9c7dc; letter-spacing:.3px}
    .control{display:flex; align-items:center; gap:8px; margin:8px 0}
    .control label{width:110px; color:var(--muted); font-size:12px}
    .control input[type=range]{flex:1}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#0e1620; border:1px solid #1f2a3a; border-radius:999px; font-size:12px}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    .btn{background:#0f1621; border:1px solid #1e2a39; color:var(--ink); padding:8px 10px; border-radius:10px; font-size:12px; cursor:pointer}
    .btn:hover{border-color:#2a3b52}
    .btn.primary{background:linear-gradient(180deg,#1f344a,#142337); border-color:#2a3b52}
    .btn.ghost{background:transparent}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:11px; background:#0f1621; border:1px solid #1e2a39; padding:2px 6px; border-radius:6px}
    .log{font-family:ui-monospace,Consolas,monospace; font-size:12px; white-space:pre-wrap; background:#0f1621; border:1px solid #1e2a39; padding:8px; border-radius:8px}

    /* Center stage */
    .stage{position:relative; background:radial-gradient(1200px 800px at 60% 40%,#0f1722 0%, #0b0f14 70%); display:flex; align-items:center; justify-content:center; overflow:hidden}
    canvas#dish{width:min(100%,1100px); height:min(100%,820px); border-radius:24px; border:1px solid #1e2a39; background:radial-gradient(ellipse at center, #081018 0, #09131e 65%, #060b11 100%)}

    /* Notebook */
    .notebook-card{background:#0f1621; border:1px solid #1e2a39; border-radius:12px; padding:10px; margin-bottom:10px}
    .tag{display:inline-block; padding:2px 8px; border:1px solid #2a3b52; border-radius:999px; font-size:11px; color:#c7d6ec; margin:2px 4px 0 0}
    .badge{padding:4px 8px; border-radius:8px; font-size:11px; background:#112033; border:1px solid #223650; color:#bfe5ff}

    /* Tooltip */
    .tip{color:var(--muted); font-size:12px}

    /* Small helpers */
    .grid-2{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
    .mono{font-family:ui-monospace,Consolas,monospace}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Living Textbook Simulation">
    <header>
      <h1>Living Textbook ‚Äî Petri Dish Chapters <span class="sub">Interact with genes; watch transcription & translation respond to your touch.</span></h1>
    </header>

    <!-- Controls / Chapter setup -->
    <aside class="left" aria-label="Controls and Setup">
      <div class="section">
        <h2>Chapter (Dish) Controls</h2>
        <div class="control"><label for="light">Light</label><input id="light" type="range" min="0" max="1" step="0.01" value="0.35"><span class="pill" id="lightVal">35%</span></div>
        <div class="control"><label for="nutr">Nutrients</label><input id="nutr" type="range" min="0" max="1" step="0.01" value="0.55"><span class="pill" id="nutrVal">55%</span></div>
        <div class="control"><label for="temp">Temp (¬∞C)</label><input id="temp" type="range" min="10" max="45" step="0.5" value="30"><span class="pill" id="tempVal">30.0</span></div>
        <div class="row">
          <button class="btn" id="pulseLight">Flash Light</button>
          <button class="btn" id="feed">Add Nutrients</button>
          <button class="btn ghost" id="clear">Clear Particles</button>
        </div>
        <p class="tip">Hover the dish: transcription factors (TFs) spawn and drift to promoters. When conditions fit, genes glow and produce mRNA ‚Üí proteins.</p>
      </div>

      <div class="section">
        <h2>Storylines (Mechanisms)</h2>
        <div class="grid-2">
          <button class="btn" id="mutate">Mutation</button>
          <button class="btn" id="epistasis">Epistasis</button>
          <button class="btn" id="recombine">Recombination</button>
          <button class="btn" id="resetGenome">Reset Genome</button>
        </div>
        <p class="tip">Use these to change promoter affinities (mutation), add gene‚Äìgene modulation (epistasis), or swap promoter/ORF pairs (recombination).</p>
      </div>

      <div class="section">
        <h2>Challenge Mode ‚Äî ‚ÄúRescue a Gene‚Äù</h2>
        <div class="row">
          <button class="btn primary" id="startChallenge">Start</button>
          <button class="btn" id="stopChallenge">Stop</button>
          <span class="badge" id="challengeInfo">idle</span>
        </div>
        <p class="tip">Hit the target protein output for the selected gene before the timer expires by tuning light/nutrients/temperature and guiding TFs.</p>
      </div>

      <div class="section">
        <h2>Co‚Äëop (Stateless Link)</h2>
        <div class="row">
          <button class="btn" id="exportSignal">Export Link‚ÄëOut</button>
          <button class="btn" id="importSignal">Link‚ÄëIn</button>
        </div>
        <p class="tip">Share your Link‚ÄëOut string; your partner pastes it via Link‚ÄëIn to feed their dish. Chains allow multi‚Äëdish pathways.</p>
      </div>

      <div class="section">
        <h2>Notebook</h2>
        <div class="notebook-card" id="notebook"></div>
        <div class="row">
          <button class="btn" id="saveNotebook">Save</button>
          <button class="btn" id="clearNotebook">Clear</button>
        </div>
      </div>

      <div class="section">
        <h2>Data</h2>
        <div class="row">
          <button class="btn" id="exportGenome">Export Genome JSON</button>
          <button class="btn" id="importGenome">Import Genome JSON</button>
        </div>
        <p class="tip">Plug in real networks later: map promoters/ORFs to true gene IDs. This file stores in‚Äëpage only (no server needed).</p>
      </div>

      <div class="section">
        <h2>Keys</h2>
        <div class="row">
          <span class="pill"><span class="kbd">L</span> Light flash</span>
          <span class="pill"><span class="kbd">N</span> Nutrient pulse</span>
          <span class="pill"><span class="kbd">M</span> Spawn TF</span>
        </div>
      </div>
    </aside>

    <!-- Stage / Dish -->
    <main class="stage">
      <canvas id="dish" width="1100" height="820" aria-label="Petri dish canvas" tabindex="0"></canvas>
    </main>

    <!-- Right: Status & Help -->
    <aside class="right" aria-label="Status and Help">
      <div class="section">
        <h2>Status</h2>
        <div class="log" id="statusLog">ready</div>
      </div>
      <div class="section">
        <h2>Legend</h2>
        <div class="row">
          <span class="tag" style="background:#0f1230;border-color:#2d37a6;color:#cdd3ff">Gene (promoter)</span>
          <span class="tag" style="background:#1b1607;border-color:#6b5a18;color:#ffe6a6">TF particle</span>
          <span class="tag" style="background:#07161b;border-color:#174b5a;color:#bfe9ff">mRNA</span>
          <span class="tag" style="background:#0a1711;border-color:#145b34;color:#c7ffd8">Protein</span>
        </div>
      </div>
      <div class="section">
        <h2>How to Interact</h2>
        <ul style="margin:6px 0 0 16px; color:#b9c7dc; font-size:13px; line-height:1.4">
          <li>Open a chapter ‚Üí the dish activates. Adjust <b>Light</b>, <b>Nutrients</b>, <b>Temp</b>.</li>
          <li>Hover ‚Üí TFs drift to promoter sites; binding raises transcription.</li>
          <li>Active genes glow; watch <b>mRNA</b> arcs and <b>proteins</b> spawn.</li>
          <li>Try <b>Mutation</b>, <b>Epistasis</b>, <b>Recombination</b> to change outcomes.</li>
          <li>Discover motifs ‚Üí they‚Äôre logged to your <b>Notebook</b> (saved locally).</li>
          <li><b>Rescue a Gene</b> challenge: hit target protein flux before time runs out.</li>
        </ul>
      </div>
      <div class="section">
        <h2>Further It</h2>
        <ul style="margin:6px 0 0 16px; color:#b9c7dc; font-size:13px; line-height:1.4">
          <li>Swap the genome JSON with a real regulatory network (IDs, motifs).</li>
          <li>Attach a motif‚Äëfinder; auto‚Äëlearns rules into the Notebook.</li>
          <li>Use Link‚ÄëOut/Link‚ÄëIn to chain dishes (toy co‚Äëop without a server).</li>
        </ul>
      </div>
    </aside>
  </div>

  <script>
  // -----------------------------
  // World state & data structures
  // -----------------------------
  const TAU = Math.PI*2;
  const rnd = (a=1,b=0)=>Math.random()*(a-b)+b;
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const lerp=(a,b,t)=>a+(b-a)*t;

  // Gene network model: promoters laid on a ring; each gene has simple params.
  // Real networks can be imported via JSON (see Export/Import buttons).
  function defaultGenome(){
    const genes = [];
    const names = [
      {id:"lacZ", fn:"Œ≤-gal", color:"#9aa7ff"},
      {id:"araC", fn:"TF(Ara)", color:"#a8e0ff"},
      {id:"gfp", fn:"GFP", color:"#80ffa8"},
      {id:"rpoS", fn:"œÉ^S", color:"#ffd4a3"},
      {id:"galE", fn:"UDP‚ÄëGal", color:"#e0b0ff"},
      {id:"atpA", fn:"ATPase", color:"#f5a8b3"},
    ];
    const cx = 550, cy=410, R=280;
    names.forEach((n,i)=>{
      const ang = i/names.length*TAU - Math.PI/2;
      const px = cx + Math.cos(ang)*R;
      const py = cy + Math.sin(ang)*R;
      genes.push({
        id:n.id, label:n.id, product:n.fn, color:n.color,
        promoter:{x:px,y:py, baseAffinity: rnd(0.4,0.2)}, // baseline TF affinity
        kLight: rnd(1.2,0.6), kNutr: rnd(1.2,0.6), kTemp: rnd(1.2,0.6), // env sensitivities
        mrna:0, protein:0, activity:0,
      });
    });
    // Epistasis matrix: g_i influences g_j (default small zeroed)
    const epi = Array(genes.length).fill(0).map(()=>Array(genes.length).fill(0));
    return {genes, epi, chapter:"Chapter 1 ‚Äì Intro Circuits", version:1};
  }

  let genome = defaultGenome();
  let env = { light:0.35, nutr:0.55, temp:30 };

  // Particles (TFs), mRNA arcs, proteins
  const TFs=[]; const mRNAs=[]; const PROTs=[];

  // Challenge mode state
  let challenge = { running:false, targetGene: null, timeLeft:0, goal:0 };

  // Notebook (discovered motifs / notes) stored in localStorage
  const NOTE_KEY = "living_textbook_notebook";
  let notebook = JSON.parse(localStorage.getItem(NOTE_KEY) || "[]");

  // -----------------------------
  // Canvas & interaction plumbing
  // -----------------------------
  const canvas = document.getElementById('dish');
  const ctx = canvas.getContext('2d');
  const rect = ()=>canvas.getBoundingClientRect();
  let mouse={x:0,y:0,inside:false};

  canvas.addEventListener('pointermove', e=>{
    const r=rect();
    mouse.x = (e.clientX - r.left)/r.width*canvas.width;
    mouse.y = (e.clientY - r.top)/r.height*canvas.height;
    mouse.inside=true;
  });
  canvas.addEventListener('pointerleave', ()=>mouse.inside=false);
  canvas.addEventListener('pointerdown', spawnTF);
  canvas.addEventListener('keydown', e=>{
    if(e.key==='m' || e.key==='M') spawnTF();
    if(e.key==='l' || e.key==='L') flashLight();
    if(e.key==='n' || e.key==='N') pulseNutr();
  });

  function spawnTF(){
    // Spawn near cursor; drift with noise; seek nearest promoter
    const x = mouse.x||canvas.width/2, y=mouse.y||canvas.height/2;
    TFs.push({x,y,vx:rnd(0.6,-0.6),vy:rnd(0.6,-0.6), life: rnd(9,6)});
  }

  function flashLight(){
    env.light = clamp(env.light+0.3,0,1); flash('Light flash', 'good');
  }
  function pulseNutr(){
    env.nutr = clamp(env.nutr+0.25,0,1); flash('Nutrient pulse', 'good');
  }

  // UI bindings
  const $ = id=>document.getElementById(id);
  const light = $('light'), nutr=$('nutr'), temp=$('temp');
  const lightVal=$('lightVal'), nutrVal=$('nutrVal'), tempVal=$('tempVal');
  const statusLog=$('statusLog');

  function updateLabels(){
    lightVal.textContent = Math.round(env.light*100)+"%";
    nutrVal.textContent = Math.round(env.nutr*100)+"%";
    tempVal.textContent = env.temp.toFixed(1);
  }
  light.addEventListener('input',()=>{ env.light=parseFloat(light.value); updateLabels();});
  nutr.addEventListener('input',()=>{ env.nutr=parseFloat(nutr.value); updateLabels();});
  temp.addEventListener('input',()=>{ env.temp=parseFloat(temp.value); updateLabels();});
  $('pulseLight').onclick=flashLight; $('feed').onclick=pulseNutr; $('clear').onclick=()=>{TFs.length=0; mRNAs.length=0; PROTs.length=0;};

  // Storyline buttons
  $('mutate').onclick=()=>{ mutateGenome(); };
  $('epistasis').onclick=()=>{ toggleEpistasis(); };
  $('recombine').onclick=()=>{ recombineGenome(); };
  $('resetGenome').onclick=()=>{ genome=defaultGenome(); flash('Genome reset','warn'); };

  // Challenge mode
  $('startChallenge').onclick=startChallenge;
  $('stopChallenge').onclick=stopChallenge;

  // Data I/O
  $('exportGenome').onclick=()=>{
    const blob = new Blob([JSON.stringify(genome,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'),{href:url,download:'living_textbook_genome.json'});
    a.click(); URL.revokeObjectURL(url);
  };
  $('importGenome').onclick=async()=>{
    const input = Object.assign(document.createElement('input'),{type:'file',accept:'application/json'});
    input.onchange=()=>{
      const f=input.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload=()=>{ try{ genome=JSON.parse(reader.result); flash('Genome imported','good'); }catch(e){ flash('Invalid JSON','bad') } };
      reader.readAsText(f);
    };
    input.click();
  };

  // Co‚Äëop stateless link via clipboard payload
  $('exportSignal').onclick=async()=>{
    const payload = exportLinkSignal();
    await navigator.clipboard.writeText(payload).catch(()=>{});
    flash('Link‚ÄëOut copied to clipboard','good');
  };
  $('importSignal').onclick=async()=>{
    const text = prompt('Paste Link‚ÄëOut payload:');
    if(!text) return; try{ importLinkSignal(text); flash('Link‚ÄëIn applied','good'); }catch(e){ flash('Invalid Link‚ÄëIn','bad'); }
  };

  // Notebook persistence
  $('saveNotebook').onclick=()=>{ localStorage.setItem(NOTE_KEY, JSON.stringify(notebook)); flash('Notebook saved','good'); renderNotebook(); };
  $('clearNotebook').onclick=()=>{ notebook=[]; localStorage.removeItem(NOTE_KEY); renderNotebook(); };

  function renderNotebook(){
    const host = $('notebook'); host.innerHTML='';
    if(!notebook.length){ host.innerHTML='<div class="tip">No notes yet. Discover motifs by sustaining targeted expression patterns.</div>'; return; }
    notebook.forEach(n=>{
      const card=document.createElement('div'); card.className='notebook-card';
      card.innerHTML = `<div style="font-weight:600">${n.title}</div>
        <div class="tip" style="margin:6px 0">${n.note}</div>
        <div>${(n.tags||[]).map(t=>`<span class='tag'>${t}</span>`).join('')}</div>`;
      host.appendChild(card);
    });
  }
  renderNotebook();

  // -----------------------------
  // Genetics mechanics (toy model)
  // -----------------------------
  function envFactor(g){
    // Multiplicative factor of light, nutrients, temperature
    const tOpt=34, tSpan=16; // bell around 34¬∞C
    const tScore = Math.exp(-((env.temp - tOpt)**2)/(2*(tSpan*tSpan)));
    return (1 + g.kLight*(env.light-0.5)) * (1 + g.kNutr*(env.nutr-0.5)) * (0.6 + 0.8*tScore);
  }

  function nearestPromoter(x,y){
    let best=0,bd=1e9;
    genome.genes.forEach((g,i)=>{
      const dx=g.promoter.x-x, dy=g.promoter.y-y; const d=dx*dx+dy*dy; if(d<bd){bd=d;best=i;}
    });
    return genome.genes[best];
  }

  function step(dt){
    // Move TFs toward nearest promoter with mild noise; bind to increase activity
    for(let i=TFs.length-1;i>=0;i--){
      const p=TFs[i]; p.life-=dt; if(p.life<=0){ TFs.splice(i,1); continue; }
      const t=nearestPromoter(p.x,p.y);
      const dx=t.promoter.x-p.x, dy=t.promoter.y-p.y; const d=Math.hypot(dx,dy)+1e-6;
      const speed = 40; const nx=dx/d, ny=dy/d;
      p.vx = lerp(p.vx, nx*speed, 0.03) + rnd(10,-10)*dt;
      p.vy = lerp(p.vy, ny*speed, 0.03) + rnd(10,-10)*dt;
      p.x += p.vx*dt; p.y += p.vy*dt;
      if(d<18){ // bind event
        // Activity bump scaled by baseAffinity & environment
        const bump = (t.promoter.baseAffinity*0.6 + 0.15) * envFactor(t) * 0.9;
        t.activity = clamp(t.activity + bump, 0, 3.0);
        // mRNA pulse
        mRNAs.push({x:t.promoter.x, y:t.promoter.y, ang:rnd(TAU), life:1.8, r:8});
        // remove TF
        TFs.splice(i,1);
        flash(`TF bound at ${t.id} ‚Üí +activity`, 'good', true);
      }
    }

    // Epistasis influence (linear mix)
    const G = genome.genes.length;
    for(let i=0;i<G;i++){
      let epiSum=0; for(let j=0;j<G;j++){ if(i!==j) epiSum += genome.epi[j][i] * genome.genes[j].activity; }
      const g = genome.genes[i];
      // Transcription: decay to baseline + env + epi
      const envEff = envFactor(g);
      const base = g.promoter.baseAffinity*0.3;
      const drive = base + 0.4*envEff + 0.3*epiSum;
      // relax & integrate
      g.activity = clamp( lerp(g.activity, drive, 0.15*dt) + 0.02*dt, 0, 3.5);

      // Translation: mRNA/protein pools with decay
      g.mrna = clamp(g.mrna + (0.8*g.activity - 0.5*g.mrna)*dt, 0, 100);
      g.protein = clamp(g.protein + (0.6*g.mrna - 0.2*g.protein)*dt, 0, 200);

      // Spawn proteins visually when activity high
      if(Math.random() < g.activity*0.02*dt){
        PROTs.push({x:g.promoter.x + rnd(40,-40), y:g.promoter.y + rnd(40,-40), life: rnd(2.5,1.2)});
      }

      // Motif ‚Äúdiscovery‚Äù: if user sustains activity within band over time
      if(g.activity>1.2 && g.activity<1.6){
        g._bandT = (g._bandT||0) + dt; if(g._bandT>4){
          discover(`Regulatory band @${g.id}`, `Sustained transcriptional activity suggests a motif near ${g.id}. Consider scanning promoter for consensus.`,[`motif:${g.id}`,`band:1.2‚Äì1.6`]);
          g._bandT = -1e9; // avoid spamming
        }
      } else { g._bandT = 0; }
    }

    // Animate mRNA arcs
    for(let i=mRNAs.length-1;i>=0;i--){ const m=mRNAs[i]; m.life-=dt; m.r += 40*dt; if(m.life<=0) mRNAs.splice(i,1); }
    for(let i=PROTs.length-1;i>=0;i--){ const p=PROTs[i]; p.life-=dt; p.y -= 10*dt; if(p.life<=0) PROTs.splice(i,1); }

    // Challenge ticking
    if(challenge.running){
      challenge.timeLeft -= dt; if(challenge.timeLeft<0){
        flash('Challenge failed ‚Äî time up','bad'); stopChallenge();
      } else {
        const g = challenge.targetGene; if(g && g.protein >= challenge.goal){
          flash(`Rescued ${g.id}! Goal ${challenge.goal.toFixed(0)} reached`, 'good');
          discover(`Rescue: ${g.id}`, `You restored pathway flux by achieving protein ‚â• ${challenge.goal.toFixed(0)}.`, ['challenge','rescue']);
          stopChallenge();
        }
        $('challengeInfo').textContent = `${challenge.targetGene?challenge.targetGene.id:'?'} ‚Ä¢ ${Math.max(0,challenge.timeLeft).toFixed(1)}s ‚Ä¢ goal ${challenge.goal.toFixed(0)}`;
      }
    } else {
      $('challengeInfo').textContent = 'idle';
    }
  }

  function startChallenge(){
    const g = genome.genes[Math.floor(Math.random()*genome.genes.length)];
    challenge.running=true; challenge.targetGene=g; challenge.timeLeft=25; challenge.goal = 60 + Math.random()*70;
    flash(`Rescue ${g.id}: reach protein ‚â• ${challenge.goal.toFixed(0)} in 25s`,'warn');
  }
  function stopChallenge(){ challenge.running=false; challenge.targetGene=null; }

  function mutateGenome(){
    const g = genome.genes[Math.floor(Math.random()*genome.genes.length)];
    const delta = rnd(0.25,-0.25); g.promoter.baseAffinity = clamp(g.promoter.baseAffinity + delta, 0.05, 1.4);
    flash(`Mutation @${g.id}: baseAffinity ${delta>0?'+':''}${delta.toFixed(2)}`,'warn');
  }
  function toggleEpistasis(){
    // Randomly set a few small cross‚Äëinfluences
    for(let i=0;i<genome.genes.length;i++) for(let j=0;j<genome.genes.length;j++) if(i!==j){
      genome.epi[i][j] = (Math.random()<0.15? rnd(0.5,-0.5): 0);
    }
    flash('Epistasis matrix randomized','warn');
  }
  function recombineGenome(){
    // Swap promoter positions among two random genes
    const a=Math.floor(Math.random()*genome.genes.length), b=Math.floor(Math.random()*genome.genes.length);
    if(a===b) return recombineGenome();
    const pa = genome.genes[a].promoter; genome.genes[a].promoter = genome.genes[b].promoter; genome.genes[b].promoter = pa;
    flash(`Recombined promoters: ${genome.genes[a].id} ‚áÑ ${genome.genes[b].id}`,'warn');
  }

  function exportLinkSignal(){
    // A tiny summary of global outputs (mean protein, top gene id)
    const meanProt = genome.genes.reduce((s,g)=>s+g.protein,0)/genome.genes.length;
    const top = genome.genes.reduce((a,b)=>a.protein>b.protein?a:b);
    return btoa(JSON.stringify({meanProt, top:top.id, env}));
  }
  function importLinkSignal(payload){
    const msg = JSON.parse(atob(payload));
    // Interpret partner output as an extra epistatic drive onto all genes
    const k = clamp(msg.meanProt/150, 0, 1.2);
    for(const g of genome.genes){ g.activity = clamp(g.activity + 0.15*k, 0, 3.5); }
    flash(`Co‚Äëop signal received from ${msg.top} (k=${k.toFixed(2)})`, 'good');
  }

  function discover(title, note, tags){
    // Add unique discoveries
    const key = title+"|"+note; if(notebook.some(n=>n.key===key)) return;
    notebook.push({key,title,note,tags, t:Date.now()}); renderNotebook();
  }

  function flash(msg, level='good', quiet=false){
    const emoji = level==='good'?'üü¢': level==='warn'?'üü°':'üî¥';
    if(!quiet) statusLog.textContent = `${emoji} ${msg}`;
  }

  // -----------------------------
  // Rendering
  // -----------------------------
  function draw(){
    // Clear
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Dish background & rim
    const cx=canvas.width/2, cy=canvas.height/2, R=330;
    const grad=ctx.createRadialGradient(cx,cy, R*0.1, cx,cy,R);
    grad.addColorStop(0, '#0b1320'); grad.addColorStop(1, '#050a10');
    ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(cx,cy,R,0,TAU); ctx.fill();
    ctx.strokeStyle='#1e2a39'; ctx.lineWidth=3; ctx.stroke();

    // Gentle spotlight from mouse
    if(mouse.inside){
      const g=ctx.createRadialGradient(mouse.x,mouse.y,6, mouse.x,mouse.y,120);
      g.addColorStop(0, 'rgba(86,215,255,0.25)'); g.addColorStop(1,'rgba(86,215,255,0)');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(mouse.x,mouse.y,140,0,TAU); ctx.fill();
    }

    // Genes/promoters
    for(const g of genome.genes){
      // promoter node
      ctx.beginPath(); ctx.arc(g.promoter.x, g.promoter.y, 10 + 4*g.promoter.baseAffinity, 0, TAU);
      ctx.fillStyle = g.color; ctx.globalAlpha=0.2 + 0.25*Math.min(1,g.activity/1.8); ctx.fill(); ctx.globalAlpha=1;
      ctx.strokeStyle='rgba(154,167,255,0.6)'; ctx.lineWidth=1; ctx.stroke();

      // label
      ctx.fillStyle='#bcd3ff'; ctx.font='12px ui-sans-serif'; ctx.textAlign='center';
      ctx.fillText(g.id, g.promoter.x, g.promoter.y-16);

      // mRNA arcs
      for(const m of mRNAs){ if(Math.hypot(m.x-g.promoter.x,m.y-g.promoter.y)<2){
        ctx.beginPath(); ctx.strokeStyle='rgba(86,215,255,0.7)'; ctx.lineWidth=1.2;
        ctx.arc(m.x, m.y, m.r, m.ang, m.ang+Math.PI*0.8);
        ctx.stroke();
      }}

      // protein glints
      for(const p of PROTs){ if(Math.hypot(p.x-g.promoter.x,p.y-g.promoter.y)<45){
        ctx.beginPath(); ctx.fillStyle='rgba(59,209,111,0.8)'; ctx.arc(p.x,p.y,2.2,0,TAU); ctx.fill();
      }}
    }

    // TF particles
    for(const p of TFs){
      ctx.beginPath(); ctx.fillStyle='rgba(255,209,102,0.9)'; ctx.arc(p.x,p.y,3.2,0,TAU); ctx.fill();
    }

    // HUD mini bars for each gene (protein levels)
    const barW=16, gap=6; let i=0;
    for(const g of genome.genes){
      const x=20 + i*(barW+gap), y=canvas.height-70; i++;
      const h = clamp(g.protein,0,200)*0.25; // max 50px
      ctx.fillStyle='rgba(188, 211, 255, 0.15)'; ctx.fillRect(x, y-50, barW, 50);
      ctx.fillStyle='rgba(59,209,111,0.9)'; ctx.fillRect(x, y-h, barW, h);
      ctx.fillStyle='#9fb6d6'; ctx.font='10px ui-sans-serif'; ctx.save(); ctx.translate(x+barW/2,y+8); ctx.rotate(-Math.PI/4); ctx.textAlign='center'; ctx.fillText(g.id,0,0); ctx.restore();
    }
  }

  // -----------------------------
  // Main loop
  // -----------------------------
  let last=performance.now();
  function loop(t){
    const dt = Math.min(0.05,(t-last)/1000); last=t;
    step(dt); draw(); updateLabels();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // Boot message
  flash('Chapter loaded ‚Äî hover to spawn TFs; adjust environment to explore regulation.','good');
  updateLabels();
  </script>
</body>
</html>
