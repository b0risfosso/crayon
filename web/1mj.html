<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>1 MJ Tracker • Fantasiagenesis</title>
  <style>
    :root{
      --bg: #0b0f14;
      --card: #111821;
      --ink: #e7eef7;
      --muted: #9fb2c7;
      --accent: #4dd0e1;
      --accent-2: #a78bfa;
      --danger: #ef4444;
      --ok: #22c55e;
      --warn: #f59e0b;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius: 14px;
    }
    html,body{height:100%}
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#0b0f14,#0e131a 40%,#0b0f14);
      color:var(--ink); font: 15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;
    }
    header{
      position:sticky; top:0; z-index:5; backdrop-filter: blur(8px);
      background: rgba(11,15,20,.7); border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:18px 18px; }
    h1{ margin:0 0 6px 0; font-size: 28px; letter-spacing:.2px }
    .sub{ color:var(--muted); font-size:13px }

    .grid{
      display:grid; grid-template-columns: 1.15fr .85fr; gap:18px; align-items:start; margin-top:18px
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--card); border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius); box-shadow: var(--shadow);
    }
    .card h2{ margin:0 0 8px 0; font-size:18px }
    .card .pad{ padding:16px }
    .row{ display:flex; gap:12px; flex-wrap:wrap }
    .row > *{ flex:1 1 160px }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px }
    input, select, textarea{
      width:100%; padding:10px 12px; background:#0c121a; color:var(--ink);
      border:1px solid rgba(255,255,255,.08); border-radius:10px; outline:none;
    }
    textarea{ min-height:70px; resize:vertical }
    .btn{ cursor:pointer; border:none; display:inline-flex; align-items:center; justify-content:center; gap:8px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#081017; font-weight:600;
      padding:10px 14px; border-radius:10px; box-shadow: 0 6px 16px rgba(77,208,225,.35);
    }
    .btn.ghost{ background:transparent; color:var(--ink); border:1px solid rgba(255,255,255,.12); box-shadow:none }
    .btn.warn{ background:var(--warn); color:#111 }
    .btn.danger{ background:var(--danger); color:#111 }
    .btn.secondary{ background:#1b2633; color:var(--ink); }

    .stat{
      display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; margin:12px 0; padding:10px;
      border:1px dashed rgba(255,255,255,.12); border-radius:10px;
    }
    .bar{ height:10px; background:#0b1118; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.08) }
    .bar > span{ display:block; height:100%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); width:0% }

    table{ width:100%; border-collapse:collapse; }
    th, td{ text-align:left; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.06) }
    th{ font-size:12px; color:var(--muted); font-weight:600 }
    tbody tr:hover{ background:#0f1620 }
    .pill{ padding:2px 8px; border-radius:999px; font-size:12px; background:#16202c; border:1px solid rgba(255,255,255,.08); color:var(--ink) }

    .kpi{ display:grid; grid-template-columns: repeat(4,1fr); gap:12px }
    .kpi .box{ background:#0c141c; border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:12px }
    .kpi .val{ font-size:22px; font-weight:700 }
    .kpi .lbl{ font-size:12px; color:var(--muted) }

    .muted{ color:var(--muted) }
    .hr{ height:1px; background: rgba(255,255,255,.06); margin:12px 0 }
    .right{ text-align:right }
    .hint{ font-size:12px; color:var(--muted) }
    .small{ font-size:12px }
    .flex{ display:flex; gap:10px; align-items:center }
    .gap{ gap:8px }
    .mt{ margin-top:10px }
    .mb{ margin-bottom:10px }
    .center{ text-align:center }
    .tag{ font-size:11px; color:#0b0f14; background:var(--accent); padding:2px 6px; border-radius:6px; font-weight:700 }

    .notice{ padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0d141c; color:var(--muted); font-size:13px }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="flex" style="justify-content:space-between; align-items:baseline">
      <div>
        <h1>1&nbsp;MJ Tracker</h1>
        <div class="sub">Track, compute, and narrate one megajoule across media, timescales, and experiences.</div>
      </div>
      <div class="small muted" id="now"></div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- KPIs -->
  <section class="card pad">
    <div class="kpi">
      <div class="box">
        <div class="lbl">Captured (MJ)</div>
        <div class="val" id="kpiCaptured">0.000</div>
        <div class="hint">Sum of log entries</div>
      </div>
      <div class="box">
        <div class="lbl">Deployed (MJ)</div>
        <div class="val" id="kpiDeployed">0.000</div>
        <div class="hint">Marked as deployed</div>
      </div>
      <div class="box">
        <div class="lbl">Net Available (MJ)</div>
        <div class="val" id="kpiNet">0.000</div>
        <div class="hint">Captured − Deployed</div>
      </div>
      <div class="box">
        <div class="lbl">Efficiency (Useful / Total)</div>
        <div class="val" id="kpiEff">—</div>
        <div class="hint">Set per-log useful fraction</div>
      </div>
    </div>
  </section>

  <div class="grid">
    <!-- Left column: Logs + Calculators -->
    <section class="card pad">
      <h2>Quick Log</h2>
      <div class="row">
        <div>
          <label>Energy</label>
          <div class="row">
            <input type="number" step="any" id="logEnergyVal" placeholder="e.g., 278" />
            <select id="logEnergyUnit">
              <option value="MJ">MJ</option>
              <option value="kJ">kJ</option>
              <option value="Wh">Wh</option>
              <option value="kcal">kcal</option>
            </select>
          </div>
          <div class="hint">1 MJ = 278 Wh ≈ 239 kcal.</div>
        </div>
        <div>
          <label>Medium</label>
          <select id="logMedium">
            <option>Solar</option>
            <option>Mechanical</option>
            <option>Thermal</option>
            <option>Chemical</option>
            <option>Biological</option>
            <option>Human power</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label>Duration</label>
          <div class="row">
            <input type="number" step="any" id="logDuration" placeholder="e.g., 3600" />
            <select id="logDurationUnit">
              <option value="s">s</option>
              <option value="min">min</option>
              <option value="h" selected>h</option>
            </select>
          </div>
          <div class="hint">Used to compute average power</div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Storage Medium</label>
          <select id="logStorage">
            <option>None</option>
            <option>Battery</option>
            <option>Flywheel</option>
            <option>Water reservoir</option>
            <option>Compressed gas</option>
            <option>Heat (PCM/salt)</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label>Useful Fraction</label>
          <input type="number" step="any" id="logUseful" placeholder="e.g., 0.8" />
          <div class="hint">0–1 (how much became useful work)</div>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn" id="btnAddLog">Add Log</button>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Notes</label>
          <textarea id="logNotes" placeholder="What did you do? Sensors? Conditions?"></textarea>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div class="row" style="flex:1 1 auto">
          <div>
            <label>Filter: Medium</label>
            <select id="filterMedium"><option value="">All</option><option>Solar</option><option>Mechanical</option><option>Thermal</option><option>Chemical</option><option>Biological</option><option>Human power</option><option>Other</option></select>
          </div>
          <div>
            <label>Filter: Storage</label>
            <select id="filterStorage"><option value="">All</option><option>None</option><option>Battery</option><option>Flywheel</option><option>Water reservoir</option><option>Compressed gas</option><option>Heat (PCM/salt)</option><option>Other</option></select>
          </div>
        </div>
        <div class="right" style="flex:0 0 auto; align-self:flex-end">
          <button class="btn secondary" id="btnExport">Export JSON</button>
          <label class="btn ghost" for="importFile">Import</label>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="notice mb">Power is computed as average over the given duration. Deployment marks a log as energy you intentionally used/released.</div>

      <div style="overflow:auto">
        <table id="logTable">
          <thead>
            <tr>
              <th>Date</th>
              <th class="right">Energy (MJ)</th>
              <th>Medium</th>
              <th>Duration</th>
              <th class="right">Avg Power (W)</th>
              <th>Storage</th>
              <th>Useful</th>
              <th>Deployed</th>
              <th>Notes</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Right column: Dimensions & Calculators -->
    <section class="card pad">
      <h2>Dimensions</h2>

      <!-- 1. Physical Medium -->
      <div class="stat">
        <div class="tag">1</div>
        <div>
          <b>Physical Medium</b>
          <div class="small muted">Solar • Mechanical • Thermal • Chemical • Biological • Human</div>
        </div>
        <div class="small" id="countByMedium">—</div>
      </div>

      <details class="card" style="margin-bottom:10px">
        <summary class="pad"><b>Solar & Panels</b> <span class="muted">(compute paths to 1 MJ)</span></summary>
        <div class="pad">
          <div class="row">
            <div>
              <label>Panel rating (W)</label>
              <input id="pvWatt" type="number" step="any" value="100" />
            </div>
            <div>
              <label>Full-sun hours (h)</label>
              <input id="pvSunHours" type="number" step="any" value="3" />
            </div>
            <div>
              <label>Daily energy (Wh)</label>
              <input id="pvWh" type="number" step="any" value="300" />
              <div class="hint">Auto-updates; editable</div>
            </div>
          </div>
          <div class="row">
            <div class="box">
              <div class="lbl">Days to 1 MJ (278 Wh)</div>
              <div class="val" id="pvDays">—</div>
            </div>
            <div class="box">
              <div class="lbl">Panels to reach 1 MJ/day</div>
              <div class="val" id="pvPanels">—</div>
            </div>
          </div>
          <div class="hr"></div>
          <div class="row">
            <div>
              <label>Irradiance yield (Wh/m²/day)</label>
              <input id="pvWhM2" type="number" step="any" value="1000" />
            </div>
            <div class="box" style="flex:1 1 180px">
              <div class="lbl">Area for 1 MJ</div>
              <div class="val" id="pvArea">—</div>
              <div class="hint">278 Wh / (Wh/m²/day)</div>
            </div>
          </div>
        </div>
      </details>

      <details class="card" style="margin-bottom:10px">
        <summary class="pad"><b>Mechanical Lifting</b> <span class="muted">(m·g·h)</span></summary>
        <div class="pad">
          <div class="row">
            <div>
              <label>Mass (kg)</label>
              <input id="mechMass" type="number" value="100" />
            </div>
            <div>
              <label>Height per lift (m)</label>
              <input id="mechHeight" type="number" value="1" />
            </div>
            <div>
              <label>Reps</label>
              <input id="mechReps" type="number" value="100" />
            </div>
          </div>
          <div class="row">
            <div class="box"><div class="lbl">Energy (MJ)</div><div class="val" id="mechMJ">—</div></div>
            <div class="box"><div class="lbl">Reps for 1 MJ</div><div class="val" id="mechRepsFor1">—</div></div>
          </div>
        </div>
      </details>

      <details class="card" style="margin-bottom:10px">
        <summary class="pad"><b>Human Power</b> <span class="muted">(bike / rower)</span></summary>
        <div class="pad">
          <div class="row">
            <div>
              <label>Average power (W)</label>
              <input id="humanW" type="number" value="278" />
            </div>
            <div class="box"><div class="lbl">Time to 1 MJ</div><div class="val" id="humanTime">—</div></div>
          </div>
        </div>
      </details>

      <details class="card" style="margin-bottom:10px">
        <summary class="pad"><b>Thermal (water heating)</b></summary>
        <div class="pad">
          <div class="row">
            <div>
              <label>Water mass (kg ≈ L)</label>
              <input id="waterKg" type="number" value="3" />
            </div>
            <div>
              <label>ΔT (°C)</label>
              <input id="waterDT" type="number" value="80" />
            </div>
            <div class="box"><div class="lbl">Energy (MJ)</div><div class="val" id="waterMJ">—</div></div>
          </div>
        </div>
      </details>

      <details class="card" style="margin-bottom:10px">
        <summary class="pad"><b>Chemical (LHV)</b> <span class="muted">Ethanol & Gasoline</span></summary>
        <div class="pad">
          <div class="row">
            <div>
              <label>Ethanol LHV (MJ/kg)</label>
              <input id="ethLHV" type="number" value="26.8" />
            </div>
            <div>
              <label>Gasoline LHV (MJ/kg)</label>
              <input id="gasLHV" type="number" value="44" />
            </div>
          </div>
          <div class="row">
            <div class="box"><div class="lbl">Ethanol mass for 1 MJ (g)</div><div class="val" id="ethMass">—</div></div>
            <div class="box"><div class="lbl">Gasoline mass for 1 MJ (g)</div><div class="val" id="gasMass">—</div></div>
          </div>
          <div class="notice">Safety: do controlled burns only with proper ventilation, surfaces, PPE, and extinguishers.</div>
        </div>
      </details>

      <!-- 2. Temporal -->
      <div class="stat">
        <div class="tag">2</div>
        <div>
          <b>Temporal</b>
          <div class="small muted">Burst vs trickle vs slow harvest</div>
        </div>
        <div class="small" id="temporalQuick">—</div>
      </div>
      <div class="card pad" style="margin-bottom:10px">
        <div class="row">
          <div>
            <label>Energy (MJ)</label>
            <input id="tempMJ" type="number" value="1" />
          </div>
          <div>
            <label>Duration</label>
            <div class="row">
              <input id="tempDur" type="number" value="1" />
              <select id="tempDurUnit"><option value="s">s</option><option value="h" selected>h</option><option value="day">day</option></select>
            </div>
          </div>
          <div class="box"><div class="lbl">Average Power</div><div class="val" id="tempPower">—</div></div>
        </div>
      </div>

      <!-- 3. Scale & Context -->
      <div class="stat">
        <div class="tag">3</div>
        <div>
          <b>Scale & Context</b>
          <div class="small muted">Human • Household • Industrial • Planetary</div>
        </div>
        <div class="small">Reference equivalences</div>
      </div>
      <div class="card pad" style="margin-bottom:10px">
        <div class="row">
          <div class="box"><div class="lbl">Food</div><div class="val" id="eqFood">—</div><div class="hint">kcal per MJ</div></div>
          <div class="box"><div class="lbl">100 W bulb</div><div class="val" id="eqBulb">—</div><div class="hint">hours per MJ</div></div>
          <div class="box"><div class="lbl">Sprints</div><div class="val" id="eqSprints">—</div><div class="hint">@ ~4 kJ/sprint</div></div>
          <div class="box"><div class="lbl">Earth solar time</div><div class="val" id="eqEarth">—</div><div class="hint">time for Earth to receive 1 MJ</div></div>
        </div>
      </div>

      <!-- 4. Symbolic & Strategic -->
      <div class="stat">
        <div class="tag">4</div>
        <div>
          <b>Symbolic & Strategic</b>
          <div class="small muted">Seed → Unit → Scale → Efficiency</div>
        </div>
        <div class="small">Checklist</div>
      </div>
      <div class="card pad" style="margin-bottom:10px">
        <div class="row">
          <label class="flex gap"><input id="msSeed" type="checkbox"/> Seed captured</label>
          <label class="flex gap"><input id="msStored" type="checkbox"/> Stored</label>
          <label class="flex gap"><input id="msDeployed" type="checkbox"/> Deployed</label>
        </div>
        <div class="hr"></div>
        <div>
          <div class="lbl">Scaling: 1 → 10 → 1000 MJ</div>
          <div class="stat">
            <div style="min-width:64px">10 MJ</div>
            <div class="bar"><span id="bar10"></span></div>
            <div class="small" id="bar10Txt">0%</div>
          </div>
          <div class="stat">
            <div style="min-width:64px">1000 MJ</div>
            <div class="bar"><span id="bar1000"></span></div>
            <div class="small" id="bar1000Txt">0%</div>
          </div>
        </div>
      </div>

      <!-- 5. Storage Mediums -->
      <div class="stat">
        <div class="tag">5</div>
        <div>
          <b>Storage & Agency</b>
          <div class="small muted">Battery • Flywheel • Water • Compressed air • Heat</div>
        </div>
        <div class="small" id="storeSummary">—</div>
      </div>
      <div class="card pad" style="margin-bottom:10px">
        <div class="row">
          <div>
            <label>Type</label>
            <select id="invType"><option>Battery</option><option>Flywheel</option><option>Water reservoir</option><option>Compressed gas</option><option>Heat (PCM/salt)</option><option>Other</option></select>
          </div>
          <div>
            <label>Capacity (MJ)</label>
            <input id="invCap" type="number" step="any" placeholder="e.g., 5" />
          </div>
          <div>
            <label>Round-trip η</label>
            <input id="invEta" type="number" step="any" placeholder="e.g., 0.9" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn" id="btnAddInv">Add Storage</button>
          </div>
        </div>
        <div class="row mt">
          <div style="flex:1 1 auto; overflow:auto">
            <table id="invTable">
              <thead>
                <tr><th>Type</th><th class="right">Capacity (MJ)</th><th class="right">η</th><th class="right">Usable (MJ)</th><th>Notes</th><th></th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 6. Historical & Civilizational -->
      <div class="stat">
        <div class="tag">6</div>
        <div>
          <b>Historical & Civilizational</b>
          <div class="small muted">Fire → Steam → Electric → Nuclear → Next</div>
        </div>
        <div class="small">Annotations</div>
      </div>
      <div class="card pad" style="margin-bottom:10px">
        <label>Notes</label>
        <textarea id="histNotes" placeholder="Sketch demos or exhibits for each era."></textarea>
      </div>

      <!-- 7. Experiential & Human -->
      <div class="stat">
        <div class="tag">7</div>
        <div>
          <b>Experiential & Human</b>
          <div class="small muted">Athletics • Food • Daily life • Artistic</div>
        </div>
        <div class="small">Equivalences</div>
      </div>
      <div class="card pad">
        <div class="row">
          <div>
            <label>Per-sprint energy (kJ)</label>
            <input id="sprintKJ" type="number" step="any" value="4" />
          </div>
          <div>
            <label>Chocolate bar (kcal)</label>
            <input id="chocKcal" type="number" step="any" value="240" />
          </div>
          <div>
            <label>Art release log (notes)</label>
            <input id="artNote" type="text" placeholder="e.g., 1 MJ as sound/light" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn secondary" id="btnArt">Add Artistic Event</button>
          </div>
        </div>
        <div class="mt small muted" id="artList"></div>
      </div>
    </section>
  </div>
</main>

<script>
(function(){
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const stateKey = 'one_mj_state_v1';
  const g = 9.81; // m/s^2
  const J_PER_WH = 3600; // J
  const J_PER_KCAL = 4184; // J
  const EARTH_SOLAR_W = 1.74e17; // W

  let state = {
    logs: [],
    inventory: [],
    histNotes: '',
    art: [],
  };

  function nowISO(){ return new Date().toISOString(); }
  function fmt(n, d=3){ if(n===undefined||isNaN(n)) return '—'; return Number(n).toFixed(d); }
  function pct(n){ return Math.max(0, Math.min(100, n*100)).toFixed(0) + '%'; }
  function toMJ(val, unit){
    const v = Number(val);
    if(!isFinite(v)) return 0;
    switch(unit){
      case 'MJ': return v;
      case 'kJ': return v/1000;
      case 'Wh': return (v*J_PER_WH)/1e6;
      case 'kcal': return (v*J_PER_KCAL)/1e6;
      default: return v;
    }
  }
  function durToSeconds(v, unit){
    const n = Number(v)||0;
    return unit==='s'? n : unit==='min'? n*60 : unit==='h'? n*3600 : unit==='day'? n*86400 : n;
  }
  function secondsToHMS(s){
    s = Math.max(0, Math.round(s));
    const h = Math.floor(s/3600); s-=h*3600;
    const m = Math.floor(s/60); s-=m*60;
    return `${h}h ${m}m ${s}s`;
  }

  function save(){ localStorage.setItem(stateKey, JSON.stringify(state)); }
  function load(){
    try{
      const raw = localStorage.getItem(stateKey);
      if(raw){ state = JSON.parse(raw); }
    }catch(e){ console.warn('load state failed', e); }
    qs('#histNotes').value = state.histNotes||'';
    render();
  }

  function addLog(){
    const E = toMJ(qs('#logEnergyVal').value, qs('#logEnergyUnit').value);
    const dur = durToSeconds(qs('#logDuration').value, qs('#logDurationUnit').value);
    const log = {
      id: crypto.randomUUID(),
      ts: nowISO(),
      energyMJ: Number(E)||0,
      medium: qs('#logMedium').value,
      duration_s: Number(dur)||0,
      storage: qs('#logStorage').value,
      useful: Math.max(0, Math.min(1, Number(qs('#logUseful').value||0))) ,
      deployed: false,
      notes: (qs('#logNotes').value||'').trim()
    };
    state.logs.unshift(log);
    qs('#logNotes').value = '';
    save(); render();
  }
  function toggleDeploy(id){
    const it = state.logs.find(x=>x.id===id); if(!it) return;
    it.deployed = !it.deployed; save(); render();
  }
  function delLog(id){ state.logs = state.logs.filter(x=>x.id!==id); save(); render(); }

  function addInv(){
    const type = qs('#invType').value;
    const cap = Number(qs('#invCap').value)||0;
    const eta = Math.max(0, Math.min(1, Number(qs('#invEta').value||0)));
    if(cap<=0) return;
    state.inventory.push({ id: crypto.randomUUID(), type, capMJ: cap, eta, notes:'' });
    qs('#invCap').value=''; qs('#invEta').value='';
    save(); render();
  }
  function delInv(id){ state.inventory = state.inventory.filter(x=>x.id!==id); save(); render(); }

  function exportJSON(){
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = '1mj_state.json'; a.click(); URL.revokeObjectURL(url);
  }
  function importJSON(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{ state = JSON.parse(reader.result); save(); render(); }
      catch(e){ alert('Import failed: '+e.message); }
    };
    reader.readAsText(file);
  }

  function render(){
    // Clock
    qs('#now').textContent = new Date().toLocaleString();

    // Logs table & KPIs
    const medFilter = qs('#filterMedium').value || '';
    const storFilter = qs('#filterStorage').value || '';
    const tbody = qs('#logTable tbody');
    tbody.innerHTML = '';

    const logs = state.logs.filter(x => (!medFilter || x.medium===medFilter) && (!storFilter || x.storage===storFilter));

    let captured=0, deployed=0, usefulSum=0;
    const byMedium = new Map();
    logs.forEach(x=>{
      captured += x.energyMJ;
      if(x.deployed) deployed += x.energyMJ;
      usefulSum += x.energyMJ * (x.useful||0);
      byMedium.set(x.medium, (byMedium.get(x.medium)||0)+x.energyMJ);

      const tr = document.createElement('tr');
      const pwrW = x.duration_s>0 ? (x.energyMJ*1e6 / x.duration_s) : 0;
      tr.innerHTML = `
        <td>${new Date(x.ts).toLocaleString()}</td>
        <td class="right">${fmt(x.energyMJ,3)}</td>
        <td><span class="pill">${x.medium}</span></td>
        <td>${x.duration_s? secondsToHMS(x.duration_s): '—'}</td>
        <td class="right">${x.duration_s? fmt(pwrW,0): '—'}</td>
        <td>${x.storage}</td>
        <td>${x.useful? fmt(x.useful,2): '—'}</td>
        <td><input type="checkbox" ${x.deployed?'checked':''} aria-label="deployed"></td>
        <td class="small">${x.notes||''}</td>
        <td class="right">
          <button class="btn ghost small" data-del>Delete</button>
        </td>`;
      // wire listeners
      tr.querySelector('input[type="checkbox"]').addEventListener('change', ()=> toggleDeploy(x.id));
      tr.querySelector('[data-del]').addEventListener('click', ()=> delLog(x.id));
      tbody.appendChild(tr);
    });

    const eff = captured>0 ? (usefulSum/captured) : NaN;
    qs('#kpiCaptured').textContent = fmt(captured,3);
    qs('#kpiDeployed').textContent = fmt(deployed,3);
    qs('#kpiNet').textContent = fmt(captured - deployed,3);
    qs('#kpiEff').textContent = isNaN(eff)? '—' : fmt(eff,2);

    // Medium counts
    const mtxt = Array.from(byMedium.entries()).map(([k,v])=> `${k}: ${fmt(v,2)} MJ`).join(' · ');
    qs('#countByMedium').textContent = mtxt || 'No logs yet';

    // Scaling bars relative to captured
    const p10 = Math.min(1, captured/10);
    const p1000 = Math.min(1, captured/1000);
    qs('#bar10').style.width = pct(p10);
    qs('#bar10Txt').textContent = pct(p10);
    qs('#bar1000').style.width = pct(p1000);
    qs('#bar1000Txt').textContent = pct(p1000);

    // Inventory
    const invBody = qs('#invTable tbody');
    invBody.innerHTML = '';
    let usableSum = 0;
    state.inventory.forEach(it=>{
      const usable = (it.capMJ||0) * (it.eta||0);
      usableSum += usable;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${it.type}</td><td class="right">${fmt(it.capMJ,2)}</td><td class="right">${fmt(it.eta,2)}</td><td class="right">${fmt(usable,2)}</td><td class="small">${it.notes||''}</td><td class="right"><button class="btn ghost small" data-del>Remove</button></td>`;
      tr.querySelector('[data-del]').addEventListener('click', ()=> delInv(it.id));
      invBody.appendChild(tr);
    });
    qs('#storeSummary').textContent = state.inventory.length? `${state.inventory.length} items • usable ≈ ${fmt(usableSum,2)} MJ` : 'No storage items';

    // Historical notes
    state.histNotes = qs('#histNotes').value;
    save();

    // Equivalences (for 1 MJ baseline)
    const kcal = 1e6 / J_PER_KCAL; // per MJ
    qs('#eqFood').textContent = `${fmt(kcal,1)} kcal`;
    qs('#eqBulb').textContent = `${fmt(1e6/100/3600,2)} h`;
    const sprintKJ = Number(qs('#sprintKJ').value)||4;
    qs('#eqSprints').textContent = `${fmt(1000 / sprintKJ,0)} sprints`;
    const tEarth = 1e6 / EARTH_SOLAR_W; // seconds
    // format tiny time nicely
    qs('#eqEarth').textContent = tEarth < 1e-6 ? `${fmt(tEarth*1e12,2)} ps` : tEarth < 1e-3 ? `${fmt(tEarth*1e6,2)} µs` : `${fmt(tEarth,6)} s`;

    // Temporal quick (burst/h/trickle/day)
    qs('#temporalQuick').textContent = `1 MJ → 1 s: 1 MW · 1 h: 278 W · 1 day: 11.6 W`;

    // Solar calculators
    const pvW = Number(qs('#pvWatt').value)||0;
    const sunH = Number(qs('#pvSunHours').value)||0;
    const pvWh = pvW * sunH; qs('#pvWh').value = pvWh.toFixed(1);
    qs('#pvDays').textContent = pvWh>0 ? fmt(278 / pvWh,2) : '—';
    qs('#pvPanels').textContent = pvWh>0 ? fmt(278 / pvWh,2) : '—';
    const whm2 = Number(qs('#pvWhM2').value)||0;
    qs('#pvArea').textContent = whm2>0 ? `${fmt(278 / whm2,3)} m²` : '—';

    // Mechanical
    const mkg = Number(qs('#mechMass').value)||0;
    const mh = Number(qs('#mechHeight').value)||0;
    const mr = Number(qs('#mechReps').value)||0;
    const EmJ = (mkg*g*mh*mr)/1e6; // MJ
    qs('#mechMJ').textContent = fmt(EmJ,3);
    const perRepMJ = (mkg*g*mh)/1e6;
    qs('#mechRepsFor1').textContent = perRepMJ>0? fmt(1/perRepMJ,0): '—';

    // Human power to 1 MJ
    const humanW = Number(qs('#humanW').value)||0;
    const tsec = humanW>0? 1e6/humanW : 0;
    qs('#humanTime').textContent = humanW>0? secondsToHMS(tsec) : '—';

    // Water heating
    const wkg = Number(qs('#waterKg').value)||0; const dT = Number(qs('#waterDT').value)||0;
    const Ew = (wkg * J_PER_KCAL * dT) / 1000; // kJ since 1 kcal = 4184 J; but using directly:
    const Ewj = wkg * 4184 * dT; // J
    qs('#waterMJ').textContent = fmt(Ewj/1e6,3);

    // Chemical
    const eth = Number(qs('#ethLHV').value)||26.8;
    const gas = Number(qs('#gasLHV').value)||44;
    qs('#ethMass').textContent = fmt(1000/eth*1000,0); // grams for 1 MJ
    qs('#gasMass').textContent = fmt(1000/gas*1000,0);

    // Temporal calculator
    const tempMJ = Number(qs('#tempMJ').value)||0;
    const tempDur = durToSeconds(qs('#tempDur').value, qs('#tempDurUnit').value);
    const P = tempDur>0? (tempMJ*1e6)/tempDur : 0;
    qs('#tempPower').textContent = tempDur>0? `${fmt(P,0)} W` : '—';

    // Art events list
    qs('#artList').innerHTML = state.art.map(a=> `<div>• ${new Date(a.ts).toLocaleString()} — ${a.note||'Art event'} (${fmt(a.MJ,3)} MJ reference)</div>`).join('');
  }

  // Wire inputs for reactive updates
  ['pvWatt','pvSunHours','pvWhM2','mechMass','mechHeight','mechReps','humanW','waterKg','waterDT','ethLHV','gasLHV','tempMJ','tempDur','tempDurUnit','sprintKJ']
    .forEach(id=> qs('#'+id).addEventListener('input', render));

  qs('#pvWh').addEventListener('input', ()=>{
    // If user edits Wh directly, back-compute implied sun hours given fixed W
    const pvW = Number(qs('#pvWatt').value)||0; const wh = Number(qs('#pvWh').value)||0;
    if(pvW>0){ qs('#pvSunHours').value = (wh/pvW).toFixed(2); render(); }
  });

  qs('#btnAddLog').addEventListener('click', addLog);
  qs('#btnExport').addEventListener('click', exportJSON);
  qs('#importFile').addEventListener('change', e=>{ if(e.target.files[0]) importJSON(e.target.files[0]); });
  qs('#btnAddInv').addEventListener('click', addInv);
  qs('#filterMedium').addEventListener('change', render);
  qs('#filterStorage').addEventListener('change', render);
  qs('#histNotes').addEventListener('input', ()=>{ state.histNotes = qs('#histNotes').value; save(); });
  qs('#btnArt').addEventListener('click', ()=>{
    state.art.unshift({ ts: nowISO(), note: (qs('#artNote').value||'').trim(), MJ:1 });
    qs('#artNote').value=''; save(); render();
  });

  // Milestones
  ['msSeed','msStored','msDeployed'].forEach(id=>{
    const el = qs('#'+id);
    el.addEventListener('change', ()=>{ state[id]=el.checked; save(); });
  });

  // First load
  load();
  // Refresh clock every 30s
  setInterval(()=>{ qs('#now').textContent = new Date().toLocaleString(); }, 30000);
})();
</script>
</body>
</html>
