<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fantasiagenesis — Seeds</title>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:Canvas;--fg:CanvasText;--line:color-mix(in oklab,var(--fg) 14%,transparent);--card:color-mix(in oklab,var(--bg) 95%,var(--fg) 5%);--chip:color-mix(in oklab,var(--fg) 8%,transparent);--accent:color-mix(in oklab,var(--fg) 22%,transparent);--ok:#1a7f37;--r:14px}
*{box-sizing:border-box} body{margin:0;font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
header{padding:18px clamp(14px,4vw,28px);border-bottom:1px solid var(--line);display:grid;gap:8px}
h1{margin:0;font-size:clamp(1.1rem,2.6vw,1.6rem)}
.small{font-size:.9rem;opacity:.8}
.toolbar{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
.input{display:flex;align-items:center;gap:.5rem;border:1px solid var(--line);border-radius:10px;padding:.45rem .6rem;background:var(--bg);min-width:260px}
.input input{all:unset;width:240px}
a.back{color:inherit;text-decoration:none} a.back:hover{text-decoration:underline}
main{padding:18px clamp(14px,4vw,28px);display:grid;gap:12px;max-width:1200px;margin:0 auto}
.grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:12px;display:grid;gap:8px}
.card h3{margin:.2rem 0 .3rem;font-size:1rem}
.row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
.kv{display:grid;gap:6px}
.kv .row{display:flex;gap:.5rem;align-items:flex-start}
.kv .k{width:92px;opacity:.75;font-weight:600}
.kv .v{flex:1}
.chip{display:inline-flex;gap:.35rem;align-items:center;padding:.16rem .52rem;border-radius:999px;background:var(--chip);font-size:.78rem}
.btn{border:1px solid var(--line);background:var(--bg);border-radius:10px;padding:.45rem .75rem;cursor:pointer;font-weight:700}
.btn[disabled]{opacity:.55;cursor:not-allowed}
.published{color:var(--ok);font-weight:700}
.empty{border:2px dashed var(--line);border-radius:12px;padding:18px;text-align:center;opacity:.8}
.progress{height:6px;background:var(--chip);border-radius:999px;overflow:hidden}
.bar{height:100%;width:0%;background:var(--accent);transition:width .2s}
</style>
</head>
<body>
<header>
  <div class="small"><a class="back" id="back" href="domains.html">← Back</a></div>
  <h1 id="title">Seeds</h1>
  <div class="small" id="subtitle"></div>
  <div class="toolbar">
    <label class="input" title="Filter by problem/objective/solution/provider">
      <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5 1.5-1.5zM4 9.5C4 6.46 6.46 4 9.5 4S15 6.46 15 9.5 12.54 15 9.5 15 4 12.54 4 9.5"/></svg>
      <input id="q" placeholder="Filter seeds…"/>
    </label>
    <span class="chip"><span id="count">0</span> total</span>
    <span class="chip"><span id="pubCount">0</span> with Box</span>
  </div>
  <div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>
</header>
<main>
  <div id="list" class="grid" role="list"></div>
  <div id="empty" class="empty" hidden>No seeds found for this dimension.</div>
</main>
<script>
(function(){
  const p=new URLSearchParams(location.search);
  const dimension_id=Number(p.get('dimension_id')||'0');
  const dim_title=p.get('title')||'';
  const domain_title=p.get('domain')||'';
  document.getElementById('title').textContent = dim_title ? `Seeds — ${dim_title}` : 'Seeds';
  document.getElementById('subtitle').textContent = [domain_title?`Domain: ${domain_title}`:'', dim_title?`Dimension: ${dim_title}`:''].filter(Boolean).join(' • ');
  document.getElementById('back').href = domain_title ? `dimensions.html?narrative_id=&title=${encodeURIComponent(domain_title)}` : 'domains.html';

  const $list=document.getElementById('list'), $empty=document.getElementById('empty'), $q=document.getElementById('q');
  const $count=document.getElementById('count'), $pub=document.getElementById('pubCount'), $bar=document.getElementById('bar');

  if(!dimension_id){ $empty.hidden=false; $empty.textContent='Missing dimension_id.'; return; }

  let DATA=[], PUB=0, SCANNED=0, TOTAL=0;
  const fetchJSON=async(u)=>{const r=await fetch(u,{headers:{'Accept':'application/json'}}); if(!r.ok) throw new Error(u+' -> '+r.status); return r.json();};
  function esc(s) {
  return (s ?? '')
    .toString()
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

  function setProgress(){ const pct = TOTAL? Math.min(100, Math.round(SCANNED*100/TOTAL)) : 0; $bar.style.width=pct+'%'; }

  function card(s){
    const div=document.createElement('div'); div.className='card'; div.setAttribute('role','listitem');
    div.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3>Seed #${s.id}</h3>
        <span class="chip">${esc(s.provider||'')}</span>
      </div>
      <div class="kv">
        <div class="row"><div class="k">Problem</div><div class="v">${esc(s.problem)}</div></div>
        <div class="row"><div class="k">Objective</div><div class="v">${esc(s.objective)}</div></div>
        <div class="row"><div class="k">Solution</div><div class="v">${esc(s.solution)}</div></div>
      </div>
      <div class="row small" style="opacity:.75">Created: ${esc(s.created_at||'')}</div>
      <div class="row">
        <button class="btn" data-open disabled>Open Box</button>
        <span class="chip" data-status>checking…</span>
      </div>
    `;
    // After publication check, we toggle button
    (async ()=>{
      try{
        const rows = await fetchJSON(`/api/seeds/${s.id}/boxes`);
        const published = Array.isArray(rows) && rows.some(r=>r.is_published===true || r.is_published===1);
        SCANNED++; setProgress();
        const btn = div.querySelector('[data-open]'); const lab = div.querySelector('[data-status]');
        if(published){
          PUB++; $pub.textContent=String(PUB);
          btn.disabled=false; btn.addEventListener('click',()=>window.open(`https://fantasiagenesis.com/boxes/${s.id}`,'_blank','noopener'));
          lab.textContent='published'; lab.classList.add('published');
        }else{
          lab.textContent='no box';
        }
      }catch(e){
        SCANNED++; setProgress();
        const lab = div.querySelector('[data-status]'); lab.textContent='error';
      }
    })();
    return div;
  }

  function render(items){
    $list.innerHTML=''; if(!items.length){$empty.hidden=false;$count.textContent='0';return;}
    $empty.hidden=true; const f=document.createDocumentFragment(); items.forEach(s=>f.appendChild(card(s))); $list.appendChild(f); $count.textContent=String(items.length);
    PUB=0; SCANNED=0; TOTAL=items.length; setProgress();
  }

  function filter(){
    const t=($q.value||'').toLowerCase().trim(); 
    if(!t) return render(DATA);
    render(DATA.filter(s => [s.problem,s.objective,s.solution,s.provider,s.id].map(x=>String(x||'').toLowerCase()).join(' ').includes(t)));
  }
  $q.addEventListener('input', filter);

  (async ()=>{
    try{
      const resp = await fetchJSON(`/api/dimensions/${dimension_id}/seeds`);
      DATA = (resp && resp.seeds) ? resp.seeds : [];
      render(DATA);
    }catch(e){ console.error(e); $empty.hidden=false; $empty.textContent='Failed to load seeds.'; }
  })();
})();
</script>
</body>
</html>
