<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dirt</title>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: Canvas; color: CanvasText;
    }
    header {
      padding: .9rem 1rem;
      border-bottom: 1px solid color-mix(in oklab, CanvasText 12%, transparent);
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
    }
    header h1 { margin:0; font-size:1.05rem; font-weight:700; letter-spacing:.02em; }
    main { padding: 1rem; display:grid; gap:1rem; max-width:1200px; margin:0 auto; }
    .grid { display:grid; gap:1rem; }
    .cols-2 { grid-template-columns: 420px 1fr; }
    @media (max-width: 1000px){ .cols-2 { grid-template-columns: 1fr; } }

    .card {
      border:1px solid color-mix(in oklab, CanvasText 14%, transparent);
      border-radius:.6rem; background: color-mix(in oklab, Canvas 94%, CanvasText 6%);
      box-shadow: 0 1px 0 rgba(0,0,0,.04) inset;
    }
    .card header { padding:.6rem .75rem; border-bottom:1px solid color-mix(in oklab, CanvasText 12%, transparent); }
    .card header h2 { margin:0; font-size:.95rem; font-weight:650; }
    .card .body { padding:.75rem; display:grid; gap:.6rem; }
    label { font-size:.85rem; opacity:.9; display:block; margin-bottom:.25rem; }
    select, input[type="text"], input[type="number"], textarea {
      width:100%; padding:.55rem .6rem; border-radius:.5rem;
      border:1px solid color-mix(in oklab, CanvasText 18%, transparent);
      background: color-mix(in oklab, Canvas 96%, CanvasText 4%); color: inherit;
    }
    textarea { min-height: 120px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.9rem; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:.6rem; }
    @media (max-width: 600px){ .row { grid-template-columns: 1fr; } }
    .actions { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    button {
      padding:.55rem .8rem; border-radius:.5rem; border:1px solid color-mix(in oklab, CanvasText 18%, transparent);
      background: color-mix(in oklab, Canvas 92%, CanvasText 8%); color: inherit; cursor:pointer;
    }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .muted { font-size:.85rem; opacity:.75; }
    .ok { color: color-mix(in oklab, CanvasText 20%, lime); }
    .err { color: color-mix(in oklab, CanvasText 20%, red); }
    .pill { display:inline-block; padding:.2rem .5rem; border:1px solid color-mix(in oklab, CanvasText 18%, transparent);
            border-radius:999px; font-size:.75rem; background: color-mix(in oklab, Canvas 96%, CanvasText 4%); }
    .toolbar { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    .spacer { flex:1; }
    .codeblock {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: .9rem;
      line-height: 1.35;
      white-space: pre-wrap;
      word-wrap: break-word;
      border: 1px solid color-mix(in oklab, CanvasText 14%, transparent);
      background: color-mix(in oklab, Canvas 98%, CanvasText 2%);
      border-radius: .5rem;
      padding: .75rem;
      max-height: 55vh;
      overflow: auto;
      user-select: text;
    }
    .threecol { display:grid; gap:.6rem; grid-template-columns: 1fr 1fr 1fr; }
    @media (max-width: 1100px){ .threecol { grid-template-columns: 1fr; } }
    .small { font-size:.85rem; }
  </style>
</head>
<body>
  <header>
    <h1>Dirt</h1>
    <div class="muted">Create draft or publish immediately • Preview included</div>
  </header>

  <main class="grid cols-2">
    <!-- Left: Seed selection -->
    <section class="card" aria-labelledby="h-select">
      <header><h2 id="h-select">Select Seed</h2></header>
      <div class="body">
        <div class="row">
          <div>
            <label for="domainSelect">Domain</label>
            <select id="domainSelect"><option value="">Loading…</option></select>
          </div>
          <div>
            <label for="dimensionSelect">Dimension</label>
            <select id="dimensionSelect" disabled><option value="">Select a domain</option></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="seedSelect">Seed</label>
            <select id="seedSelect" disabled><option value="">Select a dimension</option></select>
          </div>
          <div>
            <label for="seedIdInput">Or enter Seed ID directly</label>
            <input id="seedIdInput" type="number" placeholder="e.g., 123"/>
          </div>
        </div>
        <div class="toolbar">
          <span id="selStatus" class="muted"></span>
        </div>
      </div>
    </section>

    <!-- Right: Selected Context -->
    <section class="card" aria-labelledby="h-context">
      <header><h2 id="h-context">Selected Context</h2></header>
      <div class="body" id="contextBody">
        <div id="ctxDomain">
          <div class="muted">Domain</div>
          <div id="ctxDomainTitle">—</div>
        </div>
        <hr style="border:none; border-top:1px solid color-mix(in oklab, CanvasText 12%, transparent); margin:.5rem 0;">
        <div id="ctxDimension">
          <div class="muted">Dimension</div>
          <div id="ctxDimTitle">—</div>
          <div id="ctxDimDesc" class="muted" style="margin-top:.15rem;"></div>
        </div>
        <hr style="border:none; border-top:1px solid color-mix(in oklab, CanvasText 12%, transparent); margin:.5rem 0;">
        <div id="ctxSeed">
          <div class="muted">Seed</div>
          <div id="ctxSeedA" style="white-space:pre-wrap;"></div>
          <div id="ctxSeedB" style="white-space:pre-wrap; margin-top:.25rem;"></div>
          <div id="ctxSeedL" style="white-space:pre-wrap; margin-top:.25rem;"></div>
        </div>
      </div>
    </section>

    <!-- Narrative Prototype -->
    <section class="card" aria-labelledby="h-proto">
      <header><h2 id="h-proto">Narrative Prototype</h2></header>
      <div class="body">
        <div class="actions">
          <button id="genProtoBtn">Generate Prototype</button>
          <span id="protoStatus" class="muted"></span>
        </div>
        <div id="protoWrap" hidden style="border:1px solid color-mix(in oklab, CanvasText 14%, transparent);
             border-radius:.6rem; padding:.75rem; background: color-mix(in oklab, Canvas 96%, CanvasText 4%); display:grid; gap:.5rem;">
          <div id="protoCore" style="white-space:pre-wrap;"></div>
          <div id="protoBuild" style="white-space:pre-wrap;"></div>
          <div id="protoTest" style="white-space:pre-wrap;"></div>
          <div id="protoEyes"></div>
          <div id="protoWhy" style="white-space:pre-wrap;"></div>
        </div>
      </div>
    </section>

    <!-- Deployment & Artifacts -->
    <section class="card" aria-labelledby="h-artifacts">
      <header><h2 id="h-artifacts">Deployment & Box-of-Dirt Artifacts</h2></header>
      <div class="body">
        <div class="actions">
          <button id="genArtifactsBtn">Generate Artifacts (Markdown)</button>
          <span id="artifactsStatus" class="muted"></span>
        </div>
        <pre id="artifactsMd" class="codeblock" tabindex="0" style="min-height:180px;"></pre>
      </div>
    </section>

    <!-- NEW: Real-World Validation -->
    <section class="card" aria-labelledby="h-validate">
      <header><h2 id="h-validate">Real-World Validation</h2></header>
      <div class="body">
        <div class="actions small">
          <button id="loadFromSelectionBtn" title="Prefill fields from the current Domain/Dimension/Seed">Load from selection</button>
          <span class="muted">POST <span class="pill">/api/narrative-validation</span></span>
          <span id="valStatus" class="muted"></span>
        </div>

        <div class="row">
          <div>
            <label for="valDomain">Domain</label>
            <input id="valDomain" type="text" placeholder="Domain label"/>
          </div>
          <div>
            <label for="valDimension">Dimension</label>
            <input id="valDimension" type="text" placeholder="Dimension label"/>
          </div>
        </div>

        <div>
          <label for="valProblem">Problem</label>
          <textarea id="valProblem" placeholder="A (Problem)…"></textarea>
        </div>
        <div>
          <label for="valObjective">Objective</label>
          <textarea id="valObjective" placeholder="B (Objective)…"></textarea>
        </div>
        <div>
          <label for="valSolution">Solution (Link)</label>
          <textarea id="valSolution" placeholder="Solution (Link)…"></textarea>
        </div>

        <div class="actions">
          <button id="runValidationBtn">Run Validation</button>
          <span id="valRunNote" class="muted"></span>
        </div>

        <div id="valPretty" class="threecol" style="margin-top:.25rem;"></div>
        <div>
          <label class="muted" for="valRaw">Raw JSON</label>
          <pre id="valRaw" class="codeblock" tabindex="0" style="min-height:140px;"></pre>
        </div>
      </div>
    </section>
  </main>

  <script>
  (function(){
    const els = {
      domain: document.getElementById('domainSelect'),
      dimension: document.getElementById('dimensionSelect'),
      seed: document.getElementById('seedSelect'),
      seedIdInput: document.getElementById('seedIdInput'),
      selStatus: document.getElementById('selStatus'),

      // Prototype
      genProtoBtn: document.getElementById('genProtoBtn'),
      protoStatus: document.getElementById('protoStatus'),
      protoWrap: document.getElementById('protoWrap'),
      protoCore: document.getElementById('protoCore'),
      protoBuild: document.getElementById('protoBuild'),
      protoTest: document.getElementById('protoTest'),
      protoEyes: document.getElementById('protoEyes'),
      protoWhy: document.getElementById('protoWhy'),

      // Context
      ctxDomainTitle: document.getElementById('ctxDomainTitle'),
      ctxDimTitle: document.getElementById('ctxDimTitle'),
      ctxDimDesc: document.getElementById('ctxDimDesc'),
      ctxSeedA: document.getElementById('ctxSeedA'),
      ctxSeedB: document.getElementById('ctxSeedB'),
      ctxSeedL: document.getElementById('ctxSeedL'),

      // Artifacts
      genArtifactsBtn: document.getElementById('genArtifactsBtn'),
      artifactsStatus: document.getElementById('artifactsStatus'),
      artifactsMd: document.getElementById('artifactsMd'),

      // Validation
      loadFromSelectionBtn: document.getElementById('loadFromSelectionBtn'),
      valStatus: document.getElementById('valStatus'),
      valDomain: document.getElementById('valDomain'),
      valDimension: document.getElementById('valDimension'),
      valProblem: document.getElementById('valProblem'),
      valObjective: document.getElementById('valObjective'),
      valSolution: document.getElementById('valSolution'),
      runValidationBtn: document.getElementById('runValidationBtn'),
      valRunNote: document.getElementById('valRunNote'),
      valPretty: document.getElementById('valPretty'),
      valRaw: document.getElementById('valRaw'),
    };

    const API = {
      narratives: '/api/narratives',
      dims: (nid) => `/api/narratives/${encodeURIComponent(nid)}/dimensions`,
      seeds: (did) => `/api/dimensions/${encodeURIComponent(did)}/seeds`,
      validate: '/api/narrative-validation',
      bodArtifacts: '/api/box-of-dirt/artifacts',
    };

    let cache = { narratives: [], dims: new Map(), seeds: new Map() };

    // Helpers
    function stripHashId(name){
      return String(name||'').replace(/\s*\(#\d+\)\s*$/, '');
    }
    function composeSeedText(seedRow){
      const A = seedRow?.problem ? `A (Problem): ${seedRow.problem}` : '';
      const B = seedRow?.objective ? `B (Objective): ${seedRow.objective}` : '';
      const L = seedRow?.solution ? `Solution (Link): ${seedRow.solution}` : '';
      return [A,B,L].filter(Boolean).join('\n');
    }
    function composePrototypeText(p){
      const lines = [];
      if (p.core_intent) lines.push(`Core Intent — ${p.core_intent}`);
      if (p.minimal_build) lines.push(`Minimal Build — ${p.minimal_build}`);
      const panels = Array.isArray(p.panels) ? p.panels
                  : Array.isArray(p.scenes) ? p.scenes
                  : Array.isArray(p.storyboard) ? p.storyboard
                  : [];
      panels.forEach((item, i) => {
        if (typeof item === 'string'){
          lines.push(`Panel ${i+1} — ${item}`);
        } else if (item && (item.title || item.heading)){
          const title = item.title || item.heading || `Panel ${i+1}`;
          lines.push(`Panel ${i+1} — ${title}`);
          const bullets = Array.isArray(item.bullets) ? item.bullets
                        : Array.isArray(item.points) ? item.points
                        : [];
          bullets.forEach(b => lines.push(`- ${b}`));
          if (item.caption) lines.push(item.caption);
        }
      });
      if (p.load_bearing_test) lines.push(`Load-Bearing Test — ${p.load_bearing_test}`);
      if (p.validating_reactions){
        if (Array.isArray(p.validating_reactions)){
          lines.push('Validating reactions we want —'); p.validating_reactions.forEach(x => lines.push(`- ${x}`));
        } else { lines.push(`Validating reactions we want — ${p.validating_reactions}`); }
      }
      if (p.red_flags){
        if (Array.isArray(p.red_flags)){
          lines.push('Red flags (invalidate) —'); p.red_flags.forEach(x => lines.push(`- ${x}`));
        } else { lines.push(`Red flags (invalidate) — ${p.red_flags}`); }
      }
      if (p.first_eyes){
        if (Array.isArray(p.first_eyes)){
          lines.push('First Eyes —'); p.first_eyes.forEach(x => lines.push(`- ${x}`));
        } else { lines.push(`First Eyes — ${p.first_eyes}`); }
      }
      if (p.why_box_of_dirt) lines.push(`Why This is a Box of Dirt — ${p.why_box_of_dirt}`);
      return lines.join('\n');
    }
    function setStatus(el, msg, ok){
      el.textContent = msg || '';
      el.classList.remove('ok','err');
      if (!msg) return;
      el.classList.add(ok ? 'ok' : 'err');
    }
    async function fetchJSON(url){
      const res = await fetch(url, { headers: { 'Accept':'application/json' }});
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    // Deep-link helpers
    async function resolveNarrativeIdByDimensionId(did) {
      for (const n of (cache.narratives || [])) {
        try {
          let dims = cache.dims.get(String(n.id));
          if (!dims) {
            dims = await fetchJSON(`/api/narratives/${encodeURIComponent(n.id)}/dimensions`);
            cache.dims.set(String(n.id), dims);
          }
          if (Array.isArray(dims) && dims.some(d => String(d.id) === String(did))) {
            return String(n.id);
          }
        } catch (e) {}
      }
      return null;
    }
    async function resolveDimensionAndNarrativeBySeedId(sid) {
      for (const n of (cache.narratives || [])) {
        let dims = cache.dims.get(String(n.id));
        if (!dims) {
          try {
            dims = await fetchJSON(`/api/narratives/${encodeURIComponent(n.id)}/dimensions`);
            cache.dims.set(String(n.id), dims);
          } catch (e) { continue; }
        }
        for (const d of (dims || [])) {
          try {
            const payload = await fetchJSON(`/api/dimensions/${encodeURIComponent(d.id)}/seeds`);
            const seeds = Array.isArray(payload?.seeds) ? payload.seeds : [];
            if (seeds.some(s => String(s.id) === String(sid))) {
              return { nid: String(n.id), did: String(d.id) };
            }
          } catch (e) {}
        }
      }
      return null;
    }
    async function maybeDeepLink() {
      const params = new URLSearchParams(location.search);
      let nid = params.get('nid');
      let did = params.get('did');
      let sid = params.get('sid');

      if (!nid && did) nid = await resolveNarrativeIdByDimensionId(did);
      if ((!nid || !did) && sid) {
        const found = await resolveDimensionAndNarrativeBySeedId(sid);
        if (found) { nid = nid || found.nid; did = did || found.did; }
      }
      if (!nid) return;

      els.domain.value = String(nid);
      await onDomainChange();
      if (did) {
        els.dimension.value = String(did);
        await onDimensionChange();
      }
      if (sid) {
        els.seed.value = String(sid);
        els.seedIdInput.value = String(sid);
      }
      renderContext();
    }

    // Loaders
    async function loadNarratives(){
      try{
        const rows = await fetchJSON(API.narratives);
        cache.narratives = rows;
        els.domain.innerHTML = `<option value="">Select…</option>` +
          rows.map(r => `<option value="${r.id}">${escapeHTML(r.title)} (#${r.id})</option>`).join('');
      }catch(e){
        els.domain.innerHTML = `<option value="">Failed to load narratives</option>`;
      }
    }
    async function onDomainChange(){
      const nid = els.domain.value;
      els.dimension.disabled = !nid;
      els.seed.disabled = true;
      els.dimension.innerHTML = `<option value="">${nid ? 'Loading…' : 'Select a domain'}</option>`;
      els.seed.innerHTML = `<option value="">Select a dimension</option>`;
      if (!nid) return;
      try{
        const dims = await fetchJSON(API.dims(nid));
        cache.dims.set(nid, dims);
        els.dimension.innerHTML = `<option value="">Select…</option>` +
          dims.map(d => `<option value="${d.id}">${escapeHTML(d.title)} (#${d.id})</option>`).join('');
        renderContext();
      }catch(e){
        els.dimension.innerHTML = `<option value="">Failed to load dimensions</option>`;
      }
    }
    async function onDimensionChange(){
      const did = els.dimension.value;
      els.seed.disabled = !did;
      els.seed.innerHTML = `<option value="">${did ? 'Loading…' : 'Select a dimension'}</option>`;
      if (!did) return;
      try{
        const payload = await fetchJSON(`/api/dimensions/${encodeURIComponent(did)}/seeds`);
        const seeds = Array.isArray(payload?.seeds) ? payload.seeds : [];
        cache.seeds.set(did, seeds);
        els.seed.innerHTML = `<option value="">Select…</option>` +
          seeds.map(s => `<option value="${s.id}">${escapeHTML((s.problem||'Seed'))} (#${s.id})</option>`).join('');
        renderContext();
      }catch(e){
        els.seed.innerHTML = `<option value="">Failed to load seeds</option>`;
      }
    }
    function currentSeedId(){
      const fromSelect = els.seed.value && Number(els.seed.value);
      const fromInput = els.seedIdInput.value && Number(els.seedIdInput.value);
      return fromSelect || fromInput || null;
    }

    // Prototype generation
    async function generatePrototypeAndBuild(){
      const nid = els.domain.value;
      const did = els.dimension.value;
      const sid = els.seed.value;

      const domainRow = (cache.narratives || []).find(n => String(n.id) === String(nid));
      const dims = cache.dims.get(nid) || [];
      const dimRow = dims.find(d => String(d.id) === String(did));
      const seeds = cache.seeds.get(did) || [];
      const seedRow = seeds.find(s => String(s.id) === String(sid));

      const errs = [];
      if (!domainRow) errs.push('domain');
      if (!dimRow) errs.push('dimension');
      if (!seedRow) errs.push('seed');
      if (errs.length){
        els.protoStatus.textContent = `Select a ${errs.join(', ')} first.`;
        els.protoWrap.hidden = true;
        return;
      }

      els.genProtoBtn.disabled = true;
      els.protoStatus.textContent = 'Generating…';
      els.protoWrap.hidden = true;

      try{
        const protoRes = await fetch('/api/narrative-prototype', {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify({
            domain: stripHashId(domainRow.title || `Narrative ${domainRow.id}`),
            dimension: stripHashId(dimRow.title || `Dimension ${dimRow.id}`),
            seed: {
              problem: seedRow.problem || '',
              objective: seedRow.objective || '',
              solution: seedRow.solution || ''
            }
          })
        });
        if (!protoRes.ok) throw new Error(`HTTP ${protoRes.status}`);
        const out = await protoRes.json();
        const p = out.prototype || out;

        els.protoCore.innerText  = p.core_intent ? `Core Intent — ${p.core_intent}` : '';
        els.protoBuild.innerText = p.minimal_build ? `Minimal Build — ${p.minimal_build}` : '';
        els.protoTest.innerText  = p.load_bearing_test ? `Load-Bearing Test — ${p.load_bearing_test}` : '';
        if (Array.isArray(p.first_eyes)) {
          els.protoEyes.innerHTML = `<div style="font-weight:600;">First Eyes —</div>` +
            `<ul style="margin:.25rem 0 .5rem .95rem; padding:0;">` +
            p.first_eyes.map(x => `<li>${String(x)}</li>`).join('') + `</ul>`;
        } else {
          els.protoEyes.textContent = p.first_eyes ? `First Eyes — ${p.first_eyes}` : '';
        }
        els.protoWhy.innerText = p.why_box_of_dirt ? `Why This is a Box of Dirt — ${p.why_box_of_dirt}` : '';
        els.protoWrap.hidden = false;
        els.protoStatus.textContent = '';
      }catch(e){
        els.protoStatus.textContent = 'Error: ' + e.message;
        els.protoWrap.hidden = true;
      }finally{
        els.genProtoBtn.disabled = false;
      }
    }

    // Artifacts (Markdown only, per your prior setup)
    async function generateArtifactsAndPage() {
      const nid = els.domain.value;
      const did = els.dimension.value;
      const sid = els.seed.value || els.seedIdInput.value;

      const domainRow = (cache.narratives || []).find(n => String(n.id) === String(nid));
      const dims      = cache.dims.get(nid) || [];
      const dimRow    = dims.find(d => String(d.id) === String(did));
      const seeds     = cache.seeds.get(did) || [];
      const seedRow   = seeds.find(s => String(s.id) === String(sid));

      const missing = [];
      if (!domainRow) missing.push("domain");
      if (!dimRow) missing.push("dimension");
      if (!seedRow) missing.push("seed");
      if (missing.length) {
        els.artifactsStatus.textContent = `Select a ${missing.join(", ")} first.`;
        els.artifactsStatus.classList.remove('ok'); els.artifactsStatus.classList.add('err');
        return;
      }

      const domain    = stripHashId(domainRow.title || '');
      const dimension = stripHashId(dimRow.title || '');
      const seedThree = composeSeedText(seedRow);

      els.artifactsStatus.textContent = 'Generating artifacts…';
      els.artifactsMd.textContent = '';
      els.genArtifactsBtn.disabled = true;

      try {
        const artRes = await fetch(API.bodArtifacts, {
          method:'POST',
          headers:{'Content-Type':'application/json', 'Accept':'text/markdown'},
          body: JSON.stringify({ domain, dimension, seed: seedThree })
        });
        if (!artRes.ok) throw new Error(`Artifacts HTTP ${artRes.status}`);
        const md = await artRes.text();
        els.artifactsMd.textContent = md;

        els.artifactsStatus.textContent = 'OK — artifacts generated';
        els.artifactsStatus.classList.add('ok');
      } catch(e) {
        els.artifactsStatus.textContent = 'Error: '+e.message;
        els.artifactsStatus.classList.remove('ok'); els.artifactsStatus.classList.add('err');
      } finally {
        els.genArtifactsBtn.disabled = false;
      }
    }

    // === Validation card logic ===
    function getSelectedRows(){
      const nid = els.domain.value;
      const did = els.dimension.value;
      const sid = els.seed.value;
      const domainRow = (cache.narratives || []).find(n => String(n.id) === String(nid));
      const dims = cache.dims.get(nid) || [];
      const dimRow = dims.find(d => String(d.id) === String(did));
      const seeds = cache.seeds.get(did) || [];
      const seedRow = seeds.find(s => String(s.id) === String(sid));
      return { domainRow, dimRow, seedRow };
    }

    function prefillValidationFromSelection(){
      const { domainRow, dimRow, seedRow } = getSelectedRows();
      let missing = [];
      if (!domainRow) missing.push('domain');
      if (!dimRow) missing.push('dimension');
      if (!seedRow) missing.push('seed');
      if (missing.length){
        setStatus(els.valStatus, `Select a ${missing.join(', ')} first.`, false);
        return;
      }
      setStatus(els.valStatus, '', false);
      els.valDomain.value    = stripHashId(domainRow.title || '');
      els.valDimension.value = stripHashId(dimRow.title || '');
      els.valProblem.value   = seedRow.problem   || '';
      els.valObjective.value = seedRow.objective || '';
      els.valSolution.value  = seedRow.solution  || '';
    }

    function renderValidationPretty(payload){
      // payload.validation = { problem_validation:[], objective_measurement:[], solution_justification:[] }
      const v = payload && payload.validation;
      els.valPretty.innerHTML = '';
      if (!v) return;

      const blocks = [
        ['Problem Validation', v.problem_validation],
        ['Objective Measurement', v.objective_measurement],
        ['Solution Justification', v.solution_justification],
      ];

      const sectionHTML = (title, arr=[]) => {
        if (!Array.isArray(arr) || arr.length === 0) {
          return `<div class="card"><div class="body"><div class="muted">${title}</div><div class="muted">No items.</div></div></div>`;
        }
        const items = arr.map(item => {
          const metric = escapeHTML(item.metric || '');
          const desc = item.description ? `<div class="muted small" style="margin:.15rem 0 .25rem;">${escapeHTML(item.description)}</div>` : '';
          const datasets = Array.isArray(item.datasets) ? item.datasets : [];
          const dsList = datasets.map(ds => {
            const name = escapeHTML(ds.name || '');
            const org = escapeHTML(ds.organization || '');
            const notes = ds.notes ? ` — <span class="muted">${escapeHTML(ds.notes)}</span>` : '';
            const url = ds.url ? `<div class="muted small">${escapeHTML(ds.url)}</div>` : '';
            return `<li><strong>${name}</strong> <span class="muted">(${org})</span>${notes}${url}</li>`;
          }).join('');
          return `<li style="margin:.4rem 0;">
            <div><strong>${metric}</strong></div>
            ${desc}
            ${dsList ? `<ul style="margin:.25rem 0 .25rem 1rem; padding:0;">${dsList}</ul>` : ''}
          </li>`;
        }).join('');
        return `<div class="card">
          <div class="body">
            <div style="font-weight:650;">${title}</div>
            <ul style="margin:.25rem 0 0 1rem; padding:0;">${items}</ul>
          </div>
        </div>`;
      };

      els.valPretty.innerHTML = blocks.map(([t,a]) => sectionHTML(t,a)).join('');
    }

    async function runValidation(){
      const domain    = (els.valDomain.value || '').trim();
      const dimension = (els.valDimension.value || '').trim();
      const problem   = (els.valProblem.value || '').trim();
      const objective = (els.valObjective.value || '').trim();
      const solution  = (els.valSolution.value || '').trim();
      const provider  = 'openai_web';

      const missing = [];
      if (!domain)    missing.push('domain');
      if (!dimension) missing.push('dimension');
      if (!problem)   missing.push('problem');
      if (!objective) missing.push('objective');
      if (!solution)  missing.push('solution');
      if (missing.length){
        setStatus(els.valStatus, `Missing: ${missing.join(', ')}`, false);
        return;
      }

      setStatus(els.valStatus, 'Running…', false);
      els.runValidationBtn.disabled = true;
      els.valRunNote.textContent = '';
      els.valRaw.textContent = '';
      els.valPretty.innerHTML = '';

      try{
        const res = await fetch(API.validate, {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify({ domain, dimension, problem, objective, solution, provider })
        });
        const text = await res.text();
        let payload = null;
        try { payload = JSON.parse(text); } catch(e){ /* keep raw */ }

        els.valRaw.textContent = prettyJSON(text);

        if (!res.ok){
          setStatus(els.valStatus, `HTTP ${res.status}`, false);
        } else if (payload && payload.error){
          setStatus(els.valStatus, payload.error, false);
        } else {
          setStatus(els.valStatus, 'OK', true);
          if (payload && payload.ok){
            renderValidationPretty(payload);
          }
        }
      }catch(e){
        setStatus(els.valStatus, e.message, false);
      }finally{
        els.runValidationBtn.disabled = false;
      }
    }

    function prettyJSON(raw){
      try { return JSON.stringify(JSON.parse(raw), null, 2); }
      catch(_) { return raw; }
    }

    function renderContext(){
      const nid = els.domain.value;
      const domainRow = (cache.narratives || []).find(n => String(n.id) === String(nid));
      els.ctxDomainTitle.textContent = domainRow ? `${domainRow.title} (#${domainRow.id})` : '—';

      const did = els.dimension.value;
      const dims = cache.dims.get(nid) || [];
      const dimRow = dims.find(d => String(d.id) === String(did));
      els.ctxDimTitle.textContent = dimRow ? `${dimRow.title} (#${dimRow.id})` : '—';
      els.ctxDimDesc.textContent = dimRow?.description ? String(dimRow.description) : '';

      const sid = els.seed.value;
      const seeds = cache.seeds.get(did) || [];
      const seedRow = seeds.find(s => String(s.id) === String(sid));

      const A = seedRow?.problem || '';
      const B = seedRow?.objective || '';
      const L = seedRow?.solution || '';

      els.ctxSeedA.textContent = A ? `A (Problem): ${A}` : '';
      els.ctxSeedB.textContent = B ? `B (Objective): ${B}` : '';
      els.ctxSeedL.textContent = L ? `Solution (Link): ${L}` : '';
    }

    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, c => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[c]));
    }

    // Wiring
    els.domain.addEventListener('change', onDomainChange);
    els.dimension.addEventListener('change', onDimensionChange);
    els.seed.addEventListener('change', ()=>{
      setStatus(els.selStatus, '', false);
      els.seedIdInput.value = els.seed.value || '';
      renderContext();
    });
    els.seedIdInput.addEventListener('input', ()=>{
      setStatus(els.selStatus, '', false);
      renderContext();
    });

    els.genProtoBtn.addEventListener('click', generatePrototypeAndBuild);
    els.genArtifactsBtn.addEventListener('click', generateArtifactsAndPage);

    // Validation events
    els.loadFromSelectionBtn.addEventListener('click', prefillValidationFromSelection);
    els.runValidationBtn.addEventListener('click', runValidation);

    // Boot
    loadNarratives().then(maybeDeepLink);
    renderContext();
  })();
  </script>
</body>
</html>
