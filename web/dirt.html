<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dirt</title>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: Canvas; color: CanvasText;
    }
    header {
      padding: .9rem 1rem;
      border-bottom: 1px solid color-mix(in oklab, CanvasText 12%, transparent);
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
    }
    header h1 { margin:0; font-size:1.05rem; font-weight:700; letter-spacing:.02em; }
    main { padding: 1rem; display:grid; gap:1rem; max-width:1200px; margin:0 auto; }
    .grid { display:grid; gap:1rem; }
    .cols-2 { grid-template-columns: 420px 1fr; }
    @media (max-width: 1000px){ .cols-2 { grid-template-columns: 1fr; } }

    .card {
      border:1px solid color-mix(in oklab, CanvasText 14%, transparent);
      border-radius:.6rem; background: color-mix(in oklab, Canvas 94%, CanvasText 6%);
      box-shadow: 0 1px 0 rgba(0,0,0,.04) inset;
    }
    .card header { padding:.6rem .75rem; border-bottom:1px solid color-mix(in oklab, CanvasText 12%, transparent); }
    .card header h2 { margin:0; font-size:.95rem; font-weight:650; }
    .card .body { padding:.75rem; display:grid; gap:.6rem; }
    label { font-size:.85rem; opacity:.9; display:block; margin-bottom:.25rem; }
    select, input[type="text"], input[type="number"], textarea {
      width:100%; padding:.55rem .6rem; border-radius:.5rem;
      border:1px solid color-mix(in oklab, CanvasText 18%, transparent);
      background: color-mix(in oklab, Canvas 96%, CanvasText 4%); color: inherit;
    }
    textarea { min-height: 120px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.9rem; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:.6rem; }
    @media (max-width: 600px){ .row { grid-template-columns: 1fr; } }
    .actions { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    button {
      padding:.55rem .8rem; border-radius:.5rem; border:1px solid color-mix(in oklab, CanvasText 18%, transparent);
      background: color-mix(in oklab, Canvas 92%, CanvasText 8%); color: inherit; cursor:pointer;
    }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .muted { font-size:.85rem; opacity:.75; }
    .ok { color: color-mix(in oklab, CanvasText 20%, lime); }
    .err { color: color-mix(in oklab, CanvasText 20%, red); }
    .pill { display:inline-block; padding:.2rem .5rem; border:1px solid color-mix(in oklab, CanvasText 18%, transparent);
            border-radius:999px; font-size:.75rem; background: color-mix(in oklab, Canvas 96%, CanvasText 4%); }
    .toolbar { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    .spacer { flex:1; }
    .codeblock {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: .9rem;
      line-height: 1.35;
      white-space: pre-wrap;
      word-wrap: break-word;
      border: 1px solid color-mix(in oklab, CanvasText 14%, transparent);
      background: color-mix(in oklab, Canvas 98%, CanvasText 2%);
      border-radius: .5rem;
      padding: .75rem;
      max-height: 55vh;
      overflow: auto;
      user-select: text;
    }
    .threecol { display:grid; gap:.6rem; grid-template-columns: 1fr 1fr 1fr; }
    @media (max-width: 1100px){ .threecol { grid-template-columns: 1fr; } }
    .small { font-size:.85rem; }
    .validation-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: .75rem;
    }
    .val-section {
      border: 1px solid color-mix(in oklab, CanvasText 14%, transparent);
      border-radius: .6rem;
      background: color-mix(in oklab, Canvas 96%, CanvasText 4%);
      padding: .75rem;
      display: flex;
      flex-direction: column;
    }
    .val-section h3 {
      margin: 0 0 .5rem 0;
      font-size: .95rem;
      font-weight: 650;
    }
    .val-content {
      flex: 1;
      overflow-y: auto;
      max-height: 240px; /* lock height */
      font-size: .85rem;
      line-height: 1.4;
    }

    @media (max-width: 1100px){ .validation-grid { grid-template-columns: 1fr; } }

    .proto-box {
      border: 1px solid color-mix(in oklab, CanvasText 14%, transparent);
      border-radius: .6rem;
      padding: .75rem;
      background: color-mix(in oklab, Canvas 96%, CanvasText 4%);
      display: grid;
      gap: .5rem;

      /* NEW: lock height + scroll */
      max-height: 300px;   /* adjust as needed */
      overflow-y: auto;
    }

    /* Reusable grids + scroll areas for the new cards */
    .cardgrid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:.75rem; }
    .cardgrid-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:.75rem; }
    .cardgrid-4 { display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:.75rem; }
    @media (max-width: 1100px){
      .cardgrid-4, .cardgrid-3, .cardgrid-2 { grid-template-columns: 1fr; }
    }
    .box-section {
      border: 1px solid color-mix(in oklab, CanvasText 14%, transparent);
      border-radius: .6rem;
      background: color-mix(in oklab, Canvas 96%, CanvasText 4%);
      padding: .75rem;
      display:flex; flex-direction:column; gap:.25rem;
    }
    .box-section h3 { margin:0 0 .35rem 0; font-size:.95rem; font-weight:650; }
    .box-scroll { flex:1; overflow-y:auto; max-height: 260px; font-size:.9rem; line-height:1.35; }
    .box-scroll ul { margin:.3rem 0 0 1rem; padding:0; }
    .box-kv { font-size:.85rem; opacity:.85; }

  </style>
</head>
<body>
  <header>
    <h1>Dirt</h1>
    <div class="muted">Create draft or publish immediately • Preview included</div>
  </header>

  <main class="grid cols-2">
    <!-- Left: Seed selection -->
    <section class="card" aria-labelledby="h-select">
      <header><h2 id="h-select">Select Seed</h2></header>
      <div class="body">
        <div class="row">
          <div>
            <label for="domainSelect">Domain</label>
            <select id="domainSelect"><option value="">Loading…</option></select>
          </div>
          <div>
            <label for="dimensionSelect">Dimension</label>
            <select id="dimensionSelect" disabled><option value="">Select a domain</option></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="seedSelect">Seed</label>
            <select id="seedSelect" disabled><option value="">Select a dimension</option></select>
          </div>
          <div>
            <label for="seedIdInput">Or enter Seed ID directly</label>
            <input id="seedIdInput" type="number" placeholder="e.g., 123"/>
          </div>
        </div>
        <div class="toolbar">
          <span id="selStatus" class="muted"></span>
        </div>
      </div>
    </section>

    <!-- Right: Selected Context -->
    <section class="card" aria-labelledby="h-context">
      <header><h2 id="h-context">Selected Context</h2></header>
      <div class="body" id="contextBody">
        <div id="ctxDomain">
          <div class="muted">Domain</div>
          <div id="ctxDomainTitle">—</div>
        </div>
        <hr style="border:none; border-top:1px solid color-mix(in oklab, CanvasText 12%, transparent); margin:.5rem 0;">
        <div id="ctxDimension">
          <div class="muted">Dimension</div>
          <div id="ctxDimTitle">—</div>
          <div id="ctxDimDesc" class="muted" style="margin-top:.15rem;"></div>
        </div>
        <hr style="border:none; border-top:1px solid color-mix(in oklab, CanvasText 12%, transparent); margin:.5rem 0;">
        <div id="ctxSeed">
          <div class="muted">Seed</div>
          <div id="ctxSeedA" style="white-space:pre-wrap;"></div>
          <div id="ctxSeedB" style="white-space:pre-wrap; margin-top:.25rem;"></div>
          <div id="ctxSeedL" style="white-space:pre-wrap; margin-top:.25rem;"></div>
        </div>
      </div>
    </section>

    <!-- Narrative Prototype -->
    <!-- Narrative Prototype (JSON envelope) -->
    <section class="card" aria-labelledby="h-proto">
      <header><h2 id="h-proto">Narrative Prototype</h2></header>
      <div class="body">
        <div class="actions small" style="gap:.6rem;align-items:center;">
          <span class="muted">POST <span class="pill">/api/narrative-prototype</span></span>
          <span id="protoStatus" class="muted"></span>
        </div>

        <div class="actions">
          <button id="genProtoBtn">Generate Prototype</button>
          <span id="protoRunNote" class="muted"></span>
        </div>

        <!-- Pretty, scrollable result -->
        <div id="protoWrap" hidden class="proto-box">
          <div><strong>Core Intent</strong><div id="protoCore" style="white-space:pre-wrap;"></div></div>
          <div><strong>Minimal Build</strong><div id="protoBuild" style="white-space:pre-wrap;"></div></div>
          <div><strong>Load-Bearing Test</strong><div id="protoTest" style="white-space:pre-wrap;"></div></div>
          <div><strong>First Eyes</strong><div id="protoEyes"></div></div>
          <div><strong>Why This is a Box of Dirt</strong><div id="protoWhy" style="white-space:pre-wrap;"></div></div>
        </div>
      </div>
    </section>


    <!-- Deployment & Artifacts -->
    <!-- Deployment & Box-of-Dirt Artifacts (JSON envelope) -->
    <section class="card" aria-labelledby="h-artifacts">
      <header><h2 id="h-artifacts">Deployment & Box-of-Dirt Artifacts</h2></header>
      <div class="body">
        <div class="actions small" style="gap:.6rem;align-items:center;">
          <span class="muted">POST <span class="pill">/api/box-of-dirt/artifacts</span></span>
          <span id="artifactsStatus" class="muted"></span>
        </div>

        <div class="actions">
          <button id="genArtifactsBtn">Generate Artifacts</button>
          <span id="artRunNote" class="muted"></span>
        </div>

        <!-- Pretty layout for JSON bundle -->
        <div class="cardgrid-2" id="artifactsPretty" style="margin-top:.25rem;">
          <div class="box-section">
            <h3>Real Artifacts</h3>
            <div class="box-scroll" id="realArtifactsBox"><!-- filled by JS --></div>
          </div>
          <div class="box-section">
            <h3>Box of Dirt</h3>
            <div class="box-scroll" id="bodItemsBox"><!-- filled by JS --></div>
          </div>
        </div>

        <div class="box-section" style="margin-top:.6rem;">
          <h3>Safety & Guardrails</h3>
          <div class="box-scroll" id="guardrailsBox"><!-- filled by JS --></div>
        </div>

        <div class="box-section" style="margin-top:.6rem;">
          <h3 id="nextStepsTitle">Next steps (48–72 hours)</h3>
          <div class="box-scroll" id="nextStepsBox"><!-- filled by JS --></div>
        </div>
      </div>
    </section>

    <!-- NEW: Real-World Validation -->
    <section class="card" aria-labelledby="h-validate">
      <header><h2 id="h-validate">Real-World Validation</h2></header>
      <div class="body">
        <div class="actions small">
          <span class="muted">POST <span class="pill">/api/narrative-validation</span></span>
          <span id="valStatus" class="muted"></span>
        </div>
    
        <!-- Optional: live summary of what's about to be validated -->
        <div id="valSummary" class="muted small" style="line-height:1.4;"></div>
    
        <div class="actions">
          <button id="runValidationBtn">Run Validation</button>
          <span id="valRunNote" class="muted"></span>
        </div>
    
        <div id="valPretty" class="validation-grid">
          <div class="val-section" id="valProblem"><h3>Problem Validation</h3><div class="val-content"></div></div>
          <div class="val-section" id="valObjective"><h3>Objective Measurement</h3><div class="val-content"></div></div>
          <div class="val-section" id="valSolution"><h3>Solution Justification</h3><div class="val-content"></div></div>
        </div>
  
      </div>
    </section>

    <!-- Stakeholder mapping -->
    <section class="card" aria-labelledby="h-stake">
      <header><h2 id="h-stake">Stakeholder Mapping</h2></header>
      <div class="body">
        <div class="actions small">
          <span class="muted">POST <span class="pill">/api/narrative-stakeholders</span></span>
          <span id="stakeStatus" class="muted"></span>
        </div>
        <div class="actions">
          <button id="runStakeBtn">Run Stakeholders</button>
        </div>
        <div id="stakePretty" class="cardgrid-4">
          <div class="box-section" id="stakePrimary"><h3>Primary</h3><div class="box-scroll"></div></div>
          <div class="box-section" id="stakeSecondary"><h3>Secondary</h3><div class="box-scroll"></div></div>
          <div class="box-section" id="stakeEndUsers"><h3>End Users / Beneficiaries</h3><div class="box-scroll"></div></div>
          <div class="box-section" id="stakeExternal"><h3>External / Contextual</h3><div class="box-scroll"></div></div>
        </div>
      </div>
    </section>

    <!-- Embodied narrative -->
    <section class="card" aria-labelledby="h-embodied">
      <header><h2 id="h-embodied">6 Senses</h2></header>
      <div class="body">
        <div class="actions small">
          <span class="muted">POST <span class="pill">/api/narrative-embodied</span></span>
          <span id="embStatus" class="muted"></span>
        </div>
        <div class="actions">
          <button id="runEmbBtn">Run 6 senses</button>
        </div>
        <div id="embPretty" class="cardgrid-3">
          <div class="box-section" id="embEyes"><h3>Sight</h3><div class="box-scroll"></div></div>
          <div class="box-section" id="embEars"><h3>Sound</h3><div class="box-scroll"></div></div>
          <div class="box-section" id="embHands"><h3>Touch</h3><div class="box-scroll"></div></div>
          <div class="box-section" id="embNose"><h3>Smell</h3><div class="box-scroll"></div></div>
          <div class="box-section" id="embMouth"><h3>Taste</h3><div class="box-scroll"></div></div>
          <div class="box-section" id="embMusic"><h3>Music</h3><div class="box-scroll"></div></div>
        </div>
      </div>
    </section>

    <!-- Archetype-driven playbook -->
    <section class="card" aria-labelledby="h-archpb">
      <header><h2 id="h-archpb">Archetype-Driven Playbook</h2></header>
      <div class="body">
        <div class="actions small">
          <span class="muted">POST <span class="pill">/api/narrative-archetype-playbook</span></span>
          <span id="archStatus" class="muted"></span>
        </div>
        <div class="actions">
          <button id="runArchBtn">Run Archetype Playbook</button>
        </div>
        <div id="archClass" class="box-kv"></div>
        <div id="archPretty" class="cardgrid-3"><!-- phases --></div>
        <div id="archNorth" class="box-section" style="margin-top:.6rem;">
          <h3>North Star</h3><div class="box-scroll" id="archNorthBody"></div>
        </div>
      </div>
    </section>

    <!-- Risks & early-warning monitoring -->
    <section class="card" aria-labelledby="h-risks">
      <header><h2 id="h-risks">Risks & Early-Warning Monitoring</h2></header>
      <div class="body">
        <div class="actions small">
          <span class="muted">POST <span class="pill">/api/narrative-risks</span></span>
          <span id="riskStatus" class="muted"></span>
        </div>
        <div class="actions">
          <button id="runRiskBtn">Run Risks</button>
        </div>
        <div class="cardgrid-2">
          <div class="box-section" id="riskFailures"><h3>Likely Failures & Countermeasures</h3><div class="box-scroll"></div></div>
        </div>
      </div>
    </section>

  </main>

  <script>
  (function(){
    const els = {
      domain: document.getElementById('domainSelect'),
      dimension: document.getElementById('dimensionSelect'),
      seed: document.getElementById('seedSelect'),
      seedIdInput: document.getElementById('seedIdInput'),
      selStatus: document.getElementById('selStatus'),

      // Prototype
      genProtoBtn: document.getElementById('genProtoBtn'),
      protoStatus: document.getElementById('protoStatus'),
      protoWrap: document.getElementById('protoWrap'),
      protoCore: document.getElementById('protoCore'),
      protoBuild: document.getElementById('protoBuild'),
      protoTest: document.getElementById('protoTest'),
      protoEyes: document.getElementById('protoEyes'),
      protoWhy: document.getElementById('protoWhy'),
      protoRunNote: document.getElementById('protoRunNote'),

      // Context
      ctxDomainTitle: document.getElementById('ctxDomainTitle'),
      ctxDimTitle: document.getElementById('ctxDimTitle'),
      ctxDimDesc: document.getElementById('ctxDimDesc'),
      ctxSeedA: document.getElementById('ctxSeedA'),
      ctxSeedB: document.getElementById('ctxSeedB'),
      ctxSeedL: document.getElementById('ctxSeedL'),

      // Artifacts
      genArtifactsBtn: document.getElementById('genArtifactsBtn'),
      artifactsStatus: document.getElementById('artifactsStatus'),
      artRunNote: document.getElementById('artRunNote'),
      realArtifactsBox: document.getElementById('realArtifactsBox'),
      bodItemsBox: document.getElementById('bodItemsBox'),
      guardrailsBox: document.getElementById('guardrailsBox'),
      nextStepsTitle: document.getElementById('nextStepsTitle'),
      nextStepsBox: document.getElementById('nextStepsBox'),

      // Validation
      valStatus: document.getElementById('valStatus'),
      valSummary: document.getElementById('valSummary'),
      runValidationBtn: document.getElementById('runValidationBtn'),
      valRunNote: document.getElementById('valRunNote'),
      valPretty: document.getElementById('valPretty'),

      // Stakeholders
      runStakeBtn: document.getElementById('runStakeBtn'),
      stakeStatus: document.getElementById('stakeStatus'),
      stakePretty: document.getElementById('stakePretty'),

      // Embodied
      runEmbBtn: document.getElementById('runEmbBtn'),
      embStatus: document.getElementById('embStatus'),
      embPretty: document.getElementById('embPretty'),

      // Roadmap
      runRoadBtn: document.getElementById('runRoadBtn'),
      roadStatus: document.getElementById('roadStatus'),
      roadPretty: document.getElementById('roadPretty'),

      // Archetype
      runArchBtn: document.getElementById('runArchBtn'),
      archStatus: document.getElementById('archStatus'),
      archClass: document.getElementById('archClass'),
      archPretty: document.getElementById('archPretty'),
      archNorthBody: document.getElementById('archNorthBody'),

      // Risks
      runRiskBtn: document.getElementById('runRiskBtn'),
      riskStatus: document.getElementById('riskStatus'),
      riskFailures: document.querySelector('#riskFailures .box-scroll'),
    };

    const API = {
      narratives: '/api/narratives',
      dims: (nid) => `/api/narratives/${encodeURIComponent(nid)}/dimensions`,
      seeds: (did) => `/api/dimensions/${encodeURIComponent(did)}/seeds`,
      validate: '/api/narrative-validation',
      bodArtifacts: '/api/box-of-dirt/artifacts',
      stake: '/api/narrative-stakeholders',
      embodied: '/api/narrative-embodied',
      road: '/api/narrative-playbook',
      arch: '/api/narrative-archetype-playbook',
      risks: '/api/narrative-risks',
    };

    let cache = { narratives: [], dims: new Map(), seeds: new Map() };

    // Helpers
    function stripHashId(name){
      return String(name||'').replace(/\s*\(#\d+\)\s*$/, '');
    }
    function composeSeedText(seedRow){
      const A = seedRow?.problem ? `A (Problem): ${seedRow.problem}` : '';
      const B = seedRow?.objective ? `B (Objective): ${seedRow.objective}` : '';
      const L = seedRow?.solution ? `Solution (Link): ${seedRow.solution}` : '';
      return [A,B,L].filter(Boolean).join('\n');
    }
    function composePrototypeText(p){
      const lines = [];
      if (p.core_intent) lines.push(`Core Intent — ${p.core_intent}`);
      if (p.minimal_build) lines.push(`Minimal Build — ${p.minimal_build}`);
      const panels = Array.isArray(p.panels) ? p.panels
                  : Array.isArray(p.scenes) ? p.scenes
                  : Array.isArray(p.storyboard) ? p.storyboard
                  : [];
      panels.forEach((item, i) => {
        if (typeof item === 'string'){
          lines.push(`Panel ${i+1} — ${item}`);
        } else if (item && (item.title || item.heading)){
          const title = item.title || item.heading || `Panel ${i+1}`;
          lines.push(`Panel ${i+1} — ${title}`);
          const bullets = Array.isArray(item.bullets) ? item.bullets
                        : Array.isArray(item.points) ? item.points
                        : [];
          bullets.forEach(b => lines.push(`- ${b}`));
          if (item.caption) lines.push(item.caption);
        }
      });
      if (p.load_bearing_test) lines.push(`Load-Bearing Test — ${p.load_bearing_test}`);
      if (p.validating_reactions){
        if (Array.isArray(p.validating_reactions)){
          lines.push('Validating reactions we want —'); p.validating_reactions.forEach(x => lines.push(`- ${x}`));
        } else { lines.push(`Validating reactions we want — ${p.validating_reactions}`); }
      }
      if (p.red_flags){
        if (Array.isArray(p.red_flags)){
          lines.push('Red flags (invalidate) —'); p.red_flags.forEach(x => lines.push(`- ${x}`));
        } else { lines.push(`Red flags (invalidate) — ${p.red_flags}`); }
      }
      if (p.first_eyes){
        if (Array.isArray(p.first_eyes)){
          lines.push('First Eyes —'); p.first_eyes.forEach(x => lines.push(`- ${x}`));
        } else { lines.push(`First Eyes — ${p.first_eyes}`); }
      }
      if (p.why_box_of_dirt) lines.push(`Why This is a Box of Dirt — ${p.why_box_of_dirt}`);
      return lines.join('\n');
    }
    function setStatus(el, msg, ok){
      el.textContent = msg || '';
      el.classList.remove('ok','err');
      if (!msg) return;
      el.classList.add(ok ? 'ok' : 'err');
    }
    async function fetchJSON(url){
      const res = await fetch(url, { headers: { 'Accept':'application/json' }});
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    // Deep-link helpers
    async function resolveNarrativeIdByDimensionId(did) {
      for (const n of (cache.narratives || [])) {
        try {
          let dims = cache.dims.get(String(n.id));
          if (!dims) {
            dims = await fetchJSON(`/api/narratives/${encodeURIComponent(n.id)}/dimensions`);
            cache.dims.set(String(n.id), dims);
          }
          if (Array.isArray(dims) && dims.some(d => String(d.id) === String(did))) {
            return String(n.id);
          }
        } catch (e) {}
      }
      return null;
    }
    async function resolveDimensionAndNarrativeBySeedId(sid) {
      for (const n of (cache.narratives || [])) {
        let dims = cache.dims.get(String(n.id));
        if (!dims) {
          try {
            dims = await fetchJSON(`/api/narratives/${encodeURIComponent(n.id)}/dimensions`);
            cache.dims.set(String(n.id), dims);
          } catch (e) { continue; }
        }
        for (const d of (dims || [])) {
          try {
            const payload = await fetchJSON(`/api/dimensions/${encodeURIComponent(d.id)}/seeds`);
            const seeds = Array.isArray(payload?.seeds) ? payload.seeds : [];
            if (seeds.some(s => String(s.id) === String(sid))) {
              return { nid: String(n.id), did: String(d.id) };
            }
          } catch (e) {}
        }
      }
      return null;
    }
    async function maybeDeepLink() {
      const params = new URLSearchParams(location.search);
      let nid = params.get('nid');
      let did = params.get('did');
      let sid = params.get('sid');

      if (!nid && did) nid = await resolveNarrativeIdByDimensionId(did);
      if ((!nid || !did) && sid) {
        const found = await resolveDimensionAndNarrativeBySeedId(sid);
        if (found) { nid = nid || found.nid; did = did || found.did; }
      }
      if (!nid) return;

      els.domain.value = String(nid);
      await onDomainChange();
      if (did) {
        els.dimension.value = String(did);
        await onDimensionChange();
      }
      if (sid) {
        els.seed.value = String(sid);
        els.seedIdInput.value = String(sid);
      }
      renderContext();
    }

    // Loaders
    async function loadNarratives(){
      try{
        const rows = await fetchJSON(API.narratives);
        cache.narratives = rows;
        els.domain.innerHTML = `<option value="">Select…</option>` +
          rows.map(r => `<option value="${r.id}">${escapeHTML(r.title)} (#${r.id})</option>`).join('');
      }catch(e){
        els.domain.innerHTML = `<option value="">Failed to load narratives</option>`;
      }
    }
    async function onDomainChange(){
      const nid = els.domain.value;
      els.dimension.disabled = !nid;
      els.seed.disabled = true;
      els.dimension.innerHTML = `<option value="">${nid ? 'Loading…' : 'Select a domain'}</option>`;
      els.seed.innerHTML = `<option value="">Select a dimension</option>`;
      if (!nid) return;
      try{
        const dims = await fetchJSON(API.dims(nid));
        cache.dims.set(nid, dims);
        els.dimension.innerHTML = `<option value="">Select…</option>` +
          dims.map(d => `<option value="${d.id}">${escapeHTML(d.title)} (#${d.id})</option>`).join('');
        renderContext();
      }catch(e){
        els.dimension.innerHTML = `<option value="">Failed to load dimensions</option>`;
      }
    }
    async function onDimensionChange(){
      const did = els.dimension.value;
      els.seed.disabled = !did;
      els.seed.innerHTML = `<option value="">${did ? 'Loading…' : 'Select a dimension'}</option>`;
      if (!did) return;
      try{
        const payload = await fetchJSON(`/api/dimensions/${encodeURIComponent(did)}/seeds`);
        const seeds = Array.isArray(payload?.seeds) ? payload.seeds : [];
        cache.seeds.set(did, seeds);
        els.seed.innerHTML = `<option value="">Select…</option>` +
          seeds.map(s => `<option value="${s.id}">${escapeHTML((s.problem||'Seed'))} (#${s.id})</option>`).join('');
        renderContext();
      }catch(e){
        els.seed.innerHTML = `<option value="">Failed to load seeds</option>`;
      }
    }

    // Artifacts (Markdown only, per your prior setup)
    async function generateArtifactsAndPage() {
      const nid = els.domain.value;
      const did = els.dimension.value;
      const sid = els.seed.value || els.seedIdInput.value;

      const domainRow = (cache.narratives || []).find(n => String(n.id) === String(nid));
      const dims      = cache.dims.get(nid) || [];
      const dimRow    = dims.find(d => String(d.id) === String(did));
      const seeds     = cache.seeds.get(did) || [];
      const seedRow   = seeds.find(s => String(s.id) === String(sid));

      const missing = [];
      if (!domainRow) missing.push("domain");
      if (!dimRow) missing.push("dimension");
      if (!seedRow) missing.push("seed");
      if (missing.length) {
        els.artifactsStatus.textContent = `Select a ${missing.join(", ")} first.`;
        els.artifactsStatus.classList.remove('ok'); els.artifactsStatus.classList.add('err');
        return;
      }

      const domain    = stripHashId(domainRow.title || '');
      const dimension = stripHashId(dimRow.title || '');
      const seedThree = composeSeedText(seedRow);

      els.artifactsStatus.textContent = 'Generating artifacts…';
      els.genArtifactsBtn.disabled = true;

      try {
        const artRes = await fetch(API.bodArtifacts, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ domain, dimension, seed: seedThree })
        });
        if (!artRes.ok) throw new Error(`Artifacts HTTP ${artRes.status}`);
        const md = await artRes.text();

        els.artifactsStatus.textContent = 'OK — artifacts generated';
        els.artifactsStatus.classList.add('ok');
      } catch(e) {
        els.artifactsStatus.textContent = 'Error: '+e.message;
        els.artifactsStatus.classList.remove('ok'); els.artifactsStatus.classList.add('err');
      } finally {
        els.genArtifactsBtn.disabled = false;
      }
    }

    // --- Pretty renderer: three scrollable sections (no raw JSON) ---
    function renderValidationPretty(payload){
      const v = (payload && payload.validation) || {};
      // Ensure containers exist (valProblem/valObjective/valSolution each has .val-content)
      fillValSection('valProblem',   v.problem_validation);
      fillValSection('valObjective', v.objective_measurement);
      fillValSection('valSolution',  v.solution_justification);
    }

    function fillValSection(sectionId, items){
      const wrap = document.querySelector(`#${sectionId} .val-content`);
      if (!wrap) return;

      if (!Array.isArray(items) || items.length === 0){
        wrap.innerHTML = `<div class="muted">No entries</div>`;
        return;
      }

      const html = items.map(item => {
        const metric = escapeHTML(item?.metric || '');
        const desc   = item?.description ? `<div class="muted">${escapeHTML(item.description)}</div>` : '';

        const ds = Array.isArray(item?.datasets) ? item.datasets : [];
        const dsHTML = ds.map(d => {
          const name = escapeHTML(d?.name || '');
          const org  = escapeHTML(d?.organization || '');
          const notes= d?.notes ? ` — <span class="muted">${escapeHTML(d.notes)}</span>` : '';
          const url  = d?.url ? ` — <a href="${escapeAttr(d.url)}" target="_blank" rel="noopener">${escapeHTML(d.url)}</a>` : '';
          return `<li><strong>${name}</strong> <span class="muted">(${org})</span>${notes}${url}</li>`;
        }).join('');

        return `
          <div class="metric" style="margin:.55rem 0; word-break: break-word;">
            <div style="font-weight:650;">${metric}</div>
            ${desc}
            ${dsHTML ? `<ul style="margin:.35rem 0 0 1rem; padding:0;">${dsHTML}</ul>` : ''}
          </div>
        `;
      }).join('');

      wrap.innerHTML = html;
    }

    // Small escaper for href/src attributes
    function escapeAttr(s){
      return String(s || '').replace(/"/g, '&quot;');
    }



    function getSelectedRows(){
      const nid = els.domain.value;
      const did = els.dimension.value;
      const sid = els.seed.value;

      const domainRow = (cache.narratives || []).find(n => String(n.id) === String(nid));
      const dims = cache.dims.get(nid) || [];
      const dimRow = dims.find(d => String(d.id) === String(did));
      const seeds = cache.seeds.get(did) || [];
      const seedRow = seeds.find(s => String(s.id) === String(sid));

      return { nid, did, sid, domainRow, dimRow, seedRow };
    }

    function renderValSummary(domainRow, dimRow, seedRow){
      if (!els.valSummary) return;
      if (!domainRow || !dimRow || !seedRow){
        els.valSummary.textContent = 'Select a domain, dimension, and seed.';
        return;
      }
      const domain = stripHashId(domainRow.title || '');
      const dimension = stripHashId(dimRow.title || '');
      const A = seedRow.problem || '';
      const B = seedRow.objective || '';
      const L = seedRow.solution || '';

      els.valSummary.innerHTML =
        `<div><strong>Domain:</strong> ${escapeHTML(domain)} (#${domainRow.id})</div>` +
        `<div><strong>Dimension:</strong> ${escapeHTML(dimension)} (#${dimRow.id})</div>` +
        (A ? `<div><strong>Problem:</strong> ${escapeHTML(A)}</div>` : '') +
        (B ? `<div><strong>Objective:</strong> ${escapeHTML(B)}</div>` : '') +
        (L ? `<div><strong>Solution:</strong> ${escapeHTML(L)}</div>` : '');
    }

    function currentSeedTriplet() {
      const { domainRow, dimRow, seedRow } = getSelectedRows();
      if (!domainRow || !dimRow || !seedRow) return null;
      return {
        domain: stripHashId(domainRow.title || ''),
        dimension: stripHashId(dimRow.title || ''),
        problem: (seedRow.problem || '').trim(),
        objective: (seedRow.objective || '').trim(),
        solution: (seedRow.solution || '').trim(),
      };
    }

    function requiredTripletOrStatus(statusEl){
      const t = currentSeedTriplet();
      if (!t) setStatus(statusEl, 'Select a domain, dimension, and seed first.', false);
      else {
        const miss = [];
        if (!t.domain) miss.push('domain');
        if (!t.dimension) miss.push('dimension');
        if (!t.problem) miss.push('problem');
        if (!t.objective) miss.push('objective');
        if (!t.solution) miss.push('solution');
        if (miss.length) { setStatus(statusEl, `Missing: ${miss.join(', ')}`, false); return null; }
      }
      return t;
    }

    function clearEl(el){ if (el) el.textContent = ''; }
    function clearHTML(el){ if (el) el.innerHTML = ''; }

    // tiny util to clear sections without deleting their containers
    function clearBoxScroll(selector){
      const el = document.querySelector(selector);
      if (el) el.replaceChildren();
    }

    // default provider setting for these new routes
    const DEFAULT_PROVIDER = 'openai';



    async function runValidation(){
      const { domainRow, dimRow, seedRow } = getSelectedRows();

      if (!domainRow || !dimRow || !seedRow) {
        setStatus(els.valStatus, 'Select a domain, dimension, and seed first.', false);
        els.valPretty.innerHTML = '';
        renderValSummary(domainRow, dimRow, seedRow);
        return;
      }

      const domain    = stripHashId(domainRow.title || '');
      const dimension = stripHashId(dimRow.title || '');
      const problem   = (seedRow.problem   || '').trim();
      const objective = (seedRow.objective || '').trim();
      const solution  = (seedRow.solution  || '').trim();

      renderValSummary(domainRow, dimRow, seedRow);

      // provider is fixed to openai_web per your spec
      const provider = 'openai_web';

      // Basic validation
      const missing = [];
      if (!domain)    missing.push('domain');
      if (!dimension) missing.push('dimension');
      if (!problem)   missing.push('problem');
      if (!objective) missing.push('objective');
      if (!solution)  missing.push('solution');
      if (missing.length){
        setStatus(els.valStatus, `Missing: ${missing.join(', ')}`, false);
        return;
      }

      setStatus(els.valStatus, 'Running…', false);
      els.runValidationBtn.disabled = true;
      els.valRunNote.textContent = '';
      
      const clear = sel => {
        const el = document.querySelector(sel);
        if (el) el.innerHTML = '';
      };
      clear('#valProblem .val-content');
      clear('#valObjective .val-content');
      clear('#valSolution .val-content');

      try{
        const res = await fetch('/api/narrative-validation', {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify({ domain, dimension, problem, objective, solution, provider })
        });

        const text = await res.text();
        let payload = null;
        try { payload = JSON.parse(text); } catch(e){}


        if (!res.ok){
          setStatus(els.valStatus, `HTTP ${res.status}`, false);
        } else if (payload && payload.error){
          setStatus(els.valStatus, payload.error, false);
        } else {
          setStatus(els.valStatus, 'OK', true);
          if (payload && payload.ok){
            renderValidationPretty(payload);
          }
        }
      }catch(e){
        setStatus(els.valStatus, e.message, false);
      }finally{
        els.runValidationBtn.disabled = false;
      }
    }

    function prettyJSON(raw){
      try { return JSON.stringify(JSON.parse(raw), null, 2); }
      catch(_) { return raw; }
    }

    function renderPrototypeEnvelope(payload){
      const p = payload?.prototype ?? payload; // tolerate direct object
      if (!p) return;

      // Pretty content
      els.protoCore.textContent  = p.core_intent || '';
      els.protoBuild.textContent = p.minimal_build || '';
      els.protoTest.textContent  = p.load_bearing_test || '';

      if (Array.isArray(p.first_eyes) && p.first_eyes.length){
        els.protoEyes.innerHTML = `<ul style="margin:.25rem 0 0 1rem; padding:0;">${
          p.first_eyes.map(x => `<li>${escapeHTML(String(x))}</li>`).join('')
        }</ul>`;
      } else {
        els.protoEyes.textContent = '';
      }

      els.protoWhy.textContent = p.why_box_of_dirt || '';

      // Show pretty, hide debug
      if (els.protoWrap)  els.protoWrap.hidden = false;
    }

    async function generatePrototypeAndBuild(){
      const t = requiredTripletOrStatus(els.protoStatus); if (!t) return;

      // Reset UI
      setStatus(els.protoStatus, 'Running…', false);
      clearEl(els.protoRunNote);
      if (els.protoWrap)  els.protoWrap.hidden = true;
      clearHTML(els.protoEyes);
      clearEl(els.protoCore); clearEl(els.protoBuild); clearEl(els.protoTest); clearEl(els.protoWhy);
      els.genProtoBtn.disabled = true;

      try{
        // Build request per new API shape: either SeedInput variant is allowed; we’ll send the split fields
        const body = {
          domain: t.domain,
          dimension: t.dimension,
          provider: DEFAULT_PROVIDER, // explicit default
          seed: { problem: t.problem, objective: t.objective, solution: t.solution }, // also allowed by API
        };

        const res = await fetch('/api/narrative-prototype', {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify(body),
        });

        const text = await res.text();
        let data = null;
        try { data = JSON.parse(text); } catch { /* leave as null for error display */ }

        // HTTP error -> surface .error if present
        if (!res.ok){
          const msg = data?.error || `HTTP ${res.status}`;
          setStatus(els.protoStatus, msg, false);
          return;
        }

        // Envelope handling
        if (data?.error){
          setStatus(els.protoStatus, data.error, false);
          return;
        }

        if (data?.ok === false){
          setStatus(els.protoStatus, 'Model output could not be parsed (showing raw).', false);
          return;
        }

        if (data?.ok === true){
          renderPrototypeEnvelope(data);
          setStatus(els.protoStatus, 'OK', true);
          return;
        }

        // Fallback: try to render if the object already looks like the prototype
        renderPrototypeEnvelope(data);
        setStatus(els.protoStatus, 'OK', true);
      }catch(e){
        setStatus(els.protoStatus, e.message, false);
      }finally{
        els.genProtoBtn.disabled = false;
      }
    }

    // ============ ARTIFACTS (JSON envelope) ============

    function renderArtifactsBundle(bundle){
      if (!bundle) return;

      // Real artifacts
      if (els.realArtifactsBox){
        const arr = Array.isArray(bundle.real_artifacts) ? bundle.real_artifacts : [];
        els.realArtifactsBox.innerHTML = arr.length ? arr.map(a => {
          const title = `<div style="font-weight:650;">${escapeHTML(a.title||'')}</div>`;
          const owner = a.owner ? `<div class="box-kv"><strong>Owner:</strong> ${escapeHTML(a.owner)}</div>` : '';
          const desc  = a.description ? `<div>${escapeHTML(a.description)}</div>` : '';
          const notes = a.notes ? `<div class="muted">${escapeHTML(a.notes)}</div>` : '';
          return `<div style="margin:.6rem 0;">${title}${owner}${desc}${notes}</div>`;
        }).join('') : '<div class="muted">—</div>';
      }

      // Box of Dirt items
      if (els.bodItemsBox){
        const arr = Array.isArray(bundle.box_of_dirt) ? bundle.box_of_dirt : [];
        els.bodItemsBox.innerHTML = arr.length ? arr.map(b => {
          const title = `<div style="font-weight:650;">${escapeHTML(b.title||'')}</div>`;
          const owner = b.owner ? `<div class="box-kv"><strong>Owner:</strong> ${escapeHTML(b.owner)}</div>` : '';
          const bullets = Array.isArray(b.bullets) && b.bullets.length
            ? `<ul>${b.bullets.map(x=>`<li>${escapeHTML(String(x))}</li>`).join('')}</ul>` : '';
          return `<div style="margin:.6rem 0;">${title}${owner}${bullets}</div>`;
        }).join('') : '<div class="muted">—</div>';
      }

      // Safety / guardrails
      if (els.guardrailsBox){
        els.guardrailsBox.innerHTML = bundle.safety_guardrails
          ? `<pre class="codeblock" tabindex="0" style="max-height:220px;">${escapeHTML(bundle.safety_guardrails)}</pre>`
          : '<div class="muted">—</div>';
      }

      // Next steps
      if (els.nextStepsTitle){
        els.nextStepsTitle.textContent = bundle.next_steps_title || 'Next steps (48–72 hours)';
      }
      if (els.nextStepsBox){
        const steps = Array.isArray(bundle.next_steps) ? bundle.next_steps : [];
        els.nextStepsBox.innerHTML = steps.length
          ? `<ol style="margin:.2rem 0 0 1rem;">${steps.map(x=>`<li>${escapeHTML(String(x))}</li>`).join('')}</ol>`
          : '<div class="muted">—</div>';
      }
    }

    async function generateArtifacts(){
      const t = requiredTripletOrStatus(els.artifactsStatus); if (!t) return;

      // Reset UI
      setStatus(els.artifactsStatus, 'Running…', false);
      clearEl(els.artRunNote);
      clearHTML(els.realArtifactsBox);
      clearHTML(els.bodItemsBox);
      clearHTML(els.guardrailsBox);
      clearHTML(els.nextStepsBox);
      els.genArtifactsBtn.disabled = true;

      try{
        // Build request per new API shape. Send split seed fields to avoid any parsing ambiguity.
        const body = {
          domain: t.domain,
          dimension: t.dimension,
          provider: DEFAULT_PROVIDER,
          seed_problem: t.problem,
          seed_objective: t.objective,
          seed_solution: t.solution,
        };

        const res = await fetch('/api/box-of-dirt/artifacts', {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify(body),
        });

        const text = await res.text();
        let data = null;
        try { data = JSON.parse(text); } catch { /* leave as null for error display */ }

        if (!res.ok){
          const msg = data?.error || `HTTP ${res.status}`;
          setStatus(els.artifactsStatus, msg, false);
          return;
        }

        if (data?.error){
          setStatus(els.artifactsStatus, data.error, false);
          return;
        }

        if (data?.ok === false){
          setStatus(els.artifactsStatus, 'Model output could not be parsed (showing raw).', false);
          return;
        }

        if (data?.ok === true){
          renderArtifactsBundle(data.artifacts);
          setStatus(els.artifactsStatus, 'OK', true);
          return;
        }

        // Fallback: attempt to render if the object already looks like the bundle
        renderArtifactsBundle(data?.artifacts ?? data);
        setStatus(els.artifactsStatus, 'OK', true);
      }catch(e){
        setStatus(els.artifactsStatus, e.message, false);
      }finally{
        els.genArtifactsBtn.disabled = false;
      }
    }

    function renderContext(){
      const nid = els.domain.value;
      const domainRow = (cache.narratives || []).find(n => String(n.id) === String(nid));
      els.ctxDomainTitle.textContent = domainRow ? `${domainRow.title} (#${domainRow.id})` : '—';

      const did = els.dimension.value;
      const dims = cache.dims.get(nid) || [];
      const dimRow = dims.find(d => String(d.id) === String(did));
      els.ctxDimTitle.textContent = dimRow ? `${dimRow.title} (#${dimRow.id})` : '—';
      els.ctxDimDesc.textContent = dimRow?.description ? String(dimRow.description) : '';

      const sid = els.seed.value;
      const seeds = cache.seeds.get(did) || [];
      const seedRow = seeds.find(s => String(s.id) === String(sid));

      const A = seedRow?.problem || '';
      const B = seedRow?.objective || '';
      const L = seedRow?.solution || '';

      els.ctxSeedA.textContent = A ? `A (Problem): ${A}` : '';
      els.ctxSeedB.textContent = B ? `B (Objective): ${B}` : '';
      els.ctxSeedL.textContent = L ? `Solution (Link): ${L}` : '';
    }

    function renderStakeholders(payload){
      const v = payload?.stakeholders || payload?.map || payload; // be tolerant
      const S = {
        primary: v?.primary || [],
        secondary: v?.secondary || [],
        end: v?.end_users_beneficiaries || [],
        ext: v?.external_contextual || [],
      };
      const paint = (id, arr) => {
        const box = document.querySelector(`#${id} .box-scroll`);
        if (!box) return;
        if (!Array.isArray(arr) || !arr.length){ box.innerHTML = '<div class="muted">No entries</div>'; return; }
        box.innerHTML = arr.map(x=>{
          const name = escapeHTML(x.name||'');
          const cat  = x.category ? ` <span class="muted">(${escapeHTML(x.category)})</span>` : '';
          const role = x.role ? `<div class="box-kv"><strong>Role:</strong> ${escapeHTML(x.role)}</div>` : '';
          const why  = x.why ? `<div>${escapeHTML(x.why)}</div>` : '';
          return `<div style="margin:.5rem 0;"><div style="font-weight:650;">${name}${cat}</div>${role}${why}</div>`;
        }).join('');
      };
      paint('stakePrimary', S.primary);
      paint('stakeSecondary', S.secondary);
      paint('stakeEndUsers', S.end);
      paint('stakeExternal', S.ext);
    }

    async function runStakeholders(){
      const t = requiredTripletOrStatus(els.stakeStatus); if (!t) return;
      setStatus(els.stakeStatus, 'Running…', false);
      ['#stakePrimary .box-scroll','#stakeSecondary .box-scroll','#stakeEndUsers .box-scroll','#stakeExternal .box-scroll'].forEach(clearBoxScroll);
      try{
        const res = await fetch(API.stake, {
          method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify({...t, provider: DEFAULT_PROVIDER})
        });
        const j = await res.json().catch(()=>null);
        if (!res.ok || j?.error){ setStatus(els.stakeStatus, j?.error||`HTTP ${res.status}`, false); return; }
        setStatus(els.stakeStatus, 'OK', true);
        renderStakeholders(j?.map ?? j?.stakeholders ?? j?.output ?? j);
      }catch(e){ setStatus(els.stakeStatus, e.message, false); }
    }

    function renderEmbodied(payload){
      const v = payload?.embodied || payload?.map || payload;
      const keys = [
        ['embEyes', v?.eyes], ['embEars', v?.ears], ['embHands', v?.hands],
        ['embNose', v?.nose], ['embMouth', v?.mouth], ['embMusic', v?.music],
      ];
      for (const [id, arr] of keys){
        const box = document.querySelector(`#${id} .box-scroll`);
        if (!box) continue;
        if (!Array.isArray(arr) || !arr.length){ box.innerHTML = '<div class="muted">No entries</div>'; continue; }
        box.innerHTML = arr.map(x=>{
          const cue = escapeHTML(x.cue||'');
          const why = x.why ? `<div class="muted">${escapeHTML(x.why)}</div>` : '';
          return `<div style="margin:.5rem 0;"><div style="font-weight:650;">${cue}</div>${why}</div>`;
        }).join('');
      }
    }

    async function runEmbodied(){
      const t = requiredTripletOrStatus(els.embStatus); if (!t) return;
      setStatus(els.embStatus, 'Running…', false);
      ['#embEyes .box-scroll','#embEars .box-scroll','#embHands .box-scroll','#embNose .box-scroll','#embMouth .box-scroll','#embMusic .box-scroll'].forEach(clearBoxScroll);
      try{
        const res = await fetch(API.embodied, {
          method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify({...t, provider: DEFAULT_PROVIDER})
        });
        const j = await res.json().catch(()=>null);
        if (!res.ok || j?.error){ setStatus(els.embStatus, j?.error||`HTTP ${res.status}`, false); return; }
        setStatus(els.embStatus, 'OK', true);
        renderEmbodied(j?.map ?? j?.embodied ?? j?.output ?? j);
      }catch(e){ setStatus(els.embStatus, e.message, false); }
    }

    function renderRoadmap(payload){
      const v = payload?.playbook || payload?.roadmap || payload;
      const phases = Array.isArray(v?.phases) ? v.phases : [];
      const root = els.roadPretty; if (!root) return;
      root.innerHTML = phases.map(p=>{
        const name = escapeHTML(p.name||'');
        const horizon = p.horizon ? `<div class="box-kv"><strong>Horizon:</strong> ${escapeHTML(p.horizon)}</div>` : '';
        const mk = (label, arr) => (Array.isArray(arr)&&arr.length)
          ? `<div><strong>${label}:</strong><ul>${arr.map(x=>`<li>${escapeHTML(String(x))}</li>`).join('')}</ul></div>` : '';
        return `<div class="box-section"><h3>${name}</h3>${horizon}
          ${p.goal ? `<div><strong>Goal:</strong> ${escapeHTML(p.goal)}</div>`:''}
          <div class="box-scroll">
            ${mk('Milestones', p.milestones)}
            ${mk('Outputs', p.outputs)}
            ${mk('Indicators', p.indicators)}
            ${mk('Decision Gates', p.decision_gates)}
          </div>
        </div>`;
      }).join('') || '<div class="muted">No phases</div>';
    }

    async function runRoadmap(){
      const t = requiredTripletOrStatus(els.roadStatus); if (!t) return;
      setStatus(els.roadStatus, 'Running…', false);
      els.roadPretty.replaceChildren();
      try{
        const res = await fetch(API.road, {
          method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify({...t, provider: DEFAULT_PROVIDER})
        });
        const j = await res.json().catch(()=>null);
        if (!res.ok || j?.error){ setStatus(els.roadStatus, j?.error||`HTTP ${res.status}`, false); return; }
        setStatus(els.roadStatus, 'OK', true);
        renderRoadmap(j?.playbook ?? j?.roadmap ?? j);
      }catch(e){ setStatus(els.roadStatus, e.message, false); }
    }

    function renderArchetype(payload){
      // accept any of these shapes
      const v = payload?.archetype_playbook ?? payload?.playbook ?? payload;

      // classification
      const cls = v?.classification;
      if (els.archClass) {
        els.archClass.innerHTML = cls
          ? `<strong>Archetype:</strong> ${escapeHTML(cls.archetype || '')} — <span class="muted">${escapeHTML(cls.why || '')}</span>`
          : '';
      }

      // phases
      const phases = Array.isArray(v?.phases) ? v.phases : [];
      if (els.archPretty) {
        els.archPretty.innerHTML = phases.length ? phases.map(p=>{
          const name = escapeHTML(p.name || '');
          const horizon = p.horizon ? `<div class="box-kv"><strong>Horizon:</strong> ${escapeHTML(p.horizon)}</div>` : '';
          const mk = (label, arr) => (Array.isArray(arr) && arr.length)
            ? `<div><strong>${label}:</strong><ul>${arr.map(x=>`<li>${escapeHTML(String(x))}</li>`).join('')}</ul></div>` : '';
          return `<div class="box-section"><h3>${name}</h3>${horizon}
            <div class="box-scroll">
              ${p.goal ? `<div><strong>Goal:</strong> ${escapeHTML(p.goal)}</div>` : ''}
              ${mk('Milestones', p.milestones)}
              ${mk('Outputs', p.outputs)}
              ${mk('Indicators', p.indicators)}
              ${mk('Decision Gates', p.decision_gates)}
            </div>
          </div>`;
        }).join('') : '<div class="muted">No phases</div>';
      }

      // north star
      if (els.archNorthBody) {
        els.archNorthBody.innerHTML = v?.north_star
          ? escapeHTML(v.north_star)
          : '<div class="muted">—</div>';
      }
    }


    async function runArchetype(){
      const t = requiredTripletOrStatus(els.archStatus); if (!t) return;
      setStatus(els.archStatus, 'Running…', false);
      els.archPretty.replaceChildren(); els.archClass.textContent=''; els.archNorthBody.textContent='';
      try{
        const res = await fetch(API.arch, {
          method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify({...t, provider: DEFAULT_PROVIDER})
        });
        const j = await res.json().catch(()=>null);
        if (!res.ok || j?.error){ setStatus(els.archStatus, j?.error||`HTTP ${res.status}`, false); return; }
        setStatus(els.archStatus, 'OK', true);
        renderArchetype(j?.archetype_playbook ?? j?.playbook ?? j);
      }catch(e){ setStatus(els.archStatus, e.message, false); }
    }

    function renderRisks(payload){
      const v = payload?.assessment || payload?.risks || payload;
      const failures = Array.isArray(v?.failures) ? v.failures : [];

      // Failures + their monitoring
      if (els.riskFailures){
        els.riskFailures.innerHTML = failures.length ? failures.map(f=>{
          const name = `<div style="font-weight:650;">${escapeHTML(f.name||'')}</div>`;
          const mk = (label, arr) => (Array.isArray(arr)&&arr.length)
            ? `<div><strong>${label}:</strong><ul>${arr.map(x=>`<li>${escapeHTML(String(x))}</li>`).join('')}</ul></div>` : '';
          const impact = f.impact ? `<div><strong>Impact:</strong> ${escapeHTML(f.impact)}</div>` : '';
          const counters = mk('Countermeasures', f.countermeasures);
          const symptoms = mk('Symptoms', f.symptoms);

          // Monitoring per failure
          const m = f.monitoring || {};
          const metrics = Array.isArray(m.metrics) ? m.metrics : [];
          const actions = Array.isArray(m.triggered_actions) ? m.triggered_actions : [];
          const metricsHTML = metrics.length ? `<div style="margin-top:.4rem;"><strong>Metrics:</strong><ul>${
            metrics.map(x=>{
              const line = `<strong>${escapeHTML(x.metric||'')}</strong>`;
              const why  = x.rationale ? ` — <span class="muted">${escapeHTML(x.rationale)}</span>` : '';
              const thr  = (x.yellow||x.red)
                ? `<div class="box-kv">Thresholds: yellow=${escapeHTML(String(x.yellow||''))}, red=${escapeHTML(String(x.red||''))}</div>` : '';
              return `<li>${line}${why}${thr}</li>`;
            }).join('')
          }</ul></div>` : '';

          const actionsHTML = actions.length ? `<div style="margin-top:.3rem;"><strong>Triggered Actions:</strong><ul>${
            actions.map(a=>{
              const t = `<strong>${escapeHTML(a.action||'')}</strong>`;
              const owner = a.owner ? ` — <span class="muted">owner: ${escapeHTML(a.owner)}</span>` : '';
              const notes = a.notes ? `<div class="box-kv">${escapeHTML(a.notes)}</div>` : '';
              return `<li>${t}${owner}${notes}</li>`;
            }).join('')
          }</ul></div>` : '';

          return `<div style="margin:.6rem 0;">
            ${name}${impact}${symptoms}${counters}
            ${metricsHTML}${actionsHTML}
          </div>`;
        }).join('') : '<div class="muted">No failures</div>';
      }

    }


    async function runRisks(){
      const t = requiredTripletOrStatus(els.riskStatus); if (!t) return;
      setStatus(els.riskStatus, 'Running…', false);
      clearBoxScroll('#riskFailures .box-scroll');
      try{
        const res = await fetch(API.risks, {
          method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify({...t, provider: DEFAULT_PROVIDER})
        });
        const j = await res.json().catch(()=>null);
        if (!res.ok || j?.error){ setStatus(els.riskStatus, j?.error||`HTTP ${res.status}`, false); return; }
        setStatus(els.riskStatus, 'OK', true);
        renderRisks(j?.assessment ?? j?.risks ?? j);
      }catch(e){ setStatus(els.riskStatus, e.message, false); }
    }


    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, c => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[c]));
    }

    // Wiring
    els.domain.addEventListener('change', onDomainChange);
    els.dimension.addEventListener('change', onDimensionChange);
    els.seed.addEventListener('change', ()=>{
      setStatus(els.selStatus, '', false);
      els.seedIdInput.value = els.seed.value || '';
      renderContext();
    });
    els.seedIdInput.addEventListener('input', ()=>{
      setStatus(els.selStatus, '', false);
      renderContext();
    });

    els.genProtoBtn?.addEventListener('click', generatePrototypeAndBuild);
    els.genArtifactsBtn?.addEventListener('click', generateArtifacts);

    // Validation events
    els.runValidationBtn?.addEventListener('click', runValidation);
    els.runStakeBtn?.addEventListener('click', runStakeholders);
    els.runEmbBtn?.addEventListener('click', runEmbodied);
    els.runRoadBtn?.addEventListener('click', runRoadmap);
    els.runArchBtn?.addEventListener('click', runArchetype);
    els.runRiskBtn?.addEventListener('click', runRisks);

    // Boot
    loadNarratives().then(maybeDeepLink);
    renderContext();
  })();
  </script>
</body>
</html>
