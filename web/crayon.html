<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fantasiagenesis · Crayon</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; margin: 2rem; max-width: 1100px; }
    header h1 { margin: 0 0 .35rem 0; font-size: clamp(1.25rem, 2.4vw, 1.75rem); }
    .muted { opacity:.85; font-size:.9rem; }
    .row { display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; }
    .panel { border:1px solid color-mix(in oklab, CanvasText 20%, transparent); border-radius:.6rem; padding: .8rem 1rem; background: color-mix(in oklab, Canvas 92%, CanvasText 8%); }
    .panel.blue { border-color: color-mix(in oklab, dodgerblue 40%, CanvasText 20%); background: color-mix(in oklab, Canvas 88%, dodgerblue 12%); box-shadow: 0 1px 0 rgba(30,144,255,.12) inset; }
    input[type="text"], input[type="email"], textarea { width: min(92vw, 56rem); padding:.6rem .7rem; border:1px solid #c9c9c9; border-radius:.55rem; }
    input[type="text"], input[type="email"] { height: 2.5rem; }
    textarea { min-height: 6rem; }
    button { padding:.65rem .95rem; border:0; border-radius:.55rem; cursor:pointer; background:#0b5cff; color:#fff; }
    button.secondary { background:#444; }
    .badge { font-size:.8rem; padding:.15rem .45rem; border:1px solid #ddd; border-radius:.4rem; }
    .grid { display:grid; gap:.9rem; }
    .columns { display:grid; gap: .9rem; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .group-block { border:1px solid #e2e2e2; border-radius:.6rem; padding:.75rem .9rem; background: rgba(0,0,0,.02); }
    .group-title { font-weight:600; display:flex; align-items:center; gap:.45rem; margin-bottom:.4rem; }
    .domain-card { border:1px solid #e5e5e5; border-radius:.6rem; padding:.6rem .75rem; background: color-mix(in oklab, Canvas 96%, CanvasText 4%); }
    .domain-head { font-weight:600; margin-bottom:.25rem; display:flex; align-items:center; gap:.4rem; justify-content:space-between; }
    .meta { font-size:.9rem; opacity:.9; margin:.5rem 0 .8rem; }
    .error { color:#b00020; white-space:pre-wrap; }
    .dim-list { margin-top:.5rem; display:grid; gap:.35rem; }
    .dim-item { border:1px dashed #d5d5d5; border-radius:.5rem; padding:.45rem .55rem; background: color-mix(in oklab, Canvas 98%, CanvasText 2%); }
    .dim-name { font-weight:600; }
    pre { background:#f6f6f6; padding:.75rem; border-radius:.5rem; overflow-x:auto; }
    .core-row{border:1px solid #e1e1e1;border-radius:.55rem;padding:.6rem .7rem;background:color-mix(in oklab, Canvas 97%, CanvasText 3%);display:grid;gap:.4rem}
    .core-row .row{gap:.4rem}
  </style>
</head>
<body>
  <header>
    <h1>Fantasiagenesis · Crayon</h1>
    <p class="muted">Enter a <strong>title</strong> and <strong>description</strong> of what you would like to create (one or more), click <em>Draw All</em> to architect a blueprint.</p>
  </header>

  <section class="panel blue" aria-labelledby="h-how">
    <header><p id="h-how" style="margin:0;font-weight:600;">Flow</p></header>
    <div class="content" style="font-size:.92rem; line-height:1.45;">
      <ol style="margin:.4rem 0 0; padding-left:1.1rem;">
        <li>Save your email (recommended) so results persist.</li>
        <li>Add one or more cores (what you are creating/building/investigating) below.</li>
        <li>Press <strong>Draw All</strong>. We’ll architect a blueprint to get you from a -> b.</li>
      </ol>
    </div>
  </section>

  <div class="row">
    <input type="email" id="emailInput" placeholder="Email (saves results under your account — optional but recommended)" />
    <button type="button" id="saveEmailBtn" class="secondary" title="Save email locally">Save email</button>
  </div>

  <section class="panel" aria-labelledby="core-head">
    <header id="core-head">Cores</header>
    <div class="content">
      <div id="coresRepeater" class="list"></div>
      <div class="row" style="margin-top:.5rem;">
        <button id="addCoreBtn" type="button">+ Add core</button>
        <button id="drawAllBtn" type="button" style="margin-left:auto;">Draw All</button>
      </div>
      <div id="multiStatus" class="muted" style="margin-top:.5rem;"></div>
    </div>
  </section>

  <div id="container"></div>

  <script>
    // ------- Config -------
    const EMAIL_KEY = 'fg_user_email';
    const EP_DOMAIN_ARCH = '/api/domain-architect';
    const EP_DIM_GEN     = '/api/dimensions/generate';
    const EP_THESIS_GEN  = '/api/thesis/generate';
    const EP_THESIS_EVAL = '/api/thesis/evaluate';
    const EP_LIST_THESES = (dimensionId, email) => `/api/dimensions/${dimensionId}/theses?email=${encodeURIComponent(email)}`;

    // ------- Elements -------
    const elEmail = document.getElementById('emailInput');
    const btnSave = document.getElementById('saveEmailBtn');
    const container = document.getElementById('container');

    // ------- Utils -------
    function el(tag, opts={}) {
      const n = document.createElement(tag);
      if (opts.className) n.className = opts.className;
      if ('text' in opts) n.textContent = opts.text;
      if ('html' in opts) n.innerHTML = opts.html;
      if (opts.attrs) Object.entries(opts.attrs).forEach(([k,v])=> n.setAttribute(k,v));
      return n;
    }
    function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }
    async function fetchWithTimeout(url, options={}, timeoutMs=180000){
      const controller = new AbortController();
      const id = setTimeout(()=> controller.abort(), timeoutMs);
      try { return await fetch(url, { ...options, signal: controller.signal }); }
      finally { clearTimeout(id); }
    }
    async function postJSON(url, body, timeoutMs=180000){
      const resp = await fetchWithTimeout(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }, timeoutMs);
      let data; try { data = await resp.json(); } catch { throw new Error(`Non-JSON response from ${url} (status ${resp.status})`); }
      if (!resp.ok || data?.ok === false) {
        const msg = (data && (data.error||data.detail)) ? `${data.error||''} ${data.detail||''}`.trim() : `HTTP ${resp.status}`;
        throw new Error(msg);
      }
      return data;
    }

    // Run an async iterator over items with at most `limit` in-flight
    async function mapLimit(items, limit, iteratee) {
        const results = new Array(items.length);
        let next = 0, active = 0;
        return new Promise((resolve, reject) => {
            const launch = () => {
            while (active < limit && next < items.length) {
                const i = next++;
                active++;
                Promise.resolve()
                .then(() => iteratee(items[i], i))
                .then(r => { results[i] = r; })
                .catch(reject)
                .finally(() => {
                    active--;
                    if (results.length === items.length && next >= items.length && active === 0) resolve(results);
                    else launch();
                });
            }
            };
            launch();
        });
    }

    function saveEmailToStorage(v){ const s = String(v||'').trim().toLowerCase(); if (s) localStorage.setItem(EMAIL_KEY, s); else localStorage.removeItem(EMAIL_KEY); }
    function readEmailFromStorage(){ return (localStorage.getItem(EMAIL_KEY)||'').trim().toLowerCase(); }
    function prefillEmail(){ const v = readEmailFromStorage(); if (v && elEmail && !elEmail.value) elEmail.value = v; }

    // ------- Multi-core inputs -------
    function coreRowTemplate(i){
      const wrap  = el('div', { className:'core-row', attrs:{ 'data-idx': String(i) }});
      const title = el('input', { attrs:{ type:'text', placeholder:'Core title… (e.g., Chicago Microgrids)', name:`core_title_${i}` }});
      const desc  = el('input', { attrs:{ type:'text', placeholder:'Core description… (what are you creating / exploring / building? - "building solar microgrids in the city of Chicago")', name:`core_desc_${i}` }});
      const row   = el('div', { className:'row' });
      const del   = el('button', { className:'secondary', text:'Remove', attrs:{ type:'button' }});
      del.addEventListener('click', ()=> wrap.remove());
      row.append(del);
      wrap.append(title, desc, row);
      return wrap;
    }
    function addCoreRow(){
      const cont = document.getElementById('coresRepeater');
      const i = cont.children.length + 1;
      cont.append(coreRowTemplate(i));
    }
    function readCorePairs(){
      const cont = document.getElementById('coresRepeater');
      const pairs = [];
      cont.querySelectorAll('.core-row').forEach(row=>{
        const title = row.querySelector('input[name^="core_title_"]')?.value?.trim();
        const desc  = row.querySelector('input[name^="core_desc_"]')?.value?.trim();
        if (title) pairs.push({ title, description: desc || '' });
      });
      return pairs;
    }

    // ------- Renderer -------
    function render(core, groups){
      if (container.children.length) container.append(el('hr'));
      const h2 = el('h2', { text: core.title });
      const desc = el('div', { className: 'muted', text: core.description || '' });
      container.append(h2, desc);

      const meta = el('div', { className:'meta', html:
        `Core ID: <code>${escapeHtml(String(core.id || ''))}</code> · Owner: <code>${escapeHtml(core.owner_email||'')}</code> · Provider: <span class="badge">${escapeHtml(core.provider||'openai')}</span>`
      });
      container.append(meta);

      if (!Array.isArray(groups) || !groups.length){
        container.append(el('div', { className:'muted', text:'No domain groups returned.' }));
        return;
      }

      groups.forEach(g=>{
        const block = el('div', { className:'group-block' });
        const head = el('div', { className:'group-title', html: `${escapeHtml(g.title || 'Domains')} <span class="badge">group</span>` });
        const cols = el('div', { className:'columns' });

        (g.domains||[]).forEach(d=>{
          const card = el('div', { className:'domain-card' });
          const domTitle = el('div', { className:'domain-head', html:
            `${escapeHtml(d.name || 'Untitled domain')} ${d.id ? `<span class="badge">id ${escapeHtml(String(d.id))}</span>` : ''}`
          });
          const domDesc = el('div', { className:'muted', text: d.description || '' });
          const dimList = el('div', { className:'dim-list', attrs: { id: `dim-${d.id}` } });
          card.append(domTitle, domDesc, dimList);
          cols.append(card);
        });

        block.append(head, cols);
        container.append(block);
      });
    }

    // ------- Thesis + Evaluation -------
    async function generateThesisAndEval(dimensionId){
      const email = (elEmail.value || readEmailFromStorage() || '').trim().toLowerCase();
      const mountThesis = document.getElementById(`thesis-${dimensionId}`);
      const mountEval   = document.getElementById(`eval-${dimensionId}`);
      if (mountThesis) mountThesis.textContent = 'Generating thesis…';
      if (mountEval)   mountEval.textContent   = '';

      // 1) Generate thesis
      let thesis;
      try{
        const res = await postJSON(EP_THESIS_GEN, {
          email, dimension_id: dimensionId, model: 'gpt-5-mini-2025-08-07'
        }, 180000);
        thesis = res?.thesis;
        if (!thesis?.id) throw new Error('No thesis id');
        if (mountThesis) mountThesis.innerHTML = `<strong>Thesis:</strong> ${escapeHtml(thesis.text || '')}`;
      }catch(err){
        if (mountThesis) mountThesis.innerHTML = `<span class="error">Thesis failed: ${escapeHtml(err.message||String(err))}</span>`;
        return;
      }

      // 2) Evaluate thesis
      if (mountEval) mountEval.textContent = 'Evaluating thesis…';
      try{
        const res = await postJSON(EP_THESIS_EVAL, {
          email, thesis_id: thesis.id, model: 'gpt-5-mini-2025-08-07', save: true
        }, 180000);
        const a = res?.analysis || {};
        const ver = Array.isArray(a.verification) ? a.verification : [];
        mountEval.innerHTML =
          `<div><strong>Verification / Falsification</strong><ul>${
            ver.map(v=>`<li>${escapeHtml(v)}</li>`).join('')
          }</ul></div>
          <div style="margin-top:.3rem;"><strong>If True</strong><div class="muted">${escapeHtml(a.if_true||'')}</div></div>
          <div style="margin-top:.3rem;"><strong>If False (Alternative Thesis)</strong><div class="muted">${escapeHtml(a.if_false_alternative_thesis||'')}</div></div>`;
      }catch(err){
        if (mountEval) mountEval.innerHTML = `<span class="error">Evaluation failed: ${escapeHtml(err.message||String(err))}</span>`;
      }
    }

    // ------- Dimensions -------
    async function generateDimsForDomain(domainId, count=3){
      const email = (elEmail.value || readEmailFromStorage() || '').trim().toLowerCase();
      if (!domainId) return;
      try{
        const res = await postJSON(EP_DIM_GEN, { email, domain_id: domainId, count, model: 'gpt-5-mini-2025-08-07' });
        const dims = res.dimensions || [];
        const mount = document.getElementById(`dim-${domainId}`);
        if (mount) {
          mount.innerHTML = '';
          if (!dims.length) {
            mount.append(el('div', { className:'muted', text:'No dimensions returned.' }));
          } else {
            dims.forEach(d=>{
              const it = el('div', { className:'dim-item' });
              const nm = el('div', { className:'dim-name', text: d.name || 'Dimension' });
              const th = el('div', { className:'muted', text: d.thesis || '' });
              const tg = el('div', { className:'muted', text: (d.targets||[]).join(', ') });
              const thesisMount = el('div', { className:'muted', attrs:{ id:`thesis-${d.id}` } });
              const evalMount   = el('div', { className:'muted', attrs:{ id:`eval-${d.id}` } });
              it.append(nm, th, tg, thesisMount, evalMount);
              mount.append(it);
            });
            for (const dim of dims) {
              if (dim?.id) {
                await generateThesisAndEval(dim.id);
              }
            }
          }
        }
      }catch(err){
        alert(`Failed to draw dimensions: ${err.message || err}`);
      }
    }

    // ------- Domain Architect (single call helper) -------
    async function runDomainArchitect(email, title, description, model='gpt-5-mini-2025-08-07'){
      return postJSON(EP_DOMAIN_ARCH, {
        email: email || '',
        core_title: title,
        core_description: description,
        model
      }, 600000);
    }

    // ------- Draw All (sequential multi-core) -------
    async function processSingleCore(p, email, multiStatus, idx, total) {
        multiStatus.textContent = `Drawing "${p.title}"… (${idx+1}/${total})`;

        // 1) Domain Architect
        const arch = await runDomainArchitect(email, p.title, p.description);

        // 2) Render the result (stacked)
        render(arch.core || { title: p.title, description: p.description, owner_email: email }, arch.groups || []);

        // 3) For each domain -> dimensions -> thesis/eval (limit concurrency inside a core)
        const groups = arch.groups || [];
        const domains = groups.flatMap(g => g.domains || []).filter(d => d?.id);

        const innerLimit = Math.min(2, parseInt(document.getElementById('concurrencyInput')?.value || '2', 10) || 2);
        await mapLimit(domains, innerLimit, async (d) => {
            await generateDimsForDomain(d.id, 3);
        });

        multiStatus.textContent = `Done "${p.title}". (${idx+1}/${total})`;
        }

    async function drawAllSequential(){ // keeps the same id hook
        const email = (elEmail?.value || readEmailFromStorage() || '').trim().toLowerCase();
        const multiStatus = document.getElementById('multiStatus');
        if (!email){ alert('Enter owner email first.'); return; }

        const pairs = readCorePairs();
        if (!pairs.length){ alert('Add at least one core.'); return; }

        // Read pool size from UI; fallback to 2 if missing
        const n = Math.max(1, Math.min(8, parseInt(document.getElementById('concurrencyInput')?.value || '2', 10) || 2));

        let completed = 0;
        multiStatus.textContent = `Starting… 0 / ${pairs.length} (concurrency ${n})`;

        try {
            await mapLimit(pairs, n, async (p, i) => {
            try {
                await processSingleCore(p, email, multiStatus, i, pairs.length);
            } catch (err) {
                console.error(err);
                container.append(el('div',{className:'error',text:`Failed on "${p.title}": ${err.message||err}`}));
            } finally {
                completed++;
                multiStatus.textContent = `Progress: ${completed} / ${pairs.length} (concurrency ${n})`;
                await new Promise(r=>setTimeout(r, 100)); // small breather for UI paints
            }
            });
        } finally {
            multiStatus.textContent = `All done. ${completed} / ${pairs.length} succeeded.`;
            if (email) saveEmailToStorage(email);
        }
    }


    // ------- Init -------
    btnSave?.addEventListener('click', ()=>{
      const em = (elEmail?.value||'').trim().toLowerCase();
      if (!em) { alert('Enter an email to save.'); return; }
      saveEmailToStorage(em);
      const old = btnSave.textContent; btnSave.textContent = 'Saved'; setTimeout(()=> btnSave.textContent = old, 1200);
    });
    (function init(){
      prefillEmail();
      // seed one empty row for multi-core
      addCoreRow();
      document.getElementById('addCoreBtn').addEventListener('click', addCoreRow);
      document.getElementById('drawAllBtn').addEventListener('click', drawAllSequential);
    })();
  </script>
</body>
</html>
