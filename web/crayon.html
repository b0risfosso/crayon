<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fantasiagenesis · Crayon</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; margin: 2rem; max-width: 1100px; }
    header h1 { margin: 0 0 .35rem 0; font-size: clamp(1.25rem, 2.4vw, 1.75rem); }
    .muted { opacity:.85; font-size:.9rem; }
    .row { display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; }
    .panel { border:1px solid color-mix(in oklab, CanvasText 20%, transparent); border-radius:.6rem; padding: .8rem 1rem; background: color-mix(in oklab, Canvas 92%, CanvasText 8%); }
    .panel.blue { border-color: color-mix(in oklab, dodgerblue 40%, CanvasText 20%); background: color-mix(in oklab, Canvas 88%, dodgerblue 12%); box-shadow: 0 1px 0 rgba(30,144,255,.12) inset; }
    input[type="text"], input[type="email"], textarea { width: min(92vw, 56rem); padding:.6rem .7rem; border:1px solid #c9c9c9; border-radius:.55rem; }
    input[type="text"], input[type="email"] { height: 2.5rem; }
    textarea { min-height: 6rem; }
    button { padding:.65rem .95rem; border:0; border-radius:.55rem; cursor:pointer; background:#0b5cff; color:#fff; }
    button.secondary { background:#444; }
    .badge { font-size:.8rem; padding:.15rem .45rem; border:1px solid #ddd; border-radius:.4rem; }
    .grid { display:grid; gap:.9rem; }
    .columns { display:grid; gap: .9rem; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .group-block { border:1px solid #e2e2e2; border-radius:.6rem; padding:.75rem .9rem; background: rgba(0,0,0,.02); }
    .group-title { font-weight:600; display:flex; align-items:center; gap:.45rem; margin-bottom:.4rem; }
    .domain-card { border:1px solid #e5e5e5; border-radius:.6rem; padding:.6rem .75rem; background: color-mix(in oklab, Canvas 96%, CanvasText 4%); }
    .domain-head { font-weight:600; margin-bottom:.25rem; display:flex; align-items:center; gap:.4rem; }
    .meta { font-size:.9rem; opacity:.9; margin:.5rem 0 .8rem; }
    .error { color:#b00020; white-space:pre-wrap; }
    pre { background:#f6f6f6; padding:.75rem; border-radius:.5rem; overflow-x:auto; }
  </style>
</head>
<body>
  <header>
    <h1>Fantasiagenesis · Crayon</h1>
    <p class="muted">Enter <strong>a single core</strong> (title + description). We’ll call the Domain Architect and display its groups & domains.</p>
  </header>

  <section class="panel blue" aria-labelledby="h-how">
    <header><p id="h-how" style="margin:0;font-weight:600;">How this page works</p></header>
    <div class="content" style="font-size:.92rem; line-height:1.45;">
      <ul style="margin: .4rem 0 0; padding-left:1.1rem; display:grid; gap:.35rem;">
        <li>Provide a <strong>core title</strong> and <strong>core description</strong>.</li>
        <li>Optionally add your <strong>email</strong> (recommended) so results are saved to the new schema.</li>
        <li>Click <em>Generate Domains</em> to call <code>/api/domain-architect</code> (OpenAI).</li>
      </ul>
    </div>
  </section>

  <form id="form" autocomplete="off" style="display:grid; gap:.8rem; margin:1rem 0 1.25rem;">
    <input id="coreTitle" type="text" placeholder="Core title (e.g., Unity Through Alignment)" />
    <textarea id="coreDescription" placeholder="Core description (what are you exploring / building?)"></textarea>

    <div class="row">
      <input type="email" id="emailInput" placeholder="Email (saves results under your account — optional but recommended)" />
      <button type="button" id="saveEmailBtn" class="secondary" title="Save email locally">Save email</button>
    </div>

    <div class="row">
      <button type="submit">Generate Domains</button>
      <span id="hint" class="muted">Provider: <span class="badge">openai</span> · Endpoint: <code>/api/domain-architect</code></span>
    </div>
  </form>

  <div id="globalStatus" class="meta"></div>
  <div id="container"></div>

  <script>
    // ------- Config -------
    const EMAIL_KEY = 'fg_user_email'; // reuse same key as other pages
    const ENDPOINT = '/api/domain-architect'; // new OpenAI-only route

    // ------- Elements -------
    const elTitle = document.getElementById('coreTitle');
    const elDesc  = document.getElementById('coreDescription');
    const elEmail = document.getElementById('emailInput');
    const btnSave = document.getElementById('saveEmailBtn');
    const form    = document.getElementById('form');
    const status  = document.getElementById('globalStatus');
    const container = document.getElementById('container');

    // ------- Utils -------
    function el(tag, opts={}) {
      const n = document.createElement(tag);
      if (opts.className) n.className = opts.className;
      if ('text' in opts) n.textContent = opts.text;
      if ('html' in opts) n.innerHTML = opts.html;
      if (opts.attrs) Object.entries(opts.attrs).forEach(([k,v])=> n.setAttribute(k,v));
      return n;
    }
    function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }
    async function fetchWithTimeout(url, options={}, timeoutMs=180000){
      const controller = new AbortController();
      const id = setTimeout(()=> controller.abort(), timeoutMs);
      try { return await fetch(url, { ...options, signal: controller.signal }); }
      finally { clearTimeout(id); }
    }
    async function postJSON(url, body, timeoutMs=180000){
      const resp = await fetchWithTimeout(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }, timeoutMs);
      let data; try { data = await resp.json(); } catch { throw new Error(`Non-JSON response from ${url} (status ${resp.status})`); }
      if (!resp.ok) {
        const msg = (data && (data.error||data.detail)) ? `${data.error||''} ${data.detail||''}`.trim() : `HTTP ${resp.status}`;
        throw new Error(msg);
      }
      return data;
    }

    // ------- Email storage -------
    function saveEmailToStorage(email){
      const v = String(email||'').trim().toLowerCase();
      if(v) localStorage.setItem(EMAIL_KEY, v); else localStorage.removeItem(EMAIL_KEY);
    }
    function readEmailFromStorage(){ return (localStorage.getItem(EMAIL_KEY)||'').trim().toLowerCase(); }
    function prefillEmail(){
      const v = readEmailFromStorage();
      if (v && elEmail && !elEmail.value) elEmail.value = v;
    }
    btnSave?.addEventListener('click', ()=>{
      const em = (elEmail?.value||'').trim().toLowerCase();
      if (!em) { alert('Enter an email to save.'); return; }
      saveEmailToStorage(em);
      const old = btnSave.textContent; btnSave.textContent = 'Saved'; setTimeout(()=> btnSave.textContent = old, 1200);
    });

    // ------- Render -------
    function renderResult(core, result){
      container.innerHTML = '';
      const h2 = el('h2', { text: core.title });
      const desc = el('div', { className: 'muted', text: core.description || '' });
      container.append(h2, desc);

      const meta = el('div', { className:'meta', html:
        `Core ID: <code>${escapeHtml(String(core.id || ''))}</code> · Owner: <code>${escapeHtml(core.owner_email||'')}</code> · Provider: <span class="badge">openai</span>`
      });
      container.append(meta);

      const groups = Array.isArray(result?.groups) ? result.groups : [];
      if (!groups.length) {
        container.append(el('div', { className:'muted', text:'No domain groups returned.' }));
        return;
      }

      groups.forEach(g=>{
        const block = el('div', { className:'group-block' });
        const head = el('div', { className:'group-title', html: `${escapeHtml(g.title || 'Domains')} <span class="badge">group</span>` });
        const cols = el('div', { className:'columns' });
        block.append(head, cols);

        const doms = Array.isArray(g.domains) ? g.domains : [];
        doms.forEach(d=>{
          const card = el('div', { className:'domain-card' });
          const domHead = el('div', { className:'domain-head', html:
            `${escapeHtml(d.name || 'Untitled domain')} ${d.id ? `<span class="badge">id ${escapeHtml(String(d.id))}</span>` : ''}`
          });
          const domDesc = el('div', { className:'muted', text: d.description || '' });
          card.append(domHead, domDesc);
          cols.append(card);
        });

        container.append(block);
      });

      // raw JSON toggle (debug)
      const details = el('details');
      const sum = el('summary', { text: 'Raw JSON (debug)' });
      const pre = el('pre');
      pre.textContent = JSON.stringify({ core, groups: result.groups }, null, 2);
      details.append(sum, pre);
      container.append(details);
    }

    // ------- Submit -------
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      status.textContent = '';
      container.innerHTML = '';

      const title = (elTitle.value || '').trim();
      const description = (elDesc.value || '').trim();
      const email = (elEmail.value || readEmailFromStorage() || '').trim().toLowerCase();

      if (!title) { status.textContent = 'Please enter a core title.'; return; }
      if (!email) status.textContent = 'No email entered — results may not be saved to your account.';

      const body = {
        email: email || '',                 // backend accepts empty, but saving requires it
        core_title: title,
        core_description: description,
        model: 'gpt-4o-mini'
      };

      try {
        status.textContent = 'Architecting domains…';
        const data = await postJSON(ENDPOINT, body);
        // data shape from crayon.py: { ok, provider, model, core:{...}, groups:[{title, domains:[{id,name,description}]}] }
        if (!data?.ok) throw new Error(data?.error || 'Unknown error');
        renderResult(data.core || { title, description, owner_email: email }, { groups: data.groups || [] });
        status.textContent = 'Done.';
        if (email) saveEmailToStorage(email);
      } catch (err) {
        status.className = 'meta error';
        status.textContent = `Domain architecture failed: ${err.message || err}`;
      }
    });

    // ------- Init -------
    prefillEmail();
  </script>
</body>
</html>
