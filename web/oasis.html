<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Oasis</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, sans-serif; background: #f7f7f7; color: #111; }
    main { max-width: 1100px; margin: 0 auto; padding: 24px 18px 48px; }
    header { display: flex; justify-content: space-between; align-items: baseline; gap: 12px; margin-bottom: 16px; }
    h1 { margin: 0; font-size: 22px; }
    .muted { color: #666; font-size: 13px; }
    .card { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; padding: 14px 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); }
    .stack { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .grid-2 { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px) {
      .grid-2 { grid-template-columns: 1fr 1fr; }
    }
    label { font-size: 13px; font-weight: 600; }
    select, textarea { width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 8px; border: 1px solid #d9d9d9; font-size: 14px; font-family: inherit; background: #fbfbfb; }
    textarea { min-height: 120px; resize: vertical; }
    button { padding: 9px 12px; border-radius: 8px; border: 1px solid #c9c9c9; background: linear-gradient(180deg, #fff, #f0f0f0); cursor: pointer; font-weight: 600; font-size: 14px; }
    button:hover { background: #f7f7f7; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .error { color: #b00020; font-size: 13px; margin-top: 6px; }
    pre { white-space: pre-wrap; margin: 0; line-height: 1.6; }
    details { border: 1px solid #e6e6e6; border-radius: 10px; background: #fff; padding: 10px 12px; }
    summary { cursor: pointer; font-weight: 700; display: flex; align-items: center; gap: 8px; list-style: none; }
    summary::-webkit-details-marker { display: none; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef3ff; color: #325ac0; font-size: 11px; border: 1px solid #d7e1ff; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .entity-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 260px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid #e5e5e5;
      padding: 8px;
      background: #f9fafb;
    }
  </style>
</head>
<body>
  <main>
    <header>
      <div>
        <h1>Oasis</h1>
        <div class="muted">Art + color context into story pipeline.</div>
      </div>
      <div class="muted" id="status"></div>
    </header>

    <section class="stack">
      <div class="card">
        <div class="muted">Art</div>
        <div id="art-meta" class="muted" style="margin-top:4px;"></div>
        <pre id="art-text" style="margin-top:8px;">Loading art...</pre>
      </div>
      <div class="card">
        <div class="muted">Color</div>
        <div id="color-meta" class="muted" style="margin-top:4px;"></div>
        <pre id="color-text" style="margin-top:8px;">Loading color...</pre>
      </div>
    </section>

    <section class="card" style="margin-top:14px;">
      <form id="storyForm" class="stack">
        <div>
          <label>Entities (material / energetic / monetary system)</label>
          <div id="entityList" class="entity-list" style="margin-top:6px;"></div>
          <div class="row" style="margin-top:8px;">
            <label for="randomCount" class="muted">Random N</label>
            <input id="randomCount" type="number" min="1" value="3" style="width:80px;" />
            <button type="button" id="randomPickBtn">Pick random</button>
            <button type="button" id="clearSelectionBtn">Clear</button>
          </div>
        </div>
        <div>
          <label for="promptSelect">Story prompt</label>
          <select id="promptSelect">
            <option value="connection">Connection</option>
            <option value="origin">Origin / Production</option>
            <option value="conflict">Conflict</option>
            <option value="coordination">Coordination</option>
            <option value="relationship">Relationship Types</option>
          </select>
        </div>
        <div class="row">
          <button type="submit" id="submitButton">Run story pipeline</button>
          <div id="formError" class="error" role="alert" aria-live="polite"></div>
        </div>
      </form>
    </section>

    <section class="grid-2" style="margin-top:14px;">
      <div class="card">
        <h2 style="margin:0 0 8px; font-size:16px;">Stories</h2>
        <pre id="storyOutput" class="muted">No output yet.</pre>
      </div>
      <div class="card">
        <h2 style="margin:0 0 8px; font-size:16px;">Sources</h2>
        <pre id="sourcesOutput" class="muted">No output yet.</pre>
      </div>
    </section>

    <section style="margin-top:14px;">
      <div class="card">
        <h2 style="margin:0 0 8px; font-size:16px;">Previous stories</h2>
        <div id="historyList" class="muted">Loading history...</div>
      </div>
    </section>
  </main>

  <script>
    const params = new URLSearchParams(window.location.search);
    const artId = parseInt(params.get("art_id") || "", 10);
    const colorId = parseInt(params.get("color_id") || "", 10);

    const entityList = document.getElementById("entityList");
    const randomCount = document.getElementById("randomCount");
    const randomPickBtn = document.getElementById("randomPickBtn");
    const clearSelectionBtn = document.getElementById("clearSelectionBtn");
    const promptSelect = document.getElementById("promptSelect");
    const storyOutput = document.getElementById("storyOutput");
    const sourcesOutput = document.getElementById("sourcesOutput");
    const historyList = document.getElementById("historyList");
    const statusEl = document.getElementById("status");
    const formError = document.getElementById("formError");
    const submitButton = document.getElementById("submitButton");

    let entities = [];
    let selectedEntityIds = new Set();

    if (!artId || !colorId) {
      document.getElementById("art-text").textContent = "Missing art_id or color_id.";
      document.getElementById("color-text").textContent = "Missing art_id or color_id.";
    } else {
      loadArt();
      loadColor();
      loadEntities();
    }

    async function loadArt() {
      try {
        const res = await fetch(`/art/api/art/${artId}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "Failed to load art");
        document.getElementById("art-meta").textContent =
          `Art #${data.id || artId} · ${data.created_at || ""}`;
        document.getElementById("art-text").textContent = data.art || "";
      } catch (err) {
        document.getElementById("art-text").textContent = `Error: ${err.message || err}`;
      }
    }

    async function loadColor() {
      try {
        const res = await fetch(`/colors/${colorId}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "Failed to load color");
        document.getElementById("color-meta").textContent =
          `Color #${data.id || colorId} · ${data.origin || ""} · ${data.created_at || ""}`;
        document.getElementById("color-text").textContent = data.output_text || "";
      } catch (err) {
        document.getElementById("color-text").textContent = `Error: ${err.message || err}`;
      }
    }

    async function loadEntities() {
      entityList.innerHTML = "";
      try {
        const res = await fetch("/oasis");
        if (!res.ok) throw new Error("Failed to load entities");
        entities = await res.json();
        if (!entities.length) {
          entityList.textContent = "No entities available.";
          return;
        }
        renderEntityList();
        await loadHistory();
      } catch (err) {
        formError.textContent = err.message || "Could not load entities.";
      }
    }

    function renderEntityList() {
      entityList.innerHTML = "";
      entities.forEach((entity) => {
        const row = document.createElement("label");
        row.className = "row";
        row.style.alignItems = "center";
        row.style.margin = "4px 0";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = entity.id;
        checkbox.checked = selectedEntityIds.has(entity.id);
        checkbox.addEventListener("change", () => {
          if (checkbox.checked) {
            selectedEntityIds.add(entity.id);
          } else {
            selectedEntityIds.delete(entity.id);
          }
        });

        const title = document.createElement("span");
        title.textContent = entity.name || `Entity ${entity.id}`;

        row.appendChild(checkbox);
        row.appendChild(title);
        entityList.appendChild(row);
      });
    }

    function selectRandomEntities() {
      selectedEntityIds.clear();
      const n = Math.max(1, Math.min(parseInt(randomCount.value, 10) || 1, entities.length));
      const shuffled = [...entities].sort(() => Math.random() - 0.5);
      shuffled.slice(0, n).forEach((entity) => selectedEntityIds.add(entity.id));
      renderEntityList();
    }

    randomPickBtn.addEventListener("click", () => {
      selectRandomEntities();
    });

    clearSelectionBtn.addEventListener("click", () => {
      selectedEntityIds.clear();
      renderEntityList();
    });

    document.getElementById("storyForm").addEventListener("submit", async (event) => {
      event.preventDefault();
      formError.textContent = "";
      statusEl.textContent = "Queued...";
      storyOutput.textContent = "Running...";
      sourcesOutput.textContent = "Running...";

      if (selectedEntityIds.size === 0) {
        formError.textContent = "Select at least one entity.";
        return;
      }
      if (!artId || !colorId) {
        formError.textContent = "Missing art_id or color_id.";
        return;
      }

      submitButton.disabled = true;

      try {
        const tasks = Array.from(selectedEntityIds).map((id) => {
          return fetch("/oasis/story", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              entity_id: Number(id),
              art_id: artId,
              color_id: colorId,
              prompt_type: promptSelect.value
            })
          }).then(async (res) => {
            if (!res.ok) {
              const msg = await res.text();
              throw new Error(msg || "Request failed");
            }
            return res.json();
          });
        });

        const taskResponses = await Promise.all(tasks);
        await Promise.all(taskResponses.map((t) => pollTask(t.task_id)));
      } catch (err) {
        formError.textContent = err.message || "Failed to enqueue task.";
        statusEl.textContent = "";
      } finally {
        submitButton.disabled = false;
      }
    });

    async function pollTask(taskId) {
      const pollInterval = 2000;
      while (true) {
        const res = await fetch(`/oasis/llm/tasks/${taskId}`);
        if (!res.ok) {
          formError.textContent = "Unable to read task status.";
          statusEl.textContent = "";
          return;
        }
        const task = await res.json();
        statusEl.textContent = task.status || "unknown";
        if (task.status === "done") {
          storyOutput.textContent = task.result?.story_text || "No story output.";
          sourcesOutput.textContent = task.result?.sources_text || "No sources output.";
          statusEl.textContent = "done";
          await loadHistory();
          return;
        }
        if (task.status === "error") {
          storyOutput.textContent = "Failed.";
          sourcesOutput.textContent = "Failed.";
          formError.textContent = task.error || "Task failed.";
          statusEl.textContent = "error";
          return;
        }
        await new Promise((resolve) => setTimeout(resolve, pollInterval));
      }
    }


    async function loadHistory() {
      historyList.textContent = "Loading...";
      try {
        const url = `/oasis/story/runs?art_id=${encodeURIComponent(artId)}&color_id=${encodeURIComponent(colorId)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("Failed to load history");
        const runs = await res.json();
        renderHistory(Array.isArray(runs) ? runs : []);
      } catch (err) {
        historyList.textContent = err.message || "Could not load history.";
      }
    }

    function renderHistory(runs) {
      historyList.innerHTML = "";
      if (!runs.length) {
        historyList.textContent = "No stories yet for this art/color.";
        return;
      }
      runs.forEach((run) => {
        const wrapper = document.createElement("details");
        const summary = document.createElement("summary");
        const promptLabel = run.prompt_type ? ` · ${run.prompt_type}` : "";
        summary.textContent = `${run.entity_title || "Entity"}${promptLabel} · ${run.created_at || "unknown time"}`;
        const pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = `#${run.id}`;
        summary.appendChild(pill);

        const actionRow = document.createElement("div");
        actionRow.className = "row";
        actionRow.style.margin = "8px 0";
        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = async () => {
          if (!confirm("Delete this story run?")) return;
          try {
            const res = await fetch(`/oasis/story/runs/${run.id}`, { method: "DELETE" });
            if (!res.ok) throw new Error("Delete failed");
            await loadHistory();
          } catch (err) {
            alert(err.message || "Could not delete.");
          }
        };
        actionRow.appendChild(deleteBtn);

        const grid = document.createElement("div");
        grid.className = "grid-2";

        const storyBlock = document.createElement("pre");
        storyBlock.textContent = run.story_text || "No story output.";

        const sourcesBlock = document.createElement("pre");
        sourcesBlock.textContent = run.sources_text || "No sources output.";

        grid.appendChild(storyBlock);
        grid.appendChild(sourcesBlock);

        wrapper.appendChild(summary);
        wrapper.appendChild(actionRow);
        wrapper.appendChild(grid);
        historyList.appendChild(wrapper);
      });
    }
  </script>
</body>
</html>
