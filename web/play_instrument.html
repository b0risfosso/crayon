<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Play Instrument</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, sans-serif; background: radial-gradient(circle at 15% 20%, #fefefe, #f2f4ff 38%, #f9f9f9); min-height: 100vh; color: #111; }
    main { max-width: 760px; margin: 0 auto; padding: 32px 18px 48px; }
    a { color: #0b68d0; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    h1 { margin: 0; font-size: 24px; }
    .card { margin-top: 16px; background: #fff; border: 1px solid #e5e5e5; border-radius: 12px; padding: 18px 20px; box-shadow: 0 10px 36px rgba(0,0,0,0.05); }
    .muted { color: #666; font-size: 13px; }
    .title { font-size: 22px; margin: 0 0 8px; }
    .desc { white-space: pre-wrap; line-height: 1.7; margin: 0; font-size: 15px; }
    .error { color: #b00020; margin-top: 12px; }
    details.desc-block { margin-top: 12px; border: 1px solid #e6e6e6; border-radius: 10px; background: #fafafa; padding: 10px 12px; }
    details.desc-block[open] { background: #fff; }
    summary.desc-summary { cursor: pointer; font-weight: 700; display: flex; align-items: center; gap: 8px; list-style: none; margin: 0; }
    summary.desc-summary::-webkit-details-marker { display: none; }
    .chevron { font-size: 12px; color: #666; }
    .form-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
    textarea, input, button { font-family: inherit; }
    textarea { width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 8px; border: 1px solid #dcdcdc; font-size: 14px; min-height: 120px; }
    button { padding: 9px 12px; border-radius: 8px; border: 1px solid #c9c9c9; background: linear-gradient(180deg, #fff, #f0f0f0); cursor: pointer; font-weight: 600; font-size: 14px; }
    button:hover { background: #f7f7f7; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .runs { margin-top: 12px; display: flex; flex-direction: column; gap: 10px; }
    .run { border: 1px solid #e5e5e5; border-radius: 10px; padding: 10px 12px; background: #fafafa; }
    .run h3 { margin: 0 0 6px; font-size: 15px; }
    .run .meta { font-size: 12px; color: #555; display: flex; gap: 8px; flex-wrap: wrap; }
    .run .output { white-space: pre-wrap; line-height: 1.5; margin-top: 6px; font-size: 13px; }
    .status-pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 11px; border: 1px solid #ddd; background: #eef3ff; color: #325ac0; }
    .status-error { background: #fef2f2; color: #b91c1c; border-color: #fecaca; }
    .muted-line { color: #666; font-size: 13px; margin-top: 8px; }
    details.run-details { border: 1px solid #e5e5e5; border-radius: 10px; padding: 10px 12px; background: #fafafa; }
    summary.run-summary { cursor: pointer; list-style: none; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    summary.run-summary::-webkit-details-marker { display: none; }
    .chev { font-size: 12px; color: #666; margin-right: 6px; }
    .actions { display: flex; gap: 8px; }
    .linkish { border: none; background: transparent; padding: 0; color: #0b68d0; cursor: pointer; text-decoration: underline; font-size: 12px; }
  </style>
</head>
<body>
  <main>
    <header>
      <div>
        <h1>Play Instrument</h1>
        <div class="muted">Load an instrument and view its details.</div>
      </div>
      <a href="/instruments.html">Back to instruments</a>
    </header>

    <section id="instrumentCard" class="card">
      <div id="loadingState" class="muted">Loading instrument…</div>
    </section>

    <section class="card" id="scenarioCard" style="display:none;">
      <div class="flex-between" style="align-items:center; gap:10px;">
        <h2 style="margin:0; font-size:18px;">Run scenario</h2>
        <div id="submitStatus" class="muted"></div>
      </div>
      <form id="scenarioForm">
        <div class="form-grid">
          <label style="font-weight:600; font-size:13px;">
            Scenario
            <textarea id="scenarioInput" placeholder="Describe the goal, context, constraints…" required></textarea>
          </label>
        </div>
        <button type="submit" id="runButton">Compile plan</button>
        <div id="formError" class="error" role="alert" aria-live="polite"></div>
      </form>
    </section>

    <section class="card" id="runsCard" style="display:none;">
      <div class="flex-between" style="align-items:center;">
        <h2 style="margin:0; font-size:18px;">Previous scenarios</h2>
        <button type="button" id="refreshRuns" style="font-size:12px;">Refresh</button>
      </div>
      <div id="runsList" class="runs"></div>
    </section>
  </main>

  <script>
    function apiBase() {
      const custom = (window.INSTRUMENTS_API_BASE || "").trim();
      if (custom) return custom.replace(/\/+$/, "");
      const origin = window.location.origin;
      if (origin && origin !== "null" && origin !== "file://") {
        return origin.replace(/\/+$/, "") + "/instruments";
      }
      return "instruments";
    }
    const API_BASE = apiBase();
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    if (!id) {
      document.getElementById("instrumentCard").innerHTML = '<div class="error">No instrument id provided.</div>';
    } else {
      fetchInstrument(id);
      document.getElementById("scenarioCard").style.display = "block";
      document.getElementById("runsCard").style.display = "block";
      loadRuns();
    }

    document.getElementById("scenarioForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      await submitScenario();
    });

    document.getElementById("refreshRuns").addEventListener("click", loadRuns);

    async function fetchInstrument(instrumentId) {
      const card = document.getElementById("instrumentCard");
      const loading = document.getElementById("loadingState");
      loading.textContent = "Loading instrument…";

      try {
        const res = await fetch(`${API_BASE}/${encodeURIComponent(instrumentId)}`);
        if (!res.ok) {
          const msg = await res.text();
          throw new Error(msg || "Instrument not found.");
        }
        const data = await res.json();
        renderInstrument(card, data);
      } catch (err) {
        card.innerHTML = `<div class="error">${err.message || "Unable to load instrument."}</div>`;
      }
    }

    function renderInstrument(card, instrument) {
      card.innerHTML = "";
      const title = document.createElement("h2");
      title.className = "title";
      title.textContent = instrument.name || "(untitled instrument)";

      const meta = document.createElement("div");
      meta.className = "muted";
      meta.textContent = `#${instrument.id}`;

      const details = document.createElement("details");
      details.className = "desc-block";

      const summary = document.createElement("summary");
      summary.className = "desc-summary";
      const chevron = document.createElement("span");
      chevron.className = "chevron";
      chevron.textContent = "▸";
      summary.appendChild(chevron);
      summary.appendChild(document.createTextNode(" Description"));

      summary.addEventListener("click", () => {
        setTimeout(() => {
          chevron.textContent = details.open ? "▾" : "▸";
        }, 0);
      });

      const desc = document.createElement("p");
      desc.className = "desc";
      desc.textContent = instrument.description || "No description provided.";

      details.appendChild(summary);
      details.appendChild(desc);
      chevron.textContent = details.open ? "▾" : "▸";

      card.appendChild(title);
      card.appendChild(meta);
      card.appendChild(details);
    }

    async function submitScenario() {
      const scenario = document.getElementById("scenarioInput").value.trim();
      const errEl = document.getElementById("formError");
      const btn = document.getElementById("runButton");
      const status = document.getElementById("submitStatus");
      errEl.textContent = "";
      if (!scenario) {
        errEl.textContent = "Scenario is required.";
        return;
      }
      btn.disabled = true;
      status.textContent = "Queued (processing in background)…";

      try {
        const res = await fetch(`${API_BASE}/compile`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            instrument_id: Number(id),
            scenario,
          }),
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data?.description || data?.error || JSON.stringify(data));
        }
        const taskId = data.task_id;
        // Clear immediately and note enqueue; polling continues to populate history.
        document.getElementById("scenarioInput").value = "";
        status.textContent = "Queued; waiting for result…";
        await pollTask(taskId);
        await loadRuns();
        status.textContent = "Done";
      } catch (err) {
        errEl.textContent = err.message || "Unable to run scenario.";
      } finally {
        btn.disabled = false;
        setTimeout(() => (status.textContent = ""), 1200);
      }
    }

    async function pollTask(taskId) {
      const maxAttempts = 30;
      const delay = (ms) => new Promise((res) => setTimeout(res, ms));
      for (let i = 0; i < maxAttempts; i++) {
        const res = await fetch(`/instruments/llm/tasks/${encodeURIComponent(taskId)}`);
        if (!res.ok) break;
        const data = await res.json();
        if (data.status === "done") return data;
        if (data.status === "error") throw new Error(data.error || "LLM task failed");
        await delay(1000);
      }
      throw new Error("Timed out waiting for task");
    }

    async function loadRuns() {
      const runsEl = document.getElementById("runsList");
      runsEl.innerHTML = '<div class="muted">Loading…</div>';
      try {
        const res = await fetch(`${API_BASE}/${encodeURIComponent(id)}/runs`);
        if (!res.ok) throw new Error("Failed to load runs");
        const items = await res.json();
        renderRuns(Array.isArray(items) ? items : []);
      } catch (err) {
        runsEl.innerHTML = `<div class="error">${err.message || "Unable to load scenarios."}</div>`;
      }
    }

    async function deleteRun(runId) {
      if (!confirm("Delete this scenario run?")) return;
      try {
        const res = await fetch(`/instruments/runs/${runId}`, { method: "DELETE" });
        if (!res.ok) throw new Error("Delete failed");
        await loadRuns();
      } catch (err) {
        alert(err.message || "Unable to delete run.");
      }
    }

    function renderRuns(items) {
      const runsEl = document.getElementById("runsList");
      if (!items.length) {
        runsEl.innerHTML = '<div class="muted">No scenarios yet for this instrument.</div>';
        return;
      }
      runsEl.innerHTML = "";
      items.forEach((run) => {
        const details = document.createElement("details");
        details.className = "run-details";

        const summary = document.createElement("summary");
        summary.className = "run-summary";
        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        left.style.gap = "6px";

        const chev = document.createElement("span");
        chev.className = "chev";
        chev.textContent = "▸";
        left.appendChild(chev);

        const title = document.createElement("span");
        title.textContent = (run.scenario || "").slice(0, 80) || "Scenario";
        left.appendChild(title);

        summary.appendChild(left);

        const right = document.createElement("div");
        right.className = "actions";
        const status = document.createElement("span");
        status.className = "status-pill" + (run.status === "error" ? " status-error" : "");
        status.textContent = run.status || "unknown";
        right.appendChild(status);

        const del = document.createElement("button");
        del.type = "button";
        del.className = "linkish";
        del.textContent = "Delete";
        del.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          deleteRun(run.id);
        };
        right.appendChild(del);

        summary.appendChild(right);

        summary.addEventListener("click", () => {
          setTimeout(() => {
            chev.textContent = details.open ? "▾" : "▸";
          }, 0);
        });

        const body = document.createElement("div");
        body.style.marginTop = "8px";

        const scenario = document.createElement("div");
        scenario.className = "muted-line";
        scenario.textContent = run.scenario || "";
        body.appendChild(scenario);

        const meta = document.createElement("div");
        meta.className = "meta";
        if (run.model) meta.innerHTML += `<span>model: ${run.model}</span>`;
        if (run.tokens_in != null) meta.innerHTML += `<span>tokens in: ${run.tokens_in}</span>`;
        if (run.tokens_out != null) meta.innerHTML += `<span>tokens out: ${run.tokens_out}</span>`;
        if (run.created_at) meta.innerHTML += `<span>${run.created_at}</span>`;
        body.appendChild(meta);

        if (run.error) {
          const err = document.createElement("div");
          err.className = "error";
          err.textContent = run.error;
          body.appendChild(err);
        } else if (run.output_text) {
          const out = document.createElement("div");
          out.className = "output";
          out.textContent = run.output_text;
          body.appendChild(out);
        }

        details.appendChild(summary);
        details.appendChild(body);
        runsEl.appendChild(details);
      });
    }
  </script>
</body>
</html>
