<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Fantasiagenesis ‚Äî Genesis</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--bg:#f5f5f5;--card:#ffffff;--accent:#4aa3ff;}
    html,body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);}    /* top bar */
    nav{display:flex;align-items:center;gap:14px;padding:12px 20px;background:#222;color:#eee;font-size:14px}
    nav a{color:#9fd3ff;text-decoration:none;}
    nav select{margin-left:auto;padding:4px 6px;font-size:14px}

    main{max-width:900px;margin:0 auto;padding:32px 20px 60px;}

    details.card{background:var(--card);border:1px solid #ccc;border-radius:8px;margin-bottom:16px;box-shadow:0 2px 6px rgba(0,0,0,.06);overflow:hidden;transition:border-color .15s;}
    details.card[open]{border-color:var(--accent);}

    summary{cursor:pointer;padding:14px 20px;display:flex;align-items:center;gap:12px;font-weight:600;list-style:none;}
    summary::-webkit-details-marker{display:none;}
    .card-title{flex:1;}
    .enter-btn{padding:4px 10px;font-size:13px;border:1px solid var(--accent);border-radius:6px;background:#fff;color:var(--accent);text-decoration:none;transition:.15s;white-space:nowrap;}
    .enter-btn:hover{background:var(--accent);color:#fff;}

    .card-body{padding:16px 20px 24px;border-top:1px solid #eee;white-space:pre-wrap;line-height:1.4;font-size:15px;}
    details.card[open] .card-body{animation:fadeIn .25s ease;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-4px);}to{opacity:1;transform:none;}}

    #status{text-align:center;font-size:1rem;color:#666;margin-top:60px;}
  </style>
</head>
<body>
  <nav>
    <a href="index.html">‚Üê Home</a>
    <span>Genesis</span>
    <select id="narrativeSelect"></select>
  </nav>

  <main id="listContainer"><div id="status">Loading‚Ä¶</div></main>

  <script type="module">
    const PREFIX='genesis-';
    const sel=document.getElementById('narrativeSelect');
    const list=document.getElementById('listContainer');
    const params=new URLSearchParams(location.search);
    const PAGE=params.get('page');

    init();

    async function init(){
      const all=await fetchJson('/api/narratives');
      const cats=all.filter(n=>n.id.startsWith(PREFIX));
      if(!cats.length){list.innerHTML='<div id="status">No Genesis categories yet.</div>';return;}

      if(!PAGE){
        sel.style.display='none';
        renderCategories(cats);
        return;
      }

      populateSelect(cats);
      sel.value=PAGE;
      loadNarratives(PAGE);
    }

    function renderCategories(arr){
      list.innerHTML='';
      arr.forEach(cat=>{
        const det=document.createElement('details');det.className='card';
        const sum=document.createElement('summary');
        const title=document.createElement('span');title.className='card-title';title.textContent=cat.title;
        const btn=document.createElement('a');btn.className='enter-btn';btn.textContent='Enter';btn.href=`genesis.html?page=${cat.id}`;
        sum.append(title,btn);
        det.append(sum);
        list.appendChild(det);
      });
    }

    function populateSelect(arr){
      sel.innerHTML='';
      arr.forEach(n=>{const o=document.createElement('option');o.value=n.id;o.textContent=n.title;sel.appendChild(o);});
      sel.addEventListener('change',e=>{params.set('page',e.target.value);location.search=params;});
    }

    async function loadNarratives(id){
      list.innerHTML='<div id="status">Loading‚Ä¶</div>';
      try{const data=await fetchJson(`/api/history?narrative=${encodeURIComponent(id)}`);renderList(data);}catch(err){list.innerHTML='<div id="status">Failed to load.</div>';console.error(err);} }

    function renderList(data){
      const roots=data.filter(it=>!it.parent);
      list.innerHTML='';
      if(!roots.length){list.innerHTML='<div id="status">No entries in this category.</div>';return;}
      roots.forEach(item=>{
        const det=document.createElement('details');det.className='card';
        const sum=document.createElement('summary');
        const title=document.createElement('span');title.className='card-title';title.textContent=`üó®Ô∏è ${item.user?.slice(0,120)||'(system)'}`;
        const btn=document.createElement('a');btn.className='enter-btn';btn.textContent='Enter';btn.href=`entry.html?id=${item.id}`;
        sum.append(title,btn);
        const body=document.createElement('div');body.className='card-body';body.textContent=item.answer;
        det.append(sum,body);
        list.appendChild(det);
      });
    }

    async function fetchJson(url){const r=await fetch(url);if(!r.ok) throw new Error(r.statusText);return r.json();}
  </script>
</body>
</html>
