<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fantasiagenesis · v4</title>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: Canvas; color: CanvasText;
    }
    header {
      padding: .75rem 1rem; border-bottom: 1px solid color-mix(in oklab, CanvasText 12%, transparent);
      display: flex; align-items: center; gap: .75rem; justify-content: space-between;
    }
    header h1 { font-size: 1rem; margin: 0; letter-spacing: .02em; font-weight: 650; }

    .app {
      display: grid; grid-template-columns: 340px 1fr; min-height: calc(100dvh - 56px);
    }
    /* Left rail has 3 stacked panels */
    .left-rail {
      border-right: 1px solid color-mix(in oklab, CanvasText 12%, transparent);
      padding: .75rem; display: grid; grid-template-rows: auto auto auto; gap: .75rem; min-height: 0;
      background: color-mix(in oklab, Canvas 96%, CanvasText 4%);
    }
    .panel {
      display: flex; flex-direction: column; min-height: 0; border: 1px solid color-mix(in oklab, CanvasText 14%, transparent); border-radius: .6rem;
      background: color-mix(in oklab, Canvas 92%, CanvasText 8%);
      box-shadow: 0 1px 0 rgba(0,0,0,.04) inset;
    }
    .panel header { border: 0; padding: .55rem .7rem; background: transparent; }
    .panel header h2 { font-size: .9rem; margin: 0; font-weight: 650; opacity: .9; }
    .panel .content { padding: .35rem .35rem .5rem; overflow: auto; min-height: 0; max-height: var(--panel-max-height, 30vh); }

    .list { list-style: none; margin: 0; padding: 0; display: grid; gap: .25rem; }
    .item {
      display: flex; align-items: center; gap: .5rem; padding: .5rem .6rem; border-radius: .5rem; cursor: pointer;
      border: 1px solid transparent;
    }
    .item:hover { background: color-mix(in oklab, CanvasText 8%, transparent); }
    .item.active { background: color-mix(in oklab, Highlight 22%, transparent); border-color: color-mix(in oklab, Highlight 30%, transparent); }
    .item .title { font-size: .92rem; font-weight: 560; }
    .item .sub { font-size: .75rem; opacity: .7; }

    /* Right side display */
    .display {
      min-width: 0; display: grid; grid-template-rows: auto 1fr; min-height: 0;
    }
    .breadcrumbs { padding: .75rem 1rem; border-bottom: 1px solid color-mix(in oklab, CanvasText 12%, transparent); font-size: .85rem; opacity: .8; }
    .viewer { padding: 1rem 1.25rem 2rem; overflow: auto; min-height: 0; }
    .viewer .seed-title { font-size: 1.1rem; font-weight: 650; margin: 0 0 .5rem; }
    .viewer .seed-body { white-space: pre-wrap; line-height: 1.5; font-size: .98rem; }

    .empty { opacity: .6; font-size: .95rem; padding: .5rem; }

    /* Small screens: collapse left rail height-wise */
    @media (max-width: 980px) {
      .app { grid-template-columns: 100%; }
      .left-rail { grid-template-rows: auto; grid-auto-rows: minmax(220px, auto); }
      .panel .content { max-height: min(42vh, 420px); }
    }
      .left-rail { grid-template-rows: auto; grid-auto-rows: minmax(240px, 1fr); }
    #boxHost iframe { width: 100%; height: 70vh; border: 1px solid color-mix(in oklab, CanvasText 14%, transparent);
                     border-radius: .6rem; background: Canvas; }
    .muted { opacity:.7; font-size:.9rem; }

  </style>
</head>
<body>
  <header>
    <h1>Fantasiagenesis · v4</h1>
    <div style="font-size:.85rem; opacity:.7">Domains → Dimensions → Seeds</div>
  </header>

  <main class="app" id="app">
    <aside class="left-rail" aria-label="Navigation panels">
      <section class="panel" id="panel-domains" aria-labelledby="h-domains">
        <header><h2 id="h-domains">Narrative Domains</h2></header>
        <div class="content">
          <ul class="list" id="domainsList"></ul>
          <div class="empty" id="domainsEmpty" hidden>Load or define narrative domains.</div>
        </div>
      </section>

      <section class="panel" id="panel-dimensions" aria-labelledby="h-dimensions">
        <header><h2 id="h-dimensions">Narrative Dimensions</h2></header>
        <div class="content">
          <ul class="list" id="dimensionsList"></ul>
          <div class="empty" id="dimensionsEmpty" hidden>Select a domain to load dimensions.</div>
        </div>
      </section>

      <section class="panel" id="panel-seeds" aria-labelledby="h-seeds">
        <header><h2 id="h-seeds">Narrative Seeds</h2></header>
        <div class="content">
          <ul class="list" id="seedsList"></ul>
          <div class="empty" id="seedsEmpty" hidden>Select a dimension to load seeds.</div>
        </div>
      </section>
    </aside>

    <section class="display" aria-label="Display">
      <div class="breadcrumbs" id="crumbs">Choose a seed to view its text.</div>
      <div class="viewer" id="viewer">
        <p class="empty" id="viewerEmpty">Nothing selected yet.</p>
        <article id="seedView" hidden>
          <h3 class="seed-title" id="seedTitle"></h3>
          <div class="seed-body" id="seedBody"></div>
          <div class="actions" style="margin-top: .75rem; display:flex; gap:.5rem; align-items:center;">
            <button id="genProtoBtn" disabled style="padding:.55rem .8rem; border:1px solid color-mix(in oklab, CanvasText 18%, transparent); background:color-mix(in oklab, Canvas 92%, CanvasText 8%); border-radius:.5rem; cursor:not-allowed;">
              Generate Prototype
            </button>
            <span id="protoStatus" style="font-size:.85rem; opacity:.7;"></span>
          </div>
          <section id="protoSection" hidden style="margin-top:1rem;">
            <div class="proto-card" style="border:1px solid color-mix(in oklab, CanvasText 14%, transparent); border-radius:.6rem; padding: .8rem .9rem; background: color-mix(in oklab, Canvas 96%, CanvasText 4%);">
              <h4 style="margin:.2rem 0 .6rem; font-size:1rem; font-weight:650;">Narrative Prototype</h4>
              <div id="protoCore" style="white-space:pre-wrap; margin:.25rem 0;"></div>
              <div id="protoBuild" style="white-space:pre-wrap; margin:.25rem 0;"></div>
              <div id="protoTest" style="white-space:pre-wrap; margin:.25rem 0;"></div>
              <div id="protoEyes" style="margin:.25rem 0;"></div>
              <div id="protoWhy" style="white-space:pre-wrap; margin:.25rem 0;"></div>
            </div>
          </section>
          <section id="boxSection" hidden style="margin-top:1rem;">
            <div style="border:1px solid color-mix(in oklab, CanvasText 14%, transparent); border-radius:.6rem;
                        padding:.8rem .9rem; background:color-mix(in oklab, Canvas 96%, CanvasText 4%);">
              <h4 style="margin:.2rem 0 .6rem; font-size:1rem; font-weight:650;">Prototype</h4>
              <div id="boxError" class="muted" style="margin:.25rem 0 .5rem;"></div>
              <div id="boxHost" style="min-height:60vh;">
                <!-- will be populated with either innerHTML or an iframe[srcdoc] -->
              </div>
            </div>
          </section>
        </article>
      </div>
    </section>
  </main>

  <script>
  (function(){
    const els = {
      domainsList: document.getElementById('domainsList'),
      domainsEmpty: document.getElementById('domainsEmpty'),
      dimensionsList: document.getElementById('dimensionsList'),
      dimensionsEmpty: document.getElementById('dimensionsEmpty'),
      seedsList: document.getElementById('seedsList'),
      seedsEmpty: document.getElementById('seedsEmpty'),
      crumbs: document.getElementById('crumbs'),
      viewerEmpty: document.getElementById('viewerEmpty'),
      seedView: document.getElementById('seedView'),
      seedTitle: document.getElementById('seedTitle'),
      seedBody: document.getElementById('seedBody'),
      genProtoBtn: document.getElementById('genProtoBtn'),
      protoStatus: document.getElementById('protoStatus'),
      protoSection: document.getElementById('protoSection'),
      protoCore: document.getElementById('protoCore'),
      protoBuild: document.getElementById('protoBuild'),
      protoTest: document.getElementById('protoTest'),
      protoEyes: document.getElementById('protoEyes'),
      protoWhy: document.getElementById('protoWhy'),
      boxSection: document.getElementById('boxSection'),
      boxError: document.getElementById('boxError'),
      boxHost: document.getElementById('boxHost'),

    };

    // === API endpoints wired to provided Flask app ===
    const API = {
      listNarratives: '/api/narratives',
      listDimensions: (narrativeId) => `/api/narratives/${encodeURIComponent(narrativeId)}/dimensions`,
      listSeeds: (dimensionId) => `/api/dimensions/${encodeURIComponent(dimensionId)}/seeds`,
      getSeedBox: (seedId) => `/api/seeds/${encodeURIComponent(seedId)}/box`,
    };

    // Simple cache
    let lastBoxRequestSeedId = null;        // race guard
    const boxCache = new Map();             // you already declared one; keep it here

    // Clear & render helpers
    function clearBox(){ els.boxError.textContent = ''; els.boxHost.replaceChildren(); els.boxSection.hidden = true; }


    async function fetchJSON(url){
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    // Helpers
    const keyOf = (o) => o?.id ?? o?.slug ?? o?.name ?? o?.title ?? String(o);
    const label = {
      domain: (d) => d?.title ?? `Narrative ${d?.id ?? ''}`,
      dimension: (x) => x?.title ?? `Dimension ${x?.id ?? ''}`,
      seedTitle: (s) => (s?.problem ? s.problem : `Seed ${s?.id ?? ''}`).slice(0, 100),
    };

    let state = { domain: null, dimension: null, seed: null };

    function setBreadcrumbs(){
      const parts = [];
      if (state.domain) parts.push(label.domain(state.domain));
      if (state.dimension) parts.push(label.dimension(state.dimension));
      if (state.seed) parts.push('Seed');
      els.crumbs.textContent = parts.length ? parts.join(' / ') : 'Choose a seed to view its text.';
    }

    function clearList(ul){ while (ul.firstChild) ul.removeChild(ul.firstChild); }
    function showEmpty(el, show){ el.hidden = !show; }

    function renderList(ul, items, getText, onClick, activeKey){
      clearList(ul);
      items.forEach(it => {
        const li = document.createElement('li');
        li.className = 'item' + (activeKey && keyOf(it) === activeKey ? ' active' : '');
        li.tabIndex = 0;
        li.dataset.key = keyOf(it);
        li.innerHTML = `<div class="title">${getText(it)}</div>` + (it?.description ? `<div class="sub">${it.description}</div>` : '');
        li.addEventListener('click', () => onClick(it, li));
        li.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onClick(it, li); }});
        ul.appendChild(li);
      });
    }

    function setActive(ul, li){
      Array.from(ul.children).forEach(ch => ch.classList.remove('active'));
      if (li) li.classList.add('active');
    }

    function joinAB(s){
      const A = s.problem || s.A || s.a || s.Problem;
      const B = s.objective || s.B || s.b || s.Objective;
      const L = s.solution || s.Solution || s.link || s.Link;
      if (!(A || B || L)) return '';
      return [
        A ? `A (Problem): ${A}` : '',
        B ? `B (Objective): ${B}` : '',
        L ? `Solution (Link): ${L}` : ''
      ].filter(Boolean).join('\n\n');
    }

    function showSeed(seed){
      state.seed = seed || null;
      setBreadcrumbs();
      // reset prototype UI
      els.protoSection.hidden = true;
      els.protoStatus.textContent = '';
      els.genProtoBtn.disabled = !seed;
      els.genProtoBtn.style.cursor = seed ? 'pointer' : 'not-allowed';

      if (!seed){
        els.seedView.hidden = true; els.viewerEmpty.hidden = false; return;
      }
      els.viewerEmpty.hidden = true; els.seedView.hidden = false;
      els.seedTitle.textContent = label.seedTitle(seed);
      els.seedBody.textContent = joinAB(seed) || JSON.stringify(seed, null, 2);

      // auto-load Box of Dirt for this seed
      loadBoxForSeed(seed.id);
    }

    // Loaders aligned to Flask API
    async function loadDomains(){
      try {
        const data = await fetchJSON(API.listNarratives);
        const domains = Array.isArray(data) ? data : [];
        showEmpty(els.domainsEmpty, domains.length === 0);
        renderList(els.domainsList, domains, label.domain, onSelectDomain, state.domain && keyOf(state.domain));
      } catch (e){
        showEmpty(els.domainsEmpty, true);
        els.domainsEmpty.textContent = 'Failed to load narratives: ' + e.message;
      }
    }

    async function onSelectDomain(domain, li){
      state.domain = domain; state.dimension = null; state.seed = null; setBreadcrumbs();
      setActive(els.domainsList, li);
      clearList(els.dimensionsList); clearList(els.seedsList);
      showEmpty(els.dimensionsEmpty, true); showEmpty(els.seedsEmpty, true);
      showSeed(null);
      try {
        const dims = await fetchJSON(API.listDimensions(domain.id));
        showEmpty(els.dimensionsEmpty, dims.length === 0);
        renderList(els.dimensionsList, dims, label.dimension, onSelectDimension, state.dimension && keyOf(state.dimension));
      } catch (e){
        showEmpty(els.dimensionsEmpty, true);
        els.dimensionsEmpty.textContent = 'Failed to load dimensions: ' + e.message;
      }
    }

    async function onSelectDimension(dimension, li){
      state.dimension = dimension; state.seed = null; setBreadcrumbs();
      setActive(els.dimensionsList, li);
      clearList(els.seedsList);
      showEmpty(els.seedsEmpty, true);
      showSeed(null);
      try {
        const payload = await fetchJSON(API.listSeeds(dimension.id));
        const seeds = Array.isArray(payload?.seeds) ? payload.seeds : [];
        showEmpty(els.seedsEmpty, seeds.length === 0);
        renderList(els.seedsList, seeds, (s)=>label.seedTitle(s), onSelectSeed, state.seed && keyOf(state.seed));
      } catch (e){
        showEmpty(els.seedsEmpty, true);
        els.seedsEmpty.textContent = 'Failed to load seeds: ' + e.message;
      }
    }

    function onSelectSeed(seed, li){
      state.seed = seed; setBreadcrumbs(); setActive(els.seedsList, li); showSeed(seed);
    }

    // Prototype generation
    async function generatePrototype(){
      if (!state.domain || !state.dimension || !state.seed) return;
      els.genProtoBtn.disabled = true;
      els.genProtoBtn.style.cursor = 'not-allowed';
      els.protoStatus.textContent = 'Generating…';
      els.protoSection.hidden = true;

      const payload = {
        domain: state.domain.title || state.domain.name || `Narrative ${state.domain.id}`,
        dimension: state.dimension.title || state.dimension.name || `Dimension ${state.dimension.id}`,
        seed: {
          problem: state.seed.problem || state.seed.A || state.seed.a || state.seed.Problem || '',
          objective: state.seed.objective || state.seed.B || state.seed.b || state.seed.Objective || '',
          solution: state.seed.solution || state.seed.Solution || state.seed.link || state.seed.Link || ''
        }
      };

      try {
        const res = await fetch('/api/narrative-prototype', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const p = data.prototype || data; // tolerate either shape
        // Render
        els.protoCore.innerText = p.core_intent ? `Core Intent — ${p.core_intent}` : '';
        els.protoBuild.innerText = p.minimal_build ? `Minimal Build — ${p.minimal_build}` : '';
        els.protoTest.innerText = p.load_bearing_test ? `Load-Bearing Test — ${p.load_bearing_test}` : '';
        if (Array.isArray(p.first_eyes)) {
          els.protoEyes.innerHTML = `<div style="font-weight:600;">First Eyes —</div>` +
            `<ul style="margin:.25rem 0 .5rem .95rem; padding:0;">` +
            p.first_eyes.map(x => `<li>${String(x)}</li>`).join('') + `</ul>`;
        } else {
          els.protoEyes.textContent = p.first_eyes ? `First Eyes — ${p.first_eyes}` : '';
        }
        els.protoWhy.innerText = p.why_box_of_dirt ? `Why This is a Box of Dirt — ${p.why_box_of_dirt}` : '';

        els.protoSection.hidden = false;
        els.protoStatus.textContent = '';
      } catch (e){
        els.protoStatus.textContent = 'Error: ' + e.message;
      } finally {
        els.genProtoBtn.disabled = false;
        els.genProtoBtn.style.cursor = 'pointer';
      }
    }

    els.genProtoBtn.addEventListener('click', generatePrototype);

    async function fetchSeedBox(seedId){
  const res = await fetch(API.getSeedBox(seedId), { headers: { 'Accept': 'application/json' }});
  if (res.status === 404) return null;
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

async function loadBoxForSeed(seedId){
  if (!seedId) { 
    els.boxError.textContent = ''; 
    els.boxHost.replaceChildren(); 
    els.boxSection.hidden = true; 
    return; 
  }

  lastBoxRequestSeedId = seedId;
  els.boxSection.hidden = false;
  els.boxError.textContent = 'Loading…';
  els.boxHost.replaceChildren();

  try {
    const cached = boxCache.get(seedId);
    const data = cached || await fetchSeedBox(seedId);
    if (lastBoxRequestSeedId !== seedId) return; // user switched seeds

    if (!data) {
      els.boxError.textContent = 'No published box found for this seed.';
      return;
    }
    boxCache.set(seedId, data);
    els.boxError.textContent = `Version ${data.version ?? ''} • Updated ${data.updated_at ?? ''}`;
    renderBoxHTML(data);
  } catch (e) {
    if (lastBoxRequestSeedId !== seedId) return;
    els.boxError.textContent = 'Error loading box: ' + e.message;
  }
}


function renderBoxHTML(payload){
  const html = (payload && payload.html) ? String(payload.html) : '';
  els.boxSection.hidden = false;

  if (!html) {
    els.boxError.textContent = 'No published box found for this seed.';
    els.boxHost.replaceChildren();
    return;
  }

  els.boxHost.replaceChildren();
  const looksFull = /<html[^>]*>/i.test(html) || /<!DOCTYPE/i.test(html);

  if (looksFull) {
    const iframe = document.createElement('iframe');
    iframe.title = 'Prototype';
    iframe.loading = 'lazy';
    iframe.setAttribute('sandbox', 'allow-scripts'); // drop allow-same-origin unless needed
    iframe.style.width = '100%';
    iframe.style.height = '70vh';
    iframe.style.border = '1px solid color-mix(in oklab, CanvasText 14%, transparent)';
    iframe.style.borderRadius = '.6rem';
    iframe.srcdoc = html;
    els.boxHost.appendChild(iframe);
  } else {
    const container = document.createElement('div');
    container.innerHTML = html; // trusted authoring
    els.boxHost.appendChild(container);
  }
}


    // Boot
    loadDomains();
  })();
  </script>
</body>
</html>
