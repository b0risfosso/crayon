<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fantasiagenesis Â· Draw</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light; }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 20px; }
    header h1 { margin: 0 0 .25rem 0; font-size: clamp(1.2rem, 2.4vw, 1.6rem); }
    .muted { opacity: .85; }
    .row { display: flex; gap: .5rem; align-items: center; flex-wrap: wrap; }
    .panel { border: 1px solid #e3e3e6; border-radius: .6rem; padding: .9rem 1rem; background: #fafafb; }
    .panel + .panel { margin-top: .9rem; }
    input[type="text"], input[type="email"], textarea {
      width: min(92vw, 820px); padding: .6rem .7rem; border: 1px solid #cdd0d5; border-radius: .55rem; background: #fff;
    }
    input[type="text"], input[type="email"] { height: 2.4rem; }
    textarea { min-height: 7rem; }
    button { padding: .6rem .9rem; border: 0; border-radius: .55rem; cursor: pointer; background: #0b5cff; color: #fff; }
    button.secondary { background: #4b5563; }
    button.ghost { background: #eef2ff; color: #1f2937; border: 1px solid #c7d2fe; }
    .status { font-size: .92rem; margin-top: .4rem; min-height: 1.2em; }
    .status.error { color: #b00020; white-space: pre-wrap; }
    .status.ok { color: #065f46; }
    .grid { display: grid; gap: .65rem; }
    .cols { display: grid; gap: .65rem; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .card { border: 1px solid #e5e7eb; border-radius: .6rem; background: #fff; padding: .6rem .7rem; }
    .card h3 { margin: 0 0 .25rem 0; font-size: 1rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .inline { display: inline-flex; align-items: center; gap: .5rem; }
    code { background: #f6f7f9; padding: .12rem .3rem; border-radius: .3rem; }
  </style>
</head>
<body>
  <header class="row" style="justify-content: space-between;">
    <div>
      <h1>Fantasiagenesis Â· Draw</h1>
      <div class="muted">Create <strong>pictures</strong> and <strong>focuses</strong> from a vision via JID.</div>
    </div>
    <nav class="row">
      <a class="inline" href="/pictures" title="Paper">ðŸ“„ <span class="muted">Pictures</span></a>
    </nav>
  </header>

  <!-- Email -->
  <section class="panel">
    <div class="row">
      <input type="email" id="email" placeholder="Email (optional but recommended for persistence)" />
      <button id="saveEmail" class="secondary" type="button">Save email</button>
    </div>
    <div id="svcStatus" class="status"></div>
  </section>

  <!-- Create Pictures -->
  <section class="panel">
    <h2 style="margin:.1rem 0 .6rem 0;">Create Pictures</h2>
    <div class="grid">
      <!-- Single-line Vision -->
      <input id="visionInputForPictures" type="text" placeholder="Vision (single line, e.g., Harnessing energy using dirt)" />

      <!-- Optional single-line Focus -->
      <input id="focusForPictures" type="text" placeholder="Focus (optional, e.g., Microbial fuel cells in campus garden)" />

      <div class="row">
        <input id="count" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Count (optional, e.g., 3)" style="width:12rem" />
        <button id="btnCreatePictures" type="button">Create pictures</button>
      </div>
      <div id="statusPictures" class="status"></div>
      <div id="picturesOut" class="cols"></div>
    </div>
  </section>

  <!-- Create Focuses -->
  <section class="panel">
    <h2 style="margin:.1rem 0 .6rem 0;">Create Focuses</h2>
    <div class="grid">
      <!-- Single-line Vision -->
      <input id="visionInputForFocuses" type="text" placeholder="Vision (creating solar microgrids in the city of Chicago)" />

      <div class="row">
        <button id="btnCreateFocuses" type="button">Create focuses</button>
      </div>
      <div id="statusFocuses" class="status"></div>
      <div id="focusesOut" class="grid"></div>
    </div>
  </section>

  <!-- Usage -->
  <section class="panel">
    <div class="row">
      <button id="btnUsage" class="ghost" type="button" title="Show todayâ€™s token usage from JID">Show usage today</button>
      <div id="usageStatus" class="status"></div>
    </div>
    <pre id="usageOut" class="mono" style="display:none; max-width: min(92vw, 820px); overflow:auto; background:#f6f7f9; border:1px solid #e5e7eb; border-radius:.5rem; padding:.6rem .7rem;"></pre>
  </section>

  <script>
    // ------------ Config ------------
    const LS_EMAIL = 'fg_user_email';
    const EP = {
      health: '/jid/healthz',
      usageToday: '/jid/usage/today',
      createPictures: '/jid/create_pictures',
      createFocuses: '/jid/create_focuses'
    };
    // ---- Crayon endpoints
    const EP_CRAYON = {
    world: '/crayon/wax_worldwright'
    };

    // Normalize various possible response shapes
    function pickWaxStack(res){
        if (!res) return '';
        if (typeof res.wax_stack === 'string') return res.wax_stack;
        if (res.data && typeof res.data.wax_stack === 'string') return res.data.wax_stack;
        if (res.result && typeof res.result.wax_stack === 'string') return res.result.wax_stack;
        // Sometimes the LLM returns a big text field
        if (typeof res.wax === 'string') return res.wax;
        return '';
    }

    function buildFocusStringFromVision(v){
      // v.focuses may be an array of {dimension, focus} or similar
      if (!v || !Array.isArray(v.focuses) || !v.focuses.length) return '';
      // Join as "Dimension: focus" bullets, or just dimensions if thatâ€™s all you store
      const parts = v.focuses.map(it => {
        const dim = (it?.dimension || it?.title || it?.name || '').trim();
        const f   = (it?.focus || '').trim();
        return f ? `${dim}: ${f}` : (dim || '');
      }).filter(Boolean);
      return parts.join(' â€¢ ');
    }

    function openHtmlInNewTab(html){
        const w = window.open('', '_blank');
        if (!w) { alert('Popup blocked: allow popups to see the world.'); return; }
        w.document.open();
        w.document.write(html || '<!doctype html><title>World</title><pre>No HTML</pre>');
        w.document.close();
    }

    function buildCrayonInputs(visionText, pic) {
    // vision
    const vision = String(visionText || '').trim();
    if (!vision) throw new Error('This item has no vision text.');

    // title (picture_short)
    let picture_short = String(pic?.title || '').trim();
    if (!picture_short) {
        // fallback from description or id
        const fromDesc = String(pic?.description || '').trim();
        if (fromDesc) picture_short = (fromDesc.length > 80 ? fromDesc.slice(0, 77) + 'â€¦' : fromDesc);
        else if (pic?.id != null) picture_short = `Picture ${pic.id}`;
        else picture_short = 'Untitled picture';
    }

    // description (picture_description)
    let picture_description = String(pic?.description || '').trim();
    if (!picture_description) {
        // fallback from function or title
        const fromFn = String(pic?.function || '').trim();
        if (fromFn) picture_description = fromFn;
        else picture_description = picture_short; // last resort
    }

    return { vision, picture_short, picture_description };
    }


    async function createWorldForPictureCard(cardNode, visionText, pic, focusText){
        // choose email
        const emailInput = document.getElementById('email');
        const email = (emailInput?.value || localStorage.getItem('fg_user_email') || '').trim().toLowerCase();

        const status = document.createElement('div');
        status.className = 'status';
        status.textContent = 'Building crayonâ€¦';
        cardNode.append(status);

        try {
            const req = buildCrayonInputs(visionText, pic); // <-- makes all required fields non-empty

            const expRes = await postJSON('/jid/explain_picture', {
              vision: req.vision,
              picture_title: req.picture_short,          // map our normalized title to new key
              picture_description: req.picture_description,
              picture_function: String(pic?.function || '').trim(),
              focus: String(focusText || '').trim() || undefined                                   // draw.html has no per-vision focus context
            }, 600000);

            status.textContent = 'Crayon ready. Drawing worldâ€¦';

            const explanation = pickExplanation(expRes);
            if (!explanation) throw new Error('No explanation returned.');

            // 2) Worldwright
            const wwPayload = {
            vision: req.vision,
            picture_short: req.picture_short,
            picture_description: req.picture_description,
            picture_explanation: explanation,
            email: email || undefined
            };
            const worldRes = await postJSON(EP_CRAYON.world, wwPayload, 600000);
            const html = worldRes?.html || worldRes?.data?.html || worldRes?.result?.html;
            if (!html) throw new Error('No world HTML returned.');

            status.className = 'status ok';
            status.textContent = 'World built. Openingâ€¦';
            openHtmlInNewTab(html);
        } catch (e) {
            status.className = 'status error';
            status.textContent = `Failed: ${e.message || e}`;
        }
        }


        // ------------ Helpers ------------
        const $ = (id) => document.getElementById(id);
        function setText(el, msg, cls = '') {
            if (!el) return;
            el.className = 'status ' + (cls || '');
            el.textContent = msg || '';
            }
            function escapeHtml(s) {
            return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
            }
            async function fetchJSON(url, options = {}, timeoutMs = 600000) {
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), timeoutMs);
            try {
                const resp = await fetch(url, { ...options, signal: controller.signal });
                const ct = resp.headers.get('content-type') || '';
                const isJSON = ct.includes('application/json');
                const data = isJSON ? await resp.json() : await resp.text();
                if (!resp.ok) {
                const detail = isJSON ? (data?.error || data?.detail || JSON.stringify(data)) : data;
                throw new Error(detail || `HTTP ${resp.status}`);
                }
                return data;
            } finally { clearTimeout(timer); }
            }
            function postJSON(url, body, timeoutMs) {
            return fetchJSON(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body || {})
            }, timeoutMs);
        }

        function pickExplanation(res){
          if (!res) return '';
          if (typeof res.explanation === 'string') return res.explanation;
          if (res.data && typeof res.data.explanation === 'string') return res.data.explanation;
          if (res.result && typeof res.result.explanation === 'string') return res.result.explanation;
          return '';
        }

        // ------------ Email memory ------------
        function loadEmail() { const v = (localStorage.getItem(LS_EMAIL) || '').trim().toLowerCase(); if (v) $('email').value = v; }
        function saveEmail() { const v = ($('email').value || '').trim().toLowerCase(); if (v) localStorage.setItem(LS_EMAIL, v); else localStorage.removeItem(LS_EMAIL); }

        // ------------ Renderers ------------
        function renderPictures(block) {
            const mount = $('picturesOut'); mount.innerHTML = '';
            const pics = Array.isArray(block?.pictures) ? block.pictures : [];
            if (!pics.length) { mount.innerHTML = '<div class="muted">No pictures returned.</div>'; return; }
            for (const p of pics) {
                const card = document.createElement('div'); card.className = 'card';
                const h = document.createElement('h3'); h.textContent = p.title || 'Untitled picture';
                const d = document.createElement('div'); d.className = 'muted'; d.textContent = p.description || '';
                const fn = document.createElement('div'); fn.style.marginTop = '.35rem';
                fn.innerHTML = p.function ? `<strong>Function:</strong> ${escapeHtml(p.function)}` : '';
                const meta = document.createElement('div'); meta.style.marginTop = '.25rem';
                meta.innerHTML = [
                    p.id ? `<span class="mono">id:${escapeHtml(String(p.id))}</span>` : '',
                    p.status ? `<span class="mono">status:${escapeHtml(p.status)}</span>` : ''
                ].filter(Boolean).join(' Â· ');

                // --- NEW: create picture -> wax + world
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = 'create picture';
                btn.style.marginTop = '.5rem';
                btn.addEventListener('click', async () => {
                  const visionText = (document.getElementById('visionInputForPictures')?.value || '').trim();
                  if (!visionText) { alert('Enter a vision first.'); return; }
                  const focusText = (document.getElementById('focusForPictures')?.value || '').trim();
                  await createWorldForPictureCard(card, visionText, p, focusText);
                });


                card.append(h, d);
                if (fn.innerHTML) card.append(fn);
                if (meta.innerHTML) card.append(meta);
                card.append(btn);
                mount.append(card);
            }
        }

        function renderFocuses(block) {
            const mount = $('focusesOut');
            mount.innerHTML = '';

            // Accept either { focuses: [...] } or a raw array
            const items = Array.isArray(block?.focuses) ? block.focuses
                        : Array.isArray(block)           ? block
                        : [];

            if (!items.length) {
                mount.innerHTML = '<div class="muted">No focuses returned.</div>';
                return;
            }

            for (let i = 0; i < items.length; i++) {
                const f = items[i] ?? {};
                // Normalize multiple possible shapes
                const dimension = f.dimension || f.title || f.name || `Focus ${i + 1}`;
                const text      = (typeof f === 'string') ? f
                                : f.focus || f.description || '';

                const card = document.createElement('div');
                card.className = 'card';
                const head = document.createElement('div');
                head.innerHTML = `<strong>${escapeHtml(dimension)}</strong>`;
                const body = document.createElement('div');
                body.className = 'muted';
                body.textContent = text;

                card.append(head);
                if (text) card.append(body);
                mount.append(card);
            }
        }


    // ------------ Actions ------------
    async function doHealth() {
      setText($('svcStatus'), 'Checkingâ€¦');
      try {
        const d = await fetchJSON(EP.health, {}, 10000);
        setText($('svcStatus'), `JID OK ${typeof d === 'object' ? JSON.stringify(d) : String(d)}`, 'ok');
      } catch (e) {
        setText($('svcStatus'), `JID health failed: ${e.message || e}`, 'error');
      }
    }

    async function doCreatePictures() {
      const email = ($('email').value || '').trim().toLowerCase();
      const vision = ($('visionInputForPictures').value || '').trim();
      const focus  = ($('focusForPictures').value || '').trim();
      const count  = parseInt(($('count').value || '').trim(), 10);

      if (!vision) { setText($('statusPictures'), 'Enter a vision.', 'error'); return; }
      setText($('statusPictures'), 'Creating picturesâ€¦');

      try {
        const payload = { vision };
        if (email) payload.email = email;
        if (focus) payload.focus = focus;  // <-- new optional field
        if (!Number.isNaN(count) && count > 0) payload.count = count;

        const res = await postJSON('/jid/create_pictures', payload, 600000);
        const block = res?.data || res?.result || res;
        renderPictures(block);
        setText($('statusPictures'), 'Done.', 'ok');
        if (email) localStorage.setItem('fg_user_email', email);
      } catch (e) {
        setText($('statusPictures'), `Failed: ${e.message || e}`, 'error');
      }
    }


    async function doCreateFocuses() {
      const email = ($('email').value || '').trim().toLowerCase();
      const vision = ($('visionInputForFocuses').value || '').trim();
      if (!vision) { setText($('statusFocuses'), 'Enter a vision.', 'error'); return; }
      setText($('statusFocuses'), 'Creating focusesâ€¦');
      try {
        // Minimal payload â€” vision + email
        const payload = { vision };
        if (email) payload.email = email;

        const res = await postJSON(EP.createFocuses, payload, 600000);
        const block = res?.data || res?.result || res;
        renderFocuses(block);
        setText($('statusFocuses'), 'Done.', 'ok');
        if (email) saveEmail();
      } catch (e) {
        setText($('statusFocuses'), `Failed: ${e.message || e}`, 'error');
      }
    }

    async function doUsage() {
      setText($('usageStatus'), 'Loading usageâ€¦');
      $('usageOut').style.display = 'none';
      try {
        const d = await fetchJSON(EP.usageToday, {}, 15000);
        const pretty = JSON.stringify(d, null, 2);
        $('usageOut').textContent = pretty;
        $('usageOut').style.display = 'block';
        setText($('usageStatus'), 'Usage loaded.', 'ok');
      } catch (e) {
        setText($('usageStatus'), `Failed: ${e.message || e}`, 'error');
      }
    }

    // ------------ Init ------------
    (function init() {
      loadEmail();
      $('saveEmail').addEventListener('click', () => { saveEmail(); setText($('svcStatus'), 'Email saved.', 'ok'); });
      //$('checkHealth').addEventListener('click', doHealth);
      $('btnCreatePictures').addEventListener('click', doCreatePictures);
      $('btnCreateFocuses').addEventListener('click', doCreateFocuses);
      $('btnUsage').addEventListener('click', doUsage);
    })();
  </script>
</body>
</html>
