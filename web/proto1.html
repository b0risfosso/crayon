<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spots + Ice: Cheetah Gene‑Flow Planner — Mock Storyboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#0b0f14;--card:#111822;--ink:#dfe7ef;--muted:#9fb0c3;--accent:#64d6ff;--ok:#2fd573;--warn:#ffb020;--bad:#ff6161;--chip:#0f141d;--line:#1b2330}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b0f14 0%,#0b1018 60%,#0a0e15 100%);color:var(--ink);}
    a{color:var(--accent)}
    .wrap{max-width:1200px;margin:auto;padding:24px}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:1.2fr .8fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    .card{background:linear-gradient(180deg,#121a24 0%,#0f1620 100%);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .title{font-weight:800;letter-spacing:.3px}
    .subtitle{color:var(--muted);font-size:.95rem}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:.8rem;color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{--b:var(--line);--bg:#121b26;--fg:#dfe7ef;display:inline-flex;align-items:center;gap:8px;background:var(--bg, var(--bg));border:1px solid var(--b);color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer;transition:all .2s ease;font-weight:600}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .btn.primary{--bg:linear-gradient(180deg,#1a8fff,#0ea5e9);--b:transparent;color:#001018}
    .btn.good{--bg:linear-gradient(180deg,#2fd573,#1fb55b);--b:transparent;color:#00180b}
    .btn.bad{--bg:linear-gradient(180deg,#ff6161,#ff3b3b);--b:transparent;color:#2b0000}
    .switch{position:relative;display:inline-block;width:54px;height:28px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#233041;transition:.2s;border-radius:28px;border:1px solid var(--line)}
    .slider:before{position:absolute;content:"";height:22px;width:22px;left:2px;bottom:2px;background:white;transition:.2s;border-radius:50%}
    input:checked + .slider{background:#1fa3ff}
    input:checked + .slider:before{transform:translateX(26px)}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:12px;border:1px solid var(--line);background:var(--chip);color:var(--muted);font-size:.85rem}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)}.dot.warn{background:var(--warn)}.dot.bad{background:var(--bad)}
    .tooltip{position:absolute;pointer-events:none;background:#0e1620;border:1px solid var(--line);padding:10px 12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.35);min-width:240px;z-index:50}
    .muted{color:var(--muted)}
    .mini{font-size:.8rem}
    .barcode{display:flex;gap:2px;height:16px}
    .stripe{background:linear-gradient(180deg,#5aa2ff,#63ddff);height:100%}
    .reserve-btn{display:flex;flex-direction:column;gap:4px;align-items:flex-start;background:#0e1620;border:1px solid var(--line);padding:10px;border-radius:12px;cursor:pointer}
    .reserve-btn:hover{outline:1px solid #2b88ff}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0a1016;border:1px solid var(--line);border-bottom-width:2px;border-radius:8px;padding:1px 6px}
    .checklist li{margin:.35rem 0}
    .timeline{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .milestone{background:#0e1620;border:1px dashed #2e3b4f;padding:10px;border-radius:10px}
    .tag{font-size:.75rem;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#0b121a;color:var(--muted)}
    .foot{color:#7f93a8;font-size:.85rem;margin-top:6px}
    canvas{background:#0e1620;border:1px solid var(--line);border-radius:12px;padding:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card" style="position:sticky;top:12px;z-index:20">
      <div class="row">
        <div class="pill">big cats / <strong>Genes, Spots, and Ice</strong> / Seed</div>
        <span class="pill">Mock storyboard · no real data</span>
      </div>
      <h1 class="title" style="margin:8px 0 6px">Spots + Ice: Cheetah Gene‑Flow Planner</h1>
      <p class="subtitle">A genome‑informed assisted gene flow pilot: cryobank + AI mate‑choice + coordinated exchanges across fenced reserves.</p>
      <div class="row" style="margin-top:10px">
        <span class="chip"><span class="dot bad"></span> High inbreeding risk</span>
        <span class="chip"><span class="dot warn"></span> Moderate</span>
        <span class="chip"><span class="dot ok"></span> Low</span>
        <span class="chip">What‑If <label class="switch" style="margin-left:6px"><input id="whatIf" type="checkbox"><span class="slider"></span></label> <span id="whatIfLabel" class="mini muted" style="margin-left:6px">Status quo</span></span>
        <button class="btn" id="resetBtn">Reset storyboard</button>
        <button class="btn primary" id="exportBtn">Export mocked plan (JSON)</button>
      </div>
    </header>

    <section class="grid cols-2" style="margin-top:16px">
      <!-- LEFT COLUMN: Panels 1-4 -->
      <div class="grid" style="gap:16px">
        <!-- Panel 1: Metapop Map Snapshot -->
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3 class="title">Panel 1 — Metapop Map Snapshot</h3>
            <span class="mini muted">Hover/Click a reserve</span>
          </div>
          <div id="map" class="grid cols-4" style="margin-top:8px"></div>
          <div id="mapTip" class="tooltip" style="display:none"></div>
        </div>

        <!-- Panel 2: Genes-as-Stripes -->
        <div class="card">
          <h3 class="title">Panel 2 — Genes‑as‑Stripes</h3>
          <p class="foot">ROH tracts (10 reps/Reserve). Icons: 
            <span class="kbd">S</span> sperm quality, 
            <span class="kbd">P</span> pathogen screen.
          </p>
          <div id="stripes"></div>
        </div>

        <!-- Panel 3: Matchmaker Card -->
        <div class="card" id="matchmaker">
          <h3 class="title">Panel 3 — Matchmaker Card</h3>
          <div class="row">
            <div class="chip">Constraint: <label style="display:inline-flex;align-items:center;gap:6px"><input id="noLiveMoves" type="checkbox"> no live moves</label></div>
            <div class="chip">Permits: ~90d</div>
            <div class="chip">Quarantine: 30d</div>
            <div class="chip">Disease panels: FIV / FeLV / TB</div>
          </div>
          <div class="grid cols-2" style="margin-top:12px">
            <div>
              <h4>Target female</h4>
              <div id="targetFemale" class="milestone"></div>
              <h4 style="margin-top:10px">Suggested action</h4>
              <div id="suggestedAction" class="milestone"></div>
              <div class="row" style="margin-top:10px">
                <button class="btn good" id="approveBtn">Approve pairing</button>
                <button class="btn bad" id="rejectBtn">Reject pairing</button>
              </div>
            </div>
            <div>
              <h4>Candidate donors</h4>
              <div id="donorList" class="grid" style="gap:8px"></div>
            </div>
          </div>
        </div>

        <!-- Panel 4: Cryobank Inventory -->
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h3 class="title">Panel 4 — Ice Shelf (Cryobank Inventory)</h3>
            <span class="mini muted">All values mocked</span>
          </div>
          <div id="cryo" class="grid cols-3"></div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Panels 5-9 -->
      <div class="grid" style="gap:16px">
        <!-- Panel 5: Season Plan Timeline -->
        <div class="card">
          <h3 class="title">Panel 5 — Season Plan (18 months)</h3>
          <div class="timeline" id="timeline"></div>
          <div class="row" style="margin-top:8px">
            <span class="tag">Milestone: Two litters born</span>
            <span class="tag">Milestone: No disease incidents</span>
          </div>
        </div>

        <!-- Panel 6: Outcome Preview (Charts) -->
        <div class="card">
          <h3 class="title">Panel 6 — Outcome Preview</h3>
          <div class="grid cols-2" style="gap:12px">
            <canvas id="chartROH" height="170"></canvas>
            <canvas id="chartNe" height="170"></canvas>
            <canvas id="chartSemen" height="170"></canvas>
            <canvas id="chartDisease" height="170"></canvas>
          </div>
          <p class="foot" id="chartFoot">Status quo projections.</p>
        </div>

        <!-- Panel 7: What‑If Toggle & Panel 8 Logistics -->
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3 class="title">Panel 7 — What‑If & 8 — Logistics</h3>
            <label class="row">Toggle scenario → <label class="switch" style="margin-left:8px"><input id="scenarioToggle" type="checkbox"><span class="slider"></span></label></label>
          </div>
          <div class="grid cols-2" style="margin-top:8px">
            <div>
              <h4>What‑If Snapshot</h4>
              <ul class="checklist" id="whatIfList"></ul>
            </div>
            <div>
              <h4>Logistics Reality Check</h4>
              <div class="row">
                <span class="chip">Semen import <span class="kbd">$</span></span>
                <span class="chip">AI procedure <span class="kbd">$$</span></span>
                <span class="chip">Live swap <span class="kbd">$$$</span></span>
              </div>
              <p class="foot">Community & welfare footprint: capture days, sedation count visualized per action.</p>
            </div>
          </div>
        </div>

        <!-- Panel 9: Commit Card -->
        <div class="card">
          <h3 class="title">Panel 9 — Commit Card</h3>
          <div class="grid cols-2">
            <div>
              <p><strong>Pilot Scope:</strong> 2 females, 6 straws, 1 reserve pair, 12 months.</p>
              <ul class="checklist">
                <li><input type="checkbox" checked disabled> ≥10% ROH reduction in offspring</li>
                <li><input type="checkbox" checked disabled> ≥5 pp improvement in semen morphology (Yr‑2 males)</li>
                <li><input type="checkbox" checked disabled> No new pathogen introductions</li>
                <li><input type="checkbox" checked disabled> Permits & governance complete</li>
              </ul>
              <div class="row" style="margin-top:8px">
                <input id="signer" placeholder="Your name" style="padding:10px;border-radius:10px;border:1px solid var(--line);background:#0a1118;color:var(--ink)"/>
                <button class="btn primary" id="signBtn">Sign pilot</button>
              </div>
              <div id="signStatus" class="foot" style="margin-top:6px"></div>
            </div>
            <div>
              <h4>Flow sketch</h4>
              <ul class="checklist">
                <li><strong>Inputs:</strong> SNP/ROH maps, kinship, semen/embryo QC, disease screens, permits</li>
                <li><strong>Engine:</strong> Pairings ranked by <span class="kbd">heterozygosity gain × risk/cost</span></li>
                <li><strong>Outputs:</strong> Season plan, cryobank pulls, live move schedule, predicted metrics</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Load‑Bearing Test -->
        <div class="card">
          <h3 class="title">Load‑Bearing Test — First Eyes</h3>
          <p class="subtitle">Give this mock to: reserve managers (2), conservation geneticist, wildlife vet, cryobank lead, permitting liaison, biodiversity funder.</p>
          <ol class="checklist" id="lbtTasks">
            <li>Choose one <strong>red‑flag</strong> reserve and approve/reject the prefilled donor pairing. Why?</li>
            <li>Toggle constraint <span class="kbd">no live moves</span> and choose among cryo options. Still viable?</li>
            <li>Decide a 12‑month pilot scope using the Commit Card. Would you sign?</li>
          </ol>
          <textarea id="lbtNotes" rows="4" placeholder="Stakeholder notes…" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1219;color:var(--ink)"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="saveNotes">Save notes</button>
          </div>
          <div id="notesSaved" class="foot"></div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // --- Mock Data ---
    const reserves = [
      { id: 'KE', name: 'Kalahari East', risk:'bad', F:0.31, roh10mb:28, semen:24, disease:'High', coords:[2,1] },
      { id: 'SW', name: 'Serengeti West', risk:'warn', F:0.12, roh10mb:11, semen:39, disease:'Moderate', coords:[1,1] },
      { id: 'NW', name: 'Namib West', risk:'warn', F:0.19, roh10mb:17, semen:31, disease:'Low', coords:[0,0] },
      { id: 'SAZ', name: 'SAZ‑Zoo', risk:'ok', F:0.08, roh10mb:9, semen:48, disease:'Low', coords:[3,0] },
      { id: 'RD', name: 'Reserve Delta', risk:'warn', F:0.18, roh10mb:16, semen:33, disease:'Moderate', coords:[0,3] },
      { id: 'CE', name: 'Caprivi East', risk:'warn', F:0.20, roh10mb:18, semen:30, disease:'Low', coords:[2,0] },
      { id: 'BW', name: 'Botswana Wild', risk:'ok', F:0.10, roh10mb:12, semen:41, disease:'Low', coords:[1,0] },
      { id: 'SE', name: 'Savannah East', risk:'warn', F:0.16, roh10mb:15, semen:34, disease:'Moderate', coords:[3,1] },
      { id: 'NE', name: 'Ngorongoro Edge', risk:'ok', F:0.11, roh10mb:13, semen:38, disease:'Low', coords:[2,2] },
      { id: 'KV', name: 'Kavango', risk:'warn', F:0.21, roh10mb:20, semen:29, disease:'Moderate', coords:[1,3] },
      { id: 'LW', name: 'Limpopo West', risk:'warn', F:0.17, roh10mb:15, semen:32, disease:'Low', coords:[2,3] },
      { id: 'EZ', name: 'Etosha Z', risk:'ok', F:0.09, roh10mb:10, semen:43, disease:'Low', coords:[0,2] },
    ];

    const prefill = {
      target: { id:'KE-F7', reserve:'Kalahari East', age:5, rohBurden:520, health:'cleared' },
      donors: [
        { id:'SW-M3', mode:'live or semen', kinship:0.03, hetGain:18, rohDrop:42, semenGain:'10–14', source:'Serengeti West' },
        { id:'NW-M12', mode:'semen only', kinship:0.05, hetGain:14, rohDrop:30, semenGain:'—', source:'Namib West' },
      ],
      action: 'Import 6 semen straws from SW‑M3 for AI in KE‑F7 & KE‑F9; optional live male swap Q4 if permits clear.'
    };

    const cryobank = [
      { label:'SW‑M3: 24 straws (2019, motility 65%)', value:'+ROH diversity; field‑proven', tags:['rare MHC?','QC good'] },
      { label:'SAZ‑Zoo M5: 14 straws (ex situ, high MHC)', value:'Rare MHC haplotype', tags:['biosecurity: ex‑situ'] },
      { label:'Namib F‑embryos: 3 vitrified blastocysts', value:'Embryo option for diversity', tags:['vitrified','pairing flexible'] },
      { label:'BW‑M7: 10 straws (2021, motility 58%)', value:'OK QC', tags:['field collected'] },
      { label:'KV‑M1: 6 straws (2018, motility 61%)', value:'Legacy line', tags:['quarantine strict'] },
      { label:'NE‑M2: 8 straws (2022, motility 69%)', value:'High quality', tags:['screened 2024'] },
    ];

    // Status datasets for charts
    const chartsData = {
      statusQuo: {
        roh: { labels:['Y0','Y1','Y2'], data:[27,25,23] },
        ne: { labels:['Y0','Y1','Y2'], data:[35,38,40] },
        semen: { labels:['Y0','Y1','Y2'], data:[24,27,29] },
        disease: { labels:['Y0','Y1','Y2'], data:[3,3,3] }, // lower is better index
        whatIf: [
          'Cub survival 58%; two inbred matings flagged next year; Ne stagnates.',
          'ROH trending down slowly; fertility marginal gains.',
          'Biosecurity stable; minimal movement.'
        ]
      },
      assisted: {
        roh: { labels:['Y0','Y1','Y2'], data:[27,22,19] },
        ne: { labels:['Y0','Y1','Y2'], data:[35,48,58] },
        semen: { labels:['Y0','Y1','Y2'], data:[24,31,36] },
        disease: { labels:['Y0','Y1','Y2'], data:[3,3,2] },
        whatIf: [
          'Cub survival 64% (+6 pp); two high‑value outcrosses replace inbred matings.',
          'Mean ROH>10Mb drops 27→19 in KE by Year 2; Ne rises 35→58 across connected reserves.',
          'Disease risk stable/improved due to screening + staggered moves.'
        ]
      }
    };

    // --- UI Builders ---
    const mapEl = document.getElementById('map');
    const tip = document.getElementById('mapTip');
    const stripesEl = document.getElementById('stripes');
    const targetEl = document.getElementById('targetFemale');
    const donorsEl = document.getElementById('donorList');
    const actionEl = document.getElementById('suggestedAction');
    const noLiveMovesEl = document.getElementById('noLiveMoves');

    function riskDot(r){ return `<span class="dot ${r}"></span>` }

    function makeReserveCard(r){
      const btn = document.createElement('button');
      btn.className = 'reserve-btn';
      btn.innerHTML = `
        <div class="row" style="justify-content:space-between;width:100%">
          <strong>${r.name}</strong>
          ${riskDot(r.risk)}
        </div>
        <div class="mini muted">F=${r.F.toFixed(2)} · ROH>10Mb=${r.roh10mb} · semen norm=${r.semen}%</div>`;
      btn.addEventListener('mousemove', (e)=> showTip(e,r));
      btn.addEventListener('mouseleave', hideTip);
      btn.addEventListener('click', ()=> selectReserve(r));
      return btn;
    }

    function showTip(e,r){
      tip.style.display = 'block';
      tip.style.left = (e.pageX + 12) + 'px';
      tip.style.top = (e.pageY + 12) + 'px';
      // find a nearby donor example
      const donor = reserves.find(x=> x.id==='SW');
      tip.innerHTML = `<strong>${r.name}</strong><br>
        Inbreeding Risk: ${r.risk.toUpperCase()}<br>
        <div class="mini">F=${r.F.toFixed(2)}, mean ROH>10Mb=${r.roh10mb} tracts/indiv,<br> semen normal morphology=${r.semen}%, disease index=${r.disease}</div>
        <hr style="border-color:#203046">
        <div class="mini">Nearby donor candidate — <strong>${donor.name}</strong>: F=${donor.F.toFixed(2)}, ROH>10Mb=${donor.roh10mb}, semen=${donor.semen}%, disease=${donor.disease}</div>`
    }
    function hideTip(){ tip.style.display='none' }

    function selectReserve(r){
      // Prefill matchmaker with KE target regardless, but visually highlight selection
      document.querySelectorAll('.reserve-btn').forEach(b=> b.style.outline='none');
      event.currentTarget.style.outline = '2px solid #2b88ff';
    }

    function renderMap(){
      mapEl.innerHTML = '';
      reserves.forEach(r=> mapEl.appendChild(makeReserveCard(r)));
    }

    function renderStripes(){
      const makeRow = (risk)=>{
        const n = 10; const row = document.createElement('div'); row.style.margin='6px 0 14px';
        const barcode = document.createElement('div'); barcode.className='barcode';
        // risk influences average stripe length
        const base = risk==='bad'? 12 : risk==='warn'? 8 : 4;
        for(let i=0;i<n;i++){
          const s = document.createElement('div'); s.className='stripe';
          s.style.width = (base + Math.floor(Math.random()*8)) + 'px';
          s.style.opacity = risk==='bad'? 0.95 : risk==='warn'? 0.75 : 0.55;
          barcode.appendChild(s);
        }
        row.appendChild(barcode);
        const icons = document.createElement('div'); icons.className='mini muted'; icons.textContent = 'S: ' + (risk==='bad'?'red':'amber') + '  ·  P: ' + (risk==='bad'?'hold':'tick');
        row.appendChild(icons);
        return row;
      }
      stripesEl.innerHTML='';
      reserves.forEach(r=>{
        const box = document.createElement('div');
        box.style.border='1px solid var(--line)'; box.style.borderRadius='12px'; box.style.padding='10px'; box.style.margin='6px 0';
        const head = document.createElement('div'); head.className='row'; head.style.justifyContent='space-between';
        head.innerHTML = `<strong>${r.name}</strong> <span class="mini muted">ROH patterns</span>`;
        box.appendChild(head);
        // two barcode rows per reserve
        box.appendChild(makeRow(r.risk));
        box.appendChild(makeRow(r.risk));
        stripesEl.appendChild(box);
      })
    }

    function renderMatchmaker(){
      targetEl.innerHTML = `<div><strong>${prefill.target.id}</strong> — ${prefill.target.reserve}, age ${prefill.target.age}<br>ROH burden: ${prefill.target.rohBurden} Mb; health: ${prefill.target.health}</div>`;
      donorsEl.innerHTML='';
      prefill.donors.forEach(d=>{
        const div = document.createElement('div'); div.className='milestone';
        div.innerHTML = `<strong>${d.id}</strong> (${d.mode}) — from ${d.source}<br>
          kinship=${d.kinship.toFixed(2)}, predicted offspring het +${d.hetGain}%, ROH>10Mb −${d.rohDrop}%<br>
          predicted semen morphology in male offspring ${d.semenGain} pp`;
        donorsEl.appendChild(div);
      })
      updateSuggestedAction();
    }

    function updateSuggestedAction(){
      const noLive = noLiveMovesEl.checked;
      const actionText = noLive ?
        'Import 6 semen straws from SW‑M3 for AI in KE‑F7 & KE‑F9. Live swap disabled due to constraint.' :
        prefill.action;
      actionEl.textContent = actionText;
    }

    // Timeline
    const timeline = [
      { q:'Q1', steps:['Sampling refresh (10 animals/reserve)','Permit applications','Semen collection scheduling'] },
      { q:'Q2', steps:['Quarantine & disease screens','AI for KE‑F7, KE‑F9','Optional embryo placement @ Reserve Delta'] },
      { q:'Q3–Q4', steps:['Cub monitoring','Contingency swap SW → KE'] },
      { q:'Q5–Q6', steps:['Metrics readout','Adjust plan for Year‑2'] },
    ];
    function renderTimeline(){
      const host = document.getElementById('timeline'); host.innerHTML='';
      timeline.forEach(t=>{
        const d = document.createElement('div'); d.className='milestone';
        d.innerHTML = `<strong>${t.q}</strong><ul class="mini muted">${t.steps.map(s=>`<li>${s}</li>`).join('')}</ul>`;
        host.appendChild(d);
      })
    }

    // Charts
    let cROH, cNe, cSemen, cDisease;
    function makeChart(ctx, label, labels, data){
      return new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{ label, data, borderWidth:2, tension:0.25, pointRadius:3 }] },
        options:{
          responsive:true,
          plugins:{ legend:{ display:false } },
          scales:{
            x:{ grid:{ color:'#1b2736' }, ticks:{ color:'#7fa0bd' } },
            y:{ grid:{ color:'#1b2736' }, ticks:{ color:'#7fa0bd' } }
          }
        }
      })
    }

    function renderCharts(dataset){
      const d = chartsData[dataset];
      if(cROH) { cROH.destroy(); cNe.destroy(); cSemen.destroy(); cDisease.destroy(); }
      cROH = makeChart(document.getElementById('chartROH'), 'ROH>10Mb', d.roh.labels, d.roh.data);
      cNe = makeChart(document.getElementById('chartNe'), 'Effective population size (Ne)', d.ne.labels, d.ne.data);
      cSemen = makeChart(document.getElementById('chartSemen'), 'Semen morphology %', d.semen.labels, d.semen.data);
      cDisease = makeChart(document.getElementById('chartDisease'), 'Disease vulnerability index', d.disease.labels, d.disease.data);
      document.getElementById('chartFoot').textContent = dataset==='statusQuo'? 'Status quo projections.' : 'Assisted gene flow scenario projections.';
    }

    // What‑If list
    function renderWhatIf(dataset){
      const ul = document.getElementById('whatIfList'); ul.innerHTML='';
      chartsData[dataset].whatIf.forEach(item=>{
        const li = document.createElement('li'); li.textContent = item; ul.appendChild(li);
      })
    }

    // Sign & Notes
    document.getElementById('signBtn').addEventListener('click', ()=>{
      const name = (document.getElementById('signer').value||'').trim();
      const el = document.getElementById('signStatus');
      if(!name){ el.textContent = 'Please enter your name to sign.'; return; }
      el.textContent = `Signed by ${name} — committing to 2 females, 6 straws, 12 months.`;
    });
    document.getElementById('saveNotes').addEventListener('click', ()=>{
      const txt = (document.getElementById('lbtNotes').value||'').trim();
      if(!txt){ document.getElementById('notesSaved').textContent = 'No notes to save.'; return; }
      localStorage.setItem('cheetah_notes', txt);
      document.getElementById('notesSaved').textContent = 'Notes saved locally in your browser.';
    });

    // Approve / Reject pairing (simple log)
    document.getElementById('approveBtn').addEventListener('click', ()=>{
      alert('Pairing approved. Proceed with cryo pull + AI scheduling.');
    });
    document.getElementById('rejectBtn').addEventListener('click', ()=>{
      alert('Pairing rejected. Consider donor NW‑M12 or adjust constraints.');
    });

    // Toggles and buttons
    noLiveMovesEl.addEventListener('change', updateSuggestedAction);
    const whatIf = document.getElementById('whatIf');
    const scenarioToggle = document.getElementById('scenarioToggle');
    function applyScenario(){
      const assisted = whatIf.checked || scenarioToggle.checked;
      const ds = assisted? 'assisted' : 'statusQuo';
      document.getElementById('whatIfLabel').textContent = assisted? 'Assisted gene flow' : 'Status quo';
      renderCharts(ds); renderWhatIf(ds);
    }
    whatIf.addEventListener('change', applyScenario);
    scenarioToggle.addEventListener('change', applyScenario);

    document.getElementById('resetBtn').addEventListener('click', ()=>{
      whatIf.checked=false; scenarioToggle.checked=false; noLiveMovesEl.checked=false; applyScenario(); updateSuggestedAction();
      document.getElementById('signer').value=''; document.getElementById('signStatus').textContent='';
    })

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const payload = {
        target: prefill.target,
        donors: prefill.donors,
        constraints: { noLiveMoves: noLiveMovesEl.checked },
        action: actionEl.textContent,
        scenario: (whatIf.checked||scenarioToggle.checked)? 'assisted':'statusQuo',
        notes: localStorage.getItem('cheetah_notes')||''
      };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='cheetah_mock_plan.json'; a.click(); URL.revokeObjectURL(url);
    })

    // Cryobank grid
    function renderCryobank(){
      const host = document.getElementById('cryo'); host.innerHTML='';
      cryobank.forEach(item=>{
        const c = document.createElement('div'); c.className='milestone';
        c.innerHTML = `<strong>${item.label}</strong><div class="mini muted">Genetic value: ${item.value}</div><div class="row" style="margin-top:6px">${item.tags.map(t=>`<span class='tag'>${t}</span>`).join('')}</div>`;
        host.appendChild(c);
      })
    }

    // Init
    renderMap();
    renderStripes();
    renderMatchmaker();
    renderTimeline();
    renderCryobank();
    renderCharts('statusQuo');
    renderWhatIf('statusQuo');
  </script>
</body>
</html>