<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add | Creations & Gargantua</title>
  <style>
    :root {
      --border-color: #000;
      --bg-main: #fff;
      --text-muted: #444;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      color: #000;
    }

    main {
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem;
    }

    nav {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      font-size: 0.95rem;
    }

    nav a {
      color: inherit;
      text-decoration: none;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      border: 1px solid transparent;
    }

    nav a:hover {
      border-color: var(--border-color);
    }

    h1 {
      font-size: 1.5rem;
      margin: 0 0 1rem;
    }

    h2 {
      font-size: 1.25rem;
      margin: 1.5rem 0 0.75rem;
    }

    .section-card {
      border: 1px solid var(--border-color);
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .section-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      margin-bottom: 0.25rem;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 4px;
      border: 1px solid #000;
      font: inherit;
    }

    textarea {
      min-height: 5rem;
      resize: vertical;
    }

    button {
      font: inherit;
      border-radius: 4px;
      border: 1px solid #000;
      padding: 0.3rem 0.8rem;
      cursor: pointer;
      background: #000;
      color: #fff;
    }

    button.secondary {
      background: #fff;
      color: #000;
    }

    button.secondary:hover {
      background: #000;
      color: #fff;
    }

    button.danger {
      background: #fff;
      color: #b00020;
      border-color: #b00020;
    }

    button.danger:hover {
      background: #b00020;
      color: #fff;
    }

    button.small {
      font-size: 0.8rem;
      padding: 0.2rem 0.5rem;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .list {
      margin-top: 0.5rem;
      max-height: 260px;
      overflow-y: auto;
      border-top: 1px solid #ddd;
      padding-top: 0.5rem;
    }

    .list-item {
      padding: 0.45rem 0;
      border-bottom: 1px solid #eee;
    }

    .list-title {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .list-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.15rem;
    }

    /* Type chips list (for writing types) */
    .types-list {
      max-height: none;
      border-top: none;
      padding-top: 0.25rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .type-chip {
      border: 1px solid #000;
      border-radius: 999px;
      padding: 0.15rem 0.6rem;
      font-size: 0.85rem;
      cursor: pointer;
      background: #fff;
      color: #000;
    }

    .type-chip:hover {
      background: #f5f5f5;
      color: #000;
    }

    .prompt-display-text {
      font-size: 0.9rem;
      margin-top: 0.15rem;
      white-space: pre-wrap;
    }

    .prompt-edit {
      margin-top: 0.4rem;
      padding: 0.4rem;
      border-radius: 4px;
      border: 1px dashed #aaa;
      background: #fafafa;
    }

    .prompt-edit label {
      margin-top: 0.3rem;
    }

    .prompt-edit textarea {
      min-height: 4rem;
    }

    .prompt-actions {
      margin-top: 0.4rem;
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .prompt-display-header {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <main>
    <nav>
      <a href="/index.html">Home</a>
      <a href="/lang.html">Runs</a>
      <a href="/writings.html">Writings</a>
      <a href="/add.html"><strong>Add</strong></a>
    </nav>

    <h1>Add creations & gargantua</h1>


    <!-- Creations -->
    <section>
      <h2>Creations</h2>

      <div class="section-card">
        <div class="section-title">Add creation</div>
        <label for="creation-name">Creation name</label>
        <input id="creation-name" type="text" placeholder="Creation name" />

        <label for="creation-desc">Creation description</label>
        <textarea id="creation-desc" placeholder="Creation description"></textarea>

        <div class="row" style="margin-top: 0.5rem;">
          <button type="button" id="add-creation-btn">Add creation</button>
        </div>
        <div id="creation-status" class="muted" style="margin-top: 0.35rem;"></div>
      </div>

      <div class="section-card">
        <div class="section-title">Existing creations</div>
        <div id="creations-list" class="list"></div>
      </div>
    </section>

    <!-- Prompts -->
     <section>
      <h2>Gargantua entries</h2>

      <!-- Writing types from writings table -->
      <div class="section-card">
        <div class="section-title">Existing writing types</div>
        <div class="muted">
          These are all distinct <code>type</code> values in the <code>writings</code> table.
          Click a type to fill the <strong>Gargantua type</strong> field.
        </div>
        <div id="types-list" class="types-list"></div>
      </div>

      <div class="section-card">
        <div class="section-title">Add gargantua entry</div>
        <div class="muted">
          Each gargantua entry has a <strong>name</strong>, <strong>text</strong> (used as
          <code>{gargantua}</code> in the prompt), and a <strong>type</strong>
          (used as the <code>type</code> of generated child writings).
        </div>

        <label for="gargantua-name">Name</label>
        <input
          id="gargantua-name"
          type="text"
          placeholder="Short label for this gargantua entry..."
        />

        <label for="gargantua-text">Text</label>
        <textarea
          id="gargantua-text"
          placeholder="Definition / description of the {gargantua} system..."
        ></textarea>

        <label for="gargantua-type">Type</label>
        <input
          id="gargantua-type"
          type="text"
          placeholder="Type to assign to generated child writings (click a writing type above to fill)..."
        />

        <div class="row" style="margin-top: 0.5rem;">
          <button type="button" id="add-gargantua-btn">Add gargantua entry</button>
        </div>
        <div id="gargantua-status" class="muted" style="margin-top: 0.35rem;"></div>
      </div>

      <div class="section-card">
        <div class="section-title">Existing gargantua entries</div>
        <div id="gargantua-list" class="list"></div>
      </div>
    </section>

  </main>

  <script>
    const creationNameEl = document.getElementById('creation-name');
    const creationDescEl = document.getElementById('creation-desc');
    const addCreationBtn = document.getElementById('add-creation-btn');
    const creationStatusEl = document.getElementById('creation-status');
    const creationsListEl = document.getElementById('creations-list');

    const gargantuaNameEl = document.getElementById('gargantua-name');
    const gargantuaTextEl = document.getElementById('gargantua-text');
    const gargantuaTypeEl = document.getElementById('gargantua-type');
    const addGargantuaBtn = document.getElementById('add-gargantua-btn');
    const gargantuaStatusEl = document.getElementById('gargantua-status');
    const gargantuaListEl = document.getElementById('gargantua-list');

    const typesListEl = document.getElementById('types-list');

    //
    // Creations
    //
    async function loadCreations() {
      creationsListEl.textContent = 'Loading…';
      try {
        const res = await fetch('/api/creations');
        if (!res.ok) throw new Error('Failed to load creations');
        const data = await res.json();

        creationsListEl.textContent = '';
        if (!data.length) {
          creationsListEl.textContent = 'No creations yet.';
          return;
        }

        data.forEach((item) => {
          const div = document.createElement('div');
          div.className = 'list-item';

          const title = document.createElement('div');
          title.className = 'list-title';
          title.textContent = item.name || '(unnamed creation)';
          div.appendChild(title);

          if (item.description) {
            const desc = document.createElement('div');
            desc.textContent = item.description;
            desc.style.fontSize = '0.9rem';
            desc.style.marginTop = '0.15rem';
            div.appendChild(desc);
          }

          const meta = document.createElement('div');
          meta.className = 'list-meta';
          meta.textContent = `#${item.id} · created ${item.created_at || ''}`;
          div.appendChild(meta);

          creationsListEl.appendChild(div);
        });
      } catch (err) {
        creationsListEl.textContent = `Error: ${err.message}`;
      }
    }

    async function addCreation() {
      const name = creationNameEl.value.trim();
      const description = creationDescEl.value.trim();

      if (!name && !description) {
        creationStatusEl.textContent = 'Enter a name or description first.';
        return;
      }

      creationStatusEl.textContent = 'Saving…';
      try {
        const res = await fetch('/api/creations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description }),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || 'Failed to add creation');
        }
        creationNameEl.value = '';
        creationDescEl.value = '';
        creationStatusEl.textContent = 'Creation added.';
        await loadCreations();
      } catch (err) {
        creationStatusEl.textContent = `Error: ${err.message}`;
      }
    }

    //
    // Gargantua
    //
    async function loadGargantua() {
      gargantuaListEl.textContent = 'Loading…';
      try {
        const res = await fetch('/api/gargantua');
        if (!res.ok) throw new Error('Failed to load gargantua entries');
        const data = await res.json();

        gargantuaListEl.textContent = '';
        if (!data.length) {
          gargantuaListEl.textContent = 'No gargantua entries yet.';
          return;
        }

        data.forEach((g) => {
          gargantuaListEl.appendChild(renderGargantuaItem(g));
        });
      } catch (err) {
        gargantuaListEl.textContent = `Error: ${err.message}`;
      }
    }

    function renderGargantuaItem(g) {
      const div = document.createElement('div');
      div.className = 'list-item';

      // Display mode
      const display = document.createElement('div');
      const header = document.createElement('div');
      header.className = 'prompt-display-header';

      const title = document.createElement('div');
      title.className = 'list-title';
      const typeLabel = g.type ? ` [type: ${g.type}]` : '';
      title.textContent = g.name ? `${g.name}${typeLabel}` : `(id ${g.id})${typeLabel}`;
      header.appendChild(title);

      const buttons = document.createElement('div');
      buttons.className = 'row';

      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'small secondary';
      editBtn.textContent = 'Edit';

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'small danger';
      deleteBtn.textContent = 'Delete';

      buttons.appendChild(editBtn);
      buttons.appendChild(deleteBtn);
      header.appendChild(buttons);
      display.appendChild(header);

      const text = document.createElement('div');
      text.className = 'prompt-display-text';
      text.textContent = g.text || '';
      display.appendChild(text);

      const meta = document.createElement('div');
      meta.className = 'list-meta';
      meta.textContent = `#${g.id} · created ${g.created_at || ''}`;
      display.appendChild(meta);

      // Edit mode
      const edit = document.createElement('div');
      edit.className = 'prompt-edit';
      edit.style.display = 'none';

      const nameLabel = document.createElement('label');
      nameLabel.textContent = 'Name';
      const nameField = document.createElement('input');
      nameField.type = 'text';
      nameField.value = g.name || '';

      const typeLabelEdit = document.createElement('label');
      typeLabelEdit.textContent = 'Type';
      const typeField = document.createElement('input');
      typeField.type = 'text';
      typeField.value = g.type || '';

      const textLabel = document.createElement('label');
      textLabel.textContent = 'Text';
      const textField = document.createElement('textarea');
      textField.value = g.text || '';

      edit.appendChild(nameLabel);
      edit.appendChild(nameField);
      edit.appendChild(typeLabelEdit);
      edit.appendChild(typeField);
      edit.appendChild(textLabel);
      edit.appendChild(textField);

      const editActions = document.createElement('div');
      editActions.className = 'prompt-actions';

      const saveBtn = document.createElement('button');
      saveBtn.type = 'button';
      saveBtn.className = 'small';
      saveBtn.textContent = 'Save';

      const cancelBtn = document.createElement('button');
      cancelBtn.type = 'button';
      cancelBtn.className = 'small secondary';
      cancelBtn.textContent = 'Cancel';

      editActions.appendChild(saveBtn);
      editActions.appendChild(cancelBtn);
      edit.appendChild(editActions);

      // Wire up actions
      editBtn.addEventListener('click', () => {
        nameField.value = g.name || '';
        typeField.value = g.type || '';
        textField.value = g.text || '';
        display.style.display = 'none';
        edit.style.display = 'block';
      });

      cancelBtn.addEventListener('click', () => {
        edit.style.display = 'none';
        display.style.display = 'block';
      });

      saveBtn.addEventListener('click', async () => {
        const newName = nameField.value.trim();
        const newType = typeField.value.trim();
        const newText = textField.value.trim();

        if (!newName || !newText || !newType) {
          alert('Name, type, and text are required.');
          return;
        }

        try {
          saveBtn.disabled = true;
          const res = await fetch(`/api/gargantua/${encodeURIComponent(g.id)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: newName,
              type: newType,
              text: newText,
            }),
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || 'Failed to update gargantua entry');
          }
          await loadGargantua();
        } catch (err) {
          alert(`Error updating gargantua entry: ${err.message}`);
        } finally {
          saveBtn.disabled = false;
        }
      });

      deleteBtn.addEventListener('click', async () => {
        if (!confirm(`Delete gargantua entry #${g.id}?`)) return;
        try {
          deleteBtn.disabled = true;
          const res = await fetch(`/api/gargantua/${encodeURIComponent(g.id)}`, {
            method: 'DELETE',
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || 'Failed to delete gargantua entry');
          }
          await loadGargantua();
        } catch (err) {
          alert(`Error deleting gargantua entry: ${err.message}`);
        } finally {
          deleteBtn.disabled = false;
        }
      });

      div.appendChild(display);
      div.appendChild(edit);
      return div;
    }

    async function addGargantua() {
      const name = gargantuaNameEl.value.trim();
      const text = gargantuaTextEl.value.trim();
      const type = gargantuaTypeEl.value.trim();

      if (!name) {
        gargantuaStatusEl.textContent = 'Name is required.';
        return;
      }
      if (!text) {
        gargantuaStatusEl.textContent = 'Text is required.';
        return;
      }
      if (!type) {
        gargantuaStatusEl.textContent = 'Type is required.';
        return;
      }

      gargantuaStatusEl.textContent = 'Saving…';
      try {
        const res = await fetch('/api/gargantua', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, text, type }),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || 'Failed to add gargantua entry');
        }
        gargantuaNameEl.value = '';
        gargantuaTextEl.value = '';
        // keep type so you can add multiple entries with same type
        gargantuaStatusEl.textContent = 'Gargantua entry added.';
        await loadGargantua();
      } catch (err) {
        gargantuaStatusEl.textContent = `Error: ${err.message}`;
      }
    }

    //
    // Writing types helper
    //
    async function loadWritingTypes() {
      typesListEl.textContent = 'Loading…';
      try {
        const res = await fetch('/api/writing-types');
        if (!res.ok) throw new Error('Failed to load writing types');
        const data = await res.json();
        if (!Array.isArray(data)) {
          typesListEl.textContent = 'No types data.';
          return;
        }

        const types = data.filter((t) => t && typeof t === 'string');
        typesListEl.textContent = '';

        if (!types.length) {
          const span = document.createElement('span');
          span.className = 'muted';
          span.textContent = 'No writing types yet.';
          typesListEl.appendChild(span);
          return;
        }

        types.forEach((type) => {
          const chip = document.createElement('button');
          chip.type = 'button';
          chip.className = 'type-chip';
          chip.textContent = type;
          chip.addEventListener('click', () => {
            gargantuaTypeEl.value = type;
            gargantuaTypeEl.focus();
          });
          typesListEl.appendChild(chip);
        });
      } catch (err) {
        typesListEl.textContent = `Error: ${err.message}`;
      }
    }

    addCreationBtn.addEventListener('click', addCreation);
    addGargantuaBtn.addEventListener('click', addGargantua);

    (async function init() {
      await loadCreations();
      await loadGargantua();
      await loadWritingTypes();
    })();
  </script>

</body>
</html>
