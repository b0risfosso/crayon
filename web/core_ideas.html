<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fantasiagenesis Â· Core Ideas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light; }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 20px; }
    header h1 { margin: 0 0 .25rem 0; font-size: clamp(1.2rem, 2.4vw, 1.6rem); }
    .muted { opacity: .85; }
    .row { display: flex; gap: .5rem; align-items: center; flex-wrap: wrap; }
    .panel { border: 1px solid #e3e3e6; border-radius: .6rem; padding: .9rem 1rem; background: #fafafb; }
    .panel + .panel { margin-top: .9rem; }
    input[type="text"], input[type="email"], textarea, select {
      width: min(92vw, 820px); padding: .6rem .7rem; border: 1px solid #cdd0d5; border-radius: .55rem; background: #fff;
    }
    input[type="text"], input[type="email"], select { height: 2.4rem; }
    textarea { min-height: 9rem; }
    button { padding: .6rem .9rem; border: 0; border-radius: .55rem; cursor: pointer; background: #0b5cff; color: #fff; }
    button.secondary { background: #4b5563; }
    button.ghost { background: #eef2ff; color: #1f2937; border: 1px solid #c7d2fe; }
    .status { font-size: .92rem; margin-top: .4rem; min-height: 1.2em; }
    .status.error { color: #b00020; white-space: pre-wrap; }
    .status.ok { color: #065f46; }
    .grid { display: grid; gap: .65rem; }
    .cols { display: grid; gap: .65rem; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .card { border: 1px solid #e5e7eb; border-radius: .6rem; background: #fff; padding: .6rem .7rem; }
    .card h3 { margin: 0 0 .25rem 0; font-size: 1rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .inline { display: inline-flex; align-items: center; gap: .5rem; }
    .muted-small { color:#6b7280; font-size:.9rem; }
    .spinner { display:inline-block; width:1em; height:1em; border:.15em solid #dbeafe; border-top-color:#3b82f6; border-radius:50%; animation:spin 1s linear infinite; vertical-align:-.2em; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .ideas-list { display:grid; gap:.5rem; }
    .idea { border:1px solid #e5e7eb; background:#fff; border-radius:.5rem; padding:.5rem .6rem; }
  </style>
</head>
<body>
  <header class="row" style="justify-content: space-between;">
    <div>
      <h1>Fantasiagenesis Â· Core Ideas</h1>
      <div class="muted">Extract and read <strong>core ideas</strong> via JID.</div>
    </div>
    <nav class="row">
      <a class="inline" href="/draw" title="Draw">ðŸŽ¨ <span class="muted">Draw</span></a>
      <a class="inline" href="/pictures" title="Pictures">ðŸ“„ <span class="muted">Pictures</span></a>
    </nav>
  </header>

  <!-- Email -->
  <section class="panel">
    <div class="row">
      <input type="email" id="email" placeholder="Email (optional, used for persistence)" />
      <button id="saveEmail" class="secondary" type="button">Save email</button>
    </div>
    <div id="svcStatus" class="status"></div>
  </section>

  <!-- Create Core Ideas -->
  <section class="panel">
    <h2 style="margin:.1rem 0 .6rem 0;">Extract Core Ideas</h2>
    <div class="grid">
      <input id="source" type="text" placeholder="Source (stored in core_ideas.source)" />
      <textarea id="text" placeholder="Paste text to distill into core ideasâ€¦"></textarea>
      <div class="row">
        <button id="btnExtract" type="button">Extract & Save</button>
      </div>
      <div id="statusExtract" class="status"></div>
      <div id="ideasOut" class="ideas-list"></div>
    </div>
  </section>

  <!-- Read Core Ideas -->
  <section class="panel">
    <h2 style="margin:.1rem 0 .6rem 0;">Read Core Ideas</h2>
    <div class="grid">
      <div class="row">
        <input id="qSource" type="text" placeholder="Filter by source (substring match)" />
        <input id="qEmail" type="text" placeholder="Filter by email (optional)" />
        <input id="qLimit" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Limit (e.g., 50)" style="width:10rem" />
        <button id="btnRead" class="ghost" type="button">Load</button>
      </div>
      <div id="statusRead" class="status"></div>
      <div id="readOut" class="cols"></div>
    </div>
  </section>

  <script>
    const LS_EMAIL = 'fg_user_email';
    const EP = {
      createCoreIdeas: '/jid/create_core_ideas',
      readCoreIdeas: '/read/core_ideas'
    };
    const $ = (id) => document.getElementById(id);
    function setText(el, msg, cls = '') {
      if (!el) return;
      el.className = 'status ' + (cls || '');
      el.textContent = msg || '';
    }
    async function fetchJSON(url, options = {}, timeoutMs = 600000) {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const resp = await fetch(url, { ...options, signal: controller.signal });
        const ct = resp.headers.get('content-type') || '';
        const isJSON = ct.includes('application/json');
        const data = isJSON ? await resp.json() : await resp.text();
        if (!resp.ok) {
          const detail = isJSON ? (data?.error || data?.detail || JSON.stringify(data)) : data;
          throw new Error(detail || `HTTP ${resp.status}`);
        }
        return data;
      } finally { clearTimeout(timer); }
    }
    function postJSON(url, body, timeoutMs) {
      return fetchJSON(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body || {})
      }, timeoutMs);
    }
    function loadEmail() {
      const v = (localStorage.getItem(LS_EMAIL) || '').trim().toLowerCase();
      if (v) $('email').value = v;
    }
    function saveEmail() {
      const v = ($('email').value || '').trim().toLowerCase();
      if (v) localStorage.setItem(LS_EMAIL, v);
      else localStorage.removeItem(LS_EMAIL);
    }

    function renderIdeas(list, mountId) {
      const mount = $(mountId);
      mount.innerHTML = '';
      const items = Array.isArray(list) ? list : [];
      if (!items.length) { mount.innerHTML = '<div class="muted">No ideas.</div>'; return; }
      for (const s of items) {
        const div = document.createElement('div');
        div.className = 'idea';
        div.textContent = typeof s === 'string' ? s : (s.core_idea || JSON.stringify(s));
        mount.append(div);
      }
    }

    function renderRead(data) {
      const mount = $('readOut');
      mount.innerHTML = '';
      const items = Array.isArray(data?.items) ? data.items : Array.isArray(data) ? data : [];
      if (!items.length) { mount.innerHTML = '<div class="muted">No rows found.</div>'; return; }
      for (const r of items) {
        const card = document.createElement('div'); card.className = 'card';
        const head = document.createElement('h3'); head.textContent = r.source || '(no source)';
        const body = document.createElement('div'); body.className = 'muted'; body.textContent = r.core_idea || '';
        const meta = document.createElement('div'); meta.className = 'muted-small';
        const parts = [];
        if (r.email) parts.push(r.email);
        if (r.created_at) parts.push(r.created_at);
        if (r.id) parts.push('id:'+r.id);
        meta.textContent = parts.join(' Â· ');
        card.append(head, body, meta);
        mount.append(card);
      }
    }

    async function doExtract() {
      const email = ($('email').value || '').trim().toLowerCase();
      const source = ($('source').value || '').trim();
      const text = ($('text').value || '').trim();
      if (!source) { setText($('statusExtract'), 'Enter a source.', 'error'); return; }
      if (!text) { setText($('statusExtract'), 'Paste some text.', 'error'); return; }
      setText($('statusExtract'), 'Extractingâ€¦');
      $('ideasOut').innerHTML = '';
      try {
        const payload = { source, text };
        if (email) payload.email = email;
        const res = await postJSON(EP.createCoreIdeas, payload, 600000);
        const ideas = res?.ideas || [];
        renderIdeas(ideas, 'ideasOut');
        setText($('statusExtract'), `Saved ${res?.inserted ?? ideas.length} idea(s).`, 'ok');
        if (email) saveEmail();
      } catch (e) {
        setText($('statusExtract'), `Failed: ${e.message || e}`, 'error');
      }
    }

    async function doRead() {
      const q = new URLSearchParams();
      const src = ($('qSource').value || '').trim();
      const email = ($('qEmail').value || '').trim().toLowerCase();
      const lim = parseInt(($('qLimit').value || '').trim(), 10);
      if (src) q.set('source_like', src);
      if (email) q.set('email', email);
      if (!Number.isNaN(lim) && lim > 0) q.set('limit', String(lim));
      setText($('statusRead'), 'Loadingâ€¦');
      $('readOut').innerHTML = '';
      try {
        const data = await fetchJSON(`${EP.readCoreIdeas}?${q.toString()}`, {}, 60000);
        renderRead(data);
        setText($('statusRead'), `Loaded ${Array.isArray(data?.items) ? data.items.length : 0} row(s).`, 'ok');
      } catch (e) {
        setText($('statusRead'), `Failed: ${e.message || e}`, 'error');
      }
    }

    (function init() {
      loadEmail();
      $('saveEmail').addEventListener('click', () => { saveEmail(); setText($('svcStatus'), 'Email saved.', 'ok'); });
      $('btnExtract').addEventListener('click', doExtract);
      $('btnRead').addEventListener('click', doRead);
    })();
  </script>
</body>
</html>
