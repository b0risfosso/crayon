<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>5 Random Narratives + Dimensions</title>
  <style>
    :root { color-scheme: light dark; --line: color-mix(in oklab, CanvasText 16%, transparent); }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: Canvas; color: CanvasText;
    }
    header {
      position: sticky; top: 0; background: color-mix(in oklab, Canvas 90%, transparent);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--line);
      padding: .9rem 1rem;
      display: grid; gap: .35rem;
    }
    h1 { margin: 0; font-size: 1.05rem; letter-spacing:.02em; }
    .muted { opacity: .75; font-size: .92rem; }
    .toolbar { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
    button {
      appearance: none; border:1px solid var(--line); background:transparent; color:inherit;
      padding:.5rem .75rem; border-radius:.6rem; cursor:pointer;
    }
    button:disabled { opacity:.6; cursor:not-allowed; }
    main { padding: 1rem; display: grid; gap: 1rem; }
    .narr-card {
      border:1px solid var(--line); border-radius: .9rem; padding: 1rem; display:grid; gap:.6rem;
    }
    .row { display:flex; align-items:baseline; justify-content:space-between; gap:.75rem; flex-wrap:wrap; }
    .title { font-weight: 700; line-height: 1.2; }
    .meta { font-size:.85rem; opacity:.75; display:flex; gap:.6rem; flex-wrap:wrap; }
    .pill { display:inline-flex; align-items:center; border:1px solid var(--line); border-radius:999px; padding:.15rem .55rem; font-size:.78rem; }
    .dims { display:grid; gap:.6rem; }
    .dim {
      border:1px dashed var(--line); border-radius:.7rem; padding:.7rem; display:grid; gap:.35rem;
    }
    .dim .head { display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    .dim .name { font-weight:600; }
    .desc { font-size:.92rem; }
    .error { color:#c33; }
    .skeleton { background: color-mix(in oklab, CanvasText 10%, transparent); height:1rem; border-radius:.4rem; animation: pulse 1.1s ease-in-out infinite alternate; }
    @keyframes pulse { to { opacity:.45; } }
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <header>
    <h1>5 Random Narratives + Full Dimension Sets</h1>
    <div class="toolbar">
      <span id="totalPill" class="pill" title="Total narratives available">Total: —</span>
      <span id="showingPill" class="pill" title="Narratives shown">Showing: —</span>
      <button id="refreshBtn" type="button">↻ Refresh sample</button>
    </div>
    <div id="status" class="muted">Loading…</div>
  </header>

  <main id="list" aria-live="polite"></main>

  <script>
    const list = document.getElementById('list');
    const statusEl = document.getElementById('status');
    const totalPill = document.getElementById('totalPill');
    const showingPill = document.getElementById('showingPill');
    const refreshBtn = document.getElementById('refreshBtn');

    let allNarratives = [];

    function fmtDate(iso) {
      if (!iso) return '—';
      const d = new Date(iso);
      if (Number.isNaN(+d)) return '—';
      return new Intl.DateTimeFormat(undefined, {year:'numeric', month:'short', day:'2-digit'}).format(d);
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function pickRandom(items, n) {
      if (n >= items.length) return items.slice();
      const copy = items.slice();
      shuffle(copy);
      return copy.slice(0, n);
    }

    async function fetchJSON(url, opts) {
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), 15000);
      try {
        const res = await fetch(url, { ...opts, signal: controller.signal, headers: { 'Accept': 'application/json', ...(opts && opts.headers || {}) }});
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } finally {
        clearTimeout(t);
      }
    }

    function renderSkeleton(narr) {
      const card = document.createElement('section');
      card.className = 'narr-card';
      card.innerHTML = `
        <div class="row">
          <div class="title"><a href="/narratives/${narr.id}">${narr.title || '(untitled)'}</a></div>
          <div class="meta">
            <span>ID: ${narr.id}</span>
            <span>Created: ${fmtDate(narr.created_at)}</span>
          </div>
        </div>
        <div class="muted">Loading dimensions…</div>
        <div class="dims" aria-busy="true" aria-label="Dimensions">
          <div class="skeleton" style="width:40%"></div>
          <div class="skeleton" style="width:85%"></div>
          <div class="skeleton" style="width:70%"></div>
        </div>
      `;
      return card;
    }

    function renderDimensions(intoEl, dims) {
      intoEl.innerHTML = '';
      if (!dims.length) {
        const p = document.createElement('div');
        p.className = 'muted';
        p.textContent = 'No dimensions found.';
        intoEl.appendChild(p);
        return;
      }
      for (const d of dims) {
        const el = document.createElement('article');
        el.className = 'dim';
        el.innerHTML = `
          <div class="head">
            <div class="name">${d.title || '(untitled dimension)'}</div>
            <div class="meta">
              <span class="pill">Provider: ${d.provider || '—'}</span>
              <span class="pill">#${d.id}</span>
              <span class="pill">${fmtDate(d.created_at)}</span>
            </div>
          </div>
          ${d.description ? `<div class="desc">${d.description}</div>` : ''}
        `;
        intoEl.appendChild(el);
      }
    }

    async function loadAllNarratives() {
      statusEl.textContent = 'Loading narratives…';
      const rows = await fetchJSON('/api/narratives');
      allNarratives = Array.isArray(rows) ? rows : [];
      totalPill.textContent = `Total: ${allNarratives.length}`;
      return allNarratives;
    }

    async function loadSampleWithDimensions() {
      list.innerHTML = '';
      const sample = pickRandom(allNarratives, Math.min(5, allNarratives.length));
      showingPill.textContent = `Showing: ${sample.length}`;
      statusEl.textContent = sample.length ? 'Loading dimensions…' : 'No narratives available.';

      // Render skeletons first
      const cards = sample.map(n => {
        const card = renderSkeleton(n);
        list.appendChild(card);
        return card;
      });

      // Fetch dimensions in parallel
      await Promise.all(sample.map(async (n, idx) => {
        const card = cards[idx];
        const dimsWrap = card.querySelector('.dims');
        const muted = card.querySelector('.muted');

        try {
          const dims = await fetchJSON(`/api/narratives/${n.id}/dimensions`);
          muted.textContent = `Dimensions: ${dims.length}`;
          dimsWrap.setAttribute('aria-busy', 'false');
          renderDimensions(dimsWrap, Array.isArray(dims) ? dims : []);
        } catch (e) {
          muted.innerHTML = `<span class="error">Failed to load dimensions: ${e.message || e}</span>`;
          dimsWrap.innerHTML = '';
        }
      }));

      statusEl.textContent = 'Done.';
    }

    async function boot() {
      try {
        await loadAllNarratives();
        await loadSampleWithDimensions();
      } catch (e) {
        statusEl.innerHTML = `<span class="error">Failed to load narratives: ${e.message || e}</span>`;
        totalPill.textContent = 'Total: —';
        showingPill.textContent = 'Showing: —';
      }
    }

    refreshBtn.addEventListener('click', async () => {
      statusEl.textContent = 'Sampling…';
      await loadSampleWithDimensions();
    });

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
