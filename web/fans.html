<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>100 Random Narrative Domains</title>
  <style>
    :root { color-scheme: light dark; --border: color-mix(in oklab, CanvasText 14%, transparent); }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: Canvas; color: CanvasText;
    }
    header {
      position: sticky; top: 0; background: color-mix(in oklab, Canvas 90%, transparent);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--border);
      padding: .9rem 1rem; display: grid; gap: .4rem;
    }
    header .row { display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    h1 { margin:0; font-size:1.05rem; letter-spacing:.02em; }
    .muted { opacity:.7; font-size:.92rem; }
    main { padding: 1rem; }
    .toolbar { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    button {
      appearance: none; border:1px solid var(--border); background:transparent; color:inherit;
      padding:.5rem .7rem; border-radius:.65rem; cursor:pointer;
    }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .grid {
      display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap:.75rem; margin-top:1rem;
    }
    .card {
      border:1px solid var(--border); border-radius:.9rem; padding:.8rem; display:grid; gap:.35rem;
    }
    .title {
      font-weight:600; line-height:1.2;
    }
    .meta {
      font-size:.82rem; opacity:.75; display:flex; gap:.5rem; flex-wrap:wrap;
    }
    .pill {
      display:inline-flex; align-items:center; gap:.4rem;
      border:1px solid var(--border); border-radius:999px; padding:.15rem .55rem; font-size:.8rem;
    }
    .error { color: #c33; }
    a { color: inherit; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1>100 Random Narrative Domains</h1>
      <div class="toolbar">
        <span id="totalPill" class="pill" title="Total narratives available">Total: —</span>
        <span id="showingPill" class="pill" title="Number currently shown">Showing: —</span>
        <button id="refreshBtn" type="button">↻ Refresh sample</button>
      </div>
    </div>
    <div class="muted" id="status">Loading…</div>
  </header>

  <main>
    <div id="grid" class="grid" role="list" aria-label="Random narratives"></div>
  </main>

  <script>
    const grid = document.getElementById('grid');
    const statusEl = document.getElementById('status');
    const refreshBtn = document.getElementById('refreshBtn');
    const totalPill = document.getElementById('totalPill');
    const showingPill = document.getElementById('showingPill');

    let allNarratives = [];

    function fmtDate(iso) {
      if (!iso) return '—';
      try {
        const d = new Date(iso);
        return new Intl.DateTimeFormat(undefined, {year:'numeric', month:'short', day:'2-digit'}).format(d);
      } catch { return '—'; }
    }

    // Fisher–Yates shuffle (in-place)
    function shuffleInPlace(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function pickRandomSample(items, n) {
      if (n >= items.length) return items.slice();
      const copy = items.slice();
      shuffleInPlace(copy);
      return copy.slice(0, n);
    }

    function render(cards) {
      grid.innerHTML = '';
      for (const row of cards) {
        const card = document.createElement('article');
        card.className = 'card';
        card.setAttribute('role','listitem');

        const title = document.createElement('div');
        title.className = 'title';
        // If you have a narrative page route like /narratives/:id, make the title a link:
        const link = document.createElement('a');
        link.href = `/narratives/${row.id}`;
        link.textContent = row.title || '(untitled)';
        title.appendChild(link);

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `
          <span>ID: ${row.id}</span>
          <span>Created: ${fmtDate(row.created_at)}</span>
        `;

        card.appendChild(title);
        card.appendChild(meta);
        grid.appendChild(card);
      }
      showingPill.textContent = `Showing: ${cards.length}`;
    }

    async function loadAll() {
      setLoading(true, 'Loading…');
      try {
        const res = await fetch('/api/narratives', { headers: { 'Accept': 'application/json' }});
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const rows = await res.json(); // expected: [{id, title, created_at}, ...]
        allNarratives = Array.isArray(rows) ? rows : [];
        totalPill.textContent = `Total: ${allNarratives.length}`;
        statusEl.textContent = 'Loaded.';
        sampleAndRender();
      } catch (err) {
        statusEl.innerHTML = `<span class="error">Failed to load narratives: ${err?.message || err}</span>`;
        totalPill.textContent = 'Total: —';
        render([]);
      } finally {
        setLoading(false);
      }
    }

    function sampleAndRender() {
      const n = Math.min(100, allNarratives.length);
      const sample = pickRandomSample(allNarratives, n);
      render(sample);
    }

    function setLoading(isLoading, msg='') {
      refreshBtn.disabled = isLoading;
      if (msg) statusEl.textContent = msg;
    }

    refreshBtn.addEventListener('click', () => {
      if (!allNarratives.length) {
        loadAll(); // if first load failed, retry
      } else {
        statusEl.textContent = 'Sampling…';
        sampleAndRender();
        statusEl.textContent = 'Done.';
      }
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', loadAll);
  </script>
</body>
</html>
