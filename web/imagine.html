<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Imagine — Narrative Dimensions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, sans-serif; margin: 2rem; max-width: 900px; }
    h1 { font-size: 1.6rem; margin-bottom: .75rem; }
    form { display: flex; gap: .5rem; flex-wrap: wrap; margin: 1rem 0; }
    input[type="text"] { padding: .6rem .7rem; min-width: 20rem; border: 1px solid #ccc; border-radius: .5rem; }
    button { padding: .6rem .9rem; border: 0; border-radius: .5rem; cursor: pointer; background: #0b5cff; color: #fff; }
    .meta { font-size: .9rem; opacity: .8; margin-bottom: .5rem; }
    .error { color: #b00020; white-space: pre-wrap; }
    .grid { display: grid; gap: .75rem; }
    details { border: 1px solid #d0d0d0; border-radius: .6rem; padding: .75rem 1rem; }
    summary { cursor: pointer; font-weight: 600; }
    .thesis { margin: .5rem 0 .25rem; font-style: italic; }
    ul { margin: .25rem 0 0 1.25rem; }
    pre { background: #f6f6f6; padding: .75rem; border-radius: .5rem; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Imagine Narrative Dimensions</h1>

  <form id="form">
    <input id="domain" type="text" placeholder="Enter a domain (e.g., biotechnology)" required>
    <button type="submit">Generate</button>
  </form>

  <div id="meta" class="meta"></div>
  <div id="output" class="grid"></div>
  <div id="err" class="error"></div>

  <script>
    const form = document.getElementById('form');
    const domainInput = document.getElementById('domain');
    const output = document.getElementById('output');
    const meta = document.getElementById('meta');
    const errBox = document.getElementById('err');

    function el(tag, opts = {}) {
      const node = document.createElement(tag);
      if (opts.className) node.className = opts.className;
      if (opts.text != null) node.textContent = opts.text;
      return node;
    }

    function renderDimensions(payload) {
      output.innerHTML = '';
      errBox.textContent = '';
      meta.textContent = '';

      // Shape 1 (your endpoint): { domain, model, dimensions: [...] }
      if (payload && Array.isArray(payload.dimensions)) {
        meta.textContent = `Domain: ${payload.domain ?? '—'} · Model: ${payload.model ?? '—'} · Count: ${payload.dimensions.length}`;
        payload.dimensions.forEach((d, i) => {
          const card = el('details');
          const sum = el('summary');
          sum.textContent = `${i + 1}. ${d.name || 'Untitled'}`;
          const thesis = el('div', { className: 'thesis', text: d.thesis || '' });

          const ul = el('ul');
          (Array.isArray(d.targets) ? d.targets : []).forEach(t => {
            const li = el('li'); li.textContent = t; ul.appendChild(li);
          });

          card.appendChild(sum);
          card.appendChild(thesis);
          card.appendChild(ul);
          output.appendChild(card);
        });
        return;
      }

      // Shape 2: { raw: "...text..." } fallback
      if (payload && typeof payload.raw === 'string') {
        meta.textContent = `Domain: ${payload.domain ?? '—'} · Model: ${payload.model ?? '—'} (raw text shown; parsing failed)`;
        const pre = el('pre'); pre.textContent = payload.raw;
        output.replaceChildren(pre);
        return;
      }

      // Unknown shape — show whole payload for debugging
      const pre = el('pre'); pre.textContent = JSON.stringify(payload, null, 2);
      output.replaceChildren(pre);
    }

    async function callAPI(domain) {
      errBox.textContent = '';
      meta.textContent = '';
      output.innerHTML = 'Loading…';
      try {
        const resp = await fetch('/api/narrative-dimensions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ domain })
        });

        // Try to parse JSON even on non-200 for structured error
        let data;
        try { data = await resp.json(); } catch {
          throw new Error(`Non-JSON response (status ${resp.status})`);
        }

        if (!resp.ok || data.error) {
          output.innerHTML = '';
          errBox.textContent = (data && (data.error || data.detail)) ?
            `${data.error}${data.detail ? `\n${data.detail}` : ''}` :
            `HTTP ${resp.status}`;
          return;
        }

        renderDimensions(data);
      } catch (e) {
        output.innerHTML = '';
        errBox.textContent = `Request failed: ${e.message || e}`;
      }
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      callAPI(domainInput.value.trim());
    });

    // Demo: if you want to test rendering without the backend, uncomment below
    // renderDimensions({"dimensions":[{"name":"Genetic Frontiers","targets":["CRISPR and gene editing debates","personalized medicine","bioethics of genetic modification","genome sequencing advances"],"thesis":"Unlocking DNA's secrets, biotechnology writes new laws of life, reshaping ethics and identity."},{"name":"Synthetic Evolution","targets":["artificial biomes","custom organisms","bio-engineered solutions","cells as programmable machines"],"thesis":"Crafting life from scratch, synthetic biology amplifies nature's toolkit, challenging notions of creation."},{"name":"Biotechnological Economies","targets":["biopharmaceutical breakthroughs","biotech startups","investment and market dynamics","patent wars"],"thesis":"Bio-innovation transforms economies, balancing profit with moral responsibility in the quest for health and sustainability."},{"name":"Agri-Revolution","targets":["GMO controversies","vertical farming innovations","bio-fertilizers and pest control","food supply chains"],"thesis":"Designer crops and engineered resilience redefine food security amidst climate uncertainties."},{"name":"Therapeutic Rebirth","targets":["stem cell therapies","organ regeneration","cancer treatment innovations","bioprinting"],"thesis":"Regenerative medicine and biotech therapies promise a rebirth in healing, confronting mortality and illness."},{"name":"Body as Data","targets":["biometric wellness tracking","digital twins in healthcare","biotech privacy concerns","integration with AI and IoT"],"thesis":"Biotechnology transforms the body into a data frontier, informing future health landscapes and personal autonomy."}],"domain":"biotechnology","model":"gpt-4o-2024-08-06"});
  </script>
</body>
</html>
