<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Imagine — Narrative Dimensions & Seeds</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, sans-serif; margin: 2rem; max-width: 1000px; }
    h1 { font-size: 1.6rem; margin-bottom: .5rem; }
    form { display: flex; gap: .5rem; flex-wrap: wrap; margin: 1rem 0; }
    input[type="text"] { padding: .6rem .7rem; min-width: 22rem; border: 1px solid #ccc; border-radius: .5rem; }
    button { padding: .6rem .9rem; border: 0; border-radius: .5rem; cursor: pointer; background: #0b5cff; color: #fff; }
    .meta { font-size: .9rem; opacity: .85; margin: .25rem 0 1rem; }
    .grid { display: grid; gap: .8rem; }
    details { border: 1px solid #d0d0d0; border-radius: .6rem; padding: .75rem 1rem; background: rgba(0,0,0,.02); }
    summary { cursor: pointer; font-weight: 600; }
    .thesis { margin: .4rem 0 .3rem; font-style: italic; }
    .targets { margin: .25rem 0 .5rem 1.25rem; }
    .seedbox { border-top: 1px dashed #c8c8c8; margin-top: .5rem; padding-top: .5rem; }
    .seed-title { font-weight: 600; margin-bottom: .25rem; }
    .seed { margin: .35rem 0; padding: .5rem .6rem; border: 1px solid #e0e0e0; border-radius: .5rem; background: #fff; }
    .seed small { display: block; opacity: .8; margin-top: .2rem; }
    .dim-error, .seed-error, .error { color: #b00020; white-space: pre-wrap; }
    .muted { opacity: .7; font-size: .9rem; }
    pre { background: #f6f6f6; padding: .75rem; border-radius: .5rem; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Imagine Narrative Dimensions → Seeds</h1>

  <form id="form">
    <input id="domain" type="text" placeholder="Enter a domain (e.g., biotechnology)" required>
    <button type="submit">Generate</button>
  </form>

  <div id="meta" class="meta"></div>
  <div id="err" class="error"></div>
  <div id="output" class="grid"></div>

  <script>
    const form = document.getElementById('form');
    const domainInput = document.getElementById('domain');
    const meta = document.getElementById('meta');
    const errBox = document.getElementById('err');
    const output = document.getElementById('output');

    function el(tag, opts = {}) {
      const node = document.createElement(tag);
      if (opts.className) node.className = opts.className;
      if ('text' in opts) node.textContent = opts.text;
      if ('html' in opts) node.innerHTML = opts.html;
      return node;
    }

    function renderDimensionCard(idx, dim, domain) {
      const card = el('details');
      const sum = el('summary', { text: `${idx + 1}. ${dim.name || 'Untitled'}` });
      const thesis = el('div', { className: 'thesis', text: dim.thesis || '' });

      const targetsList = el('ul', { className: 'targets' });
      (Array.isArray(dim.targets) ? dim.targets : []).forEach(t => {
        targetsList.appendChild(el('li', { text: t }));
      });

      const seedBox = el('div', { className: 'seedbox' });
      const seedHeader = el('div', { className: 'seed-title', text: 'Seeds' });
      const seedStatus = el('div', { className: 'muted', text: 'Loading seeds…' });
      const seedWrap = el('div');

      seedBox.appendChild(seedHeader);
      seedBox.appendChild(seedStatus);
      seedBox.appendChild(seedWrap);

      card.appendChild(sum);
      card.appendChild(thesis);
      card.appendChild(targetsList);
      card.appendChild(seedBox);

      // Auto-fetch seeds for this dimension
      fetchSeedsForDimension({
        domain,
        dimension: dim.name,
        description: dim.thesis,
        targets: dim.targets
      }, { seedStatus, seedWrap });

      return card;
    }

    async function fetchSeedsForDimension(payload, ui) {
      const { seedStatus, seedWrap } = ui;
      try {
        const resp = await fetch('/api/narrative-seeds', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        let data;
        try { data = await resp.json(); } catch {
          throw new Error(`Non-JSON response from /api/narrative-seeds (status ${resp.status})`);
        }

        seedStatus.textContent = '';

        if (!resp.ok || data.error) {
          seedStatus.className = 'seed-error';
          seedStatus.textContent = data.error ? `${data.error}${data.detail ? ` — ${data.detail}` : ''}` : `HTTP ${resp.status}`;
          return;
        }

        if (Array.isArray(data.seeds)) {
          if (data.seeds.length === 0) {
            seedStatus.textContent = 'No seeds returned.';
            return;
          }
          data.seeds.forEach(s => {
            const seed = el('div', { className: 'seed' });
            seed.innerHTML =
              `<strong>A (Problem):</strong> ${escapeHtml(s.problem || '')}<br>` +
              `<strong>B (Objective):</strong> ${escapeHtml(s.objective || '')}<br>` +
              `<strong>Solution (Link):</strong> ${escapeHtml(s.solution || '')}`;
            seedWrap.appendChild(seed);
          });
        } else if (data.raw) {
          const pre = el('pre'); pre.textContent = data.raw;
          seedWrap.appendChild(pre);
          seedStatus.textContent = 'Model returned raw text; parsing failed upstream.';
        } else {
          const pre = el('pre'); pre.textContent = JSON.stringify(data, null, 2);
          seedWrap.appendChild(pre);
          seedStatus.textContent = 'Unexpected response shape.';
        }
      } catch (e) {
        seedStatus.className = 'seed-error';
        seedStatus.textContent = `Seed request failed: ${e.message || e}`;
      }
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    async function callDimensions(domain) {
      errBox.textContent = '';
      meta.textContent = '';
      output.innerHTML = 'Loading dimensions…';

      const resp = await fetch('/api/narrative-dimensions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ domain })
      });

      let data;
      try { data = await resp.json(); } catch {
        output.innerHTML = '';
        errBox.textContent = `Non-JSON response (status ${resp.status})`;
        return;
      }

      if (!resp.ok || data.error) {
        output.innerHTML = '';
        errBox.textContent = data.error ? `${data.error}${data.detail ? ` — ${data.detail}` : ''}` : `HTTP ${resp.status}`;
        return;
      }

      // Render dimensions
      if (Array.isArray(data.dimensions)) {
        output.innerHTML = '';
        meta.textContent = `Domain: ${data.domain ?? '—'} · Model: ${data.model ?? '—'} · Count: ${data.dimensions.length}`;
        data.dimensions.forEach((dim, idx) => {
          output.appendChild(renderDimensionCard(idx, dim, data.domain || domain));
        });
      } else if (data.raw) {
        meta.textContent = `Domain: ${data.domain ?? '—'} · Model: ${data.model ?? '—'} (raw text shown; parsing failed)`;
        const pre = el('pre'); pre.textContent = data.raw;
        output.replaceChildren(pre);
      } else {
        const pre = el('pre'); pre.textContent = JSON.stringify(data, null, 2);
        output.replaceChildren(pre);
      }
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const domain = domainInput.value.trim();
      if (domain) callDimensions(domain);
    });
  </script>
</body>
</html>
