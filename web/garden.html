<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fantasiagenesis — Garden (Published Seeds)</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg: Canvas; --fg: CanvasText;
    --muted: color-mix(in oklab, var(--fg) 60%, transparent);
    --line: color-mix(in oklab, var(--fg) 14%, transparent);
    --card: color-mix(in oklab, var(--bg) 95%, var(--fg) 5%);
    --chip: color-mix(in oklab, var(--fg) 8%, transparent);
    --accent: color-mix(in oklab, var(--fg) 22%, transparent);
    --radius: 14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font:15px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--fg)}
  header{padding:18px clamp(14px,4vw,28px); border-bottom:1px solid var(--line); display:grid; gap:10px}
  h1{margin:0; font-size:clamp(1.1rem, 2.6vw, 1.6rem); letter-spacing:.01em}
  .muted{opacity:.8}
  .row{display:flex; gap:.6rem; align-items:center; flex-wrap:wrap}
  .sep{flex:1}
  .pill{display:inline-flex; align-items:center; gap:.45rem; padding:.22rem .6rem; border:1px solid var(--line); border-radius:999px; background:var(--chip); font-size:.82rem; font-weight:700}
  .toolbar{display:flex; gap:.6rem; flex-wrap:wrap}
  .input{display:flex; align-items:center; gap:.5rem; border:1px solid var(--line); background:var(--bg); border-radius:10px; padding:.45rem .6rem; min-width:260px}
  .input input{all:unset; width:240px}
  .btn{border:1px solid var(--line); background:var(--bg); border-radius:10px; padding:.45rem .75rem; cursor:pointer; font-weight:700}
  .btn:hover{background:var(--chip)}
  main{padding:20px clamp(14px,4vw,28px); display:grid; gap:14px; max-width:1200px; margin:0 auto}
  .stats{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .grid{display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr))}
  .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:12px; display:grid; gap:8px}
  .card h3{margin:.1rem 0 .2rem; font-size:1rem}
  .chip{display:inline-flex; align-items:center; gap:.35rem; padding:.16rem .52rem; border-radius:999px; background:var(--chip); font-size:.78rem}
  .kv{display:grid; gap:6px}
  .kv .row{display:flex; gap:.5rem; align-items:flex-start}
  .kv .k{width:92px; opacity:.75; font-weight:600}
  .kv .v{flex:1}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
  .domain{border-left:4px solid var(--accent); padding-left:8px}
  .dim{opacity:.9}
  a.card-link{color:inherit; text-decoration:none}
  a.card-link:focus-visible{outline:2px solid var(--accent); outline-offset:3px; border-radius:8px}
  .small{font-size:.9rem}
  .footer-note{opacity:.75; font-size:.9rem; padding:6px 0 0}
  .progress{height:6px; background:var(--chip); border-radius:999px; overflow:hidden}
  .bar{height:100%; width:0%; background:var(--accent); transition:width .2s}
  .empty{border:2px dashed var(--line); border-radius:12px; padding:18px; text-align:center; opacity:.8}
</style>
</head>
<body>
<header>
  <h1>Fantasiagenesis — Garden</h1>
  <div class="row muted small">Published narrative seeds (click to open public box pages).</div>
  <div class="toolbar">
    <label class="input" title="Search domain, dimension, provider, problem/objective/solution">
      <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5 1.5-1.5zM4 9.5C4 6.46 6.46 4 9.5 4S15 6.46 15 9.5 12.54 15 9.5 15 4 12.54 4 9.5"/></svg>
      <input id="q" placeholder="Filter…" />
    </label>
    <button id="refresh" class="btn">Refresh</button>
    <span class="sep"></span>
    <span class="pill"><span id="count">0</span> published</span>
    <span class="pill"><span id="scanned">0</span> scanned</span>
  </div>
  <div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>
</header>

<main>
  <div id="cards" class="grid" role="list"></div>
  <div id="empty" class="empty" hidden>No published seeds found. Try Refresh.</div>
  <div class="footer-note muted">Links open on <span class="mono">fantasiagenesis.com</span>. Data gathered from existing API endpoints without downloading HTML artifacts.</div>
</main>

<script>
(function(){
  const $q = document.getElementById('q');
  const $cards = document.getElementById('cards');
  const $count = document.getElementById('count');
  const $scanned = document.getElementById('scanned');
  const $bar = document.getElementById('bar');
  const $empty = document.getElementById('empty');
  const $refresh = document.getElementById('refresh');

  const ABS_BOX = (id) => `https://fantasiagenesis.com/boxes/${id}`;
  const API = {
    narratives: '/api/narratives',
    dims: (nid) => `/api/narratives/${nid}/dimensions`,
    seeds: (did) => `/api/dimensions/${did}/seeds`,
    seedBoxes: (sid) => `/api/seeds/${sid}/boxes`
  };

  let ALL = []; // flattened published seeds
  let SCANNED = 0;
  let TOTAL_EXPECTED = 0;

  function setProgress(n, d){
    const pct = d ? Math.min(100, Math.round(n*100/d)) : 0;
    $bar.style.width = pct + '%';
  }

  function card(seed){
    const a = document.createElement('a');
    a.className = 'card card-link';
    a.href = ABS_BOX(seed.id);
    a.target = '_blank';
    a.rel = 'noopener';
    a.setAttribute('role','listitem');
    a.innerHTML = `
      <div class="domain">
        <div class="row" style="justify-content:space-between;">
          <h3 class="title">${escapeHtml(seed.dimension)}</h3>
          <span class="chip mono">#${seed.id}</span>
        </div>
        <div class="dim small muted">Domain: <strong>${escapeHtml(seed.domain)}</strong> • Dimension: <strong>${escapeHtml(seed.dimension)}</strong></div>
      </div>
      <div class="kv">
        <div class="row"><div class="k">Problem</div><div class="v">${escapeHtml(seed.problem)}</div></div>
        <div class="row"><div class="k">Objective</div><div class="v">${escapeHtml(seed.objective)}</div></div>
        <div class="row"><div class="k">Solution</div><div class="v">${escapeHtml(seed.solution)}</div></div>
      </div>
      <div class="row small muted">
        <span class="chip">provider: ${escapeHtml(seed.provider||'')}</span>
        <span class="chip">created: ${escapeHtml(seed.created_at||'')}</span>
        <span class="chip">published: yes</span>
      </div>
    `;
    return a;
  }

  function render(list){
    $cards.innerHTML = '';
    if(!list.length){
      $empty.hidden = false;
      $count.textContent = '0';
      return;
    }
    $empty.hidden = true;
    const frag = document.createDocumentFragment();
    list.forEach(s => frag.appendChild(card(s)));
    $cards.appendChild(frag);
    $count.textContent = String(list.length);
  }

  function escapeHtml(s){
    return (s==null ? '' : String(s))
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;");
  }

  function filterNow(){
    const t = ($q.value||'').toLowerCase().trim();
    if(!t){ render(ALL); return; }
    const hits = ALL.filter(s=>{
      const hay = [
        s.domain, s.dimension, s.provider, s.problem, s.objective, s.solution, s.id
      ].map(x=>String(x||'').toLowerCase()).join(' ');
      return hay.includes(t);
    });
    render(hits);
  }

  $q.addEventListener('input', filterNow);
  $refresh.addEventListener('click', ()=>{ loadAll(true); });

  // Simple concurrency limiter
  function pLimit(concurrency){
    const q = [];
    let active = 0;
    const next = ()=>{
      if(active >= concurrency || q.length === 0) return;
      active++;
      const {fn, resolve, reject} = q.shift();
      Promise.resolve().then(fn).then((v)=>{ active--; resolve(v); next(); }).catch((e)=>{ active--; reject(e); next(); });
    };
    return (fn)=>new Promise((resolve,reject)=>{ q.push({fn,resolve,reject}); next(); });
  }

  async function fetchJSON(url){
    const r = await fetch(url, {headers:{'Accept':'application/json'}});
    if(!r.ok) throw new Error(`${url} -> ${r.status}`);
    return r.json();
  }

  async function loadAll(force=false){
    // Reset
    ALL = [];
    SCANNED = 0;
    setProgress(0, 1);
    $scanned.textContent = '0';
    render([]);

    try{
      const narratives = await fetchJSON(API.narratives);
      const dimLists = await Promise.all(narratives.map(n => fetchJSON(API.dims(n.id))));
      const dims = dimLists.flat();
      const seedLists = await Promise.all(dims.map(d => fetchJSON(API.seeds(d.id))));
      // Flatten seeds alongside their context (domain/dimension)
      const seedCtx = [];
      dims.forEach((d, i)=>{
        const seedsResp = seedLists[i];
        const seeds = (seedsResp.seeds || []);
        const narrative = narratives.find(n=>n.id===d.narrative_id);
        const domainTitle = narrative ? narrative.title : '';
        seeds.forEach(s=>{
          seedCtx.push({
            id: s.id,
            problem: s.problem,
            objective: s.objective,
            solution: s.solution,
            provider: s.provider,
            created_at: s.created_at,
            domain: domainTitle,
            dimension: d.title
          });
        });
      });

      TOTAL_EXPECTED = seedCtx.length;
      setProgress(0, TOTAL_EXPECTED);

      // Check which seeds have any published artifact without downloading HTML
      const limit = pLimit(10); // concurrency
      const checks = seedCtx.map(ctx => limit(async ()=>{
        try{
          const rows = await fetchJSON(API.seedBoxes(ctx.id)); // [{version,is_published,...}]
          const published = Array.isArray(rows) ? rows.some(r=>r.is_published===true || r.is_published===1) : false;
          SCANNED++;
          $scanned.textContent = String(SCANNED);
          setProgress(SCANNED, TOTAL_EXPECTED);
          if(published){ ALL.push(ctx); }
        }catch(e){
          // ignore errors for individual seeds
          SCANNED++;
          $scanned.textContent = String(SCANNED);
          setProgress(SCANNED, TOTAL_EXPECTED);
        }
      }));

      await Promise.all(checks);
      // Sort newest first (by created_at desc, fallback by id desc)
      ALL.sort((a,b)=>{
        const ta = Date.parse(a.created_at||'') || 0;
        const tb = Date.parse(b.created_at||'') || 0;
        if(tb!==ta) return tb-ta;
        return (b.id||0)-(a.id||0);
      });
      filterNow();
    }catch(err){
      console.error(err);
      $empty.hidden = false;
      $empty.textContent = 'Failed to load data. Check server logs and try again.';
    }
  }

  // Initial load
  loadAll();
})();
</script>
</body>
</html>
