<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fantasiagenesis · v4</title>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: Canvas; color: CanvasText;
    }
    header {
      padding: .75rem 1rem; border-bottom: 1px solid color-mix(in oklab, CanvasText 12%, transparent);
      display: flex; align-items: center; gap: .75rem; justify-content: space-between;
    }
    header h1 { font-size: 1rem; margin: 0; letter-spacing: .02em; font-weight: 650; }

    .app {
      display: grid; grid-template-columns: 340px 1fr; min-height: calc(100dvh - 56px);
    }
    /* Left rail has 3 stacked panels */
    .left-rail {
      border-right: 1px solid color-mix(in oklab, CanvasText 12%, transparent);
      padding: .75rem; display: grid; grid-template-rows: auto auto auto; gap: .75rem; min-height: 0;
      background: color-mix(in oklab, Canvas 96%, CanvasText 4%);
    }
    .panel {
      display: flex; flex-direction: column; min-height: 0; border: 1px solid color-mix(in oklab, CanvasText 14%, transparent); border-radius: .6rem;
      background: color-mix(in oklab, Canvas 92%, CanvasText 8%);
      box-shadow: 0 1px 0 rgba(0,0,0,.04) inset;
    }
    .panel header { border: 0; padding: .55rem .7rem; background: transparent; }
    .panel header h2 { font-size: .9rem; margin: 0; font-weight: 650; opacity: .9; }
    .panel .content { padding: .35rem .35rem .5rem; overflow: auto; min-height: 0; max-height: var(--panel-max-height, 30vh); }

    .list { list-style: none; margin: 0; padding: 0; display: grid; gap: .25rem; }
    .item {
      display: flex; align-items: center; gap: .5rem; padding: .5rem .6rem; border-radius: .5rem; cursor: pointer;
      border: 1px solid transparent;
    }
    .item:hover { background: color-mix(in oklab, CanvasText 8%, transparent); }
    .item.active { background: color-mix(in oklab, Highlight 22%, transparent); border-color: color-mix(in oklab, Highlight 30%, transparent); }
    .item .title { font-size: .92rem; font-weight: 560; }
    .item .sub { font-size: .75rem; opacity: .7; }

    /* Right side display */
    .display {
      min-width: 0; display: grid; grid-template-rows: auto 1fr; min-height: 0;
    }
    .breadcrumbs { padding: .75rem 1rem; border-bottom: 1px solid color-mix(in oklab, CanvasText 12%, transparent); font-size: .85rem; opacity: .8; }
    .viewer { padding: 1rem 1.25rem 2rem; overflow: auto; min-height: 0; }
    .viewer .seed-title { font-size: 1.1rem; font-weight: 650; margin: 0 0 .5rem; }
    .viewer .seed-body { white-space: pre-wrap; line-height: 1.5; font-size: .98rem; }

    .empty { opacity: .6; font-size: .95rem; padding: .5rem; }

    /* Small screens: collapse left rail height-wise */
    @media (max-width: 980px) {
      .app { grid-template-columns: 100%; }
      .left-rail { grid-template-rows: auto; grid-auto-rows: minmax(220px, auto); }
      .panel .content { max-height: min(42vh, 420px); }
    }
      .left-rail { grid-template-rows: auto; grid-auto-rows: minmax(240px, 1fr); }
    #boxHost iframe { width: 100%; height: 70vh; border: 1px solid color-mix(in oklab, CanvasText 14%, transparent);
                     border-radius: .6rem; background: Canvas; }
    .muted { opacity:.7; font-size:.9rem; }

    .email-panel {
      background: color-mix(in oklab, Highlight 92%, Canvas 8%);
      border-color: color-mix(in oklab, Highlight 40%, transparent);
    }
    .email-panel header h2 {
      color: HighlightText;
    }

    .proto-box{border:1px solid color-mix(in oklab, CanvasText 14%, transparent);border-radius:.6rem;padding:.75rem;background:color-mix(in oklab, Canvas 96%, CanvasText 4%);display:grid;gap:.5rem;max-height:300px;overflow:auto;}
    .cardgrid-2{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;}
    .cardgrid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.75rem;}
    .cardgrid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:.75rem;}
    @media (max-width:1100px){.cardgrid-4,.cardgrid-3,.cardgrid-2{grid-template-columns:1fr;}}
    .box-section{border:1px solid color-mix(in oklab, CanvasText 14%, transparent);border-radius:.6rem;background:color-mix(in oklab, Canvas 96%, CanvasText 4%);padding:.75rem;display:flex;flex-direction:column;gap:.25rem;}
    .box-section h3{margin:0 0 .35rem 0;font-size:.95rem;font-weight:650;}
    .box-scroll{flex:1;overflow:auto;max-height:260px;font-size:.9rem;line-height:1.35;}
    .box-kv{font-size:.85rem;opacity:.85;}
    .tabs{display:flex;align-items:center;gap:.35rem;margin:.25rem 0 .5rem;}
    .tab{padding:.45rem .7rem;border-radius:.5rem;border:1px solid color-mix(in oklab, CanvasText 18%, transparent);background:color-mix(in oklab, Canvas 94%, CanvasText 6%);cursor:pointer;font-size:.85rem;}
    .tab.active{background:color-mix(in oklab, Canvas 90%, CanvasText 10%);border-color:color-mix(in oklab, CanvasText 26%, transparent);box-shadow:0 1px 0 rgba(0,0,0,.06) inset;}
    .codeblock{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;font-size:.9rem;line-height:1.35;white-space:pre-wrap;word-wrap:break-word;border:1px solid color-mix(in oklab, CanvasText 14%, transparent);background:color-mix(in oklab, Canvas 98%, CanvasText 2%);border-radius:.5rem;padding:.75rem;max-height:55vh;overflow:auto;user-select:text;}


  </style>
</head>
<body>
  <header>
    <h1>Fantasiagenesis · v4</h1>
    <div style="font-size:.85rem; opacity:.7">imagination and reality, growing together</div>
    
  </header>

  <main class="app" id="app">
    <aside class="left-rail" aria-label="Navigation panels">
      <section class="panel email-panel" id="panel-email" aria-labelledby="h-email">
        <header><h2 id="h-email">Your Email</h2></header>
        <div class="content" style="display:grid; gap:.5rem;">
          <input id="emailInput" type="email" placeholder="you@example.com"
                 style="padding:.5rem .6rem; border:1px solid #ccc; border-radius:.5rem;" />
          <button id="saveEmailBtn"
                  style="padding:.45rem .7rem; border:1px solid rgba(0,0,0,.2);
                         border-radius:.5rem; cursor:pointer; background:#0b5cff; color:#fff;">
            Save Email
          </button>
          <div class="muted" style="font-size:.85rem;">Email is required to load your private narratives.</div>
          <span id="emailStatus" class="muted"></span>
        </div>
      </section>
      
      <section class="panel" id="panel-domains" aria-labelledby="h-domains">
        <header><h2 id="h-domains">Narrative Domains</h2></header>
        <div class="content">
          <ul class="list" id="domainsList"></ul>
          <div class="empty" id="domainsEmpty" hidden>Load or define narrative domains.</div>
        </div>
      </section>

      <section class="panel" id="panel-dimensions" aria-labelledby="h-dimensions">
        <header><h2 id="h-dimensions">Narrative Dimensions</h2></header>
        <div class="content">
          <ul class="list" id="dimensionsList"></ul>
          <div class="empty" id="dimensionsEmpty" hidden>Select a domain to load dimensions.</div>
        </div>
      </section>

      <section class="panel" id="panel-seeds" aria-labelledby="h-seeds">
        <header><h2 id="h-seeds">Narrative Seeds</h2></header>
        <div class="content">
          <ul class="list" id="seedsList"></ul>
          <div class="empty" id="seedsEmpty" hidden>Select a dimension to load seeds.</div>
        </div>
      </section>
    </aside>

    <section class="display" aria-label="Display">
      <div class="breadcrumbs" id="crumbs">Choose a seed to view its text.</div>
      <div class="toolbar" id="displayToolbar"
        style="padding:.5rem 1rem; border-bottom:1px solid color-mix(in oklab, CanvasText 12%, transparent);
                display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
      <button id="openInDirtBtn" type="button" disabled
              style="padding:.45rem .7rem; border:1px solid color-mix(in oklab, CanvasText 18%, transparent);
                    background:color-mix(in oklab, Canvas 92%, CanvasText 8%); border-radius:.5rem; cursor:pointer;">
        Open in Dirt
      </button>
      <button id="copyDirtLinkBtn" type="button" disabled
              style="padding:.45rem .7rem; border:1px solid color-mix(in oklab, CanvasText 18%, transparent);
                    background:color-mix(in oklab, Canvas 92%, CanvasText 8%); border-radius:.5rem; cursor:pointer;">
        Copy link
      </button>
      <span id="dirtLinkStatus" class="muted" role="status" aria-live="polite"></span>
    </div>

      <div class="viewer" id="viewer">
        <p class="empty" id="viewerEmpty">Nothing selected yet.</p>
        <article id="seedView" hidden>
          <h3 class="seed-title" id="seedTitle"></h3>
          <div class="seed-body" id="seedBody"></div>
          <!-- Read-only Dirt / Prototypes (mirrors dirt.html display) -->
<section id="protoDisplay" hidden style="margin-top:1rem; display:grid; gap:1rem;">

  <!-- Storyboard -->
  <section class="panel" aria-labelledby="h-proto">
    <header><h2 id="h-proto" style="margin:0">Storyboard</h2></header>
    <div class="content" style="padding: .6rem .75rem;">
      <div id="protoWrap" class="proto-box" hidden>
        <div><strong>Core Intent</strong><div id="protoCore" style="white-space:pre-wrap;"></div></div>
        <div><strong>Minimal Build</strong><div id="protoBuild" style="white-space:pre-wrap;"></div></div>
        <div><strong>Load-Bearing Test</strong><div id="protoTest" style="white-space:pre-wrap;"></div></div>
        <div><strong>First Eyes</strong><div id="protoEyes"></div></div>
        <div><strong>Why This is a Box of Dirt</strong><div id="protoWhy" style="white-space:pre-wrap;"></div></div>
      </div>
      <div id="protoEmpty" class="empty">No storyboard yet.</div>
    </div>
  </section>

  <!-- Artifacts -->
  <section class="panel" aria-labelledby="h-artifacts">
    <header><h2 id="h-artifacts" style="margin:0">Real & Box-of-Dirt Artifacts</h2></header>
    <div class="content" style="padding:.6rem .75rem;">
      <div class="cardgrid-2">
        <div class="box-section">
          <h3>Real Artifacts</h3>
          <div class="box-scroll" id="realArtifactsBox"></div>
        </div>
        <div class="box-section">
          <h3>Box of Dirt</h3>
          <div class="box-scroll" id="bodItemsBox"></div>
        </div>
      </div>
      <div class="box-section" style="margin-top:.6rem;">
        <h3>Safety & Guardrails</h3>
        <div class="box-scroll" id="guardrailsBox"></div>
      </div>
      <div class="box-section" style="margin-top:.6rem;">
        <h3 id="nextStepsTitle">Next steps (48–72 hours)</h3>
        <div class="box-scroll" id="nextStepsBox"></div>
      </div>
      <div id="artifactsEmpty" class="empty" hidden>No artifacts yet.</div>
    </div>
  </section>

  <!-- Validation -->
  <section class="panel" aria-labelledby="h-validate">
    <header><h2 id="h-validate" style="margin:0">Real-World Validation</h2></header>
    <div class="content" style="padding:.6rem .75rem;">
      <div id="valTabs" class="tabs" style="margin-bottom:.5rem;">
        <button class="tab val-tab active" type="button" data-k="problem">Problem</button>
        <button class="tab val-tab"         type="button" data-k="objective">Objective</button>
        <button class="tab val-tab"         type="button" data-k="solution">Solution</button>
        <span class="spacer"></span>
      </div>
      <div id="valText" class="codeblock" tabindex="0" style="max-height:300px;"></div>
      <div id="valEmpty" class="empty" hidden>No validation yet.</div>
    </div>
  </section>

  <!-- Stakeholders -->
  <section class="panel" aria-labelledby="h-stake">
    <header><h2 id="h-stake" style="margin:0">Stakeholder Mapping</h2></header>
    <div class="content" style="padding:.6rem .75rem;">
      <div id="stakePretty" class="cardgrid-4">
        <div class="box-section" id="stakePrimary"><h3>Primary</h3><div class="box-scroll"></div></div>
        <div class="box-section" id="stakeSecondary"><h3>Secondary</h3><div class="box-scroll"></div></div>
        <div class="box-section" id="stakeEndUsers"><h3>End Users / Beneficiaries</h3><div class="box-scroll"></div></div>
        <div class="box-section" id="stakeExternal"><h3>External / Contextual</h3><div class="box-scroll"></div></div>
      </div>
      <div id="stakeEmpty" class="empty" hidden>No stakeholder map yet.</div>
    </div>
  </section>

  <!-- 6 Senses -->
  <section class="panel" aria-labelledby="h-embodied">
    <header><h2 id="h-embodied" style="margin:0">6 Senses</h2></header>
    <div class="content" style="padding:.6rem .75rem;">
      <div id="embTabs" class="tabs" style="margin-bottom:.5rem;">
        <button class="tab emb-tab active" type="button" data-k="eyes">Sight</button>
        <button class="tab emb-tab"         type="button" data-k="ears">Sound</button>
        <button class="tab emb-tab"         type="button" data-k="hands">Touch</button>
        <button class="tab emb-tab"         type="button" data-k="nose">Smell</button>
        <button class="tab emb-tab"         type="button" data-k="mouth">Taste</button>
        <button class="tab emb-tab"         type="button" data-k="music">Music</button>
        <span class="spacer"></span>
      </div>
      <div id="embText" class="codeblock" tabindex="0" style="max-height:300px;"></div>
      <div id="embEmpty" class="empty" hidden>No embodied cues yet.</div>
    </div>
  </section>

  <!-- Playbook -->
  <section class="panel" aria-labelledby="h-archpb">
    <header><h2 id="h-archpb" style="margin:0">Playbook</h2></header>
    <div class="content" style="padding:.6rem .75rem;">
      <div id="archClass" class="box-kv" style="margin-bottom:.35rem;"></div>
      <div id="archPretty" class="cardgrid-3"></div>
      <div id="archNorth" class="box-section" style="margin-top:.6rem;">
        <h3>North Star</h3><div class="box-scroll" id="archNorthBody"></div>
      </div>
      <div id="archEmpty" class="empty" hidden>No playbook yet.</div>
    </div>
  </section>

  <!-- Risks -->
  <section class="panel" aria-labelledby="h-risks">
    <header><h2 id="h-risks" style="margin:0">Risks & Early-Warning Monitoring</h2></header>
    <div class="content" style="padding:.6rem .75rem;">
      <div class="cardgrid-2">
        <div class="box-section" id="riskFailures"><h3>Likely Failures & Countermeasures</h3><div class="box-scroll"></div></div>
      </div>
      <div id="risksEmpty" class="empty" hidden>No risks yet.</div>
    </div>
  </section>

</section>
         
        </article>
      </div>
    </section>
  </main>

  <script>
  (function(){
    const els = {
      domainsList: document.getElementById('domainsList'),
      domainsEmpty: document.getElementById('domainsEmpty'),
      dimensionsList: document.getElementById('dimensionsList'),
      dimensionsEmpty: document.getElementById('dimensionsEmpty'),
      seedsList: document.getElementById('seedsList'),
      seedsEmpty: document.getElementById('seedsEmpty'),
      crumbs: document.getElementById('crumbs'),
      viewerEmpty: document.getElementById('viewerEmpty'),
      seedView: document.getElementById('seedView'),
      seedTitle: document.getElementById('seedTitle'),
      seedBody: document.getElementById('seedBody'),
      boxSection: document.getElementById('boxSection'),
      boxError: document.getElementById('boxError'),
      boxHost: document.getElementById('boxHost'),
      expandBoxBtn: document.getElementById('expandBoxBtn'),
      shareRow: document.getElementById('shareRow'),
      shareLink: document.getElementById('shareLink'),
      copyShareBtn: document.getElementById('copyShareBtn'),
      shareStatus: document.getElementById('shareStatus'),
      emailInput: document.getElementById('emailInput'),
      saveEmailBtn: document.getElementById('saveEmailBtn'),
      emailStatus: document.getElementById('emailStatus'),
      openInDirtBtn: document.getElementById('openInDirtBtn'),
      copyDirtLinkBtn: document.getElementById('copyDirtLinkBtn'),
      dirtLinkStatus: document.getElementById('dirtLinkStatus'),

      

    };

    // Prototypes display els
    const protoDisplay = document.getElementById('protoDisplay');
    // Storyboard
    const protoWrap = document.getElementById('protoWrap');
    const protoCore = document.getElementById('protoCore');
    const protoBuild = document.getElementById('protoBuild');
    const protoTest = document.getElementById('protoTest');
    const protoEyes = document.getElementById('protoEyes');
    const protoWhy  = document.getElementById('protoWhy');
    const protoEmpty= document.getElementById('protoEmpty');
    // Artifacts
    const realArtifactsBox = document.getElementById('realArtifactsBox');
    const bodItemsBox = document.getElementById('bodItemsBox');
    const guardrailsBox = document.getElementById('guardrailsBox');
    const nextStepsTitle = document.getElementById('nextStepsTitle');
    const nextStepsBox = document.getElementById('nextStepsBox');
    const artifactsEmpty = document.getElementById('artifactsEmpty');
    // Validation
    const valTabs = document.getElementById('valTabs');
    const valText = document.getElementById('valText');
    const valEmpty = document.getElementById('valEmpty');
    // Stakeholders
    const stakePrimary = document.querySelector('#stakePrimary .box-scroll');
    const stakeSecondary = document.querySelector('#stakeSecondary .box-scroll');
    const stakeEndUsers = document.querySelector('#stakeEndUsers .box-scroll');
    const stakeExternal = document.querySelector('#stakeExternal .box-scroll');
    const stakeEmpty = document.getElementById('stakeEmpty');
    // Embodied
    const embTabs = document.getElementById('embTabs');
    const embText = document.getElementById('embText');
    const embEmpty = document.getElementById('embEmpty');
    // Playbook / Archetype
    const archClass = document.getElementById('archClass');
    const archPretty = document.getElementById('archPretty');
    const archNorthBody = document.getElementById('archNorthBody');
    const archEmpty = document.getElementById('archEmpty');
    // Risks
    const riskFailures = document.querySelector('#riskFailures .box-scroll');
    const risksEmpty = document.getElementById('risksEmpty');


    // === API endpoints wired to provided Flask app ===
    const API = {
      listNarratives: '/api/narratives',
      listDimensions: (narrativeId) => `/api/narratives/${encodeURIComponent(narrativeId)}/dimensions`,
      listSeeds: (dimensionId) => `/api/dimensions/${encodeURIComponent(dimensionId)}/seeds`,
      getSeedBox: (seedId) => `/api/seeds/${encodeURIComponent(seedId)}/box`,
    };

    const EMAIL_KEY = 'fg_user_email';

    function saveEmailToStorage(email) {
      const v = String(email || '').trim().toLowerCase();
      if (v) localStorage.setItem(EMAIL_KEY, v);
      else localStorage.removeItem(EMAIL_KEY);
    }

    function readEmailFromStorage() {
      return (localStorage.getItem(EMAIL_KEY) || '').trim().toLowerCase();
    }

    function currentEmail() {
      const typed = (document.getElementById('emailInput')?.value || '').trim().toLowerCase();
      return typed || readEmailFromStorage();
    }

    // Append ?email=... when present
    function withEmail(url) {
      const em = currentEmail();
      if (!em) return url;
      return url + (url.includes('?') ? '&' : '?') + 'email=' + encodeURIComponent(em);
    }


    // Simple cache
    let lastBoxRequestSeedId = null;        // race guard
    const boxCache = new Map();             // you already declared one; keep it here

    // Clear & render helpers
    function clearBox(){ els.boxError.textContent = ''; els.boxHost.replaceChildren(); els.boxSection.hidden = true; }

    // Escape helpers
    function escapeHTML(s) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
      };
      return String(s || '').replace(/[&<>"']/g, c => map[c] || c);
    }

    function escapeAttr(s){ return String(s||'').replace(/"/g, '&quot;'); }


    async function fetchJSON(url){
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    // Helpers
    const keyOf = (o) => o?.id ?? o?.slug ?? o?.name ?? o?.title ?? String(o);
    const label = {
      domain: (d) => d?.title ?? `Narrative ${d?.id ?? ''}`,
      dimension: (x) => x?.title ?? `Dimension ${x?.id ?? ''}`,
      seedTitle: (s) => (s?.problem ? s.problem : `Seed ${s?.id ?? ''}`).slice(0, 100),
    };

    let state = { domain: null, dimension: null, seed: null };

    function setBreadcrumbs(){
      const parts = [];
      if (state.domain) parts.push(label.domain(state.domain));
      if (state.dimension) parts.push(label.dimension(state.dimension));
      if (state.seed) parts.push('Seed');
      els.crumbs.textContent = parts.length ? parts.join(' / ') : 'Choose a seed to view its text.';
    }

    function clearList(ul){ while (ul.firstChild) ul.removeChild(ul.firstChild); }
    function showEmpty(el, show){ el.hidden = !show; }

    function renderList(ul, items, getText, onClick, activeKey){
      clearList(ul);
      items.forEach(it => {
        const li = document.createElement('li');
        li.className = 'item' + (activeKey && keyOf(it) === activeKey ? ' active' : '');
        li.tabIndex = 0;
        li.dataset.key = keyOf(it);
        li.innerHTML = `<div class="title">${getText(it)}</div>` + (it?.description ? `<div class="sub">${it.description}</div>` : '');
        li.addEventListener('click', () => onClick(it, li));
        li.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onClick(it, li); }});
        ul.appendChild(li);
      });
    }

    function setActive(ul, li){
      Array.from(ul.children).forEach(ch => ch.classList.remove('active'));
      if (li) li.classList.add('active');
    }

    function joinAB(s){
      const A = s.problem || s.A || s.a || s.Problem;
      const B = s.objective || s.B || s.b || s.Objective;
      const L = s.solution || s.Solution || s.link || s.Link;
      if (!(A || B || L)) return '';
      return [
        A ? `A (Problem): ${A}` : '',
        B ? `B (Objective): ${B}` : '',
        L ? `Solution (Link): ${L}` : ''
      ].filter(Boolean).join('\n\n');
    }

    function showSeed(seed){
      state.seed = seed || null;
      setBreadcrumbs(); updateDirtButtons();

      if (!seed){
        els.seedView.hidden = true; els.viewerEmpty.hidden = false;
        document.getElementById('protoDisplay').hidden = true;
        return;
      }
      els.viewerEmpty.hidden = true; els.seedView.hidden = false;
      els.seedTitle.textContent = label.seedTitle(seed);
      els.seedBody.textContent = joinAB(seed) || JSON.stringify(seed, null, 2);

      // NEW: show prototypes area and load latest saved outputs
      document.getElementById('protoDisplay').hidden = false;
      loadSavedDirtForSeed(seed.id);
    }


    // Loaders aligned to Flask API
    async function loadDomains(){
      try {
        const data = await fetchJSON(withEmail(API.listNarratives));
        const domains = Array.isArray(data) ? data : [];
        showEmpty(els.domainsEmpty, domains.length === 0);
        renderList(els.domainsList, domains, label.domain, onSelectDomain, state.domain && keyOf(state.domain));
      } catch (e){
        showEmpty(els.domainsEmpty, true);
        els.domainsEmpty.textContent = 'Failed to load narratives: ' + e.message;
      }
    }

    async function maybeDeepLink(){
      const params = new URLSearchParams(location.search);
      let nid = params.get('nid');
      let did = params.get('did');
      let sid = params.get('sid');

      if (!nid && !did && !sid) return;

      // 1) Load domain (narrative)
      let narratives = [];
      try {
        narratives = await fetchJSON(withEmail(API.listNarratives));
      } catch {}
      let domain = null;

      if (nid) {
        domain = narratives.find(n => String(n.id) === String(nid)) || null;
      } else if (did || sid) {
        // if only did/sid provided, try to discover nid by scanning dims
        for (const n of narratives) {
          try {
            const dims = await fetchJSON(withEmail(API.listDimensions(n.id)));
            if (did && dims.some(d => String(d.id) === String(did))) { domain = n; nid = n.id; break; }
            if (sid) {
              for (const d of dims) {
                const payload = await fetchJSON(withEmail(API.listSeeds(d.id)));
                const seeds = Array.isArray(payload?.seeds) ? payload.seeds : [];
                if (seeds.some(s => String(s.id) === String(sid))) { domain = n; nid = n.id; did = d.id; break; }
              }
              if (domain) break;
            }
          } catch {}
        }
      }

      if (!domain) return;

      // Select domain in UI (don’t pass a <li>)
      await onSelectDomain(domain, null);

      // 2) Load/select dimension
      let dimension = null;
      if (did) {
        try {
          const dims = await fetchJSON(withEmail(API.listDimensions(domain.id)));
          dimension = dims.find(d => String(d.id) === String(did)) || null;
        } catch {}
      }
      if (!dimension && sid) {
        try {
          const dims = await fetchJSON(withEmail(API.listDimensions(domain.id)));
          for (const d of dims) {
            const payload = await fetchJSON(withEmail(API.listSeeds(d.id)));
            const seeds = Array.isArray(payload?.seeds) ? payload.seeds : [];
            if (seeds.some(s => String(s.id) === String(sid))) { dimension = d; did = d.id; break; }
          }
        } catch {}
      }
      if (!dimension) return;
      await onSelectDimension(dimension, null);

      // 3) Load/select seed
      if (sid) {
        try {
          const payload = await fetchJSON(withEmail(API.listSeeds(dimension.id)));
          const seeds = Array.isArray(payload?.seeds) ? payload.seeds : [];
          const seed = seeds.find(s => String(s.id) === String(sid));
          if (seed) onSelectSeed(seed, null);
        } catch {}
      }
    }


    async function ensureEmailThenLoad() {
      // Prefill from storage if empty
      const stored = readEmailFromStorage();
      if (els.emailInput && !els.emailInput.value && stored) {
        els.emailInput.value = stored;
        els.emailStatus.textContent = 'Loaded saved email';
        setTimeout(()=> els.emailStatus.textContent = '', 1200);
      }

      const em = currentEmail();
      if (!em) {
        // Empty the lists and prompt
        els.crumbs.textContent = 'Enter your email to load your private narratives.';
        [els.domainsList, els.dimensionsList, els.seedsList].forEach(ul => ul.replaceChildren());
        els.domainsEmpty.hidden = false; els.domainsEmpty.textContent = 'Email required.';
        els.dimensionsEmpty.hidden = false; els.dimensionsEmpty.textContent = 'Email required.';
        els.seedsEmpty.hidden = false; els.seedsEmpty.textContent = 'Email required.';
        return;
      }

      // Email present: load
      await loadDomains();
      await maybeDeepLink(); // optional; see “5)” below if you add deep links
    }

    async function onSelectDomain(domain, li){
      state.domain = domain; state.dimension = null; state.seed = null; setBreadcrumbs(); updateDirtButtons();
      setActive(els.domainsList, li);
      clearList(els.dimensionsList); clearList(els.seedsList);
      showEmpty(els.dimensionsEmpty, true); showEmpty(els.seedsEmpty, true);
      showSeed(null);
      try {
        const dims = await fetchJSON(withEmail(API.listDimensions(domain.id)));
        showEmpty(els.dimensionsEmpty, dims.length === 0);
        renderList(els.dimensionsList, dims, label.dimension, onSelectDimension, state.dimension && keyOf(state.dimension));
      } catch (e){
        showEmpty(els.dimensionsEmpty, true);
        els.dimensionsEmpty.textContent = 'Failed to load dimensions: ' + e.message;
      }
    }

    async function onSelectDimension(dimension, li){
      state.dimension = dimension; state.seed = null; setBreadcrumbs(); updateDirtButtons();
      setActive(els.dimensionsList, li);
      clearList(els.seedsList);
      showEmpty(els.seedsEmpty, true);
      showSeed(null);
      try {
        const payload = await fetchJSON(withEmail(API.listSeeds(dimension.id)));
        const seeds = Array.isArray(payload?.seeds) ? payload.seeds : [];
        showEmpty(els.seedsEmpty, seeds.length === 0);
        renderList(els.seedsList, seeds, (s)=>label.seedTitle(s), onSelectSeed, state.seed && keyOf(state.seed));
      } catch (e){
        showEmpty(els.seedsEmpty, true);
        els.seedsEmpty.textContent = 'Failed to load seeds: ' + e.message;
      }
    }

    function onSelectSeed(seed, li){
      state.seed = seed; setBreadcrumbs(); setActive(els.seedsList, li); showSeed(seed); updateDirtButtons();
    }

    async function fetchSeedBox(seedId){
  const res = await fetch(API.getSeedBox(seedId), { headers: { 'Accept': 'application/json' }});
  if (res.status === 404) return null;
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

async function loadBoxForSeed(seedId){
  if (!seedId) { 
    els.boxError.textContent = ''; 
    els.boxHost.replaceChildren(); 
    els.boxSection.hidden = true; 
    return; 
  }

  lastBoxRequestSeedId = seedId;
  els.boxSection.hidden = false;
  els.boxError.textContent = 'Loading…';
  els.boxHost.replaceChildren();

  try {
    const cached = boxCache.get(seedId);
    const data = cached || await fetchSeedBox(seedId);
    if (lastBoxRequestSeedId !== seedId) return; // user switched seeds

    if (!data) {
      els.boxError.textContent = 'No published box found for this seed.';
      return;
    }
    boxCache.set(seedId, data);
    els.boxError.textContent = `Version ${data.version ?? ''} • Updated ${data.updated_at ?? ''}`;
    renderBoxHTML(data);
  } catch (e) {
    if (lastBoxRequestSeedId !== seedId) return;
    els.boxError.textContent = 'Error loading box: ' + e.message;
  }
}

function getShareUrlForSeed(seedId){
  // Assumes a viewer route like /boxes/<seedId>
  // Prefer absolute URL for copying.
  try {
    const base = `${location.origin}/boxes/${encodeURIComponent(seedId)}`;
    return base;
  } catch {
    return `/boxes/${encodeURIComponent(seedId)}`;
  }
}

function setShareUiForSeed(seed){
  // Hide if no seed yet
  if (!seed) {
    els.shareRow.hidden = true;
    els.shareLink.value = '';
    els.shareStatus.textContent = '';
    return;
  }
  const url = getShareUrlForSeed(seed.id);
  els.shareLink.value = url;
  els.shareStatus.textContent = '';
}

function buildDirtUrl(includeEmail = true){
  if (!(state.domain && state.dimension && state.seed)) return '';
  const q = new URLSearchParams({
    nid: String(state.domain.id),
    did: String(state.dimension.id),
    sid: String(state.seed.id),
  }).toString();
  let url = `/dirt.html?${q}`;
  if (includeEmail) url = withEmail(url);   // preserves ?email=... if present
  return url;
}

function updateDirtButtons(){
  const has = !!(state.domain && state.dimension && state.seed);
  if (els.openInDirtBtn) els.openInDirtBtn.disabled = !has;
  if (els.copyDirtLinkBtn) els.copyDirtLinkBtn.disabled = !has;
  if (!has && els.dirtLinkStatus) els.dirtLinkStatus.textContent = '';
}



function renderBoxHTML(payload){
  const html = (payload && payload.html) ? String(payload.html) : '';
  els.boxSection.hidden = false;

  if (!html) {
    els.boxError.textContent = 'No published box found for this seed.';
    els.boxHost.replaceChildren();
    return;
  }

  els.boxHost.replaceChildren();
  const looksFull = /<html[^>]*>/i.test(html) || /<!DOCTYPE/i.test(html);

  if (looksFull) {
    const iframe = document.createElement('iframe');
    iframe.title = 'Box of Dirt';
    iframe.loading = 'lazy';
    iframe.setAttribute('sandbox', 'allow-scripts'); // drop allow-same-origin unless needed
    iframe.style.width = '100%';
    iframe.style.height = '70vh';
    iframe.style.border = '1px solid color-mix(in oklab, CanvasText 14%, transparent)';
    iframe.style.borderRadius = '.6rem';
    iframe.srcdoc = html;
    els.boxHost.appendChild(iframe);
  } else {
    const container = document.createElement('div');
    container.innerHTML = html; // trusted authoring
    els.boxHost.appendChild(container);
  }
}

// ---- STORYBOARD ----
function renderPrototypeEnvelope(payload){
  const p = payload?.prototype ?? payload;
  if (!p){ protoWrap.hidden = true; protoEmpty.hidden = false; return; }
  protoCore.textContent  = p.core_intent || '';
  protoBuild.textContent = p.minimal_build || '';
  protoTest.textContent  = p.load_bearing_test || '';
  if (Array.isArray(p.first_eyes) && p.first_eyes.length){
    protoEyes.innerHTML = `<ul style="margin:.25rem 0 0 1rem; padding:0;">${
      p.first_eyes.map(x => `<li>${escapeHTML(String(x))}</li>`).join('')
    }</ul>`;
  } else { protoEyes.textContent = ''; }
  protoWhy.textContent = p.why_box_of_dirt || '';
  protoEmpty.hidden = true; protoWrap.hidden = false;
}

// ---- ARTIFACTS ----
function renderArtifactsBundle(bundle){
  if (!bundle){ artifactsEmpty.hidden = false; return; }
  // Real artifacts
  realArtifactsBox.innerHTML = (Array.isArray(bundle.real_artifacts) && bundle.real_artifacts.length)
    ? bundle.real_artifacts.map(a=>{
        const t = `<div style="font-weight:650;">${escapeHTML(a.title||'')}</div>`;
        const o = a.owner ? `<div class="box-kv"><strong>Owner:</strong> ${escapeHTML(a.owner)}</div>` : '';
        const d = a.description ? `<div>${escapeHTML(a.description)}</div>` : '';
        const n = a.notes ? `<div class="muted">${escapeHTML(a.notes)}</div>` : '';
        return `<div style="margin:.6rem 0;">${t}${o}${d}${n}</div>`;
      }).join('')
    : '<div class="muted">—</div>';

  // Box of Dirt items
  bodItemsBox.innerHTML = (Array.isArray(bundle.box_of_dirt) && bundle.box_of_dirt.length)
    ? bundle.box_of_dirt.map(b=>{
        const t = `<div style="font-weight:650;">${escapeHTML(b.title||'')}</div>`;
        const o = b.owner ? `<div class="box-kv"><strong>Owner:</strong> ${escapeHTML(b.owner)}</div>` : '';
        const bullets = Array.isArray(b.bullets) && b.bullets.length
          ? `<ul>${b.bullets.map(x=>`<li>${escapeHTML(String(x))}</li>`).join('')}</ul>` : '';
        return `<div style="margin:.6rem 0;">${t}${o}${bullets}</div>`;
      }).join('')
    : '<div class="muted">—</div>';

  // Guardrails
  guardrailsBox.innerHTML = bundle.safety_guardrails
    ? `<pre class="codeblock" tabindex="0" style="max-height:220px;">${escapeHTML(bundle.safety_guardrails)}</pre>`
    : '<div class="muted">—</div>';

  // Next steps
  nextStepsTitle.textContent = bundle.next_steps_title || 'Next steps (48–72 hours)';
  const steps = Array.isArray(bundle.next_steps) ? bundle.next_steps : [];
  nextStepsBox.innerHTML = steps.length
    ? `<ol style="margin:.2rem 0 0 1rem;">${steps.map(x=>`<li>${escapeHTML(String(x))}</li>`).join('')}</ol>`
    : '<div class="muted">—</div>';

  artifactsEmpty.hidden = true;
}

// ---- VALIDATION ----
let _validationData = { problem:[], objective:[], solution:[] };

function buildValidationHTML(items){
  if (!Array.isArray(items) || items.length === 0) return `<div class="muted">No entries</div>`;
  return items.map(item=>{
    const metric = escapeHTML(item?.metric || '');
    const desc   = item?.description ? `<div class="muted">${escapeHTML(item.description)}</div>` : '';
    const ds = Array.isArray(item?.datasets) ? item.datasets : [];
    const dsHTML = ds.map(d=>{
      const name = escapeHTML(d?.name||''); const org = escapeHTML(d?.organization||'');
      const notes = d?.notes ? ` — <span class="muted">${escapeHTML(d.notes)}</span>` : '';
      const url = d?.url ? ` — <a href="${escapeAttr(d.url)}" target="_blank" rel="noopener">${escapeHTML(d.url)}</a>` : '';
      return `<li><strong>${name}</strong> <span class="muted">(${org})</span>${notes}${url}</li>`;
    }).join('');
    return `<div class="metric" style="margin:.55rem 0; word-break:break-word;">
      <div style="font-weight:650;">${metric}</div>${desc}${dsHTML?`<ul style="margin:.35rem 0 0 1rem; padding:0;">${dsHTML}</ul>`:''}
    </div>`;
  }).join('');
}
function setActiveValTab(key){
  document.querySelectorAll('#valTabs .val-tab').forEach(btn=>btn.classList.toggle('active', btn.dataset.k===key));
  valText.innerHTML = buildValidationHTML(_validationData[key] || []);
}
function renderValidationPretty(payload){
  const v = (payload && payload.validation) || {};
  _validationData = {
    problem:   Array.isArray(v.problem_validation)     ? v.problem_validation     : [],
    objective: Array.isArray(v.objective_measurement)  ? v.objective_measurement  : [],
    solution:  Array.isArray(v.solution_justification) ? v.solution_justification : [],
  };
  const hasAny = _validationData.problem.length || _validationData.objective.length || _validationData.solution.length;
  valEmpty.hidden = !!hasAny;
  setActiveValTab(document.querySelector('#valTabs .val-tab.active')?.dataset.k || 'problem');
}

// ---- STAKEHOLDERS ----
function paintStakeBox(el, arr){
  if (!el) return;
  if (!Array.isArray(arr) || !arr.length){ el.innerHTML = '<div class="muted">No entries</div>'; return; }
  el.innerHTML = arr.map(x=>{
    const name = escapeHTML(x.name||'');
    const cat  = x.category ? ` <span class="muted">(${escapeHTML(x.category)})</span>` : '';
    const role = x.role ? `<div class="box-kv"><strong>Role:</strong> ${escapeHTML(x.role)}</div>` : '';
    const why  = x.why ? `<div>${escapeHTML(x.why)}</div>` : '';
    return `<div style="margin:.5rem 0;"><div style="font-weight:650;">${name}${cat}</div>${role}${why}</div>`;
  }).join('');
}
function renderStakeholders(payload){
  const v = payload?.stakeholders || payload?.map || payload || {};
  const has = (a)=>Array.isArray(a) && a.length>0;
  const any = has(v.primary)||has(v.secondary)||has(v.end_users_beneficiaries)||has(v.external_contextual);
  stakeEmpty.hidden = !!any;
  paintStakeBox(stakePrimary,   v.primary||[]);
  paintStakeBox(stakeSecondary, v.secondary||[]);
  paintStakeBox(stakeEndUsers,  v.end_users_beneficiaries||[]);
  paintStakeBox(stakeExternal,  v.external_contextual||[]);
}

// ---- 6 SENSES ----
let _embData = { eyes:[], ears:[], hands:[], nose:[], mouth:[], music:[] };
function buildEmbHTML(items){
  if (!Array.isArray(items) || !items.length) return `<div class="muted">No entries</div>`;
  return items.map(x=>{
    const cue = escapeHTML(x?.cue || '');
    const why = x?.why ? `<div class="muted">${escapeHTML(x.why)}</div>` : '';
    return `<div style="margin:.5rem 0;"><div style="font-weight:650;">${cue}</div>${why}</div>`;
  }).join('');
}
function setActiveEmbTab(key){
  document.querySelectorAll('#embTabs .emb-tab').forEach(btn=>btn.classList.toggle('active', btn.dataset.k===key));
  embText.innerHTML = buildEmbHTML(_embData[key] || []);
}
function renderEmbodied(payload){
  const v = payload?.embodied || payload?.map || payload || {};
  _embData = {
    eyes:Array.isArray(v.eyes)?v.eyes:[], ears:Array.isArray(v.ears)?v.ears:[],
    hands:Array.isArray(v.hands)?v.hands:[], nose:Array.isArray(v.nose)?v.nose:[],
    mouth:Array.isArray(v.mouth)?v.mouth:[], music:Array.isArray(v.music)?v.music:[]
  };
  const any = Object.values(_embData).some(arr=>Array.isArray(arr)&&arr.length);
  embEmpty.hidden = !!any;
  setActiveEmbTab(document.querySelector('#embTabs .emb-tab.active')?.dataset.k || 'eyes');
}

// ---- PLAYBOOK / ARCHETYPE ----
function renderRoadmap(payload){
  const v = payload?.playbook || payload?.roadmap || payload;
  const phases = Array.isArray(v?.phases) ? v.phases : [];
  archPretty.innerHTML = phases.length ? phases.map(p=>{
    const name = escapeHTML(p.name||'');
    const hz = p.horizon ? `<div class="box-kv"><strong>Horizon:</strong> ${escapeHTML(p.horizon)}</div>` : '';
    const mk = (label, arr) => (Array.isArray(arr)&&arr.length)?`<div><strong>${label}:</strong><ul>${arr.map(x=>`<li>${escapeHTML(String(x))}</li>`).join('')}</ul></div>`:'';
    return `<div class="box-section"><h3>${name}</h3>${hz}
      <div class="box-scroll">
        ${p.goal?`<div><strong>Goal:</strong> ${escapeHTML(p.goal)}</div>`:''}
        ${mk('Milestones', p.milestones)}${mk('Outputs', p.outputs)}${mk('Indicators', p.indicators)}${mk('Decision Gates', p.decision_gates)}
      </div>
    </div>`;
  }).join('') : '<div class="muted">No phases</div>';
}
function renderArchetype(payload){
  const v = payload?.archetype_playbook ?? payload?.playbook ?? payload ?? {};
  // classification
  archClass.innerHTML = v.classification
    ? `<strong>Archetype:</strong> ${escapeHTML(v.classification.archetype||'')} — <span class="muted">${escapeHTML(v.classification.why||'')}</span>`
    : '';
  // phases + north star
  renderRoadmap(v);
  archNorthBody.innerHTML = v?.north_star ? escapeHTML(v.north_star) : '<div class="muted">—</div>';
  const phases = Array.isArray(v?.phases)?v.phases:[];
  archEmpty.hidden = !!(v.classification || v.north_star || phases.length);
}

// ---- RISKS ----
function renderRisks(payload){
  const v = payload?.assessment || payload?.risks || payload || {};
  const failures = Array.isArray(v.failures) ? v.failures : [];
  risksEmpty.hidden = failures.length>0;
  riskFailures.innerHTML = failures.length ? failures.map(f=>{
    const name = `<div style="font-weight:650;">${escapeHTML(f.name||'')}</div>`;
    const mk = (label, arr)=> (Array.isArray(arr)&&arr.length)?`<div><strong>${label}:</strong><ul>${arr.map(x=>`<li>${escapeHTML(String(x))}</li>`).join('')}</ul></div>`:'';
    const impact = f.impact ? `<div><strong>Impact:</strong> ${escapeHTML(f.impact)}</div>` : '';
    const counters = mk('Countermeasures', f.countermeasures);
    const symptoms = mk('Symptoms', f.symptoms);
    const m = f.monitoring || {};
    const metrics = Array.isArray(m.metrics)?m.metrics:[]; const actions = Array.isArray(m.triggered_actions)?m.triggered_actions:[];
    const metricsHTML = metrics.length ? `<div style="margin-top:.4rem;"><strong>Metrics:</strong><ul>${
      metrics.map(x=>{
        const line = `<strong>${escapeHTML(x.metric||'')}</strong>`;
        const why  = x.rationale ? ` — <span class="muted">${escapeHTML(x.rationale)}</span>` : '';
        const thr  = (x.yellow||x.red)?`<div class="box-kv">Thresholds: yellow=${escapeHTML(String(x.yellow||''))}, red=${escapeHTML(String(x.red||''))}</div>`:'';
        return `<li>${line}${why}${thr}</li>`;
      }).join('')
    }</ul></div>` : '';
    const actionsHTML = actions.length ? `<div style="margin-top:.3rem;"><strong>Triggered Actions:</strong><ul>${
      actions.map(a=>{
        const t = `<strong>${escapeHTML(a.action||'')}</strong>`;
        const owner = a.owner ? ` — <span class="muted">owner: ${escapeHTML(a.owner)}</span>` : '';
        const notes = a.notes ? `<div class="box-kv">${escapeHTML(a.notes)}</div>` : '';
        return `<li>${t}${owner}${notes}</li>`;
      }).join('')
    }</ul></div>` : '';
    return `<div style="margin:.6rem 0;">${name}${impact}${symptoms}${counters}${metricsHTML}${actionsHTML}</div>`;
  }).join('') : '<div class="muted">No failures</div>';
}

async function loadSavedDirtForSeed(sid){
  if (!sid){ protoDisplay.hidden = true; return; }

  // fetch recent history for this seed
  let rows = [];
  try{
    const res = await fetch(withEmail(`/api/dirt?sid=${encodeURIComponent(sid)}&limit=100`), {
      headers:{'Accept':'application/json'}
    });
    rows = await res.json();
    if (!Array.isArray(rows)) rows = [];
  }catch(_e){ rows = []; }

  // newest per kind
  const latest = new Map();
  for (const r of rows){
    const k = String(r.kind || '').toLowerCase();
    if (!k) continue;
    if (!latest.has(k)) latest.set(k, r); // rows newest-first
  }

  // Storyboard
  const sb = latest.get('storyboard') || latest.get('prototype');
  if (sb?.output){ renderPrototypeEnvelope(sb.output); } else { protoWrap.hidden = true; protoEmpty.hidden = false; }

  // Artifacts
  const ar = latest.get('artifacts');
  if (ar?.output){
    const bundle = ar.output?.artifacts ?? ar.output;
    renderArtifactsBundle(bundle);
  } else { artifactsEmpty.hidden = false; }

  // Validation
  const vv = latest.get('validation');
  if (vv?.output){ renderValidationPretty(vv.output); } else { valEmpty.hidden = false; }

  // Stakeholders
  const st = latest.get('stakeholders');
  if (st?.output){ renderStakeholders(st.output?.map ?? st.output?.stakeholders ?? st.output); } else { stakeEmpty.hidden = false; }

  // Embodied
  const em = latest.get('embodied');
  if (em?.output){ renderEmbodied(em.output?.map ?? em.output?.embodied ?? em.output); } else { embEmpty.hidden = false; }

  // Playbook (generic) and Archetype (if you saved that key)
  const pb = latest.get('playbook');
  if (pb?.output){ renderRoadmap(pb.output?.playbook ?? pb.output?.roadmap ?? pb.output); } else { /* allow empty */ }

  const ap = latest.get('archetype');
  if (ap?.output){ renderArchetype(ap.output?.archetype_playbook ?? ap.output?.playbook ?? ap.output); }

  // Risks
  const rk = latest.get('risks');
  if (rk?.output){ renderRisks(rk.output?.assessment ?? rk.output?.risks ?? rk.output); } else { risksEmpty.hidden = false; }
}


// Save button
els.saveEmailBtn?.addEventListener('click', async () => {
  const em = (els.emailInput?.value || '').trim().toLowerCase();
  if (!em) { els.emailStatus.textContent = 'Please enter an email.'; return; }
  saveEmailToStorage(em);
  const old = els.saveEmailBtn.textContent;
  els.saveEmailBtn.textContent = 'Saved';
  els.emailStatus.textContent = 'Saved locally';
  setTimeout(() => { els.saveEmailBtn.textContent = old; els.emailStatus.textContent = ''; }, 1200);
  await ensureEmailThenLoad();
});

valTabs?.addEventListener('click', (e)=>{
  const btn = e.target.closest('.val-tab'); if (!btn) return;
  setActiveValTab(btn.dataset.k);
});
embTabs?.addEventListener('click', (e)=>{
  const btn = e.target.closest('.emb-tab'); if (!btn) return;
  setActiveEmbTab(btn.dataset.k);
});


els.openInDirtBtn?.addEventListener('click', () => {
  const url = buildDirtUrl(true);
  if (url) window.open(url, '_blank', 'noopener');
});

els.copyDirtLinkBtn?.addEventListener('click', async () => {
  const url = buildDirtUrl(true);
  if (!url) return;
  try {
    await navigator.clipboard.writeText(new URL(url, location.origin).toString());
    els.dirtLinkStatus.textContent = 'Copied!';
  } catch (e){
    els.dirtLinkStatus.textContent = 'Copy failed';
  }
  setTimeout(()=> { if (els.dirtLinkStatus) els.dirtLinkStatus.textContent = ''; }, 1500);
});




    // Boot
    ensureEmailThenLoad();
    
  })();
  </script>
</body>
</html>
