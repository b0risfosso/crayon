<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Fantasiagenesis â€” Entry</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root { --bg:#f5f5f5; --card:#fff; --accent:#4aa3ff; }
    html,body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);}  
    header{display:flex;align-items:center;gap:14px;padding:12px 20px;background:#222;color:#eee;font-size:14px}
    header a{color:#9fd3ff;text-decoration:none;}
    main{max-width:900px;margin:0 auto;padding:32px 20px 80px;}

    /* banner */
    .banner details{background:var(--card);border:1px solid #ccc;border-radius:10px;margin-bottom:14px;box-shadow:0 2px 5px rgba(0,0,0,.05);overflow:hidden;}
    .banner summary{cursor:pointer;padding:14px 18px;font-weight:600;display:flex;align-items:center;gap:8px;list-style:none;}
    .banner summary::-webkit-details-marker{display:none;}
    .banner details[open]{border-color:var(--accent);}  
    .banner .content{padding:0 18px 18px;font-size:14px;line-height:1.4;white-space:pre-wrap;}

    /* forms */
    form.box{background:var(--card);border:1px solid #ccc;border-radius:10px;padding:20px;margin-bottom:36px;box-shadow:0 2px 6px rgba(0,0,0,.05);} 
    textarea{width:100%;min-height:110px;font-family:inherit;font-size:14px;padding:10px;border:1px solid #bbb;border-radius:6px;resize:vertical;}
    button, select{margin-top:12px;padding:8px 18px;font-size:14px;border:none;border-radius:6px;background:var(--accent);color:#fff;cursor:pointer;}
    select{background:#fff;color:#000;border:1px solid #bbb;}

    /* notes */
    details.note{background:var(--card);border:1px solid #ccc;border-radius:8px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,.04);overflow:hidden;transition:border-color .15s;}
    details.note[open]{border-color:var(--accent);}  
    summary{cursor:pointer;padding:14px 18px;display:flex;align-items:center;gap:12px;font-weight:600;list-style:none;}
    summary::-webkit-details-marker{display:none;}
    .note-title{flex:1;}
    .enter-btn{padding:4px 10px;font-size:13px;border:1px solid var(--accent);border-radius:6px;background:#fff;color:var(--accent);text-decoration:none;transition:.15s;white-space:nowrap;}
    .enter-btn:hover{background:var(--accent);color:#fff;}
    .note-body{padding:16px 18px 24px;border-top:1px solid #eee;white-space:pre-wrap;line-height:1.35;font-size:14px;}

    #status{text-align:center;margin-top:60px;font-size:1rem;color:#666;}
  </style>
</head>
<body>
  <header>
    <a href="javascript:history.back()">â† Back</a>
    <span id="heading">Entry</span>
  </header>

  <main>
    <section class="banner" id="narrativeBanner"></section>

    <!-- Manual subâ€‘note form -->
    <form id="createForm" class="box">
      <h3 style="margin-top:0">Add a subâ€‘note (manual)</h3>
      <textarea id="noteInput" placeholder="Write your note hereâ€¦"></textarea>
      <button type="submit">Save</button>
    </form>

    <!-- LLMâ€‘generated subâ€‘note form -->
    <form id="llmForm" class="box">
      <h3 style="margin-top:0">Generate subâ€‘note with LLM</h3>
      <label for="templateSelect">Template</label><br>
      <select id="templateSelect">
        <option value="">â€” choose a template â€”</option>
        <option value="narrative">Scientific Narrative</option>
        <option value="theory">Theoryâ€¯/â€¯Method</option>
        <option value="hypothesis">Hypothesis List</option>
      </select>

      <label for="llmSystem">System message</label>
      <textarea id="llmSystem" rows="5"></textarea>
      <label for="llmUser">User message</label>
      <textarea id="llmUser" rows="4"></textarea>
      <button type="submit">AskÂ &Â Save</button>
    </form>

    <div id="notesContainer"><div id="status">Loadingâ€¦</div></div>
  </main>

  <script type="module">
    // â”€â”€â”€ Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const params   = new URLSearchParams(location.search);
    const ID       = params.get('id');
    if(!ID){document.getElementById('status').textContent='Missing id param';throw new Error('Missing id');}

    const banner   = document.getElementById('narrativeBanner');
    const notesWrap= document.getElementById('notesContainer');
    const heading  = document.getElementById('heading');

    // Template handling fields
    const templateSelect = document.getElementById('templateSelect');
    const sysField       = document.getElementById('llmSystem');
    const usrField       = document.getElementById('llmUser');

    // LLM templates
    const TEMPLATES = {
      narrative : {
        sys : "Construct a comprehensive scientific narrative of the following topic.",
        usr : "Construct a narrative of [topic]."
      },
      theory : {
        sys : `You are a research assistant who combines rigorous scientific reasoning with speculative creativity.\nWhen the user asks for a theory/method to achieve a given outcome, always:\nState key assumptions (environment, available technology, timeâ€‘scale).\nProvide a set of hypotheses.\nDescribe a stepâ€‘byâ€‘step pathway grounded in known physics, chemistry, and biology; where knowledge is missing, propose plausible advanced or hypothetical techniques, clearly marking them speculative.\nQuantify requirements (energy, catalysts, genetic templates, computational design, reaction conditions).\nHighlight major bottlenecks, risks, and ethical issues.\nConclude with a feasibility score (0â€“10) and the breakthroughs needed to reach it.\nWrite in clear, precise prose. Use numbered lists, short paragraphs, and cite real concepts or literature when relevant. Maintain a neutral, informative tone; do not roleâ€‘play or add narrative flair unless explicitly requested.`,
        usr : "Construct scientific theories/methods on [topic]."
      },
      hypothesis : {
        sys : `You are a scientific reasoning engine. Your sole task is to output a compact list of high-quality, testable hypothesesâ€”nothing else.\nWhen responding:\n1. Produce 3 â€“ 7 numbered hypotheses (H1, H2 â€¦).\n2. For each hypothesis include exactly three short clauses in parentheses, in this order:\n   â€¢ Mechanism â€“ one sentence naming the causal process.\n   â€¢ Prediction â€“ one falsifiable, quantitative statement.\n   â€¢ Test â€“ the minimal experiment or measurement that would confirm or refute it.\n3. Mark ideas that rely on unproven physics or engineering with â€œ(speculative)â€ at the end of the clause where speculation occurs.\n4. Do not write any introduction, explanation, headings, or concluding text. Only the hypotheses list.\n5. Keep each hypothesis â‰¤ 40 words (including the three clauses).\n6. Cite real concepts or literature inline when relevantâ€”e.g. (via actomyosin ring, RauziÂ 2008)â€”but do not add full references.\n7. Maintain clear, precise prose; avoid jargon when a simpler term suffices.\n8. If insufficient information is available to form a hypothesis, output â€œNo testable hypothesis can be formed with the given information.â€ and nothing else.`,
        usr : "Construct a set of hypotheses on [topic]."
      }
    };

    templateSelect.addEventListener('change', e=>{
      const t = TEMPLATES[e.target.value] || {sys:'',usr:''};
      sysField.value = t.sys;
      usrField.value = t.usr;
    });

    // â”€â”€â”€ Initial load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    init();

    async function init(){
      try{
        const note = await fetchJson(`/api/note?id=${encodeURIComponent(ID)}`);
        renderBanner(note);
        loadNotes();
      }catch(err){notesWrap.innerHTML='<div id="status">Failed to load.</div>';console.error(err);}  
    }

    // â”€â”€â”€ Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderBanner(n){
      heading.textContent = n.user.slice(0,60);
      banner.innerHTML = '';
      banner.appendChild(makeDetails('Prompt', n.user, false));
      banner.appendChild(makeDetails('Narrative', n.answer, true));
    }

    function makeDetails(title,text,open){
      const det=document.createElement('details'); if(open)det.open=true;
      det.innerHTML=`<summary>${title}</summary><div class="content"></div>`;
      det.querySelector('.content').textContent=text;
      return det;
    }

    // â”€â”€â”€ Note list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadNotes(){
      const data = await fetchJson(`/api/subnotes?parent=${encodeURIComponent(ID)}`);
      notesWrap.innerHTML='';
      if(!data.length){notesWrap.innerHTML='<div id="status">No subâ€‘notes yet.</div>';return;}
      data.forEach(n=>notesWrap.appendChild(renderNote(n)));
    }

    function renderNote(d){
      const det=document.createElement('details');
      det.className='note'+(d.is_protocol?' protocol':'');
      det.innerHTML=`<summary><span class="note-title"></span><a class="enter-btn">Enter</a></summary><div class="note-body"></div>`;
      det.querySelector('.note-title').textContent = `ğŸ—¨ï¸ ${d.content.slice(0,120)}`;
      const link = det.querySelector('.enter-btn'); link.href=`entry.html?id=${d.id}`;
      det.querySelector('.note-body').textContent = d.content;
      return det;
    }

    // â”€â”€â”€ Manual subâ€‘note creation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('createForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const txt = document.getElementById('noteInput').value.trim();
      if(!txt) return;
      const btn=e.target.querySelector('button'); btn.disabled=true;
      try{
        await fetch('/api/subnotes',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({parent:ID,content:txt})});
        document.getElementById('noteInput').value='';
        loadNotes();
      }catch(err){alert('Failed to save');console.error(err);}finally{btn.disabled=false;}
    });

    // â”€â”€â”€ LLM subâ€‘note creation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('llmForm').addEventListener('submit',async e=>{
      e.preventDefault();
      const sys = sysField.value;
      const usr = usrField.value.trim();
      if(!usr) return;
      const btn=e.target.querySelector('button'); btn.disabled=true; btn.textContent='Thinkingâ€¦';
      try{
        // 1. Ask LLM (test mode to avoid saving topâ€‘level note)
        const res = await fetch('/api/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:sys,user:usr,narrative:'',test:true})});
        const j   = await res.json();
        const answer = j.answer || '(No answer)';
        // 2. Save answer as subâ€‘note
        await fetch('/api/subnotes',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({parent:ID,content:answer})});
        usrField.value='';
        loadNotes();
      }catch(err){alert('LLM call or save failed');console.error(err);}finally{btn.disabled=false; btn.textContent='AskÂ &Â Save';}
    });

    // â”€â”€â”€ Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchJson(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(r.statusText);
      return r.json();
    }
  </script>
</body>
</html>
