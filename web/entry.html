<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Fantasiagenesis ‚Äî Entry</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--bg:#f5f5f5;--card:#fff;--accent:#4aa3ff;}
    html,body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);}  
    header{display:flex;align-items:center;gap:14px;padding:12px 20px;background:#222;color:#eee;font-size:14px}
    header a{color:#9fd3ff;text-decoration:none;}
    main{max-width:900px;margin:0 auto;padding:32px 20px 80px;}

    /* banner accordion */
    .banner details{background:var(--card);border:1px solid #ccc;border-radius:10px;margin-bottom:14px;box-shadow:0 2px 5px rgba(0,0,0,.05);overflow:hidden;}
    .banner summary{cursor:pointer;padding:14px 18px;font-weight:600;list-style:none;display:flex;align-items:center;gap:8px;}
    .banner summary::-webkit-details-marker{display:none;}
    .banner details[open]{border-color:var(--accent);}  
    .banner .content{padding:0 18px 18px;font-size:14px;line-height:1.4;white-space:pre-wrap;}

    /* create forms */
    form.box{background:var(--card);border:1px solid #ccc;border-radius:10px;padding:20px;margin-bottom:36px;box-shadow:0 2px 6px rgba(0,0,0,.05);} 
    textarea{width:100%;min-height:110px;font-family:inherit;font-size:14px;padding:10px;border:1px solid #bbb;border-radius:6px;resize:vertical;}
    button[type="submit"], select{margin-top:12px;padding:8px 18px;font-size:14px;border:none;border-radius:6px;background:var(--accent);color:#fff;cursor:pointer;}
    select{background:#fff;color:#000;border:1px solid #bbb;}

    /* sub-note list */
    details.note{background:var(--card);border:1px solid #ccc;border-radius:8px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,.04);overflow:hidden;transition:border-color .15s;}
    details.note[open]{border-color:var(--accent);}  
    summary{cursor:pointer;padding:14px 18px;display:flex;align-items:center;gap:12px;font-weight:600;list-style:none;}
    summary::-webkit-details-marker{display:none;}
    .note-title{flex:1;}
    .enter-btn{padding:4px 10px;font-size:13px;border:1px solid var(--accent);border-radius:6px;background:#fff;color:var(--accent);text-decoration:none;transition:.15s;white-space:nowrap;}
    .enter-btn:hover{background:var(--accent);color:#fff;}
    .note-body{padding:16px 18px 24px;border-top:1px solid #eee;white-space:pre-wrap;line-height:1.35;font-size:14px;}

    #status{text-align:center;margin-top:60px;font-size:1rem;color:#666;}
  </style>
</head>
<body>
  <header>
    <a href="javascript:history.back()">‚Üê Back</a>
    <span id="heading">Entry</span>
  </header>
  <main>
    <section class="banner" id="narrativeBanner"></section>

    <!-- Manual sub-note form -->
    <form id="createForm" class="box">
      <h3 style="margin-top:0">Add a sub-note (manual)</h3>
      <textarea id="noteInput" placeholder="Write your note here‚Ä¶"></textarea>
      <button type="submit">Save</button>
    </form>

    <!-- LLM-generated sub-note form -->
    <form id="llmForm" class="box">
      <h3 style="margin-top:0">Generate sub-note with LLM</h3>
      <label for="templateSelect">Template</label><br>
      <select id="templateSelect">
        <option value="">‚Äî choose a template ‚Äî</option>
        <option value="narrative">Scientific Narrative</option>
        <option value="theory">Theory / Method</option>
        <option value="hypothesis">Hypothesis List</option>
      </select>

      <label for="llmSystem">System message</label>
      <textarea id="llmSystem" rows="5"></textarea>
      <label for="llmUser">User message</label>
      <textarea id="llmUser" rows="4"></textarea>
      <button type="submit">Ask & Save</button>
    </form>

    <div id="notesContainer">
      <div id="status">Loading‚Ä¶</div>
    </div>
  </main>

  <script type="module">
    const params = new URLSearchParams(location.search);
    const ID     = params.get('id');
    if(!ID){document.getElementById('status').textContent='Missing id param';throw new Error('Missing id');}

    const banner   = document.getElementById('narrativeBanner');
    const notesWrap= document.getElementById('notesContainer');
    const heading  = document.getElementById('heading');

    const templateSelect = document.getElementById('templateSelect');
    const sysField       = document.getElementById('llmSystem');
    const usrField       = document.getElementById('llmUser');

    const TEMPLATES = {
      narrative: {
        sys: "Construct a comprehensive scientific narrative of the following topic.",
        usr: "Construct a narrative of [topic]."
      },
      theory: {
        sys: `You are a research assistant who combines rigorous scientific reasoning with speculative creativity.\nWhen the user asks for a theory/method to achieve a given outcome, always:\nState key assumptions (environment, available technology, time‚Äëscale).\nProvide a set of hypotheses.\nDescribe a step‚Äëby‚Äëstep pathway grounded in known physics, chemistry, and biology; where knowledge is missing, propose plausible advanced or hypothetical techniques, clearly marking them speculative.\nQuantify requirements (energy, catalysts, genetic templates, computational design, reaction conditions).\nHighlight major bottlenecks, risks, and ethical issues.\nConclude with a feasibility score (0‚Äì10) and the breakthroughs needed to reach it.\nWrite in clear, precise prose. Use numbered lists, short paragraphs, and cite real concepts or literature when relevant. Maintain a neutral, informative tone; do not role‚Äëplay or add narrative flair unless explicitly requested.`,
        usr: "Construct scientific theories/methods on [topic]."
      },
      hypothesis: {
        sys: `You are a scientific reasoning engine. Your sole task is to output a compact list of high-quality, testable hypotheses‚Äînothing else.\nWhen responding:\n1. Produce 3 ‚Äì 7 numbered hypotheses (H1, H2 ‚Ä¶).\n2. For each hypothesis include exactly three short clauses in parentheses, in this order:\n‚ÄÉ‚ÄÉ‚Ä¢ Mechanism ‚Äì one sentence naming the causal process.\n‚ÄÉ‚ÄÉ‚Ä¢ Prediction ‚Äì one falsifiable, quantitative statement.\n‚ÄÉ‚ÄÉ‚Ä¢ Test ‚Äì the minimal experiment or measurement that would confirm or refute it.\n3. Mark ideas that rely on unproven physics or engineering with ‚Äú(speculative)‚Äù at the end of the clause where speculation occurs.\n4. Do not write any introduction, explanation, headings, or concluding text. Only the hypotheses list.\n5. Keep each hypothesis ‚â§ 40 words (including the three clauses).\n6. Cite real concepts or literature inline when relevant‚Äîe.g. (via actomyosin ring, Rauzi 2008)‚Äîbut do not add full references or footnotes.\n7. Maintain clear, precise prose; avoid jargon when a simpler term suffices.\n8. If insufficient information is available to form a hypothesis, output ‚ÄúNo testable hypothesis can be formed with the given information.‚Äù and nothing else.`,
        usr: "Construct a set of hypotheses on [topic]."
      }
    };

    templateSelect.addEventListener('change', e => {
      const t = TEMPLATES[e.target.value];
      if(t){
        sysField.value = t.sys;
        usrField.value = t.usr;
      } else {
        sysField.value = '';
        usrField.value = '';
      }
    });

    init();

    async function init(){
      try{
        const n = await fetchJson(`/api/note?id=${encodeURIComponent(ID)}`);
        renderBanner(n);
        loadNotes();
      }catch(err){notesWrap.innerHTML='<div id="status">Failed to load.</div>';console.error(err);}  
    }

    /* banner rendering with accordion */
    function renderBanner(n){
      heading.textContent = n.user.slice(0,60);
      banner.innerHTML = '';

      banner.appendChild(makeDetails('Prompt', n.user, false));
      banner.appendChild(makeDetails('Narrative', n.answer, true));
    }

    function makeDetails(title, text, open){
      const det = document.createElement('details');
      if(open) det.setAttribute('open','');
      const sum = document.createElement('summary');
      sum.textContent = title;
      const body = document.createElement('div');
      body.className = 'content';
      body.textContent = text;
      det.append(sum, body);
      return det;
    }

    async function loadNotes(){
      const data = await fetchJson(`/api/subnotes?parent=${encodeURIComponent(ID)}`);
      notesWrap.innerHTML = '';
      if(!data.length){notesWrap.innerHTML='<div id="status">No sub-notes yet.</div>';return;}
      data.forEach(d=>{
        notesWrap.appendChild(renderNote(d));
      });
    }

    function renderNote(d){
      const details=document.createElement('details');
      details.className='note'+(d.is_protocol?' protocol':'');
      const summary=document.createElement('summary');
      const titleSpan=document.createElement('span');titleSpan.className='note-title';titleSpan.textContent=`üó®Ô∏è ${d.content.slice(0,120)}`;
      const btn=document.createElement('a');btn.className='enter-btn';btn.textContent='Enter';btn.href=`entry.html?id=${d.id}`;
      summary.append(titleSpan,btn);
      const body=document.createElement('div');body.className='note-body';body.textContent=d.content;
      details.append(summary,body);
      return details;
    }

    // create new sub-note (manual)
    document.getElementById('createForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const txt = document.getElementById('noteInput').value.trim();
      if(!txt) return;
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      try{
        await fetch('/api/subnotes',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({parent:ID,content:txt})
        });
        document.getElementById
