<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Fantasiagenesis — Entry</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--bg:#f5f5f5;--card:#fff;--accent:#4aa3ff;}
    html,body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);}
    header{display:flex;align-items:center;gap:14px;padding:12px 20px;background:#222;color:#eee;font-size:14px}
    header a{color:#9fd3ff;text-decoration:none;}
    main{max-width:900px;margin:0 auto;padding:32px 20px 80px;}

    /* narrative banner */
    .banner{background:var(--card);border:1px solid #ccc;border-radius:10px;padding:20px;margin-bottom:30px;box-shadow:0 2px 6px rgba(0,0,0,.05);}  
    .banner h2{margin-top:0;}

    /* create form */
    form#createForm{background:var(--card);border:1px solid #ccc;border-radius:10px;padding:20px;margin-bottom:36px;box-shadow:0 2px 6px rgba(0,0,0,.05);} 
    textarea{width:100%;min-height:120px;font-family:inherit;font-size:15px;padding:10px;border:1px solid #bbb;border-radius:6px;resize:vertical;}
    button[type="submit"]{margin-top:12px;padding:8px 18px;font-size:15px;border:none;border-radius:6px;background:var(--accent);color:#fff;cursor:pointer;}

    /* sub‑note list */
    .note{background:var(--card);border:1px solid #ccc;border-radius:8px;margin-bottom:16px;padding:16px 20px;box-shadow:0 1px 4px rgba(0,0,0,.04);white-space:pre-wrap;line-height:1.4;font-size:15px;}
    #status{text-align:center;margin-top:60px;font-size:1rem;color:#666;}
  </style>
</head>
<body>
  <header>
    <a href="javascript:history.back()">← Back</a>
    <span id="heading">Entry</span>
  </header>
  <main>
    <section class="banner" id="narrativeBanner"></section>

    <form id="createForm">
      <h3>Add a sub‑note</h3>
      <textarea id="noteInput" placeholder="Write your note here…"></textarea>
      <button type="submit">Save</button>
    </form>

    <div id="notesContainer">
      <div id="status">Loading…</div>
    </div>
  </main>

  <script type="module">
    const params=new URLSearchParams(location.search);
    const ID=params.get('id');
    if(!ID){document.getElementById('status').textContent='Missing id param';throw new Error('Missing id');}

    const banner=document.getElementById('narrativeBanner');
    const notesWrap=document.getElementById('notesContainer');
    const heading=document.getElementById('heading');

    init();

    async function init(){
      try{
        const narrative=await fetchJson(`/api/note?id=${encodeURIComponent(ID)}`);
        renderBanner(narrative);
        loadNotes();
      }catch(err){notesWrap.innerHTML='<div id="status">Failed to load.</div>';console.error(err);}
    }

    function renderBanner(n){
      heading.textContent=n.user.slice(0,60);
      banner.innerHTML=`<h2>${n.user}</h2><p>${n.answer}</p>`;
    }

    async function loadNotes(){
      const data=await fetchJson(`/api/subnotes?parent=${encodeURIComponent(ID)}`);
      notesWrap.innerHTML='';
      if(!data.length){notesWrap.innerHTML='<div id="status">No sub‑notes yet.</div>';return;}
      data.forEach(d=>{const div=document.createElement('div');div.className='note';div.textContent=d.content;notesWrap.appendChild(div);});
    }

    // create new sub‑note
    document.getElementById('createForm').addEventListener('submit',async e=>{
      e.preventDefault();
      const txt=document.getElementById('noteInput').value.trim();
      if(!txt) return;
      e.target.querySelector('button').disabled=true;
      try{
        await fetch('/api/subnotes',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({parent:ID,content:txt})
        });
        document.getElementById('noteInput').value='';
        loadNotes();
      }catch(err){alert('Failed to save');console.error(err);}finally{e.target.querySelector('button').disabled=false;}
    });

    async function fetchJson(url){const r=await fetch(url);if(!r.ok) throw new Error(r.statusText);return r.json();}
  </script>
</body>
</html>
