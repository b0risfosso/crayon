<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Conductivity Sensor Playground</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      line-height: 1.4;
    }

    body {
      margin: 0;
      padding: 2rem;
      background: #0b1020;
      color: #f5f5f7;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .card {
      background: radial-gradient(circle at top left, #20263b, #080b14);
      border-radius: 18px;
      padding: 1.75rem 2rem;
      max-width: 560px;
      width: 100%;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .card-title {
      font-size: 1.3rem;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .chip {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      opacity: 0.9;
    }

    .description {
      font-size: 0.85rem;
      color: #c2c6dd;
      margin-bottom: 1.5rem;
    }

    .section-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #8b90ad;
      margin-bottom: 0.4rem;
    }

    .control-group {
      margin-bottom: 1.25rem;
    }

    label {
      font-size: 0.85rem;
      display: block;
      margin-bottom: 0.25rem;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    input[type="range"] {
      width: 100%;
    }

    .value-pill {
      min-width: 90px;
      text-align: right;
      font-size: 0.8rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .readout-grid {
      display: grid;
      grid-template-columns: 1.3fr 1.3fr;
      gap: 0.75rem;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
    }

    .readout-card {
      border-radius: 14px;
      padding: 0.75rem 0.9rem;
      background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.04),
        rgba(255, 255, 255, 0.02)
      );
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .readout-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #9ca0bf;
      margin-bottom: 0.4rem;
    }

    .readout-value {
      font-size: 1.1rem;
      font-variant-numeric: tabular-nums;
    }

    .readout-units {
      font-size: 0.7rem;
      color: #9ca0bf;
      margin-left: 0.2rem;
    }

    .status-bar {
      font-size: 0.78rem;
      color: #9ca0bf;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #20e3b2;
      box-shadow: 0 0 10px rgba(32, 227, 178, 0.6);
      margin-right: 0.4rem;
    }

    .status-left {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    button {
      background: #1d9bf0;
      color: white;
      border: none;
      border-radius: 999px;
      padding: 0.4rem 0.9rem;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    button:hover {
      background: #1583ce;
    }

    button:active {
      transform: translateY(1px);
    }

    .mini-badge {
      font-size: 0.65rem;
      padding: 0.12rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="card-header">
      <div class="card-title">Conductivity Sensor</div>
      <div class="chip">Component · Minimal Version</div>
    </div>

    <div class="description">
      This component represents a conductivity probe sitting in the acid
      reservoir. You control the underlying ammonium concentration; the
      sensor converts ionic strength into a noisy conductivity reading.
    </div>

    <div class="control-group">
      <div class="section-title">Reservoir State (Driving the Sensor)</div>
      <label for="concentrationSlider">Ammonium-N concentration (arbitrary units)</label>
      <div class="slider-row">
        <input
          id="concentrationSlider"
          type="range"
          min="0"
          max="100"
          step="1"
          value="20"
        />
        <div class="value-pill">
          <span id="concentrationValue">20</span>
          <span style="font-size: 0.7rem; color: #9ca0bf;">units</span>
        </div>
      </div>
    </div>

    <div class="control-group">
      <div class="section-title">Sensor Settings</div>
      <div class="toggle-row">
        <input id="noiseToggle" type="checkbox" checked />
        <label for="noiseToggle" style="margin: 0;">Measurement noise enabled</label>
      </div>
    </div>

    <div class="section-title">Sensor Readout</div>
    <div class="readout-grid">
      <div class="readout-card">
        <div class="readout-label">True Conductivity</div>
        <div class="readout-value">
          <span id="trueConductivity">0.00</span>
          <span class="readout-units">mS/cm (sim)</span>
        </div>
      </div>
      <div class="readout-card">
        <div class="readout-label">Measured Conductivity</div>
        <div class="readout-value">
          <span id="measuredConductivity">0.00</span>
          <span class="readout-units">mS/cm</span>
        </div>
      </div>
    </div>

    <div class="status-bar">
      <div class="status-left">
        <div class="status-dot"></div>
        <span id="statusText">Sampling at 5 Hz</span>
      </div>
      <div>
        <button id="sampleOnceBtn">
          Sample once
          <span class="mini-badge">Δt = instant</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // --- Single domain class: ConductivitySensor ----------------------

    class ConductivitySensor {
      /**
       * Represents a conductivity probe immersed in an electrolyte.
       *
       * Real-world analog:
       * - cellConstant: geometry of the probe (cm^-1)
       * - noiseStd: measurement noise magnitude (mS/cm)
       * - baseConductivity: background conductivity of acid (mS/cm)
       * - sensitivity: how strongly conductivity rises with ammonium concentration
       */
      constructor({
        cellConstant = 1.0,
        noiseStd = 0.05,
        baseConductivity = 0.5,
        sensitivity = 0.03,
      } = {}) {
        this.cellConstant = cellConstant;
        this.noiseStd = noiseStd;
        this.baseConductivity = baseConductivity;
        this.sensitivity = sensitivity;
      }

      /**
       * Given a "true" ammonium concentration (arbitrary units),
       * compute the true conductivity in mS/cm that the solution would have.
       *
       * Here we use a simple linear model:
       *   σ_true = base + sensitivity * [NH4+]
       * In a more detailed model, you'd sum contributions from all ions.
       */
      computeTrueConductivity(ammoniumUnits) {
        const sigma =
          this.baseConductivity + this.sensitivity * Number(ammoniumUnits);
        return Math.max(sigma, 0);
      }

      /**
       * Given the true conductivity, return a measured value
       * with optional noise, representing electronics + probe variation.
       */
      measure(trueConductivity, withNoise = true) {
        if (!withNoise) return trueConductivity;

        // Simple Gaussian noise using Box–Muller
        const u1 = Math.random();
        const u2 = Math.random();
        const z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
        const noisy = trueConductivity + z * this.noiseStd;

        return Math.max(noisy, 0);
      }
    }

    // --- UI Wiring for the Playground --------------------------------

    const concentrationSlider = document.getElementById("concentrationSlider");
    const concentrationValue = document.getElementById("concentrationValue");
    const trueConductivityEl = document.getElementById("trueConductivity");
    const measuredConductivityEl =
      document.getElementById("measuredConductivity");
    const noiseToggle = document.getElementById("noiseToggle");
    const statusText = document.getElementById("statusText");
    const sampleOnceBtn = document.getElementById("sampleOnceBtn");

    const sensor = new ConductivitySensor({
      cellConstant: 1.0,
      noiseStd: 0.08,
      baseConductivity: 0.6,
      sensitivity: 0.035,
    });

    let lastMeasurementTime = performance.now();

    function updateSensorReading(sampleOnce = false) {
      const conc = Number(concentrationSlider.value);
      concentrationValue.textContent = conc.toFixed(0);

      const sigmaTrue = sensor.computeTrueConductivity(conc);
      const sigmaMeas = sensor.measure(
        sigmaTrue,
        noiseToggle.checked
      );

      trueConductivityEl.textContent = sigmaTrue.toFixed(2);
      measuredConductivityEl.textContent = sigmaMeas.toFixed(2);

      if (!sampleOnce) {
        const now = performance.now();
        const dt = (now - lastMeasurementTime) / 1000;
        lastMeasurementTime = now;
        statusText.textContent = `Sampling at ~${(1 / dt).toFixed(
          1
        )} Hz`;
      }
    }

    // Continuous sampling loop (approx. 5 Hz)
    setInterval(() => {
      updateSensorReading(false);
    }, 200);

    // One-shot measurement button
    sampleOnceBtn.addEventListener("click", () => {
      updateSensorReading(true);
      statusText.textContent = "Single sample taken";
      setTimeout(() => {
        statusText.textContent = "Sampling at 5 Hz";
      }, 1200);
    });

    // React immediately when user moves slider or toggles noise
    concentrationSlider.addEventListener("input", () =>
      updateSensorReading(true)
    );
    noiseToggle.addEventListener("change", () => updateSensorReading(true));

    // Initial draw
    updateSensorReading(true);
  </script>
</body>
</html>
