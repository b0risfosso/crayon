<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Null Environment – Nitrogen World Playground</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #101827, #020617);
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      padding: 16px 24px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 16px;
      backdrop-filter: blur(16px);
      background: linear-gradient(to right, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.7));
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      font-size: 1.25rem;
      margin: 0;
      letter-spacing: 0.03em;
    }

    header p {
      margin: 0;
      font-size: 0.85rem;
      color: #9ca3af;
    }

    main {
      flex: 1;
      padding: 16px 24px 24px;
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 18px;
    }

    @media (max-width: 980px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.3), rgba(15, 23, 42, 0.96));
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 14px 16px;
      box-shadow:
        0 18px 40px rgba(15, 23, 42, 0.7),
        0 0 0 1px rgba(15, 23, 42, 0.5);
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 10% 0%, rgba(56, 189, 248, 0.08), transparent 50%),
        radial-gradient(circle at 100% 0%, rgba(129, 140, 248, 0.06), transparent 55%);
      opacity: 0.9;
      pointer-events: none;
      z-index: -1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .card-title {
      font-size: 0.9rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #a5b4fc;
    }

    .card-subtitle {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 700px) {
      .metrics-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .metric-tile {
      background: rgba(15, 23, 42, 0.85);
      border-radius: 14px;
      padding: 8px 10px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .metric-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
    }

    .metric-value {
      font-size: 1.05rem;
      font-variant-numeric: tabular-nums;
    }

    .metric-unit {
      font-size: 0.7rem;
      color: #6b7280;
      margin-left: 4px;
    }

    .metric-trend {
      font-size: 0.7rem;
      color: #6ee7b7;
    }

    .metric-trend.down {
      color: #fb7185;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .control-row {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.6fr) minmax(0, 0.9fr);
      gap: 8px;
      align-items: center;
    }

    @media (max-width: 700px) {
      .control-row {
        grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.6fr);
        grid-template-rows: auto auto;
      }
    }

    .control-label {
      font-size: 0.75rem;
      color: #e5e7eb;
    }

    .control-label span {
      display: block;
      font-size: 0.65rem;
      color: #9ca3af;
    }

    .control-input {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .control-input input[type="range"] {
      width: 100%;
    }

    .control-value {
      font-size: 0.75rem;
      color: #9ca3af;
      text-align: right;
    }

    .pill {
      display: inline-flex;
      align-items: baseline;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      font-size: 0.7rem;
      color: #e5e7eb;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px #22c55e;
    }

    .pill-dot.idle {
      background: #f97316;
      box-shadow: 0 0 8px #f97316;
    }

    .pill-dot.offline {
      background: #6b7280;
      box-shadow: none;
    }

    canvas {
      width: 100%;
      height: 220px;
      border-radius: 14px;
      background: radial-gradient(circle at top, #020617, #020617);
      border: 1px solid rgba(31, 41, 55, 0.9);
    }

    footer {
      padding: 10px 24px 16px;
      font-size: 0.7rem;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 0.7rem;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(75, 85, 99, 0.8);
    }

    .legend-swatch {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #e5e7eb;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Null Environment • Nitrogen World</h1>
      <p>Ambient ammonia, air, and time evolving with no capture system installed.</p>
    </div>
    <div class="pill">
      <div id="sim-status-dot" class="pill-dot"></div>
      <span id="sim-status-text">Environment evolving</span>
    </div>
  </header>

  <main>
    <!-- Left: World state & graph -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">World State</div>
          <div class="card-subtitle">How the room behaves when you do nothing.</div>
        </div>
        <div class="card-subtitle" id="time-display">t = 0.0 min</div>
      </div>

      <div class="metrics-grid">
        <div class="metric-tile">
          <div class="metric-label">Ambient NH₃</div>
          <div>
            <span class="metric-value" id="metric-nh3">0.00</span>
            <span class="metric-unit">ppm</span>
          </div>
          <div class="metric-trend" id="metric-nh3-trend">steady</div>
        </div>

        <div class="metric-tile">
          <div class="metric-label">Total N in Room</div>
          <div>
            <span class="metric-value" id="metric-total-n">0.00</span>
            <span class="metric-unit">mmol</span>
          </div>
          <div class="metric-trend" id="metric-total-n-trend">no sink yet</div>
        </div>

        <div class="metric-tile">
          <div class="metric-label">Room Volume</div>
          <div>
            <span class="metric-value" id="metric-volume">50</span>
            <span class="metric-unit">m³</span>
          </div>
          <div class="metric-trend">fixed boundary</div>
        </div>

        <div class="metric-tile">
          <div class="metric-label">Temperature</div>
          <div>
            <span class="metric-value" id="metric-temp">22.0</span>
            <span class="metric-unit">°C</span>
          </div>
          <div class="metric-trend" id="metric-temp-trend">diurnal drift</div>
        </div>

        <div class="metric-tile">
          <div class="metric-label">Relative Humidity</div>
          <div>
            <span class="metric-value" id="metric-humidity">50</span>
            <span class="metric-unit">%</span>
          </div>
          <div class="metric-trend" id="metric-humidity-trend">breathing & weather</div>
        </div>

        <div class="metric-tile">
          <div class="metric-label">Ventilation Loss</div>
          <div>
            <span class="metric-value" id="metric-vent-rate">0.50</span>
            <span class="metric-unit">ACH</span>
          </div>
          <div class="metric-trend" id="metric-vent-trend">diffuse nitrogen leak</div>
        </div>
      </div>

      <canvas id="world-chart"></canvas>
    </section>

    <!-- Right: Controls and description -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Environment Controls</div>
          <div class="card-subtitle">Tune how hostile or gentle the null world is.</div>
        </div>
      </div>

      <div class="controls">
        <div class="control-row">
          <div class="control-label">
            Baseline NH₃ load
            <span>Typical ambient level before spikes.</span>
          </div>
          <div class="control-input">
            <input id="slider-baseline-nh3" type="range" min="0" max="10" step="0.1" value="2" />
          </div>
          <div class="control-value">
            <span id="val-baseline-nh3">2.0</span> ppm
          </div>
        </div>

        <div class="control-row">
          <div class="control-label">
            Emission volatility
            <span>How spiky the room’s sources are.</span>
          </div>
          <div class="control-input">
            <input id="slider-emission-noise" type="range" min="0" max="1" step="0.05" value="0.4" />
          </div>
          <div class="control-value">
            <span id="val-emission-noise">0.40</span>
          </div>
        </div>

        <div class="control-row">
          <div class="control-label">
            Room volume
            <span>How big the environment is.</span>
          </div>
          <div class="control-input">
            <input id="slider-volume" type="range" min="10" max="300" step="10" value="50" />
          </div>
          <div class="control-value">
            <span id="val-volume">50</span> m³
          </div>
        </div>

        <div class="control-row">
          <div class="control-label">
            Ventilation rate
            <span>Air changes per hour to outdoors.</span>
          </div>
          <div class="control-input">
            <input id="slider-ventilation" type="range" min="0" max="6" step="0.1" value="0.5" />
          </div>
          <div class="control-value">
            <span id="val-ventilation">0.5</span> ACH
          </div>
        </div>

        <div class="control-row">
          <div class="control-label">
            Mean temperature
            <span>Center of the diurnal temperature swing.</span>
          </div>
          <div class="control-input">
            <input id="slider-temp-mean" type="range" min="5" max="35" step="0.5" value="22" />
          </div>
          <div class="control-value">
            <span id="val-temp-mean">22.0</span> °C
          </div>
        </div>

        <div class="control-row">
          <div class="control-label">
            Mean humidity
            <span>Baseline relative humidity.</span>
          </div>
          <div class="control-input">
            <input id="slider-humidity-mean" type="range" min="10" max="90" step="1" value="50" />
          </div>
          <div class="control-value">
            <span id="val-humidity-mean">50</span> %
          </div>
        </div>
      </div>

      <div style="margin-top:10px;font-size:0.75rem;color:#9ca3af;">
        This is the world with no membranes, no reservoirs, no power supply—just a room breathing,
        leaking nitrogen to the outside, and drifting through temperature and humidity cycles. Later,
        the electrochemical sink will enter this landscape and change these curves.
      </div>
    </section>
  </main>

  <footer>
    <div class="legend">
      <span>Live signals:</span>
      <span class="legend-item"><span class="legend-swatch"></span> NH₃ (ppm)</span>
      <span class="legend-item"><span class="legend-swatch"></span> Temp (°C)</span>
      <span class="legend-item"><span class="legend-swatch"></span> Humidity (%)</span>
    </div>
    <div>
      Null state • No active control, only passive flux and emission noise.
    </div>
  </footer>

  <script>
    // --------- Environment model (null state) ---------

    const env = {
      time_s: 0,
      dt_s: 0.25, // simulation step
      // state
      nh3_ppm: 2.0,
      total_n_mmol: 0,
      temp_C: 22.0,
      humidity_pct: 50,

      // parameters
      baseline_nh3_ppm: 2.0,
      emission_noise_strength: 0.4,
      room_volume_m3: 50,
      ventilation_ach: 0.5,
      temp_mean_C: 22,
      temp_amp_C: 5,
      humidity_mean_pct: 50,
      humidity_amp_pct: 10
    };

    // simple history buffer for plotting
    const history = {
      maxPoints: 600,
      t: [],
      nh3: [],
      temp: [],
      humidity: []
    };

    function pushHistory(t, nh3, temp, hum) {
      history.t.push(t);
      history.nh3.push(nh3);
      history.temp.push(temp);
      history.humidity.push(hum);

      if (history.t.length > history.maxPoints) {
        history.t.shift();
        history.nh3.shift();
        history.temp.shift();
        history.humidity.shift();
      }
    }

    function randn() {
      // Box-Muller
      const u1 = Math.random();
      const u2 = Math.random();
      const r = Math.sqrt(-2.0 * Math.log(u1));
      const theta = 2.0 * Math.PI * u2;
      return r * Math.cos(theta);
    }

    function stepEnvironment() {
      const dt = env.dt_s;
      env.time_s += dt;

      // time in hours for diurnal patterns
      const t_hours = env.time_s / 3600.0;
      const day_phase = (2 * Math.PI * t_hours) / 24.0;

      // temperature drift: mean + sin + small noise
      env.temp_C =
        env.temp_mean_C +
        env.temp_amp_C * Math.sin(day_phase) +
        0.3 * randn();

      // humidity drift, constrained 0–100
      env.humidity_pct =
        env.humidity_mean_pct +
        env.humidity_amp_pct * Math.sin(day_phase + Math.PI / 3) +
        2.0 * randn();

      env.humidity_pct = Math.max(5, Math.min(95, env.humidity_pct));

      // NH3 dynamics:
      // baseline source + noisy spikes, minus ventilation losses
      const baseline = env.baseline_nh3_ppm;

      // emission fluctuation: occasional spikes
      const spike_trigger = Math.random();
      let spike = 0;
      if (spike_trigger < env.emission_noise_strength * dt) {
        spike = 5 + 15 * Math.random(); // random strong burst
      }

      // approximate emission term
      const emission_ppm = 0.02 * (baseline - env.nh3_ppm) + spike;

      // ventilation as first-order loss (ACH)
      const lambda_h = env.ventilation_ach; // per hour
      const lambda_s = lambda_h / 3600.0; // per second
      const loss_ppm = lambda_s * env.nh3_ppm;

      env.nh3_ppm += (emission_ppm - loss_ppm) * dt;
      if (env.nh3_ppm < 0) env.nh3_ppm = 0;

      // total N in room (rough back-of-envelope):
      // 1 ppm NH3 in air ~ 0.7 mg/m3 (approx), convert to mmol
      const mg_per_m3_per_ppm = 0.7; // crude
      const mg_total = env.nh3_ppm * mg_per_m3_per_ppm * env.room_volume_m3;
      const mmol = mg_total / 17.0; // NH3 molar mass ~17 g/mol
      env.total_n_mmol = mmol;

      pushHistory(env.time_s, env.nh3_ppm, env.temp_C, env.humidity_pct);
    }

    // --------- UI wiring ---------
    const elTime = document.getElementById("time-display");
    const elNH3 = document.getElementById("metric-nh3");
    const elNH3Trend = document.getElementById("metric-nh3-trend");
    const elTotalN = document.getElementById("metric-total-n");
    const elTotalNTrend = document.getElementById("metric-total-n-trend");
    const elVolume = document.getElementById("metric-volume");
    const elTemp = document.getElementById("metric-temp");
    const elTempTrend = document.getElementById("metric-temp-trend");
    const elHumidity = document.getElementById("metric-humidity");
    const elHumidityTrend = document.getElementById("metric-humidity-trend");
    const elVentRate = document.getElementById("metric-vent-rate");
    const elVentTrend = document.getElementById("metric-vent-trend");

    const sliderBaselineNH3 = document.getElementById("slider-baseline-nh3");
    const valBaselineNH3 = document.getElementById("val-baseline-nh3");

    const sliderEmissionNoise = document.getElementById("slider-emission-noise");
    const valEmissionNoise = document.getElementById("val-emission-noise");

    const sliderVolume = document.getElementById("slider-volume");
    const valVolume = document.getElementById("val-volume");

    const sliderVent = document.getElementById("slider-ventilation");
    const valVent = document.getElementById("val-ventilation");

    const sliderTempMean = document.getElementById("slider-temp-mean");
    const valTempMean = document.getElementById("val-temp-mean");

    const sliderHumidityMean = document.getElementById("slider-humidity-mean");
    const valHumidityMean = document.getElementById("val-humidity-mean");

    // status pill
    const statusDot = document.getElementById("sim-status-dot");
    const statusText = document.getElementById("sim-status-text");

    sliderBaselineNH3.addEventListener("input", () => {
      env.baseline_nh3_ppm = parseFloat(sliderBaselineNH3.value);
      valBaselineNH3.textContent = env.baseline_nh3_ppm.toFixed(1);
    });

    sliderEmissionNoise.addEventListener("input", () => {
      env.emission_noise_strength = parseFloat(sliderEmissionNoise.value);
      valEmissionNoise.textContent = env.emission_noise_strength.toFixed(2);
    });

    sliderVolume.addEventListener("input", () => {
      env.room_volume_m3 = parseFloat(sliderVolume.value);
      valVolume.textContent = env.room_volume_m3.toFixed(0);
    });

    sliderVent.addEventListener("input", () => {
      env.ventilation_ach = parseFloat(sliderVent.value);
      valVent.textContent = env.ventilation_ach.toFixed(1);
    });

    sliderTempMean.addEventListener("input", () => {
      env.temp_mean_C = parseFloat(sliderTempMean.value);
      valTempMean.textContent = env.temp_mean_C.toFixed(1);
    });

    sliderHumidityMean.addEventListener("input", () => {
      env.humidity_mean_pct = parseFloat(sliderHumidityMean.value);
      valHumidityMean.textContent = env.humidity_mean_pct.toFixed(0);
    });

    // --------- Chart drawing ---------
    const canvas = document.getElementById("world-chart");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * window.devicePixelRatio;
      canvas.height = rect.height * window.devicePixelRatio;
      ctx.setTransform(window.devicePixelRatio, 0, 0, window.devicePixelRatio, 0, 0);
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function drawChart() {
      const w = canvas.width / window.devicePixelRatio;
      const h = canvas.height / window.devicePixelRatio;

      ctx.clearRect(0, 0, w, h);

      // background grid
      ctx.globalAlpha = 1;
      ctx.fillStyle = "#020617";
      ctx.fillRect(0, 0, w, h);

      ctx.strokeStyle = "rgba(55,65,81,0.7)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      for (let i = 0; i <= 6; i++) {
        const y = (i / 6) * h;
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
      }
      ctx.stroke();

      if (history.t.length < 2) return;

      const tMin = history.t[0];
      const tMax = history.t[history.t.length - 1];

      const nh3Min = Math.min(...history.nh3);
      const nh3Max = Math.max(...history.nh3);
      const tempMin = Math.min(...history.temp);
      const tempMax = Math.max(...history.temp);
      const humMin = Math.min(...history.humidity);
      const humMax = Math.max(...history.humidity);

      function norm(val, min, max) {
        if (max === min) return 0.5;
        return (val - min) / (max - min);
      }

      function xFromTime(t) {
        if (tMax === tMin) return w;
        return ((t - tMin) / (tMax - tMin)) * w;
      }

      // NH3 line
      ctx.lineWidth = 1.7;

      ctx.strokeStyle = "rgba(129, 140, 248, 0.9)";
      ctx.beginPath();
      history.t.forEach((t, i) => {
        const x = xFromTime(t);
        const y = h - norm(history.nh3[i], nh3Min, nh3Max) * h;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // Temperature line
      ctx.strokeStyle = "rgba(248, 250, 252, 0.9)";
      ctx.beginPath();
      history.t.forEach((t, i) => {
        const x = xFromTime(t);
        const y = h - norm(history.temp[i], tempMin, tempMax) * h;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // Humidity line
      ctx.strokeStyle = "rgba(45, 212, 191, 0.9)";
      ctx.beginPath();
      history.t.forEach((t, i) => {
        const x = xFromTime(t);
        const y = h - norm(history.humidity[i], humMin, humMax) * h;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    // --------- UI update ---------
    function updateMetrics() {
      const minutes = env.time_s / 60.0;
      elTime.textContent = `t = ${minutes.toFixed(1)} min`;

      const nh3 = env.nh3_ppm;
      elNH3.textContent = nh3.toFixed(2);

      const len = history.nh3.length;
      let trendText = "steady";
      let trendClass = "";
      if (len > 4) {
        const dh = history.nh3[len - 1] - history.nh3[len - 4];
        if (dh > 0.2) {
          trendText = "rising";
          trendClass = "";
        } else if (dh < -0.2) {
          trendText = "falling";
          trendClass = "down";
        }
      }
      elNH3Trend.textContent = trendText;
      elNH3Trend.className = "metric-trend " + trendClass;

      elTotalN.textContent = env.total_n_mmol.toFixed(2);
      elTotalNTrend.textContent = "leaks to outdoors only";

      elVolume.textContent = env.room_volume_m3.toFixed(0);

      elTemp.textContent = env.temp_C.toFixed(1);
      elHumidity.textContent = env.humidity_pct.toFixed(0);

      // qualitative trends for temp and humidity
      const lt = history.temp.length;
      if (lt > 4) {
        const dT = history.temp[lt - 1] - history.temp[lt - 4];
        elTempTrend.textContent = dT > 0.1 ? "warming" : dT < -0.1 ? "cooling" : "stable";
      }

      const lh = history.humidity.length;
      if (lh > 4) {
        const dH = history.humidity[lh - 1] - history.humidity[lh - 4];
        elHumidityTrend.textContent = dH > 0.4 ? "moistening" : dH < -0.4 ? "drying" : "stable";
      }

      elVentRate.textContent = env.ventilation_ach.toFixed(2);
      elVentTrend.textContent =
        env.ventilation_ach < 0.3
          ? "nitrogen accumulates slowly"
          : env.ventilation_ach < 2
          ? "moderate nitrogen leak"
          : "aggressive nitrogen leak";

      statusDot.className = "pill-dot";
      statusText.textContent = "Environment evolving";
    }

    // --------- Main loop ---------
    function loop() {
      for (let i = 0; i < 4; i++) {
        stepEnvironment();
      }
      updateMetrics();
      drawChart();
      requestAnimationFrame(loop);
    }

    // seed some history so graph isn’t empty
    for (let i = 0; i < 60; i++) {
      stepEnvironment();
    }

    updateMetrics();
    drawChart();
    requestAnimationFrame(loop);
  </script>
</body>
</html>
