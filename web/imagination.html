<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>imagination</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; line-height: 1.6; }
    h1 { font-size: 1.1rem; margin: 0 0 .5rem; }
    .hint { opacity: .7; font-size: .9rem; }
    ul { margin-top: .75rem; padding-left: 1.25rem; }
    li { margin: .25rem 0; }
    nav { margin-top: 1.5rem; }
    nav a { margin-right: 1rem; }

    details { border: 1px solid color-mix(in srgb, #888, transparent 50%); border-radius: .5rem; padding: .5rem .75rem; }
    details + details { margin-top: .5rem; }
    summary { cursor: pointer; font-weight: 600; outline: none; }
    .dim-wrap { margin-top: .5rem; }
    .dims { list-style: none; padding-left: 0; margin: .5rem 0 0; }
    .dim { padding: .5rem .5rem; border-left: 3px solid color-mix(in srgb, #0b5cff, transparent 20%); }
    .dim + .dim { margin-top: .5rem; }
    .dim-title { font-weight: 600; margin: 0 0 .15rem; }
    .dim-desc { margin: 0; opacity: .9; }
    .err { color: #b00020; }
  </style>
</head>
<body>
  <header>
    <p>imagination</p>
  </header>

  <ul id="list" aria-live="polite"></ul>
  <p id="empty" class="hint" hidden>No narratives found.</p>

  <nav>
    <a href="index.html">back to home</a>
    <a href="grow.html">see imagination grow</a>
  </nav>

  <script>
    const listEl = document.getElementById('list');
    const emptyEl = document.getElementById('empty');

    (async function loadNarratives() {
      try {
        const res = await fetch('/api/narratives'); // → [{id, title, ...}]
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const rows = await res.json();

        if (!rows.length) {
          emptyEl.hidden = false;
          return;
        }

        listEl.innerHTML = rows.map(r => `
          <li>
            <details data-id="${r.id}">
              <summary>${escapeHTML(r.title || 'Untitled')}</summary>
              <div class="dim-wrap" data-state="idle">
                <p class="hint">Expand to load dimensions…</p>
              </div>
            </details>
          </li>
        `).join('');

        // Lazy-load dimensions on first expand
        document.addEventListener('toggle', async (e) => {
          const det = e.target;
          if (!(det instanceof HTMLDetailsElement)) return;
          if (!det.open) return;

          const wrap = det.querySelector('.dim-wrap');
          if (!wrap || wrap.dataset.state !== 'idle') return; // already loaded or loading
          wrap.dataset.state = 'loading';
          wrap.innerHTML = `<p class="hint">Loading dimensions…</p>`;

          const id = det.dataset.id;
          try {
            const res = await fetch(`/api/narratives/${encodeURIComponent(id)}/dimensions`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const dims = await res.json(); // → [{id,title,description,...}]

            if (!Array.isArray(dims) || !dims.length) {
              wrap.innerHTML = `<p class="hint">No dimensions yet.</p>`;
              wrap.dataset.state = 'loaded';
              return;
            }

            wrap.innerHTML = `
              <ul class="dims">
                ${dims.map(d => `
                  <li class="dim">
                    <p class="dim-title">${escapeHTML(d.title || 'Untitled dimension')}</p>
                    ${d.description ? `<p class="dim-desc">${escapeHTML(d.description)}</p>` : ''}
                  </li>
                `).join('')}
              </ul>
            `;
            wrap.dataset.state = 'loaded';
          } catch (err) {
            wrap.innerHTML = `<p class="hint err">Error loading dimensions: ${escapeHTML(String(err.message || err))}</p>`;
            wrap.dataset.state = 'idle'; // allow retry by closing/re-opening
          }
        });
      } catch (err) {
        emptyEl.hidden = false;
        emptyEl.textContent = `Error loading narratives (${String(err.message || err)}).`;
      }
    }, true); // ← capture=true so it fires from <details>

    function escapeHTML(s) {
      return String(s ?? '').replace(/[&<>"']/g, c => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]
      ));
    }
  </script>
</body>
</html>
