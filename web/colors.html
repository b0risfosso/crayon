<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Colors Viewer</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .block { border: 1px solid #ccc; padding: 12px; margin-bottom: 16px; border-radius: 8px; }
    pre { white-space: pre-wrap; }
    .controls { margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap; }
    button { padding: 6px 10px; cursor: pointer; }
    .status { font-size: 12px; color: #333; margin-top: 6px; white-space: pre-wrap; }
    .entity { border-top: 1px dashed #ddd; margin-top: 8px; padding-top: 8px; }
    .entity-title { font-weight: 600; margin-bottom: 4px; }
  </style>
</head>
<body>
  <h1>Colors Expansion</h1>
  <div id="content"></div>

  <script>
    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function openEntityInNewTab(entityText, colorId, groupKey, idx) {
      const w = window.open('', '_blank');
      if (!w) return;
      w.document.write(`<!DOCTYPE html><html><head><title>${escapeHtml(groupKey)} #${idx + 1} (Color ${colorId})</title></head><body style="font-family:sans-serif; padding:20px;"><h2>${escapeHtml(groupKey)} — Entity ${idx + 1} (Color ${colorId})</h2><pre style="white-space:pre-wrap;">${escapeHtml(entityText)}</pre></body></html>`);
      w.document.close();
    }

    async function fetchEntitiesForColor(colorId) {
      // expects backend route GET /colors/entities/by_color/<colorId>
      const res = await fetch(`/colors/entities/by_color/${colorId}`);
      if (!res.ok) return null;
      const rows = await res.json();
      if (!Array.isArray(rows) || rows.length === 0) return null;

      const latest = rows[0];
      let payload = latest.entities_json;
      if (typeof payload === 'string') {
        try { payload = JSON.parse(payload); } catch { /* ignore */ }
      }
      return payload && typeof payload === 'object' ? payload : null;
    }

    async function enqueueEntities(colorId, statusDiv, entitiesDiv) {
      statusDiv.textContent = 'Queued entity extraction…';

      const res = await fetch('/colors/entities', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ color_id: colorId })
      });
      const data = await res.json();
      if (!res.ok) {
        statusDiv.textContent = data.message || 'Error queueing entities.';
        return;
      }

      const taskId = data.task_id;
      statusDiv.textContent = `Entities queued (task ${taskId}). Waiting…`;

      try {
        const result = await pollTask(taskId, statusDiv);
        statusDiv.textContent = `Entities done. Saved #${result.saved_entities?.id || ''}.`;

        const entitiesPayload = await fetchEntitiesForColor(colorId);
        renderEntities(entitiesDiv, entitiesPayload, colorId);
      } catch (e) {
        statusDiv.textContent = `Entities error: ${e.message || e}`;
      }
    }

    async function pollTask(taskId, statusDiv) {
      while (true) {
        const r = await fetch(`/colors/tasks/${taskId}`);
        const t = await r.json();
        if (!r.ok) throw new Error(t.message || 'Polling failed');
        if (t.status === 'done') return t.result;
        if (t.status === 'error') throw new Error(t.error || 'Task error');
        statusDiv.textContent = `Status: ${t.status}…`;
        await new Promise(ok => setTimeout(ok, 2000));
      }
    }

    function renderEntities(entitiesDiv, payload, colorId) {
      entitiesDiv.innerHTML = '';
      if (!payload) {
        entitiesDiv.innerHTML = '<em>No entities yet.</em>';
        return;
      }

      const keys = Object.keys(payload);
      if (keys.length === 0) {
        entitiesDiv.innerHTML = '<em>No entities yet.</em>';
        return;
      }

      keys.forEach(groupKey => {
        const items = payload[groupKey];
        if (!Array.isArray(items) || items.length === 0) return;

        const groupBlock = document.createElement('div');
        groupBlock.className = 'entity';
        groupBlock.innerHTML = `<div class="entity-title">${escapeHtml(groupKey)} (${items.length})</div>`;

        items.forEach((entityText, idx) => {
          const row = document.createElement('div');
          row.style.marginBottom = '6px';
          row.innerHTML = `
            <div style="white-space:pre-wrap; margin-bottom:4px;">${escapeHtml(entityText)}</div>
            <button onclick="openEntityInNewTab(${JSON.stringify(entityText)}, ${colorId}, ${JSON.stringify(groupKey)}, ${idx})">Open in new tab</button>
          `;
          groupBlock.appendChild(row);
        });

        entitiesDiv.appendChild(groupBlock);
      });

      if (!entitiesDiv.innerHTML.trim()) {
        entitiesDiv.innerHTML = '<em>No entities yet.</em>';
      }
    }

    async function loadColor() {
      const params = new URLSearchParams(window.location.search);
      const artId = params.get('art_id');
      if (!artId) {
        document.getElementById('content').textContent = 'Missing art_id parameter.';
        return;
      }

      try {
        const res = await fetch(`/colors/by_art/${artId}`);
        const data = await res.json();
        const container = document.getElementById('content');
        container.innerHTML = '';

        if (!Array.isArray(data) || data.length === 0) {
          container.textContent = 'No colors expansions found for this art.';
          return;
        }

        for (const entry of data) {
          const div = document.createElement('div');
          div.className = 'block';

          const entitiesDivId = `entities-${entry.id}`;
          const statusDivId = `status-${entry.id}`;

          div.innerHTML = `
            <strong>Color ID:</strong> ${entry.id}<br>
            <strong>Art ID:</strong> ${entry.art_id}<br>
            <strong>Model:</strong> ${entry.model}<br>
            <strong>Temperature:</strong> ${entry.temperature}<br>
            <strong>Created:</strong> ${entry.created_at}<br>
            <pre>${escapeHtml(entry.output_text)}</pre>

            <div class="controls">
              <button id="gen-entities-btn-${entry.id}">Extract Entities</button>
            </div>
            <div id="${statusDivId}" class="status"></div>
            <div id="${entitiesDivId}" class="status" style="margin-top:8px;"></div>
          `;

          container.appendChild(div);

          const statusDiv = document.getElementById(statusDivId);
          const entitiesDiv = document.getElementById(entitiesDivId);
          const genBtn = document.getElementById(`gen-entities-btn-${entry.id}`);

          genBtn.onclick = () => enqueueEntities(entry.id, statusDiv, entitiesDiv);

          const entitiesPayload = await fetchEntitiesForColor(entry.id);
          renderEntities(entitiesDiv, entitiesPayload, entry.id);
        }

      } catch (e) {
        document.getElementById('content').textContent = 'Error: ' + e;
      }
    }

    loadColor();
  </script>
</body>
</html>

