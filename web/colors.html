<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Colors Viewer</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .block { border: 1px solid #ccc; padding: 12px; margin-bottom: 16px; border-radius: 8px; }
    pre { white-space: pre-wrap; }

    .controls { margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap; }
    button { padding: 6px 10px; cursor: pointer; }
    .status { font-size: 12px; color: #333; margin-top: 6px; white-space: pre-wrap; }

    /* Collapsible groups */
    .entity-group { border-top: 1px dashed #ddd; margin-top: 10px; padding-top: 8px; }
    .entity-header {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      font-weight: 700;
      padding: 6px 4px;
      border-radius: 6px;
      background: #f7f7f7;
    }
    .entity-header:hover { background: #efefef; }
    .entity-caret {
      width: 18px;
      text-align: center;
      font-size: 12px;
    }
    .entity-count {
      font-weight: 400;
      font-size: 12px;
      color: #555;
    }
    .entity-body { margin-top: 8px; padding-left: 6px; }
    .entity-item { margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
    .entity-item:last-child { border-bottom: none; }
    .entity-name { font-weight: 600; margin-bottom: 4px; }
    .entity-text { white-space: pre-wrap; margin: 4px 0; }
  </style>
</head>
<body>
  <h1>Colors Expansion</h1>
  <div id="content"></div>

  <script>
    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function openEntityInNewTab(entityObj, colorId, groupKey, idx) {
      const w = window.open('', '_blank');
      if (!w) return;

      const name = escapeHtml(entityObj.name || '');
      const desc = escapeHtml(entityObj.description || '');
      const role = escapeHtml(entityObj.role_in_thought || '');

      w.document.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <title>${escapeHtml(groupKey)} #${idx + 1} (Color ${colorId})</title>
          </head>
          <body style="font-family:sans-serif; padding:20px;">
            <h2>${escapeHtml(groupKey)} — Entity ${idx + 1} (Color ${colorId})</h2>
            <h3>${name}</h3>
            <p><strong>Description:</strong> ${desc}</p>
            <p><strong>Role in thought:</strong> ${role}</p>
            <pre style="white-space:pre-wrap;">${escapeHtml(JSON.stringify(entityObj, null, 2))}</pre>
          </body>
        </html>
      `);
      w.document.close();
    }

    async function fetchEntitiesForColor(colorId) {
      const res = await fetch(`/colors/entities/by_color/${colorId}`);
      if (!res.ok) return null;

      const rows = await res.json();
      if (!Array.isArray(rows) || rows.length === 0) return null;

      const latest = rows[0];
      let payload = latest.entities_json;
      if (typeof payload === 'string') {
        try { payload = JSON.parse(payload); } catch { /* ignore */ }
      }
      return payload || null;
    }

    async function enqueueEntities(colorId, statusDiv, entitiesDiv) {
      statusDiv.textContent = 'Queued entities…';

      const res = await fetch('/colors/entities', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ color_id: colorId })
      });
      const data = await res.json();
      if (!res.ok) {
        statusDiv.textContent = data.message || 'Error queueing entities.';
        return;
      }

      const taskId = data.task_id;
      statusDiv.textContent = `Entities queued (task ${taskId}). Waiting…`;

      try {
        const result = await pollTask(taskId, statusDiv);
        statusDiv.textContent = `Entities done. Saved #${result.saved_entities?.id || ''}.`;

        const payload = await fetchEntitiesForColor(colorId);
        renderEntities(entitiesDiv, payload, colorId);
      } catch (e) {
        statusDiv.textContent = `Entities error: ${e.message || e}`;
      }
    }

    async function pollTask(taskId, statusDiv) {
      while (true) {
        const r = await fetch(`/colors/tasks/${taskId}`);
        const t = await r.json();
        if (!r.ok) throw new Error(t.message || 'Polling failed');
        if (t.status === 'done') return t.result;
        if (t.status === 'error') throw new Error(t.error || 'Task error');
        statusDiv.textContent = `Status: ${t.status}…`;
        await new Promise(ok => setTimeout(ok, 1200));
      }
    }

    function renderEntities(entitiesDiv, payload, colorId) {
      entitiesDiv.innerHTML = '';
      if (!payload || typeof payload !== 'object') {
        entitiesDiv.innerHTML = '<em>No entities yet.</em>';
        return;
      }

      const keys = Object.keys(payload);
      let renderedAnything = false;

      keys.forEach(groupKey => {
        const items = payload[groupKey];
        if (!Array.isArray(items) || items.length === 0) {
          return; // skip empty groups
        }

        renderedAnything = true;

        const groupBlock = document.createElement('div');
        groupBlock.className = 'entity-group';

        const header = document.createElement('div');
        header.className = 'entity-header';

        const caret = document.createElement('div');
        caret.className = 'entity-caret';
        caret.textContent = '▾'; // expanded by default

        const title = document.createElement('div');
        title.innerHTML = `${escapeHtml(groupKey)} <span class="entity-count">(${items.length})</span>`;

        header.appendChild(caret);
        header.appendChild(title);

        const body = document.createElement('div');
        body.className = 'entity-body';

        // default: expanded if has items
        let isOpen = true;

        header.onclick = () => {
          isOpen = !isOpen;
          body.style.display = isOpen ? 'block' : 'none';
          caret.textContent = isOpen ? '▾' : '▸';
        };

        items.forEach((entityObj, idx) => {
          if (!entityObj || typeof entityObj !== 'object') return;

          const name = escapeHtml(entityObj.name || '');
          const desc = escapeHtml(entityObj.description || '');
          const role = escapeHtml(entityObj.role_in_thought || '');

          const row = document.createElement('div');
          row.className = 'entity-item';
          row.innerHTML = `
            <div class="entity-name">${name}</div>
            <div class="entity-text"><strong>Description:</strong> ${desc}</div>
            <div class="entity-text"><strong>Role:</strong> ${role}</div>
            <button onclick='openEntityInNewTab(${JSON.stringify(entityObj)}, ${colorId}, ${JSON.stringify(groupKey)}, ${idx})'>
              Open in new tab
            </button>
          `;
          body.appendChild(row);
        });

        groupBlock.appendChild(header);
        groupBlock.appendChild(body);
        entitiesDiv.appendChild(groupBlock);
      });

      if (!renderedAnything) {
        entitiesDiv.innerHTML = '<em>No entities yet.</em>';
      }
    }

    async function loadColor() {
      const params = new URLSearchParams(window.location.search);
      const artId = params.get('art_id');
      if (!artId) {
        document.getElementById('content').textContent = 'Missing art_id parameter.';
        return;
      }

      try {
        const res = await fetch(`/colors/by_art/${artId}`);
        const data = await res.json();
        const container = document.getElementById('content');
        container.innerHTML = '';

        if (!Array.isArray(data) || data.length === 0) {
          container.textContent = 'No colors expansions found for this art.';
          return;
        }

        for (const entry of data) {
          const div = document.createElement('div');
          div.className = 'block';

          const entitiesDivId = `entities-${entry.id}`;
          const statusDivId = `status-${entry.id}`;

          div.innerHTML = `
            <strong>Color ID:</strong> ${entry.id}<br>
            <strong>Art ID:</strong> ${entry.art_id}<br>
            <strong>Model:</strong> ${entry.model}<br>
            <strong>Temperature:</strong> ${entry.temperature}<br>
            <strong>Created:</strong> ${entry.created_at}<br>
            <pre>${escapeHtml(entry.output_text)}</pre>

            <div class="controls">
              <button id="gen-entities-btn-${entry.id}">Extract Entities</button>
            </div>
            <div id="${statusDivId}" class="status"></div>
            <div id="${entitiesDivId}" class="status" style="margin-top:8px;"></div>
          `;

          container.appendChild(div);

          const statusDiv = document.getElementById(statusDivId);
          const entitiesDiv = document.getElementById(entitiesDivId);
          const genBtn = document.getElementById(`gen-entities-btn-${entry.id}`);

          genBtn.onclick = () => enqueueEntities(entry.id, statusDiv, entitiesDiv);

          const payload = await fetchEntitiesForColor(entry.id);
          renderEntities(entitiesDiv, payload, entry.id);
        }

      } catch (e) {
        document.getElementById('content').textContent = 'Error: ' + e;
      }
    }

    loadColor();
  </script>
</body>
</html>
