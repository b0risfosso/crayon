<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manage Box of Dirt</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
      color: #333;
  }
  .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }
  h1, h2, h3 {
      font-weight: 600;
      color: #222;
  }
  .meta {
      margin-bottom: 15px;
      font-size: 14px;
      color: #555;
  }
  label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
  }
  input[type="text"], input[type="file"], select {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 4px;
  }
  button {
      background: #0066cc;
      color: white;
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 12px;
  }
  button:hover {
      background: #004c99;
  }
  .forms {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
  }
  .card {
      flex: 1 1 260px;
      padding: 12px 16px;
      border-radius: 8px;
      background: #fafafa;
      border: 1px solid #ddd;
  }
  .tree {
      margin-top: 20px;
  }
  .node {
      padding: 4px 0;
      font-family: monospace;
  }
  .node.chunk {
      font-weight: bold;
  }
  .node.particle {
      color: #444;
  }
  .node .kind {
      font-size: 11px;
      text-transform: uppercase;
      color: #888;
      margin-right: 6px;
  }
  .error {
      color: #b30000;
      margin-top: 8px;
      font-weight: bold;
  }
  .success {
      color: #007700;
      margin-top: 8px;
      font-weight: bold;
  }
  a {
      color: #0066cc;
  }
</style>
</head>
<body>

<div class="container">
  <h1>Manage Box of Dirt</h1>
  <p><a href="/boxes.html">&larr; Back to boxes</a></p>

  <div id="boxMeta" class="meta"></div>
  <div id="message"></div>

  <div class="forms">
    <!-- Create chunk (folder) -->
    <div class="card">
      <h3>Create Chunk (Folder)</h3>
      <label for="chunkParent">Parent path (optional)</label>
      <input id="chunkParent" type="text" placeholder="e.g. chunk_a/chunk_a1 or blank for root">

      <label for="chunkName">Folder name</label>
      <input id="chunkName" type="text" placeholder="e.g. chunk_b">

      <button onclick="createChunk()">Create Chunk</button>
    </div>

    <!-- Upload particle (file) -->
    <div class="card">
      <h3>Upload Particle (File)</h3>
      <label for="fileParentSelect">Parent chunk</label>
      <select id="fileParentSelect">
        <!-- options populated from chunks; root is "" -->
        <option value="">(root)</option>
      </select>

      <label for="fileInput">File</label>
      <input id="fileInput" type="file">

      <button onclick="uploadParticle()">Upload Particle</button>
    </div>
  </div>

  <h2>Contents</h2>
  <div id="tree" class="tree"></div>
</div>

<script>
let currentSlug = null;
let currentNodes = [];

function getQueryParam(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}

function setMessage(html, cls) {
  const el = document.getElementById("message");
  el.innerHTML = html ? `<div class="${cls}">${html}</div>` : "";
}

async function loadBoxInfo(slug) {
  const res = await fetch(`/dirt/boxes/${encodeURIComponent(slug)}`);
  if (!res.ok) {
      throw new Error("Box not found");
  }
  return res.json();
}

async function loadNodes(slug) {
  const res = await fetch(`/dirt/boxes/${encodeURIComponent(slug)}/nodes`);
  if (!res.ok) {
      throw new Error("Failed to load nodes");
  }
  return res.json();
}

function renderBoxMeta(box) {
  const meta = document.getElementById("boxMeta");
  meta.innerHTML = `
    <strong>Slug:</strong> ${box.slug}
    ${box.title ? ` â€” <strong>${box.title}</strong>` : ""}
    <br>
    <strong>Root path:</strong> ${box.root_path}
  `;
}

function populateParentDropdown() {
  const select = document.getElementById("fileParentSelect");
  // Remember current selection so we don't annoy user when refreshing
  const previous = select.value;

  // Clear and add root option
  select.innerHTML = "";
  const rootOpt = document.createElement("option");
  rootOpt.value = "";
  rootOpt.textContent = "(root)";
  select.appendChild(rootOpt);

  // Add each chunk as an option, using its rel_path
  const chunks = currentNodes.filter(n => n.kind === "chunk");

  chunks.forEach(chunk => {
      const opt = document.createElement("option");
      opt.value = chunk.rel_path;  // used as parent_rel_path
      // label: human name if present, fallback to rel_path
      opt.textContent = chunk.name || chunk.rel_path || "(unnamed chunk)";
      select.appendChild(opt);
  });

  // Restore previous selection if still present
  const maybe = Array.from(select.options).find(o => o.value === previous);
  if (maybe) {
      select.value = previous;
  } else {
      select.value = "";
  }
}

// Track expanded/collapsed state
let expanded = {};

function buildTree(nodes) {
    const map = {};
    nodes.forEach(n => {
        map[n.id] = { ...n, children: [] };
    });

    let rootNode = null;

    nodes.forEach(n => {
        if (n.parent_id === null) return;

        if (map[n.parent_id]) {
            map[n.parent_id].children.push(map[n.id]);
        }
    });

    // find box_root
    rootNode = nodes.find(n => n.kind === "box_root");
    return map[rootNode.id]; // return the root tree node
}

function renderTreeNode(node, container, depth = 0) {
    const div = document.createElement("div");
    div.className = `node ${node.kind}`;
    div.style.paddingLeft = (depth * 16) + "px";

    const hasChildren = node.children && node.children.length > 0;
    const label = node.name || node.rel_path || "(root)";

    let toggle = "";
    if (hasChildren && node.kind === "chunk") {
        toggle = expanded[node.id] ? "[-]" : "[+]";
    }

    div.innerHTML = `
        <span class="kind">[${node.kind}]</span>
        <span class="toggle" style="cursor:pointer; margin-right:6px;">${toggle}</span>
        ${label}
        ${node.kind !== "box_root" ? `
        <button onclick="deleteNode(${node.id}, '${node.kind}')">Delete</button>
        ` : ""}
    `;

    // clicking toggle expands/collapses
    div.querySelector(".toggle")?.addEventListener("click", (ev) => {
        ev.stopPropagation();
        expanded[node.id] = !expanded[node.id];
        renderNodes(currentNodes);
    });

    container.appendChild(div);

    // render children only if expanded
    if (hasChildren && expanded[node.id]) {
        node.children.forEach(child => {
            renderTreeNode(child, container, depth + 1);
        });
    }
}

function renderNodes(nodes) {
    const tree = document.getElementById("tree");
    tree.innerHTML = "";

    if (!nodes.length) {
        tree.innerHTML = "<p>No chunks or particles yet.</p>";
        return;
    }

    const root = buildTree(nodes);
    renderTreeNode(root, tree, 0);
}


async function refreshAll() {
  setMessage("", "");
  const slug = currentSlug;
  try {
      const box = await loadBoxInfo(slug);
      renderBoxMeta(box);
      const nodes = await loadNodes(slug);
      currentNodes = nodes;
      renderNodes(nodes);
      populateParentDropdown();
  } catch (err) {
      console.error(err);
      setMessage(err.message, "error");
  }
}

async function createChunk() {
  const parentRel = document.getElementById("chunkParent").value.trim();
  const name = document.getElementById("chunkName").value.trim();

  if (!name) {
      setMessage("Folder name is required.", "error");
      return;
  }

  setMessage("", "");

  try {
      const res = await fetch(`/dirt/boxes/${encodeURIComponent(currentSlug)}/nodes`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
              kind: "chunk",
              parent_rel_path: parentRel,
              name: name
          })
      });
      const data = await res.json();
      if (!res.ok) {
          throw new Error(data.error || "Failed to create chunk");
      }
      setMessage("Chunk created.", "success");
      document.getElementById("chunkName").value = "";
      await refreshAll();
  } catch (err) {
      console.error(err);
      setMessage(err.message, "error");
  }
}

async function uploadParticle() {
  const parentRel = document.getElementById("fileParentSelect").value;
  const fileInput = document.getElementById("fileInput");
  const file = fileInput.files[0];

  if (!file) {
      setMessage("Please choose a file.", "error");
      return;
  }

  setMessage("", "");

  const formData = new FormData();
  formData.append("kind", "particle");
  formData.append("parent_rel_path", parentRel);
  formData.append("file", file);

  try {
      const res = await fetch(`/dirt/boxes/${encodeURIComponent(currentSlug)}/nodes`, {
          method: "POST",
          body: formData
      });
      const data = await res.json();
      if (!res.ok) {
          throw new Error(data.error || "Failed to upload particle");
      }
      setMessage("Particle uploaded.", "success");
      fileInput.value = "";
      await refreshAll();
  } catch (err) {
      console.error(err);
      setMessage(err.message, "error");
  }
}

async function deleteNode(id, kind) {
  const confirmMsg =
    kind === "chunk"
      ? "Delete this folder and ALL of its contents?"
      : "Delete this file?";

  if (!confirm(confirmMsg)) return;

  setMessage("", "");

  try {
      const res = await fetch(
          `/dirt/boxes/${encodeURIComponent(currentSlug)}/nodes/${id}`,
          { method: "DELETE" }
      );

      const data = await res.json();

      if (!res.ok) {
          throw new Error(data.error || "Failed to delete");
      }

      setMessage(`${kind} deleted.`, "success");
      await refreshAll();
  } catch (err) {
      console.error(err);
      setMessage(err.message, "error");
  }
}

document.addEventListener("DOMContentLoaded", async () => {
  const slug = getQueryParam("box");
  if (!slug) {
      setMessage("Missing ?box=<slug> in URL.", "error");
      return;
  }
  currentSlug = slug;
  await refreshAll();
});
</script>

</body>
</html>
