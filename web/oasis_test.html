<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Oasis Bridge Test</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, sans-serif; background: #f7f7f7; color: #111; }
    main { max-width: 1000px; margin: 0 auto; padding: 24px 18px 48px; }
    header { display: flex; justify-content: space-between; align-items: baseline; gap: 12px; margin-bottom: 16px; }
    h1 { margin: 0; font-size: 22px; }
    .muted { color: #666; font-size: 13px; }
    .card { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; padding: 14px 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); }
    form { display: grid; grid-template-columns: 1fr; gap: 10px; }
    label { font-size: 13px; font-weight: 600; }
    input, textarea, select { width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 8px; border: 1px solid #d9d9d9; font-size: 14px; font-family: inherit; background: #fbfbfb; }
    textarea { min-height: 120px; resize: vertical; }
    button { padding: 9px 12px; border-radius: 8px; border: 1px solid #c9c9c9; background: linear-gradient(180deg, #fff, #f0f0f0); cursor: pointer; font-weight: 600; font-size: 14px; }
    button:hover { background: #f7f7f7; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 16px; }
    .results { margin-top: 18px; display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px) {
      .results { grid-template-columns: 1fr 1fr; }
    }
    .history { margin-top: 18px; display: grid; grid-template-columns: 1fr; gap: 10px; }
    .history details { border: 1px solid #e6e6e6; border-radius: 10px; background: #fff; padding: 10px 12px; }
    .history summary { cursor: pointer; font-weight: 700; display: flex; align-items: center; gap: 8px; list-style: none; }
    .history summary::-webkit-details-marker { display: none; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef3ff; color: #325ac0; font-size: 11px; border: 1px solid #d7e1ff; }
    pre { white-space: pre-wrap; line-height: 1.6; margin: 0; }
    .error { color: #b00020; font-size: 13px; }
  </style>
</head>
<body>
  <main>
    <header>
      <div>
        <h1>Oasis Bridge Test</h1>
        <div class="muted">Select an entity, provide thought + analysis, then run the bridge pipeline.</div>
      </div>
      <div id="status" class="muted"></div>
    </header>

    <section class="card">
      <form id="bridgeForm">
        <div>
          <label for="entitySelect">Entity (material / energetic / monetary system)</label>
          <select id="entitySelect" required></select>
          <div id="entityDesc" class="muted" style="margin-top:6px;"></div>
        </div>
        <div>
          <label for="thoughtInput">Thought input</label>
          <textarea id="thoughtInput" placeholder="Paste thought text..."></textarea>
        </div>
        <div>
          <label for="analysisInput">Analysis input</label>
          <textarea id="analysisInput" placeholder="Paste analysis text..."></textarea>
        </div>
        <button type="submit" id="submitButton">Run bridges</button>
        <div id="formError" class="error" role="alert" aria-live="polite"></div>
      </form>
    </section>

    <section class="results">
      <div class="card">
        <h2 style="margin:0 0 8px; font-size:16px;">Bridges</h2>
        <pre id="bridgesOutput" class="muted">No output yet.</pre>
      </div>
      <div class="card">
        <h2 style="margin:0 0 8px; font-size:16px;">Sources</h2>
        <pre id="sourcesOutput" class="muted">No output yet.</pre>
      </div>
    </section>

    <section class="history">
      <div class="card">
        <h2 style="margin:0 0 8px; font-size:16px;">Previous runs</h2>
        <div id="historyList" class="muted">Select an entity to load history.</div>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = "/oasis";
    const entitySelect = document.getElementById("entitySelect");
    const entityDesc = document.getElementById("entityDesc");
    const thoughtInput = document.getElementById("thoughtInput");
    const analysisInput = document.getElementById("analysisInput");
    const bridgesOutput = document.getElementById("bridgesOutput");
    const sourcesOutput = document.getElementById("sourcesOutput");
    const historyList = document.getElementById("historyList");
    const formError = document.getElementById("formError");
    const statusEl = document.getElementById("status");
    const submitButton = document.getElementById("submitButton");

    let entities = [];

    async function loadEntities() {
      entitySelect.innerHTML = "";
      try {
        const res = await fetch(API_BASE);
        if (!res.ok) throw new Error("Failed to load entities");
        entities = await res.json();
        if (!entities.length) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No entities available";
          entitySelect.appendChild(opt);
          entitySelect.disabled = true;
          return;
        }
        entities.forEach((entity, idx) => {
          const opt = document.createElement("option");
          opt.value = entity.id;
          opt.textContent = entity.name || `Entity ${entity.id}`;
          if (idx === 0) opt.selected = true;
          entitySelect.appendChild(opt);
        });
        entitySelect.disabled = false;
        updateEntityDescription();
        await loadHistory();
      } catch (err) {
        formError.textContent = err.message || "Could not load entities.";
      }
    }

    function updateEntityDescription() {
      const selectedId = entitySelect.value;
      const entity = entities.find((e) => String(e.id) === String(selectedId));
      entityDesc.textContent = entity ? (entity.description || "No description.") : "";
    }

    entitySelect.addEventListener("change", async () => {
      updateEntityDescription();
      await loadHistory();
    });

    document.getElementById("bridgeForm").addEventListener("submit", async (event) => {
      event.preventDefault();
      formError.textContent = "";
      bridgesOutput.textContent = "Running...";
      sourcesOutput.textContent = "Running...";
      statusEl.textContent = "Queued...";

      const entityId = entitySelect.value;
      const thought = thoughtInput.value.trim();
      const analysis = analysisInput.value.trim();

      if (!entityId) {
        formError.textContent = "Select an entity.";
        return;
      }
      if (!thought || !analysis) {
        formError.textContent = "Thought and analysis are required.";
        return;
      }

      submitButton.disabled = true;

      try {
        const res = await fetch(`${API_BASE}/bridge`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            entity_id: Number(entityId),
            thought,
            analysis
          })
        });
        if (!res.ok) {
          const msg = await res.text();
          throw new Error(msg || "Request failed");
        }
        const data = await res.json();
        await pollTask(data.task_id);
      } catch (err) {
        formError.textContent = err.message || "Failed to enqueue task.";
        bridgesOutput.textContent = "No output.";
        sourcesOutput.textContent = "No output.";
        statusEl.textContent = "";
      } finally {
        submitButton.disabled = false;
      }
    });

    async function pollTask(taskId) {
      const pollInterval = 2000;
      while (true) {
        const res = await fetch(`${API_BASE}/llm/tasks/${taskId}`);
        if (!res.ok) {
          formError.textContent = "Unable to read task status.";
          statusEl.textContent = "";
          return;
        }
        const task = await res.json();
        statusEl.textContent = task.status || "unknown";
        if (task.status === "done") {
          bridgesOutput.textContent = task.result?.bridge_text || "No bridge output.";
          sourcesOutput.textContent = task.result?.sources_text || "No sources output.";
          await loadHistory();
          statusEl.textContent = "done";
          return;
        }
        if (task.status === "error") {
          bridgesOutput.textContent = "Failed.";
          sourcesOutput.textContent = "Failed.";
          formError.textContent = task.error || "Task failed.";
          statusEl.textContent = "error";
          return;
        }
        await new Promise((resolve) => setTimeout(resolve, pollInterval));
      }
    }

    async function loadHistory() {
      const entityId = entitySelect.value;
      historyList.textContent = "Loading...";
      if (!entityId) {
        historyList.textContent = "Select an entity to load history.";
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/bridge/runs?entity_id=${encodeURIComponent(entityId)}`);
        if (!res.ok) throw new Error("Failed to load history");
        const runs = await res.json();
        renderHistory(Array.isArray(runs) ? runs : []);
      } catch (err) {
        historyList.textContent = err.message || "Could not load history.";
      }
    }

    function renderHistory(runs) {
      historyList.innerHTML = "";
      if (!runs.length) {
        historyList.textContent = "No runs yet for this entity.";
        return;
      }
      runs.forEach((run) => {
        const wrapper = document.createElement("details");
        const summary = document.createElement("summary");
        const when = run.created_at || "unknown time";
        summary.textContent = when;
        const pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = `#${run.id}`;
        summary.appendChild(pill);

        const bridgeBlock = document.createElement("pre");
        bridgeBlock.textContent = run.bridge_text || "No bridge output.";

        const sourcesBlock = document.createElement("pre");
        sourcesBlock.textContent = run.sources_text || "No sources output.";

        wrapper.appendChild(summary);
        wrapper.appendChild(bridgeBlock);
        wrapper.appendChild(sourcesBlock);
        historyList.appendChild(wrapper);
      });
    }

    loadEntities();
  </script>
</body>
</html>
