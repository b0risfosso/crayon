<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Fantasiagenesis ‚Äî Create</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--bg:#f5f5f5;--card:#ffffff;--accent:#4aa3ff;}
    html,body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);}    /* top bar */
    nav{display:flex;align-items:center;gap:14px;padding:12px 20px;background:#222;color:#eee;font-size:14px}
    nav a{color:#9fd3ff;text-decoration:none;}

    main{max-width:900px;margin:0 auto;padding:32px 20px 60px;}

    /* cards for narratives */
    details.narr{background:var(--card);border:1px solid #ccc;border-radius:8px;margin-bottom:16px;box-shadow:0 2px 6px rgba(0,0,0,.06);overflow:hidden;transition:border-color .15s;}
    details.narr[open]{border-color:var(--accent);}

    summary{cursor:pointer;padding:14px 20px;display:flex;align-items:center;gap:12px;font-weight:600;list-style:none;}
    summary::-webkit-details-marker{display:none;}
    .title{flex:1;}
    .enter-btn{padding:4px 10px;font-size:13px;border:1px solid var(--accent);border-radius:6px;background:#fff;color:var(--accent);text-decoration:none;transition:.15s;white-space:nowrap;}
    .enter-btn:hover{background:var(--accent);color:#fff;}

    .note-body{padding:16px 20px 24px;border-top:1px solid #eee;white-space:pre-wrap;line-height:1.4;font-size:15px;}

    #status{text-align:center;font-size:1rem;color:#666;margin-top:60px;}
  </style>
</head>
<body>
  <nav>
    <a href="index.html">‚Üê Home</a>
    <span>Fantasia ‚Äì Narratives</span>
  </nav>

  <main id="listContainer"><div id="status">Loading‚Ä¶</div></main>

  <script type="module">
    const PREFIX='fantasia-';
    const list=document.getElementById('listContainer');

    init();

    async function init(){
      try{
        const cats=await fetchJson('/api/narratives');
        const fantCats=cats.filter(c=>c.id.startsWith(PREFIX));
        if(!fantCats.length){list.innerHTML='<div id="status">No Fantasia narratives yet.</div>';return;}

        // fetch all histories in parallel
        const sets=await Promise.all(fantCats.map(cat=>fetchJson(`/api/history?narrative=${encodeURIComponent(cat.id)}`)));

        list.innerHTML='';
        fantCats.forEach((cat,idx)=>renderNarrative(cat,sets[idx]));
      }catch(err){list.innerHTML='<div id="status">Failed to load.</div>';console.error(err);}  
    }

    function renderNarrative(cat,rows){
      const roots=rows.filter(r=>!r.parent);
      const det=document.createElement('details');det.className='narr';
      const sum=document.createElement('summary');
      const title=document.createElement('span');title.className='title';title.textContent=cat.title;
      sum.append(title);
      det.append(sum);

      if(!roots.length){
        const empty=document.createElement('div');empty.className='note-body';empty.textContent='(No notes yet)';
        det.append(empty);
      }else{
        roots.forEach(item=>{
          const sub=document.createElement('details');sub.className='narr';
          const ssum=document.createElement('summary');
          const stitle=document.createElement('span');stitle.className='title';stitle.textContent=`üó®Ô∏è ${item.user?.slice(0,120)||'(system)'}`;
          const btn=document.createElement('a');btn.className='enter-btn';btn.textContent='Enter';btn.href=`entry.html?id=${item.id}`;
          ssum.append(stitle,btn);
          const body=document.createElement('div');body.className='note-body';body.textContent=item.answer;
          sub.append(ssum,body);
          det.append(sub);
        });
      }
      list.appendChild(det);
    }

    async function fetchJson(url){
      const r=await fetch(url);
      if(!r.ok) throw new Error(r.statusText);
      return r.json();
    }
  </script>
</body>
</html>
