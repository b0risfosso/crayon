<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Fantasiagenesis ‚Äî Fantasia</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--bg:#f5f5f5;--card:#ffffff;--accent:#4aa3ff;}
    html,body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);}
    nav{display:flex;align-items:center;gap:14px;padding:12px 20px;background:#222;color:#eee;font-size:14px}
    nav a{color:#9fd3ff;text-decoration:none;}

    main{max-width:900px;margin:0 auto;padding:32px 20px 80px;}

    /* cards */
    .card{background:var(--card);border:1px solid #ccc;border-radius:10px;margin-bottom:18px;box-shadow:0 2px 6px rgba(0,0,0,.06);overflow:hidden}
    .card .head{padding:12px 16px;font-weight:700;border-bottom:1px solid #eee;}
    .card .body{padding:16px;}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 260px}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input[type="text"], select, textarea{width:100%;padding:8px;border:1px solid #bbb;border-radius:6px;font-family:inherit;font-size:14px}
    textarea{min-height:100px}
    button{margin-top:10px;padding:8px 14px;border:none;border-radius:6px;background:var(--accent);color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:default}
    pre.output{white-space:pre-wrap;overflow-wrap:anywhere;border:1px solid #ccc;background:#f7f7f7;border-radius:6px;padding:10px;margin-top:10px}

    /* narrative list */
    details.narr{background:var(--card);border:1px solid #ccc;border-radius:8px;margin-bottom:16px;box-shadow:0 2px 6px rgba(0,0,0,.06);overflow:hidden;transition:border-color .15s;}
    details.narr[open]{border-color:var(--accent);}
    summary{cursor:pointer;padding:14px 20px;display:flex;align-items:center;gap:12px;font-weight:600;list-style:none;}
    summary::-webkit-details-marker{display:none;}
    .title{flex:1;}
    .enter-btn{padding:4px 10px;font-size:13px;border:1px solid var(--accent);border-radius:6px;background:#fff;color:var(--accent);text-decoration:none;transition:.15s;white-space:nowrap;}
    .enter-btn:hover{background:var(--accent);color:#fff;}
    .note-body{padding:16px 20px 24px;border-top:1px solid #eee;white-space:pre-wrap;line-height:1.4;font-size:15px;}
    #status{text-align:center;font-size:1rem;color:#666;margin-top:20px;}
  </style>
</head>
<body>
  <nav>
    <a href="index.html">‚Üê Home</a>
    <span>Fantasia ‚Äì All Narratives</span>
  </nav>

  <main>
    <!-- Create Category (defaults to Fantasia) -->
    <section class="card">
      <div class="head">Create Category (Fantasia)</div>
      <div class="body">
        <div class="row">
          <div>
            <label for="catTitle">Title</label>
            <input id="catTitle" type="text" placeholder="e.g., rocks">
          </div>
        </div>
        <button id="createCatBtn">Create Category</button>
        <div id="catMsg" style="margin-top:8px;color:#444;"></div>
      </div>
    </section>

    <!-- LLM Generate Note -->
    <section class="card">
      <div class="head">Generate Note with LLM</div>
      <div class="body">
        <div class="row">
          <div>
            <label for="tplSel">Template</label>
            <select id="tplSel">
              <option value="">‚Äî choose a template ‚Äî</option>
              <option value="narr">Scientific Narrative</option>
              <option value="theory">Theory / Method</option>
              <option value="hypo">Hypothesis List</option>
            </select>
          </div>
          <div>
            <label for="targetPage">Save into Narrative</label>
            <select id="targetPage"></select>
          </div>
        </div>

        <label><input type="checkbox" id="testMode"> Test mode ‚Äî do NOT save</label>

        <label for="sys">System message</label>
        <textarea id="sys"></textarea>

        <label for="usr">User message</label>
        <textarea id="usr"></textarea>

        <button id="askBtn">Ask & Save</button>
        <pre id="llmOut" class="output" style="display:none;"></pre>
      </div>
    </section>

    <!-- Listing -->
    <section id="listContainer" class="card">
      <div class="head">Fantasia Narratives</div>
      <div class="body"><div id="status">Loading‚Ä¶</div></div>
    </section>
  </main>

  <script type="module">
    const PREFIX='fantasia-';  // default & only section here

    // Templates for LLM
    const TEMPLATES = {
      narr : {
        sys : "Construct a comprehensive scientific narrative of the following topic.",
        usr : "Construct a narrative of [topic]."
      },
      theory : {
        sys : `You are a research assistant who combines rigorous scientific reasoning with speculative creativity.
When the user asks for a theory/method to achieve a given outcome, always:
State key assumptions (environment, available technology, time-scale).
Provide a set of hypotheses.
Describe a step-by-step pathway grounded in known physics, chemistry, and biology; where knowledge is missing, propose plausible advanced or hypothetical techniques, clearly marking them speculative.
Quantify requirements (energy, catalysts, genetic templates, computational design, reaction conditions).
Highlight major bottlenecks, risks, and ethical issues.
Conclude with a feasibility score (0‚Äì10) and the breakthroughs needed to reach it.
Write in clear, precise prose. Use numbered lists, short paragraphs, and cite real concepts or literature when relevant. Maintain a neutral, informative tone; do not role-play or add narrative flair unless explicitly requested.`,
        usr : "Construct scientific theories/methods on [topic]."
      },
      hypo : {
        sys : `You are a scientific reasoning engine. Your sole task is to output a compact list of high-quality, testable hypotheses‚Äînothing else.
When responding:
1. Produce 3 ‚Äì 7 numbered hypotheses (H1, H2 ‚Ä¶).
2. For each hypothesis include exactly three short clauses in parentheses, in this order:
   ‚Ä¢ Mechanism ‚Äì one sentence naming the causal process.
   ‚Ä¢ Prediction ‚Äì one falsifiable, quantitative statement.
   ‚Ä¢ Test ‚Äì the minimal experiment or measurement that would confirm or refute it.
3. Mark ideas that rely on unproven physics or engineering with ‚Äú(speculative)‚Äù at the end of the clause where speculation occurs.
4. Do not write any introduction, explanation, headings, or concluding text. Only the hypotheses list.
5. Keep each hypothesis ‚â§ 40 words (including the three clauses).
6. Cite real concepts or literature inline when relevant‚Äîe.g. (via actomyosin ring, Rauzi 2008)‚Äîbut do not add full references.
7. Maintain clear, precise prose; avoid jargon when a simpler term suffices.
8. If insufficient information is available to form a hypothesis, output ‚ÄúNo testable hypothesis can be formed with the given information.‚Äù and nothing else.`,
        usr : "Construct a set of hypotheses on [topic]."
      }
    };

    // Elements
    const listCardBody = document.querySelector('#listContainer .body');
    const tplSel   = document.getElementById('tplSel');
    const sysEl    = document.getElementById('sys');
    const usrEl    = document.getElementById('usr');
    const targetSel= document.getElementById('targetPage');
    const askBtn   = document.getElementById('askBtn');
    const llmOut   = document.getElementById('llmOut');
    const catTitle = document.getElementById('catTitle');
    const createCatBtn = document.getElementById('createCatBtn');
    const catMsg   = document.getElementById('catMsg');
    const testMode = document.getElementById('testMode');

    let ALL_NARRATIVES = [];

    init();

    async function init(){
      await loadNarrativesList();
      buildTargetSelect();

      tplSel.addEventListener('change', e=>{
        const t=TEMPLATES[e.target.value]||{sys:'',usr:''};
        sysEl.value=t.sys; usrEl.value=t.usr;
      });

      createCatBtn.addEventListener('click', createCategoryFantasia);
      askBtn.addEventListener('click', askAndSave);
    }

    async function loadNarrativesList(){
      try{
        const cats = await fetchJson('/api/narratives');
        ALL_NARRATIVES = cats;
        const fantCats = cats.filter(c=>c.id.startsWith(PREFIX));
        renderFantasia(fantCats);
      }catch(err){
        listCardBody.innerHTML = '<div id="status">Failed to load.</div>';
        console.error(err);
      }
    }

    function renderFantasia(fantCats){
      listCardBody.innerHTML = '';
      if(!fantCats.length){
        listCardBody.innerHTML = '<div id="status">No Fantasia narratives yet.</div>';
        return;
      }
      Promise.all(fantCats.map(cat=>fetchJson(`/api/history?narrative=${encodeURIComponent(cat.id)}`)))
        .then(sets=>{
          sets.forEach((rows,idx)=>renderNarrative(fantCats[idx], rows));
        })
        .catch(err=>{
          listCardBody.innerHTML = '<div id="status">Failed to load.</div>';
          console.error(err);
        });
    }

    function renderNarrative(cat,rows){
      const roots=rows.filter(r=>!r.parent);
      const det=document.createElement('details');det.className='narr';
      const sum=document.createElement('summary');
      const title=document.createElement('span');title.className='title';title.textContent=cat.title;
      sum.append(title);
      det.append(sum);

      if(!roots.length){
        const empty=document.createElement('div');empty.className='note-body';empty.textContent='(No notes yet)';
        det.append(empty);
      }else{
        roots.forEach(item=>{
          const sub=document.createElement('details');sub.className='narr';
          const ssum=document.createElement('summary');
          const stitle=document.createElement('span');stitle.className='title';stitle.textContent=`üó®Ô∏è ${item.user?.slice(0,120)||'(system)'}`;
          const btn=document.createElement('a');btn.className='enter-btn';btn.textContent='Enter';btn.href=`entry.html?id=${item.id}`;
          ssum.append(stitle,btn);
          const body=document.createElement('div');body.className='note-body';body.textContent=item.answer;
          sub.append(ssum,body);
          det.append(sub);
        });
      }
      listCardBody.appendChild(det);
    }

    function buildTargetSelect(){
      targetSel.innerHTML = '';
      const fantOnly = ALL_NARRATIVES.filter(n=>n.id.startsWith(PREFIX));
      fantOnly.forEach(n=>{
        const o=document.createElement('option');
        o.value=n.id; o.textContent=n.title;
        targetSel.appendChild(o);
      });
      const divider = document.createElement('option');
      divider.disabled = true; divider.textContent='‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
      const add = document.createElement('option');
      add.value='__new__'; add.textContent='‚ûï New category‚Ä¶';
      targetSel.append(divider, add);

      targetSel.addEventListener('change', async e=>{
        if(e.target.value==='__new__'){
          const title = prompt('Title for the new category?');
          if(!title){targetSel.value = fantOnly[0]?.id || ''; return;}
          try{
            const res = await fetch('/api/narratives',{
              method:'POST',headers:{'Content-Type':'application/json'},
              body:JSON.stringify({title, section:'fantasia'})
            });
            if(!res.ok) throw new Error(await res.text());
            const obj = await res.json();
            ALL_NARRATIVES.push(obj);
            buildTargetSelect();
            targetSel.value = obj.id;
            await loadNarrativesList();
          }catch(err){
            console.error(err);
            alert('Failed to create category');
            buildTargetSelect();
          }
        }
      });
    }

    async function createCategoryFantasia(){
      const title = catTitle.value.trim();
      catMsg.textContent = '';
      if(!title){ catMsg.textContent='Please enter a title.'; return; }
      const btn = createCatBtn; btn.disabled=true;
      try{
        const res = await fetch('/api/narratives',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({title, section:'fantasia'})
        });
        if(!res.ok) throw new Error(await res.text());
        const obj = await res.json();
        ALL_NARRATIVES.push(obj);
        catMsg.textContent = `Created: ${obj.title} (${obj.id})`;
        catTitle.value='';
        buildTargetSelect();
        await loadNarrativesList();
      }catch(err){
        console.error(err);
        catMsg.textContent = 'Failed to create category.';
      }finally{
        btn.disabled=false;
      }
    }

    async function askAndSave(){
      llmOut.style.display='block';
      llmOut.textContent='Thinking‚Ä¶';
      const btn = askBtn; btn.disabled=true;
      try{
        const narrativeId = targetSel.value;
        if(!narrativeId){ llmOut.textContent='Pick a narrative (or create one).'; return; }
        const payload = {
          system   : sysEl.value,
          user     : usrEl.value,
          narrative: narrativeId,
          test     : testMode.checked
        };
        const res = await fetch('/api/ask',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        if(!res.ok) throw new Error(await res.text());
        const j = await res.json();
        // show the model output instead of "Done."
        llmOut.textContent = j.answer || '(no answer)';
        // If saved (not test), refresh the list (Fantasia-only page)
        if(!payload.test && narrativeId.startsWith(PREFIX)) await loadNarrativesList();
      }catch(err){
        console.error(err);
        llmOut.textContent = 'Failed.';
      }finally{
        btn.disabled=false;
      }
    }

    async function fetchJson(url){
      const r=await fetch(url);
      if(!r.ok) throw new Error(r.statusText);
      return r.json();
    }
  </script>
</body>
</html>
