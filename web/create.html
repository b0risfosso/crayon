<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Ask LLM & Save</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:sans-serif;max-width:820px;margin:40px auto;padding:0 10px;}
    textarea{width:100%;min-height:90px;}
    pre#out{white-space:pre-wrap;overflow-wrap:anywhere;border:1px solid #ccc;padding:8px;background:#f8f8f8;min-height:60px;}
    nav a{margin-right:8px;text-decoration:none;color:#0077cc;}
    label{display:block;margin:14px 0 6px;font-weight:600;}
    select,button{padding:6px 14px;font-size:1rem;}
    button{margin-top:12px;cursor:pointer;}
  </style>
</head>
<body>
  <nav>
    <a href="history.html">Narratives</a> |
    <a href="create.html">Create</a>
  </nav>

  <!-- Template selector -->
  <label for="tplSel">Template</label>
  <select id="tplSel">
    <option value="">— choose a template —</option>
    <option value="narr">Scientific Narrative</option>
    <option value="theory">Theory / Method</option>
    <option value="hypo">Hypothesis List</option>
  </select>

  <h2>System message</h2>
  <textarea id="sys" rows="4"></textarea>

  <h2>User message</h2>
  <textarea id="usr" rows="4"></textarea>

  <label for="targetPage">Send to narrative</label>
  <select id="targetPage"></select>

  <label><input type="checkbox" id="testMode"> Test mode — do NOT save</label>

  <button id="send">Ask</button>

  <h2>Answer</h2>
  <pre id="out">(waiting…)</pre>

<script type="module">
(async ()=>{

  /* ---------- 0. templates ---------- */
  const TEMPLATES = {
    narr : {
      sys : "Construct a comprehensive scientific narrative of the following topic.",
      usr : "Construct a narrative of [topic]."
    },
    theory : {
      sys : `You are a research assistant who combines rigorous scientific reasoning with speculative creativity.
When the user asks for a theory/method to achieve a given outcome, always:
State key assumptions (environment, available technology, time-scale).
Provide a set of hypotheses.
Describe a step-by-step pathway grounded in known physics, chemistry, and biology; where knowledge is missing, propose plausible advanced or hypothetical techniques, clearly marking them speculative.
Quantify requirements (energy, catalysts, genetic templates, computational design, reaction conditions).
Highlight major bottlenecks, risks, and ethical issues.
Conclude with a feasibility score (0–10) and the breakthroughs needed to reach it.
Write in clear, precise prose. Use numbered lists, short paragraphs, and cite real concepts or literature when relevant. Maintain a neutral, informative tone; do not role-play or add narrative flair unless explicitly requested.`,
      usr : "Construct scientific theories/methods on [topic]."
    },
    hypo : {
      sys : `You are a scientific reasoning engine. Your sole task is to output a compact list of high-quality, testable hypotheses—nothing else.
When responding:
1. Produce 3 – 7 numbered hypotheses (H1, H2 …).
2. For each hypothesis include exactly three short clauses in parentheses, in this order:
   • Mechanism – one sentence naming the causal process.
   • Prediction – one falsifiable, quantitative statement.
   • Test – the minimal experiment or measurement that would confirm or refute it.
3. Mark ideas that rely on unproven physics or engineering with “(speculative)” at the end of the clause where speculation occurs.
4. Do not write any introduction, explanation, headings, or concluding text. Only the hypotheses list.
5. Keep each hypothesis ≤ 40 words (including the three clauses).
6. Cite real concepts or literature inline when relevant—e.g. (via actomyosin ring, Rauzi 2008)—but do not add full references.
7. Maintain clear, precise prose; avoid jargon when a simpler term suffices.
8. If insufficient information is available to form a hypothesis, output “No testable hypothesis can be formed with the given information.” and nothing else.`,
      usr : "Construct a set of hypotheses on [topic]."
    }, 
    ladder : {
      sys : `You are a mastery-mapping assistant.
Your task is to analyze any given topic and construct a structured framework describing the progressive levels of mastery in both:

Understanding of the topic (what is grasped intellectually or intuitively), and
Agency over the topic (what can be manipulated, created, or influenced using that understanding).
For each level, describe:
The cognitive grasp or perception at that level
The scope and form of action available at that level
Who typically operates at this level (optional)
Use clear titles (e.g., "Level 3 – Strategic Manipulation"), and organize the levels from basic/naive to transcendent/inventive.
Optionally include a final level titled "Level N – Pure Fantasiagenesis", where imagination fuses with reality to unlock full creative and transformative power in the domain.

Your output should be rigorous, layered, and meaningful. Avoid generic or vague descriptions.

Example topics: mathematics, music, rocks, oceans, memory, cities, time, microbes, democracy, narrative, emotion.`,
      usr : `Map the levels of mastery in understanding of and agency over [insert topic here].
Begin from raw or naive interaction, and proceed toward full integration and transformation. Include a final level of Pure Fantasiagenesis, where imagination fuses with reality in this domain.`
    }

  };

  /* ---------- 1. fetch narratives ---------- */
  const NARRATIVES = await fetch('/api/narratives').then(r=>r.json());

  /* ---------- 2. populate narrative <select> ---------- */
  const sel   = document.getElementById('targetPage');
  const params= new URLSearchParams(location.search);
  const initial=params.get('page')||NARRATIVES[0]?.id;

  function rebuildSelect(){
    sel.innerHTML='';
    NARRATIVES.forEach(n=>{
      sel.insertAdjacentHTML('beforeend',`<option value="${n.id}">${n.title}</option>`);}
    );
    sel.insertAdjacentHTML('beforeend',`<option disabled>──────────</option><option value="__new__">➕ New narrative…</option>`);
    sel.value=initial;
  }
  rebuildSelect();

  sel.addEventListener('change',e=>{
    if(e.target.value==='__new__') newNarrativeFlow();
  });
