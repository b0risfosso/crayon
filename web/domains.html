<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Domains • Fantasiagenesis</title>
  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      margin: 2rem;
      line-height: 1.45;
    }
    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem; gap: 1rem; }
    h1 { font-size: 1.25rem; margin: 0; }
    .controls { display: flex; gap: .5rem; flex-wrap: wrap; align-items: center; }
    input[type="search"] {
      padding: .6rem .7rem; min-width: 16rem; border: 1px solid #ccc; border-radius: .6rem; background: transparent;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1rem;
      align-items: stretch;
    }
    .card {
      border: 1px solid rgba(128,128,128,.35);
      border-radius: 14px;
      padding: 1rem;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      transition: transform .06s ease, box-shadow .06s ease, border-color .06s ease;
      background: rgba(127,127,127,.05);
    }
    .card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 18px rgba(0,0,0,.08);
      border-color: rgba(60, 120, 255, .6);
    }
    .title { font-weight: 600; margin: 0 0 .25rem; word-wrap: anywhere; }
    .meta { font-size: .85rem; opacity: .7; margin-top: .35rem; display: flex; gap: .5rem; flex-wrap: wrap; }
    .badge {
      display: inline-flex; align-items: center; gap: .35rem;
      font-size: .8rem; padding: .15rem .5rem; border-radius: 999px;
      border: 1px solid rgba(128,128,128,.35);
    }
    .empty, .error, .loading { opacity: .8; margin-top: 2rem; font-style: italic; }
    .sr { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
</head>
<body>
  <header>
    <h1>Domains</h1>
    <div class="controls">
      <label class="sr" for="q">Search domains</label>
      <input id="q" type="search" placeholder="Search…" autocomplete="off" />
    </div>
  </header>

  <div id="status" class="loading">Loading…</div>
  <div id="grid" class="grid" hidden></div>

  <script>
    const grid = document.getElementById('grid');
    const statusEl = document.getElementById('status');
    const searchEl = document.getElementById('q');

    // Optional counts endpoint; page will gracefully fall back if it 404s.
    async function fetchCounts() {
      try {
        const r = await fetch('/api/narratives/dimension-counts', { credentials: 'same-origin' });
        if (!r.ok) return {};
        const rows = await r.json();
        const map = {};
        for (const row of rows) map[row.narrative_id] = row.dim_count;
        return map;
      } catch { return {}; }
    }

    async function fetchNarratives() {
      const r = await fetch('/api/narratives', { credentials: 'same-origin' });
      if (!r.ok) throw new Error('Failed to load /api/narratives');
      return r.json();
    }

    function fmtDate(iso) {
      // created_at is SQLite datetime('now') UTC; show as local date
      if (!iso) return '';
      const d = new Date(iso.replace(' ', 'T') + 'Z');
      if (Number.isNaN(d.getTime())) return '';
      return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: '2-digit' });
    }

    function renderCards(items, counts) {
      grid.innerHTML = '';
      if (!items.length) {
        statusEl.textContent = 'No domains yet. Create some via the API.';
        statusEl.className = 'empty';
        grid.hidden = true;
        return;
      }
      for (const it of items) {
        const a = document.createElement('a');
        a.className = 'card';
        a.href = `dimensions.html?narrative_id=${encodeURIComponent(it.id)}&title=${encodeURIComponent(it.title || '')}`;

        const h = document.createElement('h2');
        h.className = 'title';
        h.textContent = it.title || '(untitled)';
        a.appendChild(h);

        const meta = document.createElement('div');
        meta.className = 'meta';

        const created = document.createElement('span');
        created.textContent = fmtDate(it.created_at) ? `Created ${fmtDate(it.created_at)}` : '';
        if (created.textContent) meta.appendChild(created);

        const dimCount = counts?.[it.id];
        if (typeof dimCount === 'number') {
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = `${dimCount} dimension${dimCount === 1 ? '' : 's'}`;
          meta.appendChild(badge);
        }

        a.appendChild(meta);
        grid.appendChild(a);
      }
      statusEl.textContent = '';
      statusEl.className = '';
      grid.hidden = false;
    }

    function filter(items, q) {
      if (!q) return items;
      const s = q.toLowerCase();
      return items.filter(it => (it.title || '').toLowerCase().includes(s));
    }

    (async function init() {
      try {
        const [items, counts] = await Promise.all([fetchNarratives(), fetchCounts()]);
        let current = items.slice();
        renderCards(current, counts);

        searchEl.addEventListener('input', () => {
          const q = searchEl.value.trim();
          renderCards(filter(items, q), counts);
        });
      } catch (e) {
        statusEl.textContent = 'Error loading domains.';
        statusEl.className = 'error';
        console.error(e);
      }
    })();
  </script>
</body>
</html>
