<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grow</title>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background: Canvas; color: CanvasText; }
    header { padding: 1rem 1.25rem; border-bottom: 1px solid color-mix(in oklab, CanvasText 10%, transparent); display:flex; align-items:baseline; gap:1rem; }
    header h1 { margin:0; font-size: clamp(1.25rem, 2.5vw, 1.75rem); }
    header .muted { opacity:.7; font-size:.9rem; }
    main { padding: 1rem; max-width: 1200px; margin: 0 auto; }
    .grid { display: grid; gap: 1rem; }
    .cols-2 { grid-template-columns: 1fr 1fr; }
    @media (max-width: 1024px) { .cols-2 { grid-template-columns: 1fr; } }

    .card { border: 1px solid color-mix(in oklab, CanvasText 10%, transparent); border-radius: 14px; overflow: clip; background: color-mix(in oklab, Canvas 96%, transparent); }
    .card > header { padding:.75rem 1rem; border-bottom: 1px solid color-mix(in oklab, CanvasText 8%, transparent); display:flex; align-items:center; gap:.75rem; justify-content:space-between; }
    .card > header h2 { margin:0; font-size:1rem; font-weight:600; }
    .card .body { padding: 1rem; display: grid; gap: .75rem; }

    .row { display:flex; gap:1rem; flex-wrap:wrap; }
    label { display:block; font-size:.85rem; opacity:.8; margin-bottom:.25rem; }
    select, input[type=email], button { width: 100%; padding:.55rem .65rem; border-radius:10px; border:1px solid color-mix(in oklab, CanvasText 12%, transparent); background: transparent; color: inherit; }
    button { width:auto; cursor:pointer; }
    .btn { display:inline-flex; align-items:center; gap:.4rem; }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }

    .status { display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .5rem; border-radius:999px; font-size:.8rem; border:1px solid color-mix(in oklab, CanvasText 12%, transparent); }
    .status.ok {
    color: color-mix(in oklab, forestgreen 70%, CanvasText 30%);
    background: color-mix(in oklab, lime 18%, transparent);
    border-color: color-mix(in oklab, forestgreen 45%, CanvasText 15%);
    }
    .status.warn { background: color-mix(in oklab, CanvasText 6%, transparent); }

    .hidden { display:none; }
    details summary { cursor: pointer; }
    pre { margin:0; white-space:pre-wrap; word-wrap:break-word; }

    .rail { display:grid; grid-template-columns: 320px 1fr; gap:1rem; }
    @media (max-width: 1100px){ .rail { grid-template-columns: 1fr; } }

    aside.left-rail .panel { border:1px solid color-mix(in oklab, CanvasText 10%, transparent); border-radius:14px; overflow:hidden; }
    aside.left-rail .panel header {
    background: color-mix(in oklab, #2b6cb0 15%, Canvas);
    /* darker, higher-contrast label against the blue background */
    color: color-mix(in oklab, CanvasText 88%, white 12%);
    }

    aside.left-rail .panel .content { padding: 1rem; display:grid; gap:.75rem; }
    .note { font-size:.9rem; opacity:.8; }

    .actions { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    .expand-row { display:flex; gap:.5rem; align-items:center; }
  </style>
</head>
<body>
  <header>
    <h1>Grow</h1>
    <div class="muted">Read‑only viewer for saved Dirt • Nothing is generated here</div>
    <nav style="margin-left:auto; display:flex; gap:.5rem;">
      <a class="btn" href="garden.html">See your garden</a>
      <a class="btn" href="imagine.html">Create prototypes</a>
      <a class="btn" href="dirt.html" title="Go to generator">Go to Dirt (generator)</a>
    </nav>
  </header>

  <main class="rail">
    <!-- Left rail: account + selection -->
    <aside class="left-rail" aria-label="Navigation panels">
      <section class="panel" id="panel-email" aria-labelledby="h-email">
        <header><h2 id="h-email">Account</h2></header>
        <div class="content">
          <div>
            <label for="emailInput">Email (required to load narratives)</label>
            <input id="emailInput" type="email" placeholder="you@example.com" />
          </div>
          <div class="note">Enter the same email you used when creating seeds. This unlocks your domains, dimensions, and seeds.</div>
        </div>
      </section>

      <section class="panel" id="panel-select" aria-labelledby="h-select">
        <header><h2 id="h-select">Select Seed</h2></header>
        <div class="content">
          <div class="row">
            <div style="flex:1 1 45%">
              <label for="domainSelect">Domain</label>
              <select id="domainSelect"><option value="">Enter email to load…</option></select>
            </div>
            <div style="flex:1 1 45%">
              <label for="dimensionSelect">Dimension</label>
              <select id="dimensionSelect" disabled><option value="">Select a domain</option></select>
            </div>
          </div>
          <div>
            <label for="seedSelect">Seed</label>
            <select id="seedSelect" disabled><option value="">Select a dimension</option></select>
          </div>
          <div class="actions">
            <button id="loadAllBtn" class="btn" disabled>Load saved Dirt</button>
            <span id="loadAllStatus" class="status warn">Nothing loaded</span>
          </div>
        </div>
      </section>

      <section class="panel" aria-labelledby="h-help">
        <header><h2 id="h-help">How this page works</h2></header>
        <div class="content">
          <ul style="margin:0 0 0 1.25rem; display:grid; gap:.4rem;">
            <li>Loads previously saved Dirt from your backend by seed.</li>
            <li>Does <strong>not</strong> generate anything new.</li>
            <li>Each card shows a status and an <em>Expand</em> control to reveal the saved text.</li>
          </ul>
        </div>
      </section>
    </aside>

    <!-- Right: read-only cards -->
    <section id="cards" style="display:grid; gap:1rem;">
      <!-- Storyboard -->
      <section class="card" id="card-storyboard" aria-labelledby="h-storyboard">
        <header>
          <h2 id="h-storyboard">Storyboard</h2>
          <div class="expand-row">
            <span id="status-storyboard" class="status warn">Not loaded</span>
            <!-- NEW: run button -->
            <button id="run-brief" class="btn" disabled>Decision Brief</button>
            <button id="toggle-storyboard" class="btn" disabled>Expand</button>
          </div>
        </header>
        <div class="body hidden" id="body-storyboard"></div>
      </section>

      <!-- Real & Box-of-Dirt Artifacts -->
      <section class="card" id="card-artifacts" aria-labelledby="h-artifacts">
        <header>
          <h2 id="h-artifacts">Real &amp; Box‑of‑Dirt Artifacts</h2>
          <div class="expand-row">
            <span id="status-artifacts" class="status warn">Not loaded</span>
            <button id="toggle-artifacts" class="btn" disabled>Expand</button>
          </div>
        </header>
        <div class="body hidden" id="body-artifacts"></div>
      </section>

      <!-- Real-World Validation -->
      <section class="card" id="card-validation" aria-labelledby="h-validation">
        <header>
          <h2 id="h-validation">Real‑World Validation</h2>
          <div class="expand-row">
            <span id="status-validation" class="status warn">Not loaded</span>
            <button id="toggle-validation" class="btn" disabled>Expand</button>
          </div>
        </header>
        <div class="body hidden" id="body-validation"></div>
      </section>

      <!-- Stakeholders -->
      <section class="card" id="card-stakeholders" aria-labelledby="h-stakeholders">
        <header>
          <h2 id="h-stakeholders">Stakeholders</h2>
          <div class="expand-row">
            <span id="status-stakeholders" class="status warn">Not loaded</span>
            <button id="toggle-stakeholders" class="btn" disabled>Expand</button>
          </div>
        </header>
        <div class="body hidden" id="body-stakeholders"></div>
      </section>

      <!-- 6 Senses (Embodied) -->
      <section class="card" id="card-senses" aria-labelledby="h-senses">
        <header>
          <h2 id="h-senses">6 Senses (Embodied)</h2>
          <div class="expand-row">
            <span id="status-senses" class="status warn">Not loaded</span>
            <button id="toggle-senses" class="btn" disabled>Expand</button>
          </div>
        </header>
        <div class="body hidden" id="body-senses"></div>
      </section>

      <!-- Archetype -->
      <section class="card" id="card-archetype" aria-labelledby="h-archetype">
        <header>
          <h2 id="h-archetype">Archetype</h2>
          <div class="expand-row">
            <span id="status-archetype" class="status warn">Not loaded</span>
            <button id="toggle-archetype" class="btn" disabled>Expand</button>
          </div>
        </header>
        <div class="body hidden" id="body-archetype"></div>
      </section>

      <!-- Risks -->
      <section class="card" id="card-risks" aria-labelledby="h-risks">
        <header>
          <h2 id="h-risks">Risks</h2>
          <div class="expand-row">
            <span id="status-risks" class="status warn">Not loaded</span>
            <button id="toggle-risks" class="btn" disabled>Expand</button>
          </div>
        </header>
        <div class="body hidden" id="body-risks"></div>
      </section>
    </section>
  </main>

  <script>
    // ------- Utilities -------
    const els = {
      email: document.getElementById('emailInput'),
      domain: document.getElementById('domainSelect'),
      dimension: document.getElementById('dimensionSelect'),
      seed: document.getElementById('seedSelect'),
      loadAllBtn: document.getElementById('loadAllBtn'),
      loadAllStatus: document.getElementById('loadAllStatus'),

      status: {
        storyboard: document.getElementById('status-storyboard'),
        artifacts: document.getElementById('status-artifacts'),
        validation: document.getElementById('status-validation'),
        stakeholders: document.getElementById('status-stakeholders'),
        senses: document.getElementById('status-senses'),
        archetype: document.getElementById('status-archetype'),
        risks: document.getElementById('status-risks'),
      },
      toggle: {
        storyboard: document.getElementById('toggle-storyboard'),
        artifacts: document.getElementById('toggle-artifacts'),
        validation: document.getElementById('toggle-validation'),
        stakeholders: document.getElementById('toggle-stakeholders'),
        senses: document.getElementById('toggle-senses'),
        archetype: document.getElementById('toggle-archetype'),
        risks: document.getElementById('toggle-risks'),
      },
      body: {
        storyboard: document.getElementById('body-storyboard'),
        artifacts: document.getElementById('body-artifacts'),
        validation: document.getElementById('body-validation'),
        stakeholders: document.getElementById('body-stakeholders'),
        senses: document.getElementById('body-senses'),
        archetype: document.getElementById('body-archetype'),
        risks: document.getElementById('body-risks'),
      },
    cardsContainer: document.getElementById('cards'),
    briefBtn: document.getElementById('run-brief'),


    };

    const KINDS = ['storyboard','artifacts','validation','stakeholders','embodied','archetype','risks'];

    const loaded = Object.create(null); // { kind: {input, output} }

    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, c => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[c]));
    }


    // --- Email storage modelled on Dirt page ---
    const EMAIL_KEY = 'fg_user_email';
    function saveEmailToStorage(email){
        const v = String(email||'').trim().toLowerCase();
        if(v) localStorage.setItem(EMAIL_KEY, v); else localStorage.removeItem(EMAIL_KEY);
    }
    function readEmailFromStorage(){
        return (localStorage.getItem(EMAIL_KEY) || '').trim().toLowerCase();
    }
    function currentEmail(){
        const typed = (els.email?.value || '').trim().toLowerCase();
        return typed || readEmailFromStorage();
    }

    function setStatus(kind, msg, ok=false){
      const el = els.status[kind];
      if(!el) return;
      el.textContent = msg;
      el.classList.toggle('ok', !!ok);
      el.classList.toggle('warn', !ok);
    }

    function setToggleEnabled(kind, enabled){
      const b = els.toggle[kind];
      if(b){ b.disabled = !enabled; b.textContent = enabled ? 'Expand' : 'Expand'; }
    }

    function hideBody(kind){ els.body[kind]?.classList.add('hidden'); }
    function showBody(kind){ els.body[kind]?.classList.remove('hidden'); }

    function clearBodies(){
      for(const k of KINDS){
        hideBody(k);
        els.body[k].innerHTML='';
        setStatus(k, 'Not loaded', false);
        setToggleEnabled(k,false);
      }
      if (els.briefBtn) els.briefBtn.disabled = true;  // NEW
      els.loadAllStatus.textContent = 'Nothing loaded';
      els.loadAllStatus.classList.remove('ok');
      els.loadAllStatus.classList.add('warn');
    }


    function currentSeedTriplet(){
      // These are used only for display/context; loading /api/dirt relies on sid & kind
      const domain = els.domain.options[els.domain.selectedIndex]?.textContent || '';
      const dimension = els.dimension.options[els.dimension.selectedIndex]?.textContent || '';
      const seed = els.seed.options[els.seed.selectedIndex]?.textContent || '';
      return {domain, dimension, seed};
    }

    function _extractSeedTripletFromInput(input){
    // Handles shapes like: {request:{ domain, dimension, seed:{problem,objective,solution} }}
      const req = (input && (input.request || input)) || {};
      const seed = req.seed || {};
      return {
        domain: req.domain || '',
        dimension: req.dimension || '',
        problem: seed.problem || req.problem || '',
        objective: seed.objective || req.objective || '',
        solution: seed.solution || req.solution || '',
      };
    }

    function _buildBriefPayloadFromStoryboard(storyData){
      // storyData = loaded['storyboard'] = { input, output, at }
      const out = storyData?.output || {};
      const proto = out.prototype || out; // tolerate either shape
      const seedFromInput = _extractSeedTripletFromInput(storyData?.input);

      const domain    = out.domain    || seedFromInput.domain    || '';
      const dimension = out.dimension || seedFromInput.dimension || '';

      // Map storyboard fields
      const core_intent         = proto.core_intent || '';
      const minimal_build       = proto.minimal_build || '';
      const load_bearing_test   = proto.load_bearing_test || '';
      // Some storyboards embed "Validating reaction" inside load_bearing_test; pass blank if not separate
      const validating_reaction = proto.validating_reaction || '';
      const first_eyes          = Array.isArray(proto.first_eyes) ? proto.first_eyes.join('\n') : (proto.first_eyes || '');
      const why_dirt            = proto.why_box_of_dirt || proto.why_dirt || (out.why_box_of_dirt || '');

      return {
        // endpoint accepts split fields; you can also include nested seed if you prefer
        domain,
        dimension,
        seed_problem:   seedFromInput.problem   || '',
        seed_objective: seedFromInput.objective || '',
        seed_solution:  seedFromInput.solution  || '',
        core_intent,
        minimal_build,
        load_bearing_test,
        validating_reaction,
        first_eyes,
        why_dirt,
        // provider optional; omit to use server default
        // provider: 'openai',
      };
    }

    async function _requestDecisionBrief(payload){
      const res = await fetch('/api/grow/decision-brief', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
        body: JSON.stringify(payload),
      });
      const text = await res.text();
      let j = null; try { j = JSON.parse(text); } catch {_ => {}}
      if (!res.ok || !j?.ok) throw new Error((j && (j.error || j.message)) || `HTTP ${res.status}`);
      return j.brief; // { why_this_matters, plan_14d, evolve_conditions, prune_conditions, if_evolve_next_steps, if_prune_next_steps, markdown }
    }

    function _appendDecisionBriefToStoryboard(){
      const body = els.body.storyboard;
      if (!body) return;
      const brief = (loaded.__decision_brief || null);
      if (!brief) return;

      // Avoid duplicating if user toggles repeatedly
      if (body.querySelector('.brief-wrap')) return;

      const md = brief.markdown || [
        '## Why this box of dirt/prototype matters', brief.why_this_matters || '',
        '## 14-day growth plan',                      brief.plan_14d || '',
        '## Evolve vs. Prune conditions',
        ...(brief.evolve_conditions||[]).map(s=>'• '+s),
        ...(brief.prune_conditions||[]).map(s=>'• '+s),
        '## If Evolve → next steps', ...(brief.if_evolve_next_steps||[]).map(s=>'• '+s),
        '## If Prune → next steps',  ...(brief.if_prune_next_steps||[]).map(s=>'• '+s),
      ].join('\n');

      body.insertAdjacentHTML('beforeend', `
        <hr>
        <div class="brief-wrap">
          <h3 style="margin:.25rem 0 .35rem 0;">Decision Brief</h3>
          <pre>${escapeHTML(md)}</pre>
        </div>
      `);
    }


    // ------- Data loading (narratives + seeds) -------
    async function fetchJSON(url){
      const r = await fetch(url, {headers:{'Accept':'application/json'}});
      if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    }

    // --- Deep link handler for grow.html ---
    // --- Deep link handler for grow.html ---
    async function maybeDeepLink() {
        const params = new URLSearchParams(location.search);
        const email = params.get('email');
        const nid   = params.get('nid');
        const did   = params.get('did');
        const sid   = params.get('sid');

        // 1) Prefill + save email
        if (email) {
            els.email.value = email;
            saveEmailToStorage(email);
        } else {
            const stored = readEmailFromStorage();
            if (stored && !els.email.value) els.email.value = stored;
        }

        // 2) Load domain list for this email
        await loadNarrativesForEmail();

        // 3) Select domain -> fetch dimensions -> select dimension -> fetch seeds -> select seed
        if (nid) {
            els.domain.value = String(nid);
            await onDomainChange();
        }
        if (did) {
            els.dimension.value = String(did);
            await onDimensionChange();
        }
        if (sid) {
            els.seed.value = String(sid);
            updateLoadBtnState();
        }

        // 4) Optionally auto-load the saved Dirt for that seed
        if (sid) {
            await loadAllKinds(); // uses current els.seed.value
        }
    }



    async function loadNarrativesForEmail(){
      const email = currentEmail();
      if(!email){ els.domain.innerHTML = '<option value="">Enter email above…</option>'; els.dimension.innerHTML='<option value="">Select a domain</option>'; els.seed.innerHTML='<option value="">Select a dimension</option>'; els.dimension.disabled = true; els.seed.disabled = true; els.loadAllBtn.disabled = true; return; }
      els.domain.innerHTML = '<option value="">Loading…</option>';
      try{
        const data = await fetchJSON(`/api/narratives?email=${encodeURIComponent(email)}`);
        // Expecting array of {id, title, dimensions:[{id,title, seeds:[{id, title}]}]}
        const domains = Array.isArray(data?.domains || data) ? (data.domains || data) : (data.items || []);
        if(!domains.length){ els.domain.innerHTML = '<option value="">No domains found for this email</option>'; els.dimension.disabled=true; els.seed.disabled=true; els.loadAllBtn.disabled = true; return; }
        els.domain.innerHTML = '<option value="">Select a domain</option>' + domains.map(d=>`<option value="${escapeHTML(d.id)}">${escapeHTML(d.title||d.name||('Domain '+d.id))}</option>`).join('');
        els.dimension.disabled = true; els.seed.disabled = true; els.loadAllBtn.disabled = true;
        els.domain.onchange    = onDomainChange;
        els.dimension.onchange = onDimensionChange; 
        els.seed.onchange = updateLoadBtnState;
      }catch(err){
        console.error(err); els.domain.innerHTML = `<option value="">Error: ${escapeHTML(err.message)}</option>`; els.dimension.disabled=true; els.seed.disabled=true; els.loadAllBtn.disabled = true;
      }
    }

    async function onDomainChange(){
        clearBodies();
        const nid = els.domain.value;

        // reset UI
        els.dimension.disabled = !nid;
        els.seed.disabled = true;
        els.dimension.innerHTML = `<option value="">${nid ? 'Loading…' : 'Select a domain'}</option>`;
        els.seed.innerHTML = `<option value="">Select a dimension</option>`;
        updateLoadBtnState();
        if(!nid) return;

        try{
            const email = currentEmail();
            const url = `/api/narratives/${encodeURIComponent(nid)}/dimensions` + (email ? `?email=${encodeURIComponent(email)}` : '');
            const dims = await fetchJSON(url);

            els.dimension.innerHTML =
            '<option value="">Select a dimension</option>' +
            (Array.isArray(dims) ? dims.map(d =>
                `<option value="${escapeHTML(d.id)}">${escapeHTML(d.title || d.name || ('Dimension ' + d.id))}</option>`
            ).join('') : '<option value="">No dimensions</option>');

            els.dimension.disabled = false;
        }catch(err){
            els.dimension.innerHTML = `<option value="">Error: ${escapeHTML(err.message)}</option>`;
            els.dimension.disabled = true;
        }finally{
            updateLoadBtnState();
        }
    }

    async function onDimensionChange(){
        clearBodies();
        const did = els.dimension.value;

        // reset UI
        els.seed.disabled = !did;
        els.seed.innerHTML = `<option value="">${did ? 'Loading…' : 'Select a dimension'}</option>`;
        updateLoadBtnState();
        if(!did) return;

        try{
            const email = currentEmail();
            const url = `/api/dimensions/${encodeURIComponent(did)}/seeds` + (email ? `?email=${encodeURIComponent(email)}` : '');
            const payload = await fetchJSON(url);
            const seeds = Array.isArray(payload?.seeds) ? payload.seeds : [];

            els.seed.innerHTML =
            '<option value="">Select a seed</option>' +
            seeds.map(s =>
                `<option value="${escapeHTML(s.id)}">${escapeHTML(s.title || s.problem || ('Seed ' + s.id))}</option>`
            ).join('');

            els.seed.disabled = false;
        }catch(err){
            els.seed.innerHTML = `<option value="">Error: ${escapeHTML(err.message)}</option>`;
            els.seed.disabled = true;
        }finally{
            updateLoadBtnState();
        }
    }


    function findSelected(list, id){ return list?.find?.(x=> String(x.id)===String(id)); }

    function populateDimensions(domains){
      clearBodies();
      const did = els.domain.value; if(!did){ els.dimension.innerHTML='<option value="">Select a domain</option>'; els.dimension.disabled=true; els.seed.innerHTML='<option value="">Select a dimension</option>'; els.seed.disabled = true; updateLoadBtnState(); return; }
      const d = findSelected(domains, did) || {};
      const dims = d.dimensions || [];
      els.dimension.innerHTML = '<option value="">Select a dimension</option>' + dims.map(m=>`<option value="${escapeHTML(m.id)}">${escapeHTML(m.title||m.name||('Dimension '+m.id))}</option>`).join('');
      els.dimension.disabled = false;
      els.seed.innerHTML='<option value="">Select a dimension</option>'; els.seed.disabled = true;
      updateLoadBtnState();
    }

    function populateSeeds(domains){
      clearBodies();
      const did = els.domain.value; const mid = els.dimension.value; if(!did || !mid){ els.seed.innerHTML='<option value="">Select a dimension</option>'; els.seed.disabled=true; updateLoadBtnState(); return; }
      const d = findSelected(domains, did) || {}; const m = findSelected(d.dimensions||[], mid) || {};
      const seeds = m.seeds || [];
      els.seed.innerHTML = '<option value="">Select a seed</option>' + seeds.map(s=>`<option value="${escapeHTML(s.id)}">${escapeHTML(s.title||('Seed '+s.id))}</option>`).join('');
      els.seed.disabled = false; updateLoadBtnState();
    }

    function updateLoadBtnState(){ els.loadAllBtn.disabled = !(els.domain.value && els.dimension.value && els.seed.value); }

    // ------- Dirt loading (per kind) -------
    async function loadLatestDirt(kind, sid){
      const url = `/api/dirt?sid=${encodeURIComponent(sid)}&kind=${encodeURIComponent(kind)}&limit=1`;
      const r = await fetchJSON(url);
      const rows = Array.isArray(r) ? r : (r.items || []);
      if(!rows.length){ return null; }
      const row = rows[0];
      // Do not inject text yet; keep in memory until expanded
      return { input: row.input ?? row.input_json, output: row.output ?? row.output_json, at: row.created_at || row.ts || null };
    }

    async function loadAllKinds(){
      const sid = els.seed.value; if(!sid) return;
      els.loadAllBtn.disabled = true; els.loadAllStatus.textContent = 'Loading…';
      for(const k of KINDS){ setStatus(k, 'Loading…'); setToggleEnabled(k,false); hideBody(k); }
      try{
        for(const k of KINDS){
          try{
            const data = await loadLatestDirt(k, sid);
            if(data){
              loaded[k] = data;
              setStatus(k, 'Loaded — click to expand', true);
              setToggleEnabled(k, true);

              // --- NEW: if storyboard loaded, kick off decision-brief in background
              if (k === 'storyboard') {
                els.briefBtn.disabled = false;     // NEW: enable run button
              }
            } else {
              delete loaded[k];
              setStatus(k, 'No saved Dirt found', false);
              setToggleEnabled(k, false);
            }
          }catch(inner){
            console.error(k, inner);
            setStatus(k, `Error: ${inner.message}`, false);
            setToggleEnabled(k, false);
          }
        }
        els.loadAllStatus.textContent = 'Finished loading';
        els.loadAllStatus.classList.remove('warn'); els.loadAllStatus.classList.add('ok');
      } finally {
        els.loadAllBtn.disabled = false;
      }
    }


    function renderKind(kind){
      const d = loaded[kind]; const body = els.body[kind]; if(!body) return;
      if(!d){ body.innerHTML = '<div class="note">Nothing to show.</div>'; return; }
      // Render only on demand; basic sections if present
      // Many Dirt outputs store text under output.text or output.html; support common variants
      const out = d.output || {};
      const text = out.text || out.markdown || out.content || JSON.stringify(out, null, 2);
      body.innerHTML = `<pre>${escapeHTML(text)}</pre>`;
    }


    async function runDecisionBrief(){
      if (!loaded.storyboard) {
        setStatus('storyboard', 'Load a storyboard first', false);
        return;
      }
      const btn = els.briefBtn;
      if (btn) { btn.disabled = true; btn.textContent = 'Running…'; }

      try{
        const payload = _buildBriefPayloadFromStoryboard(loaded.storyboard);
        const brief = await _requestDecisionBrief(payload);
        loaded.__decision_brief = brief;

        // Auto-show storyboard body and brief
        renderKind('storyboard');                    // ensure storyboard text is painted
        const body = els.body.storyboard;
        if (body) body.classList.remove('hidden');   // unhide
        if (els.toggle.storyboard) els.toggle.storyboard.textContent = 'Hide';
        _appendDecisionBriefToStoryboard();          // append brief section
        setStatus('storyboard', 'Brief ready — shown', true);
      }catch(e){
        console.warn('Decision brief failed:', e);
        setStatus('storyboard', `Brief error: ${e.message}`, false);
      }finally{
        if (btn) { btn.disabled = false; btn.textContent = 'Decision Brief'; }
      }
    }


    

    // ------- Boot -------

    // Optionally auto-fill email from query string

   // One toggle handler for all cards (works for static & future cards)
    // One toggle handler for all cards (works for static & future cards)
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button[id^="toggle-"]');
      if (!btn || btn.disabled) return;

      // Don't react if the click originated from inside any card body
      // (prevents weird bubbling if a body has interactive children)
      if (e.target.closest('[id^="body-"]')) return;

      e.preventDefault();
      e.stopPropagation();

      const kind = btn.id.slice('toggle-'.length);
      const body = document.getElementById(`body-${kind}`);
      if (!body) return;

      const isHidden = body.classList.contains('hidden');

      if (isHidden) {
        if (typeof renderKind === 'function') renderKind(kind);
        body.classList.remove('hidden');
        btn.textContent = 'Hide';
        if (kind === 'storyboard' && loaded.__decision_brief) {
          _appendDecisionBriefToStoryboard();
        }
      } else {
        body.classList.add('hidden');
        btn.textContent = 'Expand';
      }
    });




    function init(){
        const savedEmail = readEmailFromStorage();
        if(savedEmail && !els.email.value){ els.email.value = savedEmail; }

        for (const k of KINDS) { els.toggle[k]?.setAttribute('type','button'); }

        els.email.addEventListener('change', loadNarrativesForEmail);
        els.loadAllBtn.addEventListener('click', loadAllKinds);
        els.briefBtn?.addEventListener('click', runDecisionBrief);


        // initial loads
        const params = new URLSearchParams(location.search);
        if(params.has('email')) els.email.value = params.get('email');
        loadNarrativesForEmail();
        maybeDeepLink();
    }
    document.addEventListener('DOMContentLoaded', init);

  </script>
</body>
</html>
