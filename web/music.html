<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Music Builder</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --border: #dfe3eb;
      --muted: #6b7280;
      --accent: #1f7ae0;
    }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      background: var(--bg);
      color: #111;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      margin: 0 0 6px 0;
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      align-items: center;
    }

    button {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-weight: 600;
    }

    button.primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.04);
      margin-bottom: 14px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .meta {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
      margin-bottom: 6px;
    }

    .art-text,
    .color-text {
      white-space: pre-wrap;
      background: #f9fafb;
      border: 1px solid var(--border);
      padding: 10px;
      border-radius: 8px;
      margin-top: 6px;
      font-size: 14px;
    }

    .status {
      font-size: 12px;
      color: #333;
      margin-top: 8px;
      white-space: pre-wrap;
    }

    .instrument-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 260px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      background: #f9fafb;
    }

    .instrument-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }

    .instrument-name {
      font-weight: 600;
    }

    .instrument-desc {
      font-size: 12px;
      color: var(--muted);
    }

    .run-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 8px;
    }

    .run-controls input[type="number"] {
      width: 80px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 13px;
    }

    .runs-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
      max-height: 360px;
      overflow-y: auto;
    }

    .run-item {
      font-size: 12px;
      color: var(--muted);
    }

    .prev-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: #fff;
    }

    .prev-head {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: baseline;
      margin-bottom: 4px;
    }

    .prev-body {
      margin: 0;
      white-space: pre-wrap;
      font-size: 13px;
    }

    a.back-link {
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="toolbar">
      <a id="backLink" class="back-link">
        <button>← Back to Painting</button>
      </a>
      <div class="muted" id="header-label"></div>
    </div>

    <!-- COLOR DISPLAY -->
    <section class="card">
      <div class="section-header">
        <h1 style="font-size:18px; margin:0;">Color</h1>
        <span class="muted">Source color for music / instrument runs</span>
      </div>
      <div id="color-meta" class="meta">Loading color…</div>
      <div id="color-text" class="color-text">Loading…</div>
    </section>

    <!-- INSTRUMENT SELECTION -->
    <section class="card">
      <div class="section-header">
        <h2 style="margin:0; font-size:16px;">Instruments</h2>
        <span class="muted">Select specific instruments or pick random ones</span>
      </div>

      <div id="instrument-status" class="status"></div>

      <div id="instrument-choices" class="instrument-list">
        Loading instruments…
      </div>

      <div class="run-controls">
        <label style="font-size:13px;">
          Random N:
          <input id="randomCount" type="number" min="1" value="1" />
        </label>
        <button type="button" onclick="selectRandomInstruments()">Select random</button>
        <button type="button" class="primary" onclick="runOperationalPathways()" id="runButton">
          Run operational pathways
        </button>
      </div>

      <div id="run-status" class="status"></div>
      <div id="run-results" class="runs-list"></div>
    </section>

    <!-- PREVIOUS RESULTS -->
    <section class="card">
      <div class="section-header">
        <h2 style="margin:0; font-size:16px;">Previous results</h2>
        <button type="button" onclick="loadPreviousRuns()">Refresh</button>
      </div>
      <div class="muted" style="margin-bottom:4px;">
        Showing brush strokes / instrument runs previously generated for this color.
      </div>
      <div id="previous-runs" class="runs-list">
        Loading…
      </div>
    </section>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const artId = parseInt(params.get("art_id") || "", 10);
    const colorId = parseInt(params.get("color_id") || "", 10);

    const API_INSTRUMENTS = "/instruments";
    const API_OPERATIONAL = "/instruments/operational_pathways";
    // Adjust this if your existing brush_strokes API uses a different path:
    const API_BRUSH_BY_COLOR = (cid) => `/brush_strokes/by_color/${cid}`;

    let instruments = [];
    let selectedInstrumentIds = new Set();
    let colorText = "";

    const backLink = document.getElementById("backLink");
    const headerLabel = document.getElementById("header-label");

    if (artId) {
      backLink.href = `/painting.html?art_id=${artId}`;
      headerLabel.textContent = `Art #${artId}${colorId ? " · Color #" + colorId : ""}`;
    } else {
      backLink.href = "/make-art.html";
      headerLabel.textContent = colorId ? `Color #${colorId}` : "Missing art_id";
    }

    if (!colorId) {
      document.getElementById("color-meta").textContent = "Missing color_id query param.";
      document.getElementById("color-text").textContent = "";
      document.getElementById("runButton").disabled = true;
    }

    // --- INIT ---
    (async function init() {
      try {
        await Promise.all([loadColor(), loadInstruments()]);
        await loadPreviousRuns();
      } catch (e) {
        console.warn("Init error", e);
      }
    })();

    // --- LOAD COLOR TEXT ---
    async function loadColor() {
      if (!colorId) return;
      const metaEl = document.getElementById("color-meta");
      const textEl = document.getElementById("color-text");
      metaEl.textContent = "Loading color…";
      textEl.textContent = "Loading…";

      try {
        // If your API is different, adjust this URL.
        const res = await fetch(`/colors/${colorId}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "Failed to load color");

        metaEl.textContent =
          `Origin: ${data.origin || ""} · Model: ${data.model || ""} · Created: ${data.created_at || ""}`;
        colorText = data.output_text || "";
        textEl.textContent = colorText || "(no color text)";
      } catch (err) {
        metaEl.textContent = "Error loading color.";
        textEl.textContent = err.message || String(err);
      }
    }

    // --- LOAD INSTRUMENTS ---
    async function loadInstruments() {
      const container = document.getElementById("instrument-choices");
      const statusEl = document.getElementById("instrument-status");
      container.innerHTML = "Loading instruments…";
      statusEl.textContent = "";

      try {
        const res = await fetch(API_INSTRUMENTS);
        if (!res.ok) throw new Error("Failed to load instruments");
        const data = await res.json();
        instruments = Array.isArray(data) ? data : [];
        renderInstrumentChoices();
        if (!instruments.length) {
          statusEl.textContent = "No instruments yet. Add some on instruments.html.";
        }
      } catch (err) {
        container.innerHTML = "";
        statusEl.textContent = err.message || "Error loading instruments.";
      }
    }

    function renderInstrumentChoices() {
      const container = document.getElementById("instrument-choices");
      container.innerHTML = "";

      if (!instruments.length) {
        container.innerHTML = '<div class="muted">No instruments available.</div>';
        return;
      }

      instruments.forEach((inst) => {
        const row = document.createElement("label");
        row.className = "instrument-item";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = inst.id;

        checkbox.addEventListener("change", () => {
          const id = inst.id;
          if (checkbox.checked) {
            selectedInstrumentIds.add(id);
          } else {
            selectedInstrumentIds.delete(id);
          }
        });

        const title = document.createElement("span");
        title.className = "instrument-name";
        title.textContent = inst.name || "(untitled)";

        const desc = document.createElement("span");
        desc.className = "instrument-desc";
        desc.textContent = inst.description || "No description.";

        row.appendChild(checkbox);
        row.appendChild(title);
        row.appendChild(desc);

        container.appendChild(row);
      });
    }

    // --- RANDOM SELECTION ---
    function selectRandomInstruments() {
      if (!instruments.length) return;

      const nInput = document.getElementById("randomCount");
      let n = parseInt(nInput.value || "1", 10);
      if (Number.isNaN(n) || n <= 0) n = 1;

      const ids = instruments.map((i) => i.id);
      const chosen = new Set();

      // Simple shuffle-based selection
      const shuffled = ids.slice().sort(() => Math.random() - 0.5);
      for (let i = 0; i < Math.min(n, shuffled.length); i++) {
        chosen.add(shuffled[i]);
      }

      selectedInstrumentIds = chosen;

      // Update checkboxes in UI
      const container = document.getElementById("instrument-choices");
      container.querySelectorAll("input[type=checkbox]").forEach((cb) => {
        const id = parseInt(cb.value, 10);
        cb.checked = chosen.has(id);
      });
    }

    // --- RUN OPERATIONAL PATHWAYS (PARALLEL ENDPOINT CALLS) ---
    async function runOperationalPathways() {
      if (!colorId || !artId) {
        alert("Missing art_id or color_id.");
        return;
      }
      if (!colorText) {
        alert("Color text is not loaded yet.");
        return;
      }

      const runBtn = document.getElementById("runButton");
      const statusEl = document.getElementById("run-status");
      const resultsEl = document.getElementById("run-results");

      const instrumentIds = Array.from(selectedInstrumentIds);
      if (!instrumentIds.length) {
        alert("Select at least one instrument.");
        return;
      }

      runBtn.disabled = true;
      statusEl.textContent = "Submitting tasks…";
      resultsEl.innerHTML = "";

      const payloads = instrumentIds.map((instrument_id) => ({
        art_id: artId,
        color_id: colorId,
        instrument_id,
        brush_stroke: colorText,
      }));

      const calls = payloads.map(async (payload) => {
        try {
          const res = await fetch(API_OPERATIONAL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok) {
            throw new Error(data.message || data.error || "Request failed");
          }
          const inst = instruments.find((i) => i.id === payload.instrument_id);
          return {
            ok: true,
            instrument_id: payload.instrument_id,
            instrument_name: inst ? inst.name : `Instrument #${payload.instrument_id}`,
            task_id: data.task_id,
            status: data.status,
          };
        } catch (err) {
          return {
            ok: false,
            instrument_id: payload.instrument_id,
            error: err.message || String(err),
          };
        }
      });

      const settled = await Promise.allSettled(calls);
      const flat = settled.map((r) => (r.status === "fulfilled" ? r.value : { ok: false, error: r.reason }));

      flat.forEach((entry) => {
        const div = document.createElement("div");
        div.className = "run-item";
        if (entry.ok) {
          div.textContent =
            `${entry.instrument_name} (#${entry.instrument_id}): ` +
            `queued as task ${entry.task_id} (status: ${entry.status}).`;
        } else {
          div.textContent =
            `Instrument #${entry.instrument_id ?? "?"}: error submitting – ${entry.error}`;
        }
        resultsEl.appendChild(div);
      });

      statusEl.textContent = `Submitted ${instrumentIds.length} task(s). Backend worker will process them via queue.`;
      runBtn.disabled = false;

      // After a short delay, refresh previous results so completed runs start to appear.
      setTimeout(() => {
        loadPreviousRuns();
      }, 1500);
    }

    // --- PREVIOUS RESULTS ---
    async function loadPreviousRuns() {
      if (!colorId) return;
      const container = document.getElementById("previous-runs");
      container.textContent = "Loading…";

      try {
        const res = await fetch(API_BRUSH_BY_COLOR(colorId));
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "Failed to load previous runs");

        const rows = Array.isArray(data) ? data : [];
        if (!rows.length) {
          container.innerHTML = '<div class="muted">No previous runs for this color yet.</div>';
          return;
        }

        // Newest first
        rows.sort(
          (a, b) => String(b.created_at || "").localeCompare(String(a.created_at || ""))
        );

        container.innerHTML = "";
        rows.forEach((row) => {
          const inst = instruments.find((i) => i.id === row.instrument_id);
          const name = inst ? inst.name : (row.instrument_id != null ? `Instrument #${row.instrument_id}` : "Unknown instrument");

          const card = document.createElement("div");
          card.className = "prev-card";

          const head = document.createElement("div");
          head.className = "prev-head";

          const title = document.createElement("div");
          title.innerHTML = `<strong>${escapeHtml(name)}</strong>`;

          const meta = document.createElement("div");
          meta.className = "muted";
          meta.textContent = `Brush stroke #${row.id} · ${row.created_at || ""}`;

          head.appendChild(title);
          head.appendChild(meta);

          const body = document.createElement("pre");
          body.className = "prev-body";
          body.textContent = row.output_text || "";

          card.appendChild(head);
          card.appendChild(body);

          container.appendChild(card);
        });
      } catch (err) {
        container.textContent = err.message || "Error loading previous runs.";
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
