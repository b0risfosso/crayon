<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Imagine</title>
  <style>
    body{font-family:sans-serif;max-width:800px;margin:40px auto;}
    textarea{width:100%;min-height:90px;}
    pre#out{
      white-space:pre-wrap;overflow-wrap:anywhere;border:1px solid #ccc;
      padding:8px;background:#f8f8f8;min-height:60px;
    }
    nav a{margin-right:8px}
    label{display:block;margin:14px 0 6px 0;font-weight:600;}
    select{width:100%;padding:4px;}
    button{margin-top:12px;padding:6px 14px;}
  </style>
</head>
<body>
  <nav>
    <a href="prompt.html">Imagine</a> |
    <a href="history.html">Narratives</a> |
    <a href="organize.html">Organize</a>
  </nav>

  <h2>System message</h2>
  <textarea id="sys" rows="4">Imagine.</textarea>

  <h2>User message</h2>
  <textarea id="usr" rows="4"></textarea>

  <label for="targetPage">Send to narrative</label>
  <select id="targetPage"></select>

  <button id="send">Ask</button>

  <h2>Answer</h2>
  <pre id="out">(waiting…)</pre>

<script type="module">
(async()=>{
  // 1️⃣ Fetch the narratives from the server
  const NARRATIVES = await fetch('/api/narratives')
    .then(r => r.ok ? r.json() : Promise.reject(r.statusText));

  // 2️⃣ Grab elements & URL param
  const params  = new URLSearchParams(location.search);
  const initial = params.get('page') || NARRATIVES[0].id;
  const sel     = document.getElementById('targetPage');

  // 3️⃣ Populate the <select>
  sel.innerHTML = '';
  NARRATIVES.forEach(n=>{
    const opt = document.createElement('option');
    opt.value   = n.id;
    opt.textContent = n.title;
    sel.appendChild(opt);
  });

  const divider = document.createElement('option');
  divider.disabled = true;
  divider.textContent = '──────────';
  sel.appendChild(divider);

  const addOpt = document.createElement('option');
  addOpt.value       = '__new__';
  addOpt.textContent = '➕ New narrative…';
  sel.appendChild(addOpt);

  // 4️⃣ Set initial value and hook “new” flow
  sel.value = initial;
  sel.addEventListener('change', e=>{
    if(e.target.value === '__new__') return newNarrativeFlow();
  });

  sel.value = initial;
  sel.addEventListener('change', e=>{
    if(e.target.value === '__new__') return newNarrativeFlow();
  });

  // 5️⃣ Hook the send button (sendPrompt can reference sel.value)
  document.getElementById('send').onclick = sendPrompt;
})()
 

/* ---------- 3. Send prompt ---------- */
async function sendPrompt(){
  const btn = document.getElementById('send');
  const out = document.getElementById('out');
  btn.disabled = true;
  out.textContent = 'Thinking…';

  const payload = {
    system    : document.getElementById('sys').value,
    user      : document.getElementById('usr').value,
    narrative : sel.value
  };

  try{
    const res  = await fetch('/api/ask', {
      method :'POST',
      headers:{'Content-Type':'application/json'},
      body   : JSON.stringify(payload)
    });
    if(!res.ok){
      const text = await res.text();
      throw new Error(`HTTP ${res.status}\n${text.slice(0,200)}`);
    }
    const data = await res.json();
    out.textContent = data.answer ?? '(no answer field)';

    // OPTIONAL: jump to that narrative's history right after
    // location.href = `history.html?page=${encodeURIComponent(sel.value)}`;

  }catch(err){
    out.textContent = 'Error – see console';
    console.error(err);
  }finally{
    btn.disabled = false;
  }
}

document.getElementById('send').onclick = sendPrompt;

/* ---------- 4. New‑narrative flow ---------- */
async function newNarrativeFlow(){
  const title = prompt('Title for the new narrative page?');
  if (!title) { sel.value = initial; return; }

  // make an ID
  const id = slugify(title);
  if (NARRATIVES.some(n=>n.id===id)){
    alert('That ID already exists.');
    sel.value = initial;
    return;
  }

  // tell server to persist it
  try {
    await fetch('/api/narratives', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ id, title })
    });
  } catch(err) {
    console.error(err);
    alert('Failed to create narrative.');
    sel.value = initial;
    return;
  }

  // update local list + UI
  NARRATIVES.push({id, title});
  // clear & repopulate
  sel.innerHTML = '';
  NARRATIVES.forEach(n=>{
    const o = document.createElement('option');
    o.value=n.id; o.textContent=n.title;
    sel.appendChild(o);
  });
  sel.appendChild(divider);
  sel.appendChild(addOpt);
  sel.value = id;

  // redirect to its history
  location.href = `history.html?page=${encodeURIComponent(id)}`;
}

function slugify(str){
  return str.toLowerCase()
            .replace(/[^a-z0-9]+/g,'-')
            .replace(/^-+|-+$/g,'');
}
</script>
</body>
</html>
